<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ¬∑ Avance por √Årea (Ultra)</title>
  <style>
    :root{
      --bg:#080b13;
      --bg-2:#0d1320;
      --panel:#0e1627;
      --glass:rgba(255,255,255,.06);

      --text:#e9eef7;
      --muted:#9fb0c7;

      --grid:#22133d;
      --ring:#1a2a48;

      --ok:#32e685;
      --warn:#ffd166;
      --low:#693bff;
      --danger:#ff5f7a;

      --accent:#78bfae;
      --primary:#5b9dff;

      --white:#fff;
      --black:#000;

      --shadow:0 10px 40px rgba(0,0,0,.35);
      --radius:16px;
      --gap:16px;
    }

    [data-theme="light"]{
      --bg:#f6f8fc;
      --bg-2:#eef2f9;
      --panel:#ffffff;
      --glass:rgba(20,30,60,.08);

      --text:#0e1726;
      --muted:#4b5b78;

      --grid:#d6deea;
      --ring:#c8d4e8;

      --shadow:0 10px 28px rgba(15,45,90,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1400px 700px at 10% -10%, #20355f00, #0b1220), var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    }

    .wrapper{max-width:1280px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
    .h-title h1{margin:0;font-size:22px;letter-spacing:.3px}
    .h-title small{color:var(--muted)}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .controls>*{
      background:var(--panel);
      border:1px solid var(--ring);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      box-shadow:var(--shadow)
    }
    .controls input[type=search]{
      min-width:240px;background:transparent;outline:none;border:none
    }

    .btn{cursor:pointer;user-select:none}
    .btn:hover{filter:brightness(1.08)}

    .pill{border-radius:9999px;border:1px solid var(--ring);background:var(--panel);padding:6px 10px;color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .card{
      background:linear-gradient(180deg, var(--glass), transparent), var(--panel);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    .card.pad{padding:16px}

    /* --- HERO GAUGE --- */
    .hero{grid-column:span 5;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .hero .inner{width:100%;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;position:relative}
    .hero h2{position:absolute;top:16px;left:16px;margin:0;font-size:16px;color:var(--muted)}
    .hero .val{position:absolute;text-align:center;inset:auto;top:50%;transform:translateY(-50%)}
    .hero .val .big{font-size:48px;font-weight:900;letter-spacing:.5px}
    .hero .val .sub{color:var(--muted)}
    .spark{position:absolute;inset:auto 10% 6% auto;background:radial-gradient(circle at 30% 30%, #fff, #fff0 60%);filter:blur(12px);width:120px;height:120px;opacity:.2}

    /* --- CONSTELLATION GRID --- */
    .constel{grid-column:span 7;padding:16px}
    .constel h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
    .tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .tile{position:relative;padding:10px 12px 12px 12px;border-radius:14px;background:linear-gradient(160deg, var(--glass), transparent);border:1px solid var(--ring);display:flex;align-items:center;gap:12px;overflow:hidden}
    .tile .name{font-weight:700}
    .tile .meta{font-size:12px;color:var(--muted)}
    .tile .orb{width:80px;height:80px;flex:0 0 auto}
    .tile .spot{position:absolute;inset:-20% -10% auto auto;width:120px;height:120px;background:radial-gradient(closest-side, rgba(255,255,255,.12), transparent);filter:blur(8px)}

    /* --- RANKED BARS --- */
    .bars{grid-column:span 12;padding:16px}
    .bars h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
    .tip{color:var(--muted);font-size:12px}

    /* --- KPIs STRIP --- */
    .kpis{grid-column:span 12;display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
    .kpi{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(180deg, var(--glass), transparent), var(--panel);border:1px solid var(--ring);border-radius:14px}
    .kpi .dot{width:12px;height:12px;border-radius:50%}
    .kpi h4{margin:0;font-size:12px;color:var(--muted)}
    .kpi .num{font-size:24px;font-weight:900}

    /* --- Cinematic mode --- */
    body.cinematic .wrapper{max-width:none}
    body.cinematic .controls{display:none}
    body.cinematic header{margin-bottom:0}
    body.cinematic .grid{gap:12px}
    body.cinematic .hero{grid-column:span 7}
    body.cinematic .constel{grid-column:span 5}
    /* FIX (cinema): reduce indicador principal para evitar scroll */
    body.cinematic .hero .inner{max-width:420px}
    body.cinematic .hero .val .big{font-size:36px}
    body.cinematic .hero .val .sub{font-size:12px}

    /* --- Exit Cinematic floating button --- */
    .exit-cinema{position:fixed;top:16px;right:16px;z-index:10000;display:none}
    body.cinematic .exit-cinema{display:inline-flex}

    /* --- Theme toggle --- */
    .switch{display:inline-flex;gap:8px;align-items:center}
    .toggle{appearance:none;width:44px;height:24px;border:1px solid var(--ring);border-radius:20px;background:var(--bg-2);position:relative;outline:none;cursor:pointer}
    .toggle::after{content:"";position:absolute;inset:3px auto auto 3px;width:18px;height:18px;border-radius:50%;background:linear-gradient(180deg,#2bc3ff,#4d86ff);box-shadow:0 2px 8px rgba(0,0,0,.4);transition:transform .2s ease}
    .toggle:checked::after{transform:translateX(20px)}

    /* --- Accessibility helpers --- */
    .sr{position:absolute;left:-9999px}

    @media (max-width:1080px){
      .hero{grid-column:span 12}
      .constel{grid-column:span 12}
    }
    @media (max-width:720px){
      .tiles{grid-template-columns:repeat(2,1fr)}
      .kpis{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:520px){
      .tiles{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <div class="h-title">
        <h1>PROGRESSIA ¬∑ Discord Project ¬∑ [ Project Type ]</h1>
        <small>Advance by Business Unit</small>
      </div>

      <div class="controls" role="region" aria-label="Controles">
        <input id="q" type="search" placeholder="/ Search Business Unit‚Ä¶ (HR, PAY, GDPA)" aria-label="Buscar" />
        <select id="status" aria-label="Filtro de estado">
          <option value="all">All</option>
          <option value="done">100%</option>
          <option value="wip">1‚Äì99%</option>
          <option value="todo">0%</option>
        </select>

        <button class="btn pill" data-sort="name" title="Order A‚ÜíZ (tecla: s)">A‚ÜíZ</button>
        <button class="btn pill" data-sort="progress" title="Order by Advance">Advance</button>

        <div class="switch" title="Theme light/dark">
          <span>üåô</span><input id="theme" class="toggle" type="checkbox" /><span>‚òÄÔ∏è</span>
        </div>

        <button id="cinema" class="btn pill" title="Cinematic Mode (key: x)">Cinematic</button>
        <button id="exportBars" class="btn pill" title="Exportar barras PNG">Bar PNG</button>
        <button id="exportSVG" class="btn pill" title="Exportar barras SVG">Bar SVG</button>
        <button id="exportCSV" class="btn pill" title="Exportar CSV">CSV</button>
      </div>
    </header>

    <!-- FIX: bot√≥n flotante para salir del modo cinem√°tico -->
    <button id="exitCinema" class="btn pill exit-cinema" title="Turn off cinematic mode (Esc)">Exit</button>

    <section class="grid">
      <div class="card hero">
        <div class="inner">
          <h2>Progreso Global</h2>
          <svg id="heroGauge" viewBox="0 0 360 360" width="100%" height="100%" role="img" aria-label="Medidor global"></svg>
          <div class="val" style="inset:auto; top:50%; transform:translateY(-50%);">
            <div class="big" id="heroPct">‚Äî%</div>
            <div class="sub" id="heroCaption">Avg</div>
          </div>
          <div class="spark"></div>
        </div>
      </div>

      <div class="card constel pad">
        <h3>BU's Constellation</h3>
        <div class="tiles" id="tiles"></div>
        <p class="tip">Hover to activate spotlight ¬∑ Click to lock focus ¬∑ Press ESC to release</p>
      </div>

      <div class="card kpis">
        <div class="kpi"><div class="dot" style="background:var(--ok)"></div><h4>Completed</h4><div class="num" id="kpiDone">‚Äî</div></div>
        <div class="kpi"><div class="dot" style="background:var(--warn)"></div><h4>In Progress</h4><div class="num" id="kpiWip">‚Äî</div></div>
        <div class="kpi"><div class="dot" style="background:var(--danger)"></div><h4>About to Start</h4><div class="num" id="kpiTodo">‚Äî</div></div>
        <div class="kpi"><div class="dot" style="background:var(--accent)"></div><h4>Total Avg</h4><div class="num" id="kpiAvg">‚Äî%</div></div>
      </div>

      <div class="card bars pad">
        <h3>Ranking by Advance</h3>
        <svg id="bars" viewBox="0 0 1100 460" width="100%" height="100%" role="img" aria-label="Barras de avance"></svg>
        <p class="tip">Use controls to order and filter ¬∑ Enter to clean up Search Bar</p>
      </div>
    </section>
  </div>

  <script>
    const DATA = [
      {key:'GDPA', name:'GDPA', progress:30},
      {key:'P&S', name:'P&S', progress:25},
      {key:'SPP', name:'SPP', progress:20},
      {key:'ACC', name:'ACC', progress:15},
      {key:'SMKG', name:'SMKG', progress:9},
      {key:'INV', name:'INV', progress:0},
      {key:'PSC', name:'PSC', progress:0},
      {key:'CUST I', name:'CUST I', progress:0},
      {key:'CUST II', name:'CUST II', progress:0},
      {key:'PAY', name:'PAY', progress:100},
      {key:'HR', name:'HR', progress:100},
      {key:'COMM', name:'COMM', progress:100},
    ];

    let state = { q:'', status:'all', sort:'progress', theme:'dark', pinned:null };

    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const fmt = n => `${n.toFixed(0)}%`;
    const getCSS = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();

    function color(p){
      if(p===100) return getCSS('--ok');
      if(p===0) return getCSS('--danger');
      if(p>=50) return getCSS('--warn');
      return getCSS('--low');
    }

    function filtered(){
      let arr = DATA.filter(d=> d.name.toLowerCase().includes(state.q.toLowerCase()));
      if(state.status==='done') arr = arr.filter(d=>d.progress===100);
      if(state.status==='wip')  arr = arr.filter(d=>d.progress>0 && d.progress<100);
      if(state.status==='todo') arr = arr.filter(d=>d.progress===0);

      if(state.sort==='name')  arr.sort((a,b)=>a.name.localeCompare(b.name));
      if(state.sort==='progress') arr.sort((a,b)=>b.progress - a.progress || a.name.localeCompare(b.name));
      return arr;
    }

    /* ------------- HERO GAUGE (SVG) ------------- */
    function drawHero(avg){
      const svg = $('#heroGauge'); svg.innerHTML='';
      const W=360,H=360,cx=W/2, cy=H/2, r=130, sw=28, C = 2*Math.PI*r;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
      const lg = document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
      lg.id='g'; lg.setAttribute('x1','0'); lg.setAttribute('y1','0'); lg.setAttribute('x2','1'); lg.setAttribute('y2','1');
      const stops = [[ '0%', '#4fd1ff'], ['50%', '#7affb3'], ['100%', '#ffd166']];
      stops.forEach(([o,c])=>{const s=document.createElementNS('http://www.w3.org/2000/svg','stop'); s.setAttribute('offset',o); s.setAttribute('stop-color',c); lg.appendChild(s);});
      const f = document.createElementNS('http://www.w3.org/2000/svg','filter'); f.id='glow';
      f.innerHTML='<feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>';
      defs.appendChild(lg); defs.appendChild(f); svg.appendChild(defs);

      const track = document.createElementNS('http://www.w3.org/2000/svg','circle');
      track.setAttribute('cx',cx); track.setAttribute('cy',cy); track.setAttribute('r',r);
      track.setAttribute('fill','none'); track.setAttribute('stroke', getCSS('--ring')); track.setAttribute('stroke-width',sw);
      svg.appendChild(track);

      // grid
      for(let i=0;i<=10;i++){
        const a = (i/10)*Math.PI*2 - Math.PI/2, R=r+sw/2, r2=R+8;
        const x1=cx+Math.cos(a)*R, y1=cy+Math.sin(a)*R, x2=cx+Math.cos(a)*r2, y2=cy+Math.sin(a)*r2;
        const L=document.createElementNS('http://www.w3.org/2000/svg','line');
        L.setAttribute('x1',x1); L.setAttribute('y1',y1); L.setAttribute('x2',x2); L.setAttribute('y2',y2);
        L.setAttribute('stroke', getCSS('--grid')); L.setAttribute('stroke-width', (i%5===0)?2:1);
        svg.appendChild(L);
      }

      const arc = document.createElementNS('http://www.w3.org/2000/svg','circle');
      arc.setAttribute('cx',cx); arc.setAttribute('cy',cy); arc.setAttribute('r',r);
      arc.setAttribute('fill','none'); arc.setAttribute('stroke','url(#g)');
      arc.setAttribute('stroke-width',sw); arc.setAttribute('stroke-linecap','round');
      arc.setAttribute('transform', `rotate(-90 ${cx} ${cy})`);
      const target = C*(1-avg/100);
      const t0=performance.now(); const dur=800;
      function step(t){
        const k=Math.min(1,(t-t0)/dur); const ease=.5*(1-Math.cos(Math.PI*k));
        arc.setAttribute('stroke-dasharray', `${C} ${C}`); arc.setAttribute('stroke-dashoffset', target + (C-target)*(1-ease));
        requestAnimationFrame(step);
      }
      arc.setAttribute('filter', 'url(#glow)');
      svg.appendChild(arc);

      const comet = document.createElementNS('http://www.w3.org/2000/svg','circle');
      comet.setAttribute('r','6'); comet.setAttribute('fill', '#ffffff'); comet.setAttribute('opacity','.9');
      svg.appendChild(comet);

      function step2(){
        const ang = -Math.PI/2 + 2*Math.PI*(avg/100);
        const rr=r; const x=cx+Math.cos(ang)*rr, y=cy+Math.sin(ang)*rr;
        comet.setAttribute('cx',x); comet.setAttribute('cy',y);
        requestAnimationFrame(step2);
      }
      requestAnimationFrame(step);
      requestAnimationFrame(step2);
    }

    /* ------------- CONSTELLATION TILES ------------- */
    function orbTile(d){
      const wrap = document.createElement('div'); wrap.className='tile';
      wrap.dataset.name=d.name; wrap.dataset.progress=d.progress;

      const svgNS='http://www.w3.org/2000/svg';
      const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox','0 0 100 100'); svg.setAttribute('class','orb');

      const defs=document.createElementNS(svgNS,'defs');
      const g=document.createElementNS(svgNS,'linearGradient'); g.id='g-'+d.name.replace(/\W/g,''); g.setAttribute('x1','0'); g.setAttribute('y1','0'); g.setAttribute('x2','1'); g.setAttribute('y2','1');
      [['0%','#5bdcff'],['50%', color(Math.max(1,d.progress))],['100%','#ffd166']].forEach(([o,c])=>{const s=document.createElementNS(svgNS,'stop'); s.setAttribute('offset',o); s.setAttribute('stop-color',c); g.appendChild(s);});
      defs.appendChild(g); svg.appendChild(defs);

      const r=34, cx=50, cy=50, sw=10, C=2*Math.PI*r;
      const track=document.createElementNS(svgNS,'circle');
      track.setAttribute('cy',cy); track.setAttribute('cx',cx); track.setAttribute('r',r);
      track.setAttribute('fill','none'); track.setAttribute('stroke', getCSS('--ring')); track.setAttribute('stroke-width',sw);
      svg.appendChild(track);

      const fg=document.createElementNS(svgNS,'circle');
      fg.setAttribute('cy',cy); fg.setAttribute('cx',cx); fg.setAttribute('r',r);
      fg.setAttribute('fill','none'); fg.setAttribute('stroke', `url(#${g.id})`);
      fg.setAttribute('stroke-width',sw); fg.setAttribute('stroke-linecap','round');
      fg.setAttribute('transform', `rotate(-90 ${cx} ${cy})`);
      const target=C*(1-d.progress/100); const t0=performance.now(); const dur=600+d.progress*2;
      function anim(t){ const k=Math.min(1,(t-t0)/dur); const ease=.5*(1-Math.cos(Math.PI*k));
        fg.setAttribute('stroke-dashoffset', target + (C-target)*(1-ease));
        if(k<1) requestAnimationFrame(anim);
      }
      fg.setAttribute('stroke-dasharray', `${C} ${C}`);
      svg.appendChild(fg); requestAnimationFrame(anim);

      const sat=document.createElementNS(svgNS,'circle'); sat.setAttribute('r','3'); sat.setAttribute('fill','#fff'); svg.appendChild(sat);
      function anim2(){
        const ang=-Math.PI/2 + 2*Math.PI*(d.progress/100);
        const x=cx + Math.cos(ang)*r, y=cy + Math.sin(ang)*r;
        sat.setAttribute('cx',x); sat.setAttribute('cy',y);
        requestAnimationFrame(anim2);
      }
      requestAnimationFrame(anim2);

      const info=document.createElement('div'); info.innerHTML=`<div class="name">${d.name}</div><div class="meta">${d.progress}%</div>`;
      const spot=document.createElement('div'); spot.className='spot';
      wrap.appendChild(svg); wrap.appendChild(info); wrap.appendChild(spot);

      wrap.addEventListener('mouseenter', ()=> spotlight(d.name,true));
      wrap.addEventListener('mouseleave', ()=> spotlight(d.name,false));
      wrap.addEventListener('click', ()=>{ state.pinned = (state.pinned===d.name? null : d.name); apply(); });

      return wrap;
    }

    function spotlight(name, on){
      if(state.pinned) return; // si hay selecci√≥n, ignorar hover
      $$('#tiles .tile').forEach(t=>{
        t.style.opacity = on ? (t.dataset.name===name? '1' : '.25') : '1';
      });
    }

    /* ------------- RANKED BARS ------------- */
    function drawBars(items){
      const svg=$('#bars'); svg.innerHTML='';
      const W=1100,H=460, M={t:40,r:24,b:40,l:150}; const w=W-M.l-M.r, h=H-M.t-M.b;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

      // grid + etiquetas
      for(let i=0;i<=10;i++){
        const x=M.l + (i/10)*w;
        const L=document.createElementNS('http://www.w3.org/2000/svg','line');
        L.setAttribute('x1',x); L.setAttribute('y1',M.t); L.setAttribute('x2',x); L.setAttribute('y2',M.t+h);
        L.setAttribute('stroke', getCSS('--grid')); L.setAttribute('stroke-width', (i%2===0)?2:1);
        svg.appendChild(L);

        const T=document.createElementNS('http://www.w3.org/2000/svg','text');
        T.setAttribute('x',x); T.setAttribute('y',M.t-10); T.setAttribute('text-anchor','middle');
        T.setAttribute('font-size','11'); T.textContent=(i*10)+'%'; T.setAttribute('fill', getCSS('--text'));
        svg.appendChild(T);
      }

      const barH = Math.min(26, h/items.length - 10);
      items.forEach((d,i)=>{
        const y=M.t + i*(barH+10);

        const lab=document.createElementNS('http://www.w3.org/2000/svg','text');
        lab.setAttribute('x', M.l-12); lab.setAttribute('y', y+barH/2); lab.setAttribute('text-anchor','end');
        lab.setAttribute('dominant-baseline','middle'); lab.setAttribute('font-size','13');
        lab.textContent=d.name; lab.setAttribute('fill', getCSS('--text')); svg.appendChild(lab);

        const track=document.createElementNS('http://www.w3.org/2000/svg','rect');
        track.setAttribute('x',M.l); track.setAttribute('y',y); track.setAttribute('width',w);
        track.setAttribute('height',barH); track.setAttribute('rx','8'); track.setAttribute('fill', getCSS('--ring'));
        svg.appendChild(track);

        const defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg','defs'); if(!svg.querySelector('defs')) svg.appendChild(defs);
        const gid='gb'+i;
        const gr=document.createElementNS('http://www.w3.org/2000/svg','linearGradient'); gr.id=gid; gr.setAttribute('x1','0'); gr.setAttribute('y1','0'); gr.setAttribute('x2','1'); gr.setAttribute('y2','0');
        [['0%', color(Math.max(1,d.progress))], ['100%','#ffd166']].forEach(([o,c])=>{const s=document.createElementNS('http://www.w3.org/2000/svg','stop'); s.setAttribute('offset',o); s.setAttribute('stop-color',c); gr.appendChild(s);}); defs.appendChild(gr);

        const bar=document.createElementNS('http://www.w3.org/2000/svg','rect');
        bar.setAttribute('x',M.l); bar.setAttribute('y',y); bar.setAttribute('width','0');
        bar.setAttribute('height',barH); bar.setAttribute('fill',`url(#${gid})`);
        bar.style.filter='drop-shadow(0 2px 10px rgba(0,0,0,.2))'; bar.dataset.target = w*d.progress/100;
        svg.appendChild(bar);

        const gloss=document.createElementNS('http://www.w3.org/2000/svg','rect');
        gloss.setAttribute('x',M.l); gloss.setAttribute('y',y); gloss.setAttribute('width','0');
        gloss.setAttribute('height', Math.max(2,barH*0.35)); gloss.setAttribute('rx','6');
        gloss.setAttribute('fill', '#fff'); gloss.setAttribute('opacity','0.18'); svg.appendChild(gloss);

        const v=document.createElementNS('http://www.w3.org/2000/svg','text');
        v.setAttribute('x', M.l+4); v.setAttribute('y', y+barH/2); v.setAttribute('dominant-baseline','middle');
        v.setAttribute('font-size','12'); v.setAttribute('fill', getCSS('--text')); v.textContent = fmt(d.progress); svg.appendChild(v);
      });

      // ‚úÖ FIX: seleccionar solo las barras animables por su data-attribute
      const bars = $$('rect[data-target]', svg);
      const glosses = $$('rect[rx="6"]', svg);
      bars.forEach((el,idx)=>{
        const target = +el.dataset.target; const t0=performance.now(); const dur=600;
        function step(t){ const k=Math.min(1,(t-t0)/dur); const ease=1-Math.pow(1-k,3); const w=target*ease;
          el.setAttribute('width',w); if(glosses[idx]) glosses[idx].setAttribute('width', Math.max(0,w-6));
          if(k<1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      });
    }

    /* ------------- KPIs ------------- */
    function updateKPIs(items){
      const done = items.filter(d=>d.progress===100).length;
      const wip  = items.filter(d=>d.progress>0 && d.progress<100).length;
      const todo = items.filter(d=>d.progress===0).length;
      const avg = DATA.reduce((s,d)=>s+d.progress,0)/DATA.length;
      $('#kpiDone').textContent=done; $('#kpiWip').textContent=wip;
      $('#kpiTodo').textContent=todo; $('#kpiAvg').textContent=avg.toFixed(2)+'%';
    }

    /* ------------- TILES RENDER ------------- */
    function renderTiles(items){
      const box=$('#tiles'); box.innerHTML='';
      items.forEach(d=> box.appendChild(orbTile(d))); // posiciones fijas
      if(state.pinned){ $$('#tiles .tile').forEach(t=> t.style.opacity = (t.dataset.name===state.pinned? '1' : '.18')); }
    }

    /* ------------- HERO & BARS APPLY ------------- */
    function apply(){
      const items = filtered();
      const avgGlobal = DATA.reduce((s,d)=>s+d.progress,0)/DATA.length;
      let heroValue = avgGlobal;
      let heroText = 'Avg';
      if(state.pinned){
        const sel = DATA.find(d=>d.name===state.pinned);
        if(sel){ heroValue = sel.progress; heroText = sel.name; }
      }
      drawHero(heroValue);
      $('#heroPct').textContent = fmt(heroValue);
      $('#heroCaption').textContent = heroText;

      renderTiles(items);
      drawBars(items);
      updateKPIs(items);
    }

    /* ------------- CONTROLS ------------- */
    $('#q').addEventListener('input', e=>{ state.q=e.target.value; apply(); });
    $('#status').addEventListener('change', e=>{ state.status=e.target.value; apply(); });

    $$('button[data-sort]').forEach(b=> b.addEventListener('click', e=>{
      state.sort=e.target.dataset.sort; apply();
    }));

    $('#theme').addEventListener('change', e=>{
      const theme = e.target.checked ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', theme); state.theme=theme; apply();
    });

    $('#cinema').addEventListener('click', ()=> document.body.classList.toggle('cinematic') );
    // FIX: bot√≥n de salida del modo cinem√°tico
    $('#exitCinema').addEventListener('click', ()=>{ document.body.classList.remove('cinematic'); });

    document.addEventListener('keydown', (ev)=>{
      if(ev.key==='/' && document.activeElement.id!=='q'){ ev.preventDefault(); $('#q').focus(); }
      if(ev.key==='Enter' && document.activeElement.id==='q'){ ev.preventDefault(); $('#q').value=''; state.q=''; apply(); }
      if(ev.key==='s'){ state.sort = (state.sort==='name'?'progress':'name'); apply(); }
      if(ev.key==='x'){ document.body.classList.toggle('cinematic'); }
      // FIX: ESC primero limpia selecci√≥n; si no hay selecci√≥n, sale del modo cinem√°tico
      if(ev.key==='Escape'){
        if(state.pinned){ state.pinned=null; apply(); }
        else if(document.body.classList.contains('cinematic')){
          document.body.classList.remove('cinematic');
        }
      }
    });

    /* ------------- EXPORTS ------------- */
    function download(filename, text, type='text/plain'){
      const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type}));
      a.download=filename; a.click(); URL.revokeObjectURL(a.href);
    }
    function svgToPNG(svgEl, w=2200, h=920, filename='chart.png'){
      const svg = new XMLSerializer().serializeToString(svgEl);
      const img = new Image(); img.onload=function(){ const c=document.createElement('canvas');
        c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.fillStyle=getCSS('--bg');
        ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h); c.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=filename;
          a.click(); URL.revokeObjectURL(a.href); }, 'image/png' );
      };
      img.src='data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
    }

    $('#exportBars').addEventListener('click', ()=> svgToPNG($('#bars'), 2400, 1000, 'ranking_avance.png'));
    $('#exportSVG').addEventListener('click', ()=>{
      const svg=$('#bars').cloneNode(true); const sty=document.createElement('style');
      sty.textContent = `text{fill:${getCSS('--text')};font-family:${getComputedStyle(document.body).fontFamily}}`; svg.insertBefore(sty,svg.firstChild);
      const s=`<?xml version="1.0"?>` + new XMLSerializer().serializeToString(svg);
      download('ranking_avance.svg', s, 'image/svg+xml');
    });
    $('#exportCSV').addEventListener('click', ()=>{
      const rows = DATA.map(d=>`${d.name},${d.progress}`).join('\n');
      download('avance_por_area.csv','area,progress\n'+rows,'text/csv');
    });

    /* ------------- INIT ------------- */
    apply();
  </script>
</body>
</html>
