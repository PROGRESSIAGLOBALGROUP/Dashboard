<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Slashboard Ultra · v1.0</title>
  
  
  
<style>
/* Admin Panel Styles */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  backdrop-filter:blur(10px);
  animation:fadeIn 0.3s ease;
  box-sizing:border-box;
  width:100vw;
  height:100vh;
}
.modal-overlay.active{display:flex}
.modal-content{
  background:linear-gradient(135deg,rgba(91,157,255,0.05),transparent),var(--panel);
  border:1px solid var(--ring);
  box-shadow:0 20px 70px rgba(0,0,0,0.7), 0 0 0 1px rgba(91,157,255,0.1) inset;
  border-radius:calc(var(--radius) * 1.2);
  box-sizing:border-box !important;
  max-width:90% !important;
  width:90% !important;
  min-width:320px;
  height:auto;
  min-height:400px;
  max-height:90vh;
  overflow:hidden;
  position:relative;
  animation:slideInUp .5s cubic-bezier(0.34, 1.56, 0.64, 1);
  display:flex;
  flex-direction:column;
  margin:0 auto;
}
@media (max-width: 1024px) {
  .modal-content{
    width:95vw !important;
    max-height:92vh;
    min-height:350px;
  }
}
@media (max-width: 768px) {
  .modal-content{
    width:98vw !important;
    max-height:95vh;
    min-height:300px;
    border-radius:var(--radius);
  }
}
.nested-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity 0.3s;backdrop-filter:blur(8px)}
.nested-modal.active{opacity:1;pointer-events:auto}
.nested-modal-content{
  background:linear-gradient(135deg,rgba(91,157,255,0.05),transparent),var(--panel);
  border:1px solid var(--ring);
  border-radius:var(--radius);
  box-shadow:0 25px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(91,157,255,0.15) inset;
  width:600px;
  max-width:92%;
  max-height:90vh;
  padding:24px;
  position:relative;
  animation:popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.5);
}
@media (min-width: 1800px) {
  .modal-content{max-width:none;width:90vw}
}
@media (max-width: 1200px) {
  .modal-content{width:92vw;max-width:none}
}
@media (max-width: 768px) {
  .modal-content{width:98%;margin:0;border-radius:var(--radius)}
  .modal-tabpanel.active{padding:20px 16px}
  .modal-header{padding:18px 20px}
}
@keyframes popIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
@keyframes fadeOutIn{0%{opacity:1}50%{opacity:0}100%{opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes glowPulse{0%{box-shadow:0 0 0 rgba(91,157,255,0)}50%{box-shadow:0 0 15px rgba(91,157,255,0.3)}100%{box-shadow:0 0 0 rgba(91,157,255,0)}}
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:0;
  padding:24px 32px 20px 32px;
  background:linear-gradient(135deg,rgba(91,157,255,0.1),rgba(91,157,255,0.02));
  position:sticky;
  top:0;
  z-index:10;
  border-bottom:1px solid rgba(91,157,255,0.2);
  backdrop-filter:blur(12px);
}
.modal-header h2{
  margin:0;
  font-size:22px;
  color:var(--text);
  font-weight:700;
  letter-spacing:0.5px;
  display:flex;
  align-items:center;
  gap:12px;
}
.modal-header h2::before{
  /* Remove duplicate icon */
  content:"";
  display:none;
}
.modal-close{
  appearance:none;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--muted);
  font-size:18px;
  cursor:pointer;
  padding:0;
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  transition:all 0.2s ease;
}
.modal-close:hover{
  color:var(--text);
  background:rgba(255,95,122,0.15);
  transform:rotate(90deg);
}
.modal-tabs{
  display:flex;
  gap:4px;
  padding:8px 32px 0 32px;
  margin-top:0;
  border-bottom:1px solid var(--ring);
  background:linear-gradient(180deg,rgba(14,22,39,0.95),rgba(20,30,60,0.3));
  overflow-x:auto;
  scrollbar-width:thin;
  scrollbar-color:rgba(91,157,255,0.3) transparent;
  position:sticky;
  top:0;
  z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  flex-shrink:0;
  min-height:60px;
  height:60px;
  backdrop-filter:blur(10px);
}
.modal-tabs::-webkit-scrollbar {
  height: 4px;
}
.modal-tabs::-webkit-scrollbar-track {
  background: transparent;
}
.modal-tabs::-webkit-scrollbar-thumb {
  background: rgba(91,157,255,0.3);
  border-radius: 2px;
}
.modal-tab{
  appearance:none;
  background:none;
  border:none;
  color:var(--muted);
  padding:16px 24px;
  cursor:pointer;
  border-bottom:2px solid transparent;
  font-size:14px;
  font-weight:500;
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
  white-space:nowrap;
  letter-spacing:0.2px;
  flex-shrink:0;
  min-width:max-content;
  display:flex;
  align-items:center;
  gap:8px;
  border-radius:8px 8px 0 0;
  margin:0 2px;
}
.modal-tab:hover{
  color:#ffffff;
  background:linear-gradient(135deg, rgba(91,157,255,0.25), rgba(91,157,255,0.15));
  border-bottom-color:rgba(91,157,255,0.6);
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(91,157,255,0.3);
}
.modal-tab.active{
  color:#ffffff;
  border-bottom-color:var(--primary);
  background:rgba(91,157,255,0.15);
  font-weight:600;
}
.modal-tab.active::after{
  content:"";
  position:absolute;
  bottom:-2px;
  left:0;
  width:100%;
  height:3px;
  background:var(--primary);
  box-shadow:0 0 12px 2px rgba(91,157,255,0.6);
  animation:glowPulse 2s infinite;
}
@media (max-width: 768px) {
  .modal-tabs{
    padding:0 16px;
    gap:0;
  }
  .modal-tab{
    padding:18px 12px;
    font-size:13px;
  }
}
.modal-tabpanel{display:none;animation:fadeIn 0.4s ease}
.modal-tabpanel.active{
  display:block;
  padding:32px;
}
@media (max-width: 1024px) {
  .modal-tabpanel.active{
    padding:24px;
  }
}
@media (max-width: 768px) {
  .modal-tabpanel.active{
    padding:16px;
  }
}

/* Tab Headers */
.tab-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:24px;
  margin-bottom:28px;
  padding-bottom:20px;
  border-bottom:1px solid var(--ring);
}
.tab-header h3{
  margin:0 0 8px 0;
  font-size:20px;
  color:var(--text);
  font-weight:700;
}
.tab-description{
  margin:0;
  font-size:13px;
  color:var(--muted);
  line-height:1.5;
}
@media (max-width: 768px) {
  .tab-header{
    flex-direction:column;
    gap:16px;
    margin-bottom:20px;
    padding-bottom:16px;
  }
  .tab-header h3{
    font-size:18px;
  }
  .tab-header button{
    width:100%;
  }
}

/* Filters Bar */
.filters-bar{display:flex;gap:12px;margin-bottom:24px;padding:16px;background:var(--bg-2);border-radius:10px;border:1px solid var(--ring)}
.filter-select{appearance:none;background:var(--bg);border:1px solid var(--ring);color:var(--text);padding:10px 12px;border-radius:8px;font-size:13px;cursor:pointer;transition:all 0.2s ease;min-width:200px}
.filter-select:hover,.filter-select:focus{border-color:var(--primary);box-shadow:0 0 8px rgba(91,157,255,.2);outline:none}

/* Settings Styles */
.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.settings-section{background:var(--bg-2);border:1px solid var(--ring);border-radius:10px;padding:20px;transition:all 0.2s ease}
/* Enterprise Formula Styles */
.formula-hero-section{background:linear-gradient(135deg, var(--primary)20, var(--ok)10);border:2px solid var(--primary);border-radius:20px;padding:40px;margin-bottom:32px;position:relative;overflow:hidden}
.formula-hero-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 20% 20%, var(--primary)15 0%, transparent 50%),radial-gradient(circle at 80% 80%, var(--ok)15 0%, transparent 50%);pointer-events:none}
.hero-content{position:relative;z-index:1;text-align:center}
.hero-icon{font-size:48px;margin-bottom:16px;display:block;animation:pulse 2s infinite}
@keyframes pulse{0%, 100%{transform:scale(1)}50%{transform:scale(1.1)}}
.hero-content h2{color:var(--text);font-size:32px;font-weight:700;margin:0 0 12px 0;background:linear-gradient(135deg, var(--primary), var(--ok));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.hero-subtitle{color:var(--text-secondary);font-size:16px;margin:0 0 32px 0}
.formula-showcase{display:flex;justify-content:center}
.formula-box{background:var(--bg);border:2px solid var(--primary);border-radius:16px;padding:24px;width:100%;max-width:900px;box-shadow:0 8px 32px rgba(91, 157, 255, 0.2)}
.formula-label{color:var(--primary);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.formula-equation{font-family:'Segoe UI', system-ui;font-size:20px;font-weight:600;color:var(--text);margin-bottom:8px}
.formula-equation .highlight{color:var(--primary);background:var(--primary)20;padding:2px 8px;border-radius:6px}
.formula-range{color:var(--text-secondary);font-size:14px;font-family:'Courier New', monospace}
.business-intelligence-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:20px;max-width:100%;overflow:hidden}
.bi-card{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:0;overflow:hidden;transition:all 0.3s ease;position:relative}
.bi-card:hover{border-color:var(--primary);box-shadow:0 8px 32px rgba(91, 157, 255, 0.1);transform:translateY(-2px)}
.bi-header{background:linear-gradient(135deg, var(--bg), var(--panel));border-bottom:1px solid var(--ring);padding:20px;display:flex;align-items:center;justify-content:space-between}
.bi-header h4{color:var(--text);font-size:16px;font-weight:600;margin:0}
.bi-badge{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;background:var(--primary);color:white}
.bi-badge.calculator{background:var(--ok)}
.bi-badge.config{background:var(--warn)}
.bi-badge.rules{background:var(--danger)}
.bi-badge.global{background:linear-gradient(135deg, var(--primary), var(--ok))}
.bi-badge.examples{background:var(--text-secondary)}
/* Priority Badge Styling - World-class visual consistency */
.priority-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:12px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;transition:all 0.2s ease;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.priority-badge.priority-high{background:linear-gradient(135deg, var(--danger), #ff7a8f);color:white;border:1px solid var(--danger)}
.priority-badge.priority-high:hover{box-shadow:0 4px 12px rgba(255,95,122,0.3);transform:translateY(-1px)}
.priority-badge.priority-medium{background:linear-gradient(135deg, var(--warn), #ffe599);color:#000;border:1px solid var(--warn)}
.priority-badge.priority-medium:hover{box-shadow:0 4px 12px rgba(255,209,102,0.3);transform:translateY(-1px)}
.priority-badge.priority-low{background:linear-gradient(135deg, var(--ok), #5fff99);color:#000;border:1px solid var(--ok)}
.priority-badge.priority-low:hover{box-shadow:0 4px 12px rgba(50,230,133,0.3);transform:translateY(-1px)}
#appsOverviewTableBody td:nth-child(5){text-align:center;vertical-align:middle}
.factor-matrix{padding:20px}
.factor-row{display:grid;grid-template-columns:1fr 2fr 1fr;align-items:center;gap:16px;padding:16px 0;border-bottom:1px solid var(--ring)}
.factor-row:last-child{border-bottom:none}
.factor-name{color:var(--text);font-weight:600;font-size:14px}
.factor-scale{display:flex;gap:8px}
.scale-item{flex:1;padding:8px;border-radius:8px;text-align:center;font-size:12px;font-weight:600;position:relative}
.scale-item.danger{background:var(--danger);color:white}
.scale-item.warn{background:var(--warn);color:white}
.scale-item.ok{background:var(--ok);color:white}
.scale-item span{position:absolute;top:-8px;right:-8px;background:var(--bg);border:2px solid currentColor;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.factor-desc{color:var(--text-secondary);font-size:12px;text-align:center}
.calculator-content{padding:20px}
.calc-inputs{display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:16px;margin-bottom:24px}
.calc-input label{display:block;color:var(--text);font-size:12px;font-weight:600;margin-bottom:6px}
.calc-input select,.calc-input input{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--ring);border-radius:8px;color:var(--text);font-size:14px}
.calc-result{background:linear-gradient(135deg, var(--primary)20, var(--ok)10);border:2px solid var(--primary);border-radius:12px;padding:20px;text-align:center}
.result-label{color:var(--text-secondary);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.result-value{color:var(--primary);font-size:36px;font-weight:700;margin-bottom:8px}
.result-formula{color:var(--text);font-family:'Courier New', monospace;font-size:14px}
.config-content,.inclusion-content,.global-content{padding:20px}
.method-selector{display:flex;flex-direction:column;gap:16px}
.method-option{position:relative}
.method-option input[type="radio"]{position:absolute;opacity:0;pointer-events:none}
.method-option label{display:block;background:var(--bg);border:2px solid var(--ring);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.3s ease}
.method-option input[type="radio"]:checked + label{border-color:var(--primary);background:var(--primary)10}
.method-name{color:var(--text);font-weight:600;font-size:14px;margin-bottom:4px}
.method-desc{color:var(--text-secondary);font-size:12px;margin-bottom:8px}
.method-formula{color:var(--primary);font-family:'Courier New', monospace;font-size:12px;background:var(--bg);padding:8px 12px;border-radius:6px;border:1px solid var(--ring)}
.inclusion-grid{display:flex;flex-direction:column;gap:16px}
.inclusion-item{background:var(--bg);border:1px solid var(--ring);border-radius:10px;padding:16px}
.inclusion-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.inclusion-checkbox{width:18px;height:18px;accent-color:var(--primary)}
.status-badge{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.status-badge.danger{background:var(--danger);color:white}
.status-badge.warn{background:var(--warn);color:white}
.status-badge.ok{background:var(--ok);color:white}
.inclusion-name{color:var(--text);font-weight:600;font-size:14px}
.inclusion-desc{color:var(--text-secondary);font-size:12px;margin-left:30px}
.global-selector{display:flex;flex-direction:column;gap:16px}
.global-option{position:relative}
.global-option input[type="radio"]{position:absolute;opacity:0;pointer-events:none}
.global-option label{display:block;background:var(--bg);border:2px solid var(--ring);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.3s ease}
.global-option input[type="radio"]:checked + label{border-color:var(--primary);background:var(--primary)10}
.global-name{color:var(--text);font-weight:600;font-size:14px;margin-bottom:8px}
.global-formula{color:var(--primary);font-family:'Courier New', monospace;font-size:12px;background:var(--panel);padding:8px 12px;border-radius:6px;border:1px solid var(--ring)}
.examples-content{padding:20px}
.example-item{display:flex;align-items:center;gap:16px;background:var(--bg);border:1px solid var(--ring);border-radius:10px;padding:16px;margin-bottom:12px;transition:all 0.3s ease}
.example-item:last-child{margin-bottom:0}
.example-item:hover{border-color:var(--primary);background:var(--primary)05}
.example-item .auto-weight{background:var(--primary);color:white;padding:8px 16px;border-radius:20px;font-weight:700;font-size:16px;min-width:60px;text-align:center;box-shadow:0 4px 12px rgba(91, 157, 255, 0.3)}
.example-item.max .auto-weight{background:var(--danger)}
.example-item.high .auto-weight{background:var(--warn)}
.example-item.standard .auto-weight{background:var(--primary)}
.example-item.low .auto-weight{background:var(--text-secondary)}
.example-item.min .auto-weight{background:var(--ok)}
.example-details{flex:1}
.example-combo{color:var(--text);font-weight:600;font-size:14px;margin-bottom:4px}
.example-desc{color:var(--text-secondary);font-size:12px}
.formula-label{font-family:monospace;background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;display:block;margin-top:8px}
.math-formula{color:var(--text)}
.status-config{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.status-badge{display:inline-block;padding:2px 8px;border-radius:4px;margin-right:8px;font-weight:500;font-size:0.85em}
.status-badge.danger{background:var(--danger);color:white}
.status-badge.warn{background:var(--warn);color:#000}
.status-badge.ok{background:var(--ok);color:#000}
.weight-config{display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:16px}
.formula-actions{grid-column:1/-1;display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
@media (max-width:768px){.business-intelligence-grid{grid-template-columns:1fr;gap:16px}.formula-box{min-width:auto;width:100%}.calc-inputs{grid-template-columns:1fr}.factor-row{grid-template-columns:1fr;gap:8px}.factor-scale{order:2}.factor-desc{order:3;text-align:left}}
.bi-card.factor-analysis{background:linear-gradient(135deg, var(--panel), var(--bg))}
.bi-card.weight-calculator{background:linear-gradient(135deg, var(--primary)05, var(--panel))}
.bi-card.progress-config{background:linear-gradient(135deg, var(--warn)05, var(--panel))}
.bi-card.status-inclusion{background:linear-gradient(135deg, var(--danger)05, var(--panel))}
.bi-card.global-progress{background:linear-gradient(135deg, var(--ok)05, var(--panel))}
.bi-card.weight-examples{background:linear-gradient(135deg, var(--text-secondary)05, var(--panel))}
.calc-input select:focus,.calc-input input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary)20;outline:none}
.method-option:hover label{border-color:var(--primary);background:var(--primary)05}
.global-option:hover label{border-color:var(--primary);background:var(--primary)05}
.inclusion-item:hover{border-color:var(--primary);background:var(--primary)03}
.formula-hero-section .hero-content h2{text-shadow:0 2px 4px rgba(0,0,0,0.1)}
.result-value{text-shadow:0 2px 8px rgba(91, 157, 255, 0.3);transition:all 0.3s ease}
.auto-weight{transition:all 0.3s ease;box-shadow:0 2px 8px rgba(91, 157, 255, 0.2)}
.bi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg, var(--primary), var(--ok));opacity:0;transition:opacity 0.3s ease}
.bi-card:hover::before{opacity:1}
.settings-section:hover{border-color:var(--primary);background:var(--bg)}
.settings-section.danger{border-color:var(--danger);background:rgba(255,95,122,0.05)}
.settings-section-title{margin:0 0 8px 0;font-size:15px;color:var(--text);font-weight:600}
.settings-description{margin:0 0 16px 0;font-size:12px;color:var(--muted);line-height:1.5}

/* Whitelabel Styles */
.whitelabel-container{display:flex;flex-direction:column;gap:24px}
.whitelabel-section{background:var(--bg-2);border:1px solid var(--ring);border-radius:10px;padding:24px;transition:all 0.2s ease}
.whitelabel-section:hover{border-color:var(--primary)}
.whitelabel-section-title{margin:0 0 16px 0;font-size:16px;color:var(--text);font-weight:600}
.form-group{margin-bottom:16px;display:flex;flex-direction:column;gap:8px}
.form-group label{font-size:13px;font-weight:500;color:var(--text)}
.form-input{padding:10px 12px;border:1px solid var(--ring);border-radius:8px;background:var(--bg);color:var(--text);font-size:14px;transition:all 0.2s ease}
.form-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(91,157,255,0.1)}
.form-help{font-size:11px;color:var(--muted);margin:0}
.logo-upload-area{display:flex;flex-direction:column;gap:12px;align-items:center;padding:16px;border:2px dashed var(--ring);border-radius:8px;background:rgba(91,157,255,0.02);transition:all 0.2s ease}
.logo-upload-area:hover{border-color:var(--primary);background:rgba(91,157,255,0.05)}
.logo-preview{width:100%;height:100px;background:var(--bg);border:1px solid var(--ring);border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.logo-preview img{max-width:100%;max-height:100%;object-fit:contain}
.logo-placeholder{font-size:12px;color:var(--muted)}
.whitelabel-preview{background:var(--bg);border:1px solid var(--ring);border-radius:8px;overflow:hidden;box-shadow:inset 0 0 20px rgba(0,0,0,0.2)}
.preview-header{display:flex;align-items:center;justify-content:space-between;padding:24px;gap:20px;background:linear-gradient(135deg,rgba(91,157,255,0.08),rgba(91,157,255,0.01))}
.preview-logo-left,.preview-logo-right{width:120px;height:60px;background:var(--bg-2);border:1px solid var(--ring);border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;color:var(--muted)}
.preview-logo-left img,.preview-logo-right img{max-width:100%;max-height:100%;object-fit:contain}
.preview-title{flex:1;text-align:center}
.preview-title h2{margin:0 0 4px 0;font-size:20px;color:var(--text);font-weight:700}
.preview-title p{margin:0;font-size:12px;color:var(--muted)}
.btn-sm{padding:6px 12px;font-size:12px}

/* Applications Table Container */
.apps-table-container{
  max-height:70vh;
  overflow-y:auto;
  overflow-x:hidden;
  border:1px solid var(--ring);
  border-radius:10px;
  background:var(--bg);
  box-shadow:inset 0 0 20px rgba(0,0,0,0.2);
  scrollbar-width:thin;
  scrollbar-color:rgba(91,157,255,0.3) rgba(0,0,0,0.1);
}

/* Modal Footer */
.modal-footer{display:flex;gap:16px;justify-content:flex-end;padding:24px 32px;border-top:1px solid var(--ring);background:var(--bg-2);margin-top:auto;flex-shrink:0}
@media (max-width: 768px) {
  .modal-footer{padding:16px 20px;flex-direction:column;gap:10px}
  .modal-footer button {width:100%}
}

/* Modal Scroll Container */
.modal-scroll-container{
  flex:1;
  overflow-y:auto;
  overflow-x:hidden;
  scrollbar-width:thin;
  scrollbar-color:rgba(91,157,255,0.3) rgba(0,0,0,0.1);
  padding-bottom:20px;
}
.modal-scroll-container::-webkit-scrollbar {
  width: 8px;
}
.modal-scroll-container::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.1);
  border-radius: 4px;
}
.modal-scroll-container::-webkit-scrollbar-thumb {
  background: rgba(91,157,255,0.3);
  border-radius: 4px;
}
.modal-scroll-container::-webkit-scrollbar-thumb:hover {
  background: rgba(91,157,255,0.5);
}

/* Applications Selector Section */
.apps-selector-section{background:var(--glass);border:1px solid var(--ring);border-radius:10px;padding:20px;margin-bottom:24px}
.bu-selector-premium{appearance:none;background:var(--bg-2);border:1px solid var(--ring);color:var(--text);padding:12px 14px;border-radius:8px;font-size:14px;width:100%;cursor:pointer;transition:all 0.2s ease;font-weight:600}
.bu-selector-premium:hover,.bu-selector-premium:focus{border-color:var(--primary);background:var(--bg);box-shadow:0 0 12px rgba(91,157,255,.25);outline:none}

/* Apps Editor Container */
#appEditorContainer h3{font-size:18px;color:var(--text);font-weight:700;margin:0 0 16px 0;display:flex;align-items:center;gap:8px}
#appEditorContainer h3:before{content:"📋";font-size:20px}

/* Apps Editor Header */
.apps-editor-header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--ring)}

/* Apps Table Wrapper */
.apps-table-wrapper{border:1px solid var(--ring);border-radius:10px;overflow:hidden}
.cell-input{appearance:none;background:transparent;border:none;color:var(--text);padding:2px;font-size:12px;width:100%;font-family:inherit}
.cell-input:focus{outline:none;background:var(--ring);border-radius:4px;padding:2px 4px}
.cell-select{appearance:none;background:transparent;border:none;color:var(--text);padding:2px;font-size:12px;width:100%;cursor:pointer;font-family:inherit}
.cell-select:focus{outline:none;background:var(--ring);border-radius:4px;padding:2px 4px}
.order-input{background:linear-gradient(135deg,rgba(91,157,255,0.1),rgba(50,230,133,0.05));border:1px solid rgba(91,157,255,0.3);border-radius:6px;font-weight:700;color:var(--primary)}
.order-input:focus{background:rgba(91,157,255,0.2);border-color:var(--primary);box-shadow:0 0 0 2px rgba(91,157,255,0.2)}
.progress-cell{position:relative}
.progress-cell input{width:100%}
.mini-progress{position:absolute;bottom:0;left:0;height:2px;border-radius:1px;opacity:0.6;transition:width 0.3s ease}
.empty-row{background:var(--bg-2)!important}
.bu-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
@media (min-width: 1400px) {
  .bu-list{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
}
@media (max-width: 768px) {
  .bu-list{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
}
.bu-card{padding:16px;border:1px solid var(--ring);border-radius:14px;background:linear-gradient(160deg, var(--glass), transparent), var(--bg-2);cursor:pointer;transition:all .3s cubic-bezier(0.17, 0.67, 0.83, 0.67);position:relative;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,0.08);overflow:hidden;animation:fadeIn 0.5s ease-out}
.bu-card::before{content:'';position:absolute;left:0;top:0;width:4px;height:100%;background:var(--primary);opacity:0;transition:opacity .2s ease}
.bu-card:hover{background:linear-gradient(160deg, var(--glass), transparent), var(--bg);border-color:var(--primary);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.12)}
.bu-card.selected{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), var(--ring)}
.bu-card.selected::before{opacity:1}
.bu-card-name{font-weight:700;margin-bottom:6px;font-size:16px;display:flex;align-items:center;gap:6px}
.bu-card-meta{font-size:12px;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:4px}
.bu-card-meta:last-child{margin-top:8px;padding-top:8px;border-top:1px dashed var(--ring)}
.bu-card-actions{position:absolute;top:12px;right:12px;display:flex;gap:6px;z-index:5;opacity:0.6;transition:opacity 0.2s, transform 0.2s}
.bu-card:hover .bu-card-actions{opacity:1;transform:translateY(0)}
.bu-card-btn{appearance:none;background:rgba(0,0,0,0.1);border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(2px);color:var(--text);cursor:pointer;font-size:14px;padding:0;width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:transform 0.2s, color 0.2s, background-color 0.2s, box-shadow 0.2s}
.bu-card-btn:hover{color:var(--primary);transform:scale(1.1);background:var(--bg);box-shadow:0 3px 6px rgba(0,0,0,0.15)}
.bu-card-btn.edit-bu-btn:hover{color:var(--primary)}
.bu-card-btn.delete-bu-btn:hover{color:var(--danger)}
.bu-empty-badge{font-size:10px;background:var(--ring);color:var(--muted);padding:3px 7px;border-radius:10px;vertical-align:middle;font-weight:500}
.bu-card.empty{opacity:0.85;border-style:dashed}
.bu-card-progress{position:relative;height:6px;background:var(--ring);border-radius:3px;margin-top:10px;overflow:hidden}
.bu-card-progress-bar{position:absolute;left:0;top:0;height:100%;background:var(--primary);border-radius:3px}
.bu-card-icon{display:inline-block;width:14px;height:14px;line-height:14px;font-size:12px;text-align:center}
.app-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  margin-top:0;
  background:var(--bg);
  table-layout:auto;
}
.app-table th{
  text-align:left;
  padding:16px 18px;
  border-bottom:2px solid var(--ring);
  font-size:14px;
  color:var(--text);
  font-weight:700;
  background:linear-gradient(180deg, var(--bg-2), rgba(14, 22, 39, 0.8));
  cursor:pointer;
  user-select:none;
  transition:all 0.2s ease;
  position:sticky;
  top:0;
  z-index:5;
}
.app-table th:hover{
  background:linear-gradient(180deg, rgba(91,157,255,0.1), rgba(14, 22, 39, 0.9));
  color:var(--primary);
}
.app-table td{
  padding:14px 18px;
  border-bottom:1px solid var(--ring);
  font-size:14px;
}
.app-table tr{background-color:var(--bg);transition:background-color 0.2s ease}
.app-table tr:hover{background:var(--bg-2)}
.app-table input[type=text],.app-table input[type=number],.app-table select{appearance:none;background:var(--bg-2);border:1px solid var(--ring);color:var(--text);padding:8px 10px;border-radius:6px;font-size:13px;width:100%;transition:border-color 0.2s ease}
.app-table input:focus,.app-table select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 8px rgba(91,157,255,.2)}

@media (min-width: 1400px) {
  .app-table th, .app-table td {padding: 16px 14px}
  .app-table input[type=text],.app-table input[type=number],.app-table select {padding: 8px 12px;font-size:14px}
}
@media (max-width: 768px) {
  .app-table {display: block; overflow-x: auto; white-space: nowrap}
  .app-table th, .app-table td {padding: 10px 8px}
}

/* ===== APPLICATIONS OVERVIEW PREMIUM UPGRADE ===== */

/* Stats Section */
.apps-overview-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
  background: var(--glass);
  padding: 16px;
  border-radius: 12px;
  border: 1px solid var(--ring);
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.stat-label {
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

.stat-value {
  font-size: 24px;
  font-weight: 900;
  color: var(--primary);
  font-family: 'Courier New', monospace;
}

/* Premium Filters Bar */
.filters-bar-premium {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
  padding: 12px;
  background: var(--bg-2);
  border-radius: 10px;
  border: 1px solid var(--ring);
  flex-wrap: wrap;
  align-items: center;
}

.search-box-wrapper {
  flex: 1;
  min-width: 200px;
}

.search-input-premium {
  width: 100%;
  padding: 10px 16px;
  background: var(--bg);
  border: 1px solid var(--ring);
  border-radius: 8px;
  color: var(--text);
  font-size: 13px;
  transition: all 0.2s ease;
  font-family: inherit;
}

.search-input-premium:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 12px rgba(91, 157, 255, 0.2);
  background: var(--bg-2);
}

.search-input-premium::placeholder {
  color: var(--muted);
}

.filter-select-premium {
  padding: 10px 12px;
  background: var(--bg);
  border: 1px solid var(--ring);
  border-radius: 8px;
  color: var(--text);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
  min-width: 140px;
}

.filter-select-premium:hover,
.filter-select-premium:focus {
  border-color: var(--primary);
  background: var(--bg-2);
  outline: none;
}

/* Active Filters Display */
.active-filters-container {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  padding: 8px 12px;
  background: rgba(91, 157, 255, 0.08);
  border-radius: 8px;
  border-left: 3px solid var(--primary);
  flex-wrap: wrap;
  align-items: center;
}

.active-filters-label {
  font-weight: 600;
  color: var(--muted);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

#activeFiltersList {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.active-filter-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: var(--primary);
  color: white;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.active-filter-badge .remove-filter {
  cursor: pointer;
  font-weight: bold;
  opacity: 0.7;
  transition: opacity 0.2s;
}

.active-filter-badge .remove-filter:hover {
  opacity: 1;
}

/* Premium Table Container */
.apps-table-container-premium {
  border: 1px solid var(--ring);
  border-radius: 12px;
  overflow: hidden;
  background: var(--bg);
  max-height: 600px;
  overflow-y: auto;
}

.table-header-info {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: var(--bg-2);
  border-bottom: 1px solid var(--ring);
  font-size: 13px;
  color: var(--muted);
}

.table-info-icon {
  font-size: 16px;
}

.table-info-text strong {
  color: var(--text);
  font-weight: 600;
}

/* Premium Table Styles */
.app-table-premium {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;
}

.app-table-premium th {
  background: linear-gradient(135deg, var(--bg-2), var(--bg));
  border-bottom: 2px solid var(--ring);
  padding: 14px;
  text-align: left;
  font-weight: 600;
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: sticky;
  top: 0;
  z-index: 10;
  user-select: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.app-table-premium th.sortable:hover {
  background: linear-gradient(135deg, var(--ring), var(--bg-2));
  color: var(--primary);
}

.col-icon {
  margin-right: 4px;
}

.sort-indicator {
  opacity: 0;
  margin-left: 4px;
  transition: opacity 0.2s;
  font-size: 11px;
}

.app-table-premium th.sort-asc .sort-indicator,
.app-table-premium th.sort-desc .sort-indicator {
  opacity: 1;
}

.app-table-premium th.sort-asc .sort-indicator::after {
  content: "↑";
}

.app-table-premium th.sort-desc .sort-indicator::after {
  content: "↓";
}

.app-table-premium td {
  padding: 12px 14px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  font-size: 13px;
  vertical-align: middle;
}

.app-table-premium tbody tr {
  background: var(--bg);
  transition: all 0.15s ease;
}

.app-table-premium tbody tr:hover {
  background: var(--bg-2);
  box-shadow: inset 0 0 8px rgba(91, 157, 255, 0.1);
}

.app-table-premium tbody tr.critical:hover {
  box-shadow: inset 0 0 8px rgba(255, 95, 122, 0.1);
}

.app-table-premium tbody tr.high:hover {
  box-shadow: inset 0 0 8px rgba(255, 209, 102, 0.1);
}

/* Row classes for criticality highlighting */
.app-table-premium tbody tr.critical {
  border-left: 3px solid var(--danger);
}

.app-table-premium tbody tr.high {
  border-left: 3px solid var(--warn);
}

.app-table-premium tbody tr.medium {
  border-left: 3px solid var(--primary);
}

.app-table-premium tbody tr.low {
  border-left: 3px solid var(--ok);
}

/* Priority Badge */
.priority-badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.priority-badge-premium.high {
  background: rgba(255, 95, 122, 0.15);
  color: var(--danger);
}

.priority-badge-premium.medium {
  background: rgba(255, 209, 102, 0.15);
  color: var(--warn);
}

.priority-badge-premium.low {
  background: rgba(50, 230, 133, 0.15);
  color: var(--ok);
}

/* Criticality Badge */
.criticality-badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.criticality-badge-premium.critical {
  background: rgba(255, 95, 122, 0.15);
  color: var(--danger);
}

.criticality-badge-premium.high {
  background: rgba(255, 209, 102, 0.15);
  color: var(--warn);
}

.criticality-badge-premium.medium {
  background: rgba(91, 157, 255, 0.15);
  color: var(--primary);
}

.criticality-badge-premium.low {
  background: rgba(50, 230, 133, 0.15);
  color: var(--ok);
}

/* Status Badge */
.status-badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.status-badge-premium.tbs {
  background: rgba(255, 95, 122, 0.15);
  color: var(--danger);
}

.status-badge-premium.wip {
  background: rgba(255, 209, 102, 0.15);
  color: var(--warn);
}

.status-badge-premium.clo {
  background: rgba(50, 230, 133, 0.15);
  color: var(--ok);
}

/* Impact Badge */
.impact-badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.impact-badge-premium.high {
  background: rgba(255, 95, 122, 0.15);
  color: var(--danger);
}

.impact-badge-premium.medium {
  background: rgba(91, 157, 255, 0.15);
  color: var(--primary);
}

.impact-badge-premium.low {
  background: rgba(50, 230, 133, 0.15);
  color: var(--ok);
}

/* Progress Bar Premium */
.progress-cell-premium {
  min-width: 150px;
}

.progress-container {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  font-weight: 600;
}

.progress-percentage {
  color: var(--text);
}

.progress-bar-premium {
  width: 100%;
  height: 6px;
  background: var(--ring);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.progress-bar-premium.shimmer::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.progress-value-premium {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), #4d86ff);
  border-radius: 3px;
  transition: width 0.3s ease;
  box-shadow: 0 0 8px rgba(91, 157, 255, 0.4);
}

/* Empty State */
.table-empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
  color: var(--muted);
  background: var(--bg-2);
  border-top: 1px solid var(--ring);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-state-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
}

.empty-state-description {
  font-size: 13px;
  color: var(--muted);
}

/* ===== APPLICATIONS IMPACT MATRIX STYLES ===== */

.applications-impact-matrix {
  margin-top: 40px;
  padding: 0;
}

.matrix-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--ring);
}

.matrix-title-section {
  flex: 1;
}

.matrix-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  margin: 0 0 4px 0;
  background: linear-gradient(135deg, var(--primary), #4d86ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.matrix-subtitle {
  font-size: 13px;
  color: var(--muted);
  margin: 0;
}

.matrix-controls {
  display: flex;
  gap: 12px;
}

.btn-filter-matrix,
.btn-sort-matrix {
  padding: 8px 16px;
  background: rgba(91, 157, 255, 0.1);
  border: 1px solid rgba(91, 157, 255, 0.3);
  color: var(--primary);
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-filter-matrix:hover,
.btn-sort-matrix:hover {
  background: rgba(91, 157, 255, 0.2);
  border-color: var(--primary);
  transform: translateY(-1px);
}

/* Matrix Table */
.matrix-table-wrapper {
  overflow-x: auto;
  margin-bottom: 32px;
  border-radius: 12px;
  border: 1px solid var(--ring);
  background: var(--panel);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
}

.applications-matrix-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.applications-matrix-table thead {
  background: linear-gradient(135deg, rgba(91, 157, 255, 0.1), rgba(50, 230, 133, 0.05));
  border-bottom: 2px solid var(--ring);
  position: sticky;
  top: 0;
  z-index: 10;
}

.applications-matrix-table th {
  padding: 14px 12px;
  text-align: left;
  font-weight: 700;
  color: var(--primary);
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-size: 10px;
}

.applications-matrix-table tbody tr {
  border-bottom: 1px solid var(--ring);
  transition: all 0.2s ease;
}

.applications-matrix-table tbody tr:hover {
  background: rgba(91, 157, 255, 0.08);
}

.applications-matrix-table td {
  padding: 12px;
  color: var(--text);
  vertical-align: middle;
}

.th-order,
.th-weight {
  text-align: center;
  min-width: 80px;
}

.th-app {
  min-width: 200px;
}

.th-bu {
  min-width: 120px;
}

.th-wave {
  min-width: 100px;
}

.th-factors {
  min-width: 150px;
}

.th-progress {
  min-width: 120px;
}

.th-status {
  text-align: center;
  min-width: 80px;
}

/* Cell Styles */
.matrix-order {
  font-weight: 700;
  font-size: 14px;
  background: linear-gradient(135deg, rgba(91, 157, 255, 0.15), transparent);
  padding: 6px 10px;
  border-radius: 6px;
  text-align: center;
  min-width: 50px;
  display: inline-block;
}

.matrix-app-name {
  font-weight: 600;
  color: var(--text);
}

.matrix-bu-name {
  background: rgba(91, 157, 255, 0.1);
  padding: 4px 8px;
  border-radius: 4px;
  display: inline-block;
  font-size: 11px;
}

.matrix-wave {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: linear-gradient(135deg, rgba(50, 230, 133, 0.2), rgba(91, 157, 255, 0.1));
  border-radius: 6px;
  font-weight: 600;
  color: var(--ok);
}

.matrix-weight {
  font-weight: 700;
  font-size: 13px;
  background: linear-gradient(135deg, var(--primary), #4d86ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
}

.matrix-factors {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.factor-badge {
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: 600;
  display: inline-block;
}

.factor-badge.criticality {
  background: rgba(255, 95, 122, 0.15);
  color: var(--danger);
}

.factor-badge.impact {
  background: rgba(91, 157, 255, 0.15);
  color: var(--primary);
}

.factor-badge.priority {
  background: rgba(255, 209, 102, 0.15);
  color: var(--warn);
}

.matrix-progress-bar {
  display: flex;
  align-items: center;
  gap: 8px;
}

.matrix-progress-container {
  flex: 1;
  height: 6px;
  background: var(--ring);
  border-radius: 3px;
  overflow: hidden;
}

.matrix-progress-value {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), #4d86ff);
  border-radius: 3px;
  transition: width 0.3s ease;
}

.matrix-progress-label {
  min-width: 35px;
  text-align: right;
  font-weight: 600;
}

.matrix-status {
  text-align: center;
}

/* Wave Summary Section */
.wave-summary-section {
  margin-top: 32px;
}

.wave-summary-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.wave-cards-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.wave-card {
  padding: 16px;
  background: linear-gradient(135deg, var(--panel), rgba(91, 157, 255, 0.05));
  border: 1px solid var(--ring);
  border-radius: 12px;
  transition: all 0.3s ease;
}

.wave-card:hover {
  border-color: var(--primary);
  box-shadow: 0 4px 16px rgba(91, 157, 255, 0.2);
  transform: translateY(-2px);
}

.wave-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--ring);
}

.wave-card-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--primary);
  margin: 0;
}

.wave-badge {
  background: linear-gradient(135deg, rgba(91, 157, 255, 0.2), rgba(50, 230, 133, 0.1));
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
}

.wave-card-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.wave-stat {
  text-align: center;
}

.wave-stat-value {
  font-size: 18px;
  font-weight: 700;
  background: linear-gradient(135deg, var(--primary), var(--ok));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.wave-stat-label {
  font-size: 11px;
  color: var(--muted);
  margin-top: 2px;
  font-weight: 600;
}

/* Responsive Design */
@media (max-width: 1024px) {
  .filters-bar-premium {
    flex-direction: column;
  }

  .search-box-wrapper {
    min-width: 100%;
  }

  .filter-select-premium {
    min-width: 100%;
  }

  .app-table-premium th,
  .app-table-premium td {
    padding: 10px 8px;
    font-size: 12px;
  }

  .col-icon {
    display: none;
  }
}

@media (max-width: 768px) {
  .apps-overview-stats {
    grid-template-columns: 1fr;
  }

  .apps-table-container-premium {
    border-radius: 8px;
    max-height: 400px;
  }

  .app-table-premium {
    font-size: 12px;
  }

  .app-table-premium th,
  .app-table-premium td {
    padding: 8px 6px;
  }
}

.form-group{margin-bottom:20px}
.form-group label{display:block;margin-bottom:8px;font-size:13px;color:var(--text);font-weight:600;letter-spacing:0.3px}
.form-group input,.form-group select,.form-group textarea{appearance:none;background:var(--bg-2);border:1px solid var(--ring);color:var(--text);padding:12px;border-radius:8px;font-size:14px;width:100%;font-family:inherit;transition:all 0.2s ease}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 12px rgba(91,157,255,.25);background:var(--bg)}
.form-group input:hover,.form-group select:hover,.form-group textarea:hover{border-color:var(--primary);background:var(--bg)}
.form-hint{display:block;font-size:12px;color:var(--muted);margin-top:6px;font-style:italic}
.form-actions{display:flex;gap:12px;margin-top:30px;justify-content:flex-end}
.form-error{color:var(--danger);font-size:12px;margin-top:6px;display:flex;align-items:center;gap:4px}
.form-error:before{content:"⚠️";font-size:12px}
.form-success{color:var(--ok);font-size:12px;margin-top:6px;display:flex;align-items:center;gap:4px}
.form-success:before{content:"✅";font-size:12px}
.form-stats{background:var(--glass);border:1px solid var(--ring);border-radius:10px;padding:16px;margin-top:16px}
.form-stats-title{font-weight:600;font-size:15px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.form-stats-title:before{content:"📊";font-size:15px}
.form-stats-item{display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px;padding:4px 0;border-bottom:1px dashed var(--ring)}
.form-stats-item:last-child{border-bottom:none}
.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}

/* New Form Elements */
.input-with-icon{position:relative;display:flex;align-items:center}
.input-with-icon .input-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none;opacity:0.7}
.input-with-icon input{padding-left:36px}

.color-picker{display:flex;align-items:center;gap:10px;background:var(--bg-2);border:1px solid var(--ring);border-radius:8px;padding:6px 12px;transition:all 0.2s ease}
.color-picker:hover{border-color:var(--primary);background:var(--bg)}
.color-picker input[type="color"]{-webkit-appearance:none;appearance:none;border:none;background:none;width:30px;height:30px;padding:0;cursor:pointer}
.color-picker input[type="color"]::-webkit-color-swatch-wrapper{padding:0}
.color-picker input[type="color"]::-webkit-color-swatch{border:none;border-radius:50%}
.color-preview{display:inline-block;width:24px;height:24px;border-radius:50%;background:var(--primary)}

.btn-icon{margin-right:6px;font-size:14px}
.status-badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase}
.status-tbs{background:rgba(255,95,122,.2);color:var(--danger)}
.status-wip{background:rgba(255,209,102,.2);color:var(--warn)}
.status-clo{background:rgba(50,230,133,.2);color:var(--ok)}
.btn-group{display:flex;gap:8px;margin-top:16px}
.btn-primary{
  appearance:none;
  background:linear-gradient(135deg,var(--primary),#4d86ff);
  border:none;
  color:white;
  padding:12px 24px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:all .3s cubic-bezier(.25,.8,.25,1);
  box-shadow:0 4px 15px rgba(91,157,255,0.3);
  display:inline-flex;
  align-items:center;
  gap:8px;
  position:relative;
  overflow:hidden;
}
.btn-primary:hover{
  filter:brightness(1.15);
  box-shadow:0 6px 20px rgba(91,157,255,0.4);
  transform:translateY(-2px);
}
.btn-primary:hover::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: rgba(255,255,255,0.1);
  transform: rotate(30deg);
  animation: btn-shine 1.5s ease-in-out;
}
.btn-primary:active{
  transform:translateY(0);
  filter:brightness(0.95);
}
@keyframes btn-shine {
  0% {
    transform: translateX(-100%) rotate(30deg);
  }
  100% {
    transform: translateX(100%) rotate(30deg);
  }
}
.btn-secondary{
  appearance:none;
  background:rgba(255,255,255,0.03);
  border:1px solid var(--ring);
  color:var(--text);
  padding:12px 24px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:all .3s cubic-bezier(.25,.8,.25,1);
  display:inline-flex;
  align-items:center;
  gap:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.btn-secondary:hover{
  background:rgba(91,157,255,0.08);
  border-color:var(--primary);
  color:var(--primary);
  box-shadow:0 4px 15px rgba(0,0,0,0.15);
}
.btn-danger{appearance:none;background:linear-gradient(135deg,var(--danger),#ff4757);border:none;color:white;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all .2s ease;box-shadow:0 4px 12px rgba(255,95,122,0.3);display:inline-flex;align-items:center;gap:6px}
.btn-danger:hover{filter:brightness(1.15);box-shadow:0 6px 16px rgba(255,95,122,0.4);transform:translateY(-1px)}
.btn-info{appearance:none;background:linear-gradient(135deg,var(--primary),#4a90e2);border:none;color:white;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all .2s ease;box-shadow:0 4px 12px rgba(91,157,255,0.3);display:inline-flex;align-items:center;gap:6px}
.btn-info:hover{filter:brightness(1.15);box-shadow:0 6px 16px rgba(91,157,255,0.4);transform:translateY(-1px)}
.btn-sm{padding:8px 12px;font-size:12px}

/* Dashboard Specific Styles */
/* --- HERO GAUGE --- */
.hero{grid-column:span 5;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.hero .inner{width:100%;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;position:relative}
.hero h2{position:absolute;top:16px;left:16px;margin:0;font-size:16px;color:var(--muted)}
.hero .val{position:absolute;text-align:center;inset:auto;top:50%;transform:translateY(-50%)}
.hero .val .big{font-size:48px;font-weight:900;letter-spacing:.5px}
.hero .val .sub{color:var(--muted)}
.spark{position:absolute;inset:auto 10% 6% auto;background:radial-gradient(circle at 30% 30%, #fff, #fff0 60%);filter:blur(12px);width:120px;height:120px;opacity:.2}

/* --- CONSTELLATION GRID --- */
.constel{grid-column:span 7;padding:16px}
.constel h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
.tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.tile{position:relative;padding:10px 12px 12px 12px;border-radius:14px;background:linear-gradient(160deg, var(--glass), transparent);border:1px solid var(--ring);display:flex;align-items:center;gap:12px;overflow:hidden;transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);cursor:pointer}
.tile:hover{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), linear-gradient(135deg, rgba(91,157,255,0.15), transparent);box-shadow:0 0 20px rgba(91,157,255,0.3), 0 8px 24px rgba(0,0,0,0.4)}
.tile.pinned{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), linear-gradient(135deg, rgba(91,157,255,0.2), transparent);box-shadow:0 0 24px rgba(91,157,255,0.4), 0 12px 32px rgba(0,0,0,0.5)}
.tile .name{font-weight:700}
.tile .meta{font-size:12px;color:var(--muted)}
.tile .orb{width:80px;height:80px;flex:0 0 auto}
.tile .spot{position:absolute;inset:-20% -10% auto auto;width:120px;height:120px;background:radial-gradient(closest-side, rgba(91,157,255,.25), transparent);filter:blur(12px);opacity:0;transition:opacity 0.3s ease;pointer-events:none}
.tile:hover .spot{opacity:1;animation:spotlightPulse 2s ease-in-out infinite}
.tile.pinned .spot{opacity:1;animation:spotlightGlow 0.6s ease-out}
@keyframes spotlightPulse{0%{opacity:0.6}50%{opacity:1}100%{opacity:0.6}}
@keyframes spotlightGlow{0%{transform:scale(0.8);opacity:0}50%{opacity:1}100%{transform:scale(1);opacity:0.8}}

/* --- RANKED BARS --- */
.bars{grid-column:span 12;padding:16px}
.bars h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
.tip{color:var(--muted);font-size:12px}

/* --- KPIs STRIP --- */
.kpis{grid-column:span 12;display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
.kpi{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(180deg, var(--glass), transparent), var(--panel);border:1px solid var(--ring);border-radius:14px}
.kpi .dot{width:12px;height:12px;border-radius:50%}
.kpi h4{margin:0;font-size:12px;color:var(--muted)}
.kpi .num{font-size:24px;font-weight:900}

/* Main CSS styles */
:root{
  --bg:#080b13;
  --bg-2:#0d1320;
  --panel:#0e1627;
  --glass:rgba(255,255,255,.06);

  --text:#e9eef7;
  --muted:#9fb0c7;

  --grid:#22133d;
  --ring:#1a2a48;

  --ok:#32e685;
  --warn:#ffd166;
  --low:#693bff;
  --danger:#ff5f7a;

  --accent:#78bfae;
  --primary:#5b9dff;

  --white:#fff;
  --black:#000;

  --shadow:0 10px 40px rgba(0,0,0,.35);
  --radius:16px;
  --gap:16px;
}

[data-theme="light"]{
  --bg:#f6f8fc;
  --bg-2:#eef2f9;
  --panel:#ffffff;
  --glass:rgba(20,30,60,.08);

  --text:#0e1726;
  --muted:#4b5b78;

  --grid:#d6deea;
  --ring:#c8d4e8;

  --shadow:0 10px 28px rgba(15,45,90,.12);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1400px 700px at 10% -10%, #20355f00, #0b1220), var(--bg);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
}

.wrapper{max-width:1280px;margin:0 auto;padding:20px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
.h-title h1{margin:0;font-size:22px;letter-spacing:.3px}
.h-title small{color:var(--muted)}

.controls{display:flex;gap:8px;flex-wrap:wrap}
.controls>*{
  background:var(--panel);
  border:1px solid var(--ring);
  color:var(--text);
  border-radius:10px;
  padding:10px 12px;
  box-shadow:var(--shadow)
}
.controls input[type=search]{
  min-width:240px;background:transparent;outline:none;border:none
}

.btn{cursor:pointer;user-select:none}
.btn:hover{filter:brightness(1.08)}

.pill{border-radius:9999px;border:1px solid var(--ring);background:var(--panel);padding:6px 10px;color:var(--muted);font-size:12px}

.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
.card{
  background:linear-gradient(180deg, var(--glass), transparent), var(--panel);
  border:1px solid var(--ring);
  border-radius:var(--radius);
  box-shadow:var(--shadow)
}
.card.pad{padding:16px}

/* --- HERO GAUGE (Backup Block) --- */
.hero{grid-column:span 5;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.hero .inner{width:100%;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;position:relative}
.hero h2{position:absolute;top:16px;left:16px;margin:0;font-size:16px;color:var(--muted)}
.hero .val{position:absolute;text-align:center;inset:auto;top:50%;transform:translateY(-50%)}
.hero .val .big{font-size:48px;font-weight:900;letter-spacing:.5px}
.hero .val .sub{color:var(--muted)}
.spark{position:absolute;inset:auto 10% 6% auto;background:radial-gradient(circle at 30% 30%, #fff, #fff0 60%);filter:blur(12px);width:120px;height:120px;opacity:.2}

/* --- CONSTELLATION GRID (Backup Block) --- */
.constel{grid-column:span 7;padding:16px}
.constel h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
.tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.tile{position:relative;padding:10px 12px 12px 12px;border-radius:14px;background:linear-gradient(160deg, var(--glass), transparent);border:1px solid var(--ring);display:flex;align-items:center;gap:12px;overflow:hidden;transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);cursor:pointer}
.tile:hover{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), linear-gradient(135deg, rgba(91,157,255,0.15), transparent);box-shadow:0 0 20px rgba(91,157,255,0.3), 0 8px 24px rgba(0,0,0,0.4)}
.tile.pinned{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), linear-gradient(135deg, rgba(91,157,255,0.2), transparent);box-shadow:0 0 24px rgba(91,157,255,0.4), 0 12px 32px rgba(0,0,0,0.5)}
.tile .name{font-weight:700}
.tile .meta{font-size:12px;color:var(--muted)}
.tile .orb{width:80px;height:80px;flex:0 0 auto}
.tile .spot{position:absolute;inset:-20% -10% auto auto;width:120px;height:120px;background:radial-gradient(closest-side, rgba(91,157,255,.25), transparent);filter:blur(12px);opacity:0;transition:opacity 0.3s ease;pointer-events:none}
.tile:hover .spot{opacity:1;animation:spotlightPulse 2s ease-in-out infinite}
.tile.pinned .spot{opacity:1;animation:spotlightGlow 0.6s ease-out}

/* --- RANKED BARS --- */
.bars{grid-column:span 12;padding:16px}
.bars h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
.tip{color:var(--muted);font-size:12px}

/* --- KPIs STRIP --- */
.kpis{grid-column:span 12;display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
.kpi{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(180deg, var(--glass), transparent), var(--panel);border:1px solid var(--ring);border-radius:14px}
.kpi .dot{width:12px;height:12px;border-radius:50%}
.kpi h4{margin:0;font-size:12px;color:var(--muted)}
.kpi .num{font-size:24px;font-weight:900}

/* --- Cinematic mode --- */
body.cinematic .wrapper{max-width:none}
body.cinematic .controls{display:none}
body.cinematic header{margin-bottom:0}
body.cinematic .grid{gap:12px}
body.cinematic .hero{grid-column:span 7}
body.cinematic .constel{grid-column:span 5}
/* FIX (cinema): reduce indicador principal para evitar scroll */
body.cinematic .hero .inner{max-width:420px}
body.cinematic .hero .val .big{font-size:36px}
body.cinematic .hero .val .sub{font-size:12px}

/* --- Exit Cinematic floating button --- */
.exit-cinema{position:fixed;top:16px;right:16px;z-index:10000;display:none}
body.cinematic .exit-cinema{display:inline-flex}

/* --- Theme toggle --- */
.switch{display:inline-flex;gap:8px;align-items:center}
.toggle{appearance:none;width:44px;height:24px;border:1px solid var(--ring);border-radius:20px;background:var(--bg-2);position:relative;outline:none;cursor:pointer}
.toggle::after{content:"";position:absolute;inset:3px auto auto 3px;width:18px;height:18px;border-radius:50%;background:linear-gradient(180deg,#2bc3ff,#4d86ff);box-shadow:0 2px 8px rgba(0,0,0,.4);transition:transform .2s ease}
.toggle:checked::after{transform:translateX(20px)}

/* --- Accessibility helpers --- */
.sr{position:absolute;left:-9999px}

@media (max-width:1080px){
  .hero{grid-column:span 12}
  .constel{grid-column:span 12}
}
@media (max-width:720px){
  .tiles{grid-template-columns:repeat(2,1fr)}
  .kpis{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:520px){
  .tiles{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr}
}

/* World-Class Settings Tab Styles */

/* Master Grid Container */
.settings-master-grid {
  display: flex;
  flex-direction: column;
  gap: 32px;
  padding: 24px 0;
  max-height: calc(80vh - 200px);
  overflow-y: auto;
  scroll-behavior: smooth;
}

.settings-master-grid::-webkit-scrollbar {
  width: 6px;
}

.settings-master-grid::-webkit-scrollbar-track {
  background: var(--bg);
  border-radius: 3px;
}

.settings-master-grid::-webkit-scrollbar-thumb {
  background: var(--ring);
  border-radius: 3px;
  transition: background 0.2s ease;
}

.settings-master-grid::-webkit-scrollbar-thumb:hover {
  background: var(--primary);
}

/* Category Sections */
.settings-category {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.settings-category.danger-zone {
  border-top: 2px solid var(--danger);
  padding-top: 24px;
  margin-top: 16px;
}

.category-header {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 0 4px;
}

.category-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.02em;
}

.category-icon {
  font-size: 24px;
  opacity: 0.9;
}

.category-description {
  margin: 0;
  font-size: 14px;
  color: rgba(233, 238, 247, 0.7);
  line-height: 1.5;
}

/* Settings Cards Grid */
.settings-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
  gap: 20px;
  width: 100%;
}

@media (max-width: 1200px) {
  .settings-cards-grid {
    grid-template-columns: 1fr;
  }
}

/* Individual Settings Cards */
.settings-card {
  background: linear-gradient(135deg, rgba(91,157,255,0.03), rgba(91,157,255,0.01));
  border: 1px solid var(--ring);
  border-radius: 16px;
  padding: 0;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.settings-card:hover {
  border-color: var(--primary);
  box-shadow: 0 8px 32px rgba(91,157,255,0.15);
  transform: translateY(-2px);
}

.settings-card.premium {
  background: linear-gradient(135deg, rgba(91,157,255,0.08), rgba(91,157,255,0.02));
  border: 1px solid rgba(91,157,255,0.3);
  position: relative;
}

.settings-card.premium::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), #7c3aed, #ec4899);
  opacity: 0.8;
}

.settings-card.security {
  border-color: rgba(50, 230, 133, 0.3);
  background: linear-gradient(135deg, rgba(50,230,133,0.05), rgba(50,230,133,0.01));
}

.settings-card.danger {
  border-color: var(--danger);
  background: linear-gradient(135deg, rgba(255,95,122,0.08), rgba(255,95,122,0.02));
}

/* Card Header */
.settings-card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 24px 24px 16px 24px;
  border-bottom: 1px solid var(--ring);
  background: rgba(255,255,255,0.01);
}

.settings-card-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  background: var(--bg);
  border: 1px solid var(--ring);
  position: relative;
  overflow: hidden;
}

.settings-card-icon::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(45deg, transparent, rgba(91,157,255,0.1), transparent);
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.settings-card:hover .settings-card-icon::before {
  transform: translateX(100%);
}

.settings-card-icon.export {
  background: linear-gradient(135deg, rgba(91,157,255,0.1), rgba(91,157,255,0.05));
  border-color: rgba(91,157,255,0.3);
}

.settings-card-icon.import {
  background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(255,209,102,0.05));
  border-color: rgba(255,209,102,0.3);
}

.settings-card-icon.backup {
  background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(124,58,237,0.05));
  border-color: rgba(124,58,237,0.3);
}

.settings-card-icon.performance {
  background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(34,197,94,0.05));
  border-color: rgba(34,197,94,0.3);
}

.settings-card-icon.display {
  background: linear-gradient(135deg, rgba(236,72,153,0.1), rgba(236,72,153,0.05));
  border-color: rgba(236,72,153,0.3);
}

.settings-card-icon.notifications {
  background: linear-gradient(135deg, rgba(249,115,22,0.1), rgba(249,115,22,0.05));
  border-color: rgba(249,115,22,0.3);
}

.settings-card-icon.security {
  background: linear-gradient(135deg, rgba(50,230,133,0.1), rgba(50,230,133,0.05));
  border-color: rgba(50,230,133,0.3);
}

.settings-card-icon.privacy {
  background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(168,85,247,0.05));
  border-color: rgba(168,85,247,0.3);
}

.settings-card-icon.audit {
  background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05));
  border-color: rgba(59,130,246,0.3);
}

.settings-card-icon.reset {
  background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(255,209,102,0.05));
  border-color: rgba(255,209,102,0.3);
}

.settings-card-icon.delete {
  background: linear-gradient(135deg, rgba(255,95,122,0.1), rgba(255,95,122,0.05));
  border-color: rgba(255,95,122,0.3);
}

.settings-card-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
  letter-spacing: -0.01em;
}

/* Card Content */
.settings-card-content {
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.settings-card-description {
  margin: 0;
  font-size: 14px;
  color: rgba(233, 238, 247, 0.7);
  line-height: 1.6;
}

/* Settings Rows */
.settings-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.settings-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  margin: 0;
}

/* Modern Form Controls */
.modern-checkbox {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
  font-size: 14px;
  color: var(--text);
  transition: color 0.2s ease;
}

.modern-checkbox:hover {
  color: var(--primary);
}

.modern-checkbox input[type="checkbox"] {
  display: none;
}

.modern-checkbox .checkmark {
  width: 20px;
  height: 20px;
  border: 2px solid var(--ring);
  border-radius: 6px;
  background: var(--bg);
  position: relative;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.modern-checkbox:hover .checkmark {
  border-color: var(--primary);
}

.modern-checkbox input[type="checkbox"]:checked + .checkmark {
  background: var(--primary);
  border-color: var(--primary);
}

.modern-checkbox input[type="checkbox"]:checked + .checkmark::after {
  content: '✓';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.modern-checkbox.danger input[type="checkbox"]:checked + .checkmark {
  background: var(--danger);
  border-color: var(--danger);
}

/* Modern Select */
.modern-select {
  appearance: none;
  background: var(--bg);
  border: 1px solid var(--ring);
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 14px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s ease;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 12px center;
  background-repeat: no-repeat;
  background-size: 16px;
  padding-right: 40px;
}

.modern-select:hover {
  border-color: var(--primary);
}

.modern-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(91,157,255,0.1);
}

/* Modern Range Input */
.range-input-container {
  display: flex;
  align-items: center;
  gap: 12px;
}

.modern-range {
  flex: 1;
  height: 6px;
  border-radius: 3px;
  background: var(--ring);
  outline: none;
  appearance: none;
  cursor: pointer;
}

.modern-range::-webkit-slider-thumb {
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transition: all 0.2s ease;
}

.modern-range::-webkit-slider-thumb:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(91,157,255,0.3);
}

.range-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--primary);
  min-width: 40px;
  text-align: right;
}

/* Theme Selector */
.theme-selector {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.theme-option {
  flex: 1;
  cursor: pointer;
}

.theme-option input[type="radio"] {
  display: none;
}

.theme-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 16px 12px;
  border: 2px solid var(--ring);
  border-radius: 12px;
  background: var(--bg);
  transition: all 0.2s ease;
  text-align: center;
}

.theme-option:hover .theme-preview {
  border-color: var(--primary);
  background: rgba(91,157,255,0.05);
}

.theme-option input[type="radio"]:checked + .theme-preview {
  border-color: var(--primary);
  background: rgba(91,157,255,0.1);
}

.theme-name {
  font-size: 12px;
  font-weight: 500;
  color: var(--text);
}

.theme-icon {
  font-size: 20px;
}

/* Export Options */
.export-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}

.export-option {
  padding: 12px;
  background: rgba(91,157,255,0.02);
  border: 1px solid rgba(91,157,255,0.1);
  border-radius: 8px;
  transition: all 0.2s ease;
}

.export-option:hover {
  background: rgba(91,157,255,0.05);
}

/* Import Zone */
.import-zone {
  position: relative;
  border: 2px dashed var(--ring);
  border-radius: 12px;
  padding: 32px 24px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  background: rgba(91,157,255,0.01);
}

.import-zone:hover {
  border-color: var(--primary);
  background: rgba(91,157,255,0.05);
}

.import-zone.dragover {
  border-color: var(--primary);
  background: rgba(91,157,255,0.1);
  transform: scale(1.02);
}

.import-zone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.import-icon {
  font-size: 32px;
  opacity: 0.6;
}

.import-text {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.import-text strong {
  font-size: 16px;
  color: var(--text);
}

.import-text span {
  font-size: 14px;
  color: rgba(233, 238, 247, 0.7);
}

.import-file-input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

/* Security Status */
.security-status {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.security-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.security-indicator.active .indicator-dot {
  background: var(--ok);
}

.indicator-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--ring);
  transition: background 0.2s ease;
}

.indicator-text {
  color: var(--text);
}

/* Backup Status */
.backup-status {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 16px;
  background: rgba(124,58,237,0.05);
  border: 1px solid rgba(124,58,237,0.2);
  border-radius: 8px;
}

.backup-info, .backup-size {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.backup-label {
  font-size: 14px;
  color: rgba(233, 238, 247, 0.7);
}

.backup-time, .backup-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

/* Audit Summary */
.audit-summary {
  display: flex;
  gap: 24px;
  margin-top: 16px;
}

.audit-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.audit-number {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
}

.audit-label {
  font-size: 12px;
  color: rgba(233, 238, 247, 0.7);
  text-align: center;
}

/* Warning and Danger Boxes */
.warning-box {
  display: flex;
  gap: 12px;
  padding: 16px;
  background: rgba(255,209,102,0.1);
  border: 1px solid rgba(255,209,102,0.3);
  border-radius: 8px;
  margin-top: 16px;
}

.warning-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.warning-text {
  font-size: 14px;
  color: var(--text);
  line-height: 1.5;
}

.danger-box {
  display: flex;
  gap: 12px;
  padding: 16px;
  background: rgba(255,95,122,0.1);
  border: 1px solid rgba(255,95,122,0.3);
  border-radius: 8px;
  margin-top: 16px;
}

.danger-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.danger-text {
  font-size: 14px;
  color: var(--text);
  line-height: 1.5;
}

/* Deletion Checklist */
.deletion-checklist {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}

/* Card Actions */
.settings-card-actions {
  padding: 20px 24px;
  border-top: 1px solid var(--ring);
  background: rgba(255,255,255,0.01);
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* Premium Buttons */
.btn-premium {
  background: linear-gradient(135deg, var(--primary), #7c3aed);
  border: none;
  color: white;
  font-weight: 600;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(91,157,255,0.3);
}

.btn-premium:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 24px rgba(91,157,255,0.4);
}

.btn-premium .btn-glow {
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s ease;
}

.btn-premium:hover .btn-glow {
  left: 100%;
}

.btn-warning {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  border: none;
  color: white;
  font-weight: 600;
}

.btn-warning:hover {
  background: linear-gradient(135deg, #d97706, #b45309);
  transform: translateY(-1px);
}

/* Settings Footer */
.settings-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px 0;
  border-top: 1px solid var(--ring);
  margin-top: 32px;
  gap: 24px;
  flex-wrap: wrap;
}

.settings-info {
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-label {
  font-size: 12px;
  color: rgba(233, 238, 247, 0.7);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.info-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

.settings-actions {
  display: flex;
  gap: 12px;
}

/* Button Loading State */
.btn-loading {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .settings-master-grid {
    padding: 16px 0;
    gap: 24px;
  }
  
  .settings-cards-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .settings-card-header {
    padding: 20px 20px 12px 20px;
  }
  
  .settings-card-content {
    padding: 20px;
  }
  
  .settings-card-actions {
    padding: 16px 20px;
    flex-direction: column;
  }
  
  .settings-footer {
    flex-direction: column;
    align-items: stretch;
    gap: 16px;
  }
  
  .settings-info {
    justify-content: space-between;
  }
  
  .settings-actions {
    justify-content: stretch;
  }
  
  .settings-actions .btn {
    flex: 1;
  }
}

/* Formula Actions Button */
.formula-actions{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  padding:24px 32px;
  margin-top:24px;
  border-top:1px solid rgba(91,157,255,0.15);
}

.btn-save-formulas{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:14px 32px;
  background:linear-gradient(135deg,#5b9dff,#4a8fd7);
  color:#ffffff;
  border:none;
  border-radius:12px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 4px 16px rgba(91,157,255,0.3);
}

.btn-save-formulas:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(91,157,255,0.4);
  background:linear-gradient(135deg,#6ba3ff,#5599e7);
}

.btn-save-formulas:active{
  transform:translateY(0);
  box-shadow:0 2px 8px rgba(91,157,255,0.3);
}

.btn-save-formulas .btn-icon{
  font-size:16px;
}

.formula-save-hint{
  font-size:12px;
  color:rgba(233,238,247,0.6);
  margin:0;
  text-align:center;
}

/* Weight Factor Tooltip Styles */
.factor-info-trigger{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:20px;
  height:20px;
  margin-left:8px;
  border-radius:50%;
  background:rgba(91,157,255,0.15);
  color:var(--primary);
  font-size:12px;
  cursor:help;
  transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  border:1px solid rgba(91,157,255,0.3);
  user-select:none;
}

.factor-info-trigger:hover{
  background:rgba(91,157,255,0.35);
  border-color:rgba(91,157,255,0.6);
  transform:scale(1.15) rotate(180deg);
  box-shadow:0 0 12px rgba(91,157,255,0.4);
}

.factor-info-trigger:active{
  transform:scale(0.95) rotate(180deg);
}

.tooltip-portal{
  display:none;
  position:fixed;
  inset:0;
  z-index:9999;
  pointer-events:none;
}

.tooltip-portal[aria-hidden="false"]{
  display:flex;
  pointer-events:auto;
}

.tooltip-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.6);
  backdrop-filter:blur(8px);
  animation:backdropFadeIn 0.3s ease;
  z-index:1;
}

.tooltip-content{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:90%;
  max-width:900px;
  max-height:90vh;
  background:linear-gradient(135deg,var(--panel),rgba(91,157,255,0.05));
  border:1px solid rgba(91,157,255,0.3);
  border-radius:20px;
  box-shadow:0 25px 60px rgba(0,0,0,0.4),0 0 60px rgba(91,157,255,0.15),inset 0 1px 0 rgba(255,255,255,0.1);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  animation:tooltipSlideIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
  z-index:2;
}

.tooltip-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:28px 32px;
  background:linear-gradient(135deg,rgba(91,157,255,0.15),rgba(91,157,255,0.05));
  border-bottom:1px solid rgba(91,157,255,0.2);
}

.tooltip-header h3{
  margin:0;
  font-size:24px;
  font-weight:700;
  color:var(--text);
  letter-spacing:0.5px;
}

.tooltip-close{
  width:36px;
  height:36px;
  border:none;
  background:rgba(91,157,255,0.1);
  color:var(--primary);
  font-size:20px;
  border-radius:12px;
  cursor:pointer;
  transition:all 0.3s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
}

.tooltip-close:hover{
  background:rgba(91,157,255,0.25);
  transform:rotate(90deg) scale(1.1);
  box-shadow:0 0 12px rgba(91,157,255,0.3);
}

.tooltip-body{
  padding:32px;
  overflow-y:auto;
  flex:1;
}

.tooltip-body::-webkit-scrollbar{
  width:8px;
}

.tooltip-body::-webkit-scrollbar-track{
  background:rgba(91,157,255,0.05);
  border-radius:4px;
}

.tooltip-body::-webkit-scrollbar-thumb{
  background:rgba(91,157,255,0.3);
  border-radius:4px;
  transition:all 0.3s ease;
}

.tooltip-body::-webkit-scrollbar-thumb:hover{
  background:rgba(91,157,255,0.5);
}

.tooltip-section{
  margin-bottom:32px;
}

.tooltip-section:last-child{
  margin-bottom:0;
}

.tooltip-section h4{
  margin:0 0 16px 0;
  font-size:16px;
  font-weight:700;
  color:var(--text);
  display:flex;
  align-items:center;
  gap:8px;
}

.tooltip-section p{
  margin:0 0 12px 0;
  font-size:14px;
  line-height:1.6;
  color:rgba(233,238,247,0.8);
}

.formula-breakdown{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin:20px 0;
}

.factor-item{
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:16px;
  background:rgba(91,157,255,0.08);
  border:1px solid rgba(91,157,255,0.2);
  border-radius:12px;
  text-align:center;
  transition:all 0.3s ease;
}

.factor-item:hover{
  background:rgba(91,157,255,0.15);
  border-color:rgba(91,157,255,0.4);
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(91,157,255,0.2);
}

.factor-name{
  font-size:13px;
  font-weight:600;
  color:var(--text);
}

.factor-range{
  font-size:12px;
  color:var(--primary);
  font-weight:700;
  font-family:'Monaco','Courier New',monospace;
}

.math-proof{
  display:flex;
  align-items:center;
  gap:16px;
  padding:16px 20px;
  background:linear-gradient(135deg,rgba(50,230,133,0.1),rgba(91,157,255,0.08));
  border-left:4px solid var(--ok);
  border-radius:8px;
  margin-top:16px;
}

.math-label{
  font-size:13px;
  font-weight:600;
  color:rgba(233,238,247,0.7);
}

.math-equation{
  font-size:16px;
  font-weight:700;
  color:var(--ok);
  font-family:'Monaco','Courier New',monospace;
  letter-spacing:1px;
}

.fixed-reasons{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
  margin-top:16px;
}

.reason-card{
  display:flex;
  gap:16px;
  padding:16px;
  background:rgba(91,157,255,0.08);
  border:1px solid rgba(91,157,255,0.15);
  border-radius:12px;
  transition:all 0.3s ease;
}

.reason-card:hover{
  background:rgba(91,157,255,0.12);
  border-color:rgba(91,157,255,0.3);
  transform:translateX(4px);
  box-shadow:0 4px 12px rgba(91,157,255,0.15);
}

.reason-icon{
  font-size:24px;
  flex-shrink:0;
}

.reason-text{
  flex:1;
}

.reason-text strong{
  display:block;
  font-size:13px;
  font-weight:700;
  color:var(--text);
  margin-bottom:4px;
}

.reason-text p{
  margin:0;
  font-size:13px;
  line-height:1.5;
  color:rgba(233,238,247,0.75);
}

.examples-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-top:16px;
}

.example-item{
  padding:16px;
  background:linear-gradient(135deg,rgba(91,157,255,0.1),rgba(91,157,255,0.05));
  border:1px solid rgba(91,157,255,0.2);
  border-radius:12px;
  text-align:center;
  transition:all 0.3s ease;
}

.example-item:hover{
  background:linear-gradient(135deg,rgba(91,157,255,0.15),rgba(91,157,255,0.08));
  border-color:rgba(91,157,255,0.4);
  transform:translateY(-4px);
  box-shadow:0 8px 24px rgba(91,157,255,0.2);
}

.example-title{
  font-size:13px;
  font-weight:700;
  color:var(--text);
  margin-bottom:8px;
}

.example-formula{
  font-size:12px;
  color:var(--primary);
  font-family:'Monaco','Courier New',monospace;
  margin-bottom:8px;
  padding:8px;
  background:rgba(91,157,255,0.08);
  border-radius:6px;
}

.example-result{
  font-size:16px;
  font-weight:700;
  color:var(--primary);
}

.tooltip-footer{
  padding:20px 32px;
  background:rgba(91,157,255,0.08);
  border-top:1px solid rgba(91,157,255,0.15);
  margin-top:20px;
}

.tooltip-footer p{
  margin:0;
  font-size:13px;
  line-height:1.6;
  color:rgba(233,238,247,0.85);
}

@keyframes backdropFadeIn{
  from{opacity:0;backdrop-filter:blur(0px)}
  to{opacity:1;backdrop-filter:blur(8px)}
}

@keyframes tooltipSlideIn{
  from{opacity:0;transform:translate(-50%,-48%) scale(0.92)}
  to{opacity:1;transform:translate(-50%,-50%) scale(1)}
}

@media (max-width: 768px) {
  .tooltip-content{
    width:95%;
    max-height:95vh;
  }

  .tooltip-header{
    padding:20px 24px;
  }

  .tooltip-header h3{
    font-size:20px;
  }

  .tooltip-body{
    padding:24px;
  }

  .tooltip-section{
    margin-bottom:24px;
  }

  .formula-breakdown{
    grid-template-columns:1fr;
  }

  .examples-grid{
    grid-template-columns:1fr;
  }

  .math-proof{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }

  .reason-card{
    flex-direction:column;
    align-items:flex-start;
  }
}

/* ========== BU ANALYTICS EXPORT/IMPORT - PREMIUM STYLING ========== */

.bu-analytics-premium {
  background: linear-gradient(135deg, rgba(91,157,255,0.08) 0%, rgba(50,230,133,0.04) 100%);
  border: 1px solid rgba(91,157,255,0.2);
  position: relative;
  overflow: hidden;
}

.bu-analytics-premium::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, #5b9dff, transparent);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.analytics-badge {
  display: inline-block;
  background: linear-gradient(135deg, #5b9dff 0%, #32e685 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-left: auto;
}

.bu-analytics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-top: 20px;
}

@media (max-width: 768px) {
  .bu-analytics-grid {
    grid-template-columns: 1fr;
  }
}

.analytics-section {
  padding: 20px;
  background: rgba(14, 22, 39, 0.8);
  border: 1px solid rgba(91, 157, 255, 0.15);
  border-radius: 12px;
  transition: all 0.3s ease;
}

.analytics-section:hover {
  background: rgba(14, 22, 39, 1);
  border-color: rgba(91, 157, 255, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(91, 157, 255, 0.1);
}

.section-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
}

.section-icon {
  font-size: 24px;
}

.section-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
  margin: 0;
}

.bu-selector-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.selector-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.bu-analytics-select {
  padding: 12px 14px;
  background: rgba(8, 11, 19, 0.8);
  border: 1px solid rgba(91, 157, 255, 0.2);
  border-radius: 8px;
  color: var(--text);
  font-size: 14px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.bu-analytics-select:hover,
.bu-analytics-select:focus {
  border-color: rgba(91, 157, 255, 0.5);
  background: rgba(8, 11, 19, 1);
  box-shadow: 0 0 16px rgba(91, 157, 255, 0.2);
  outline: none;
}

.selector-hint {
  font-size: 12px;
  color: rgba(233, 238, 247, 0.6);
  margin-top: 4px;
}

.preview-box {
  background: rgba(50, 230, 133, 0.05);
  border: 1px solid rgba(50, 230, 133, 0.2);
  border-radius: 10px;
  padding: 16px;
  margin: 16px 0;
  animation: slideInDown 0.4s ease;
}

@keyframes slideInDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.preview-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-weight: 600;
  color: #32e685;
  font-size: 13px;
}

.preview-icon {
  font-size: 16px;
}

.preview-title {
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.preview-content {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

@media (max-width: 600px) {
  .preview-content {
    grid-template-columns: 1fr;
  }
}

.preview-stat {
  display: flex;
  justify-content: space-between;
  padding: 8px 12px;
  background: rgba(50, 230, 133, 0.1);
  border-radius: 6px;
  font-size: 12px;
}

.preview-label {
  color: rgba(233, 238, 247, 0.7);
  font-weight: 600;
}

.preview-value {
  color: #32e685;
  font-weight: 700;
}

.analytics-divider {
  grid-column: 2;
  width: 1px;
  background: linear-gradient(180deg, transparent, rgba(91,157,255,0.3), transparent);
  margin: 0 -12px;
}

@media (max-width: 768px) {
  .analytics-divider {
    grid-column: 1;
    width: auto;
    height: 1px;
    margin: 0 -20px;
    background: linear-gradient(90deg, transparent, rgba(91,157,255,0.3), transparent);
  }
}

.merge-strategy-container {
  margin-bottom: 16px;
}

.strategy-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: block;
  margin-bottom: 12px;
}

.strategy-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.strategy-option {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 14px;
  background: rgba(8, 11, 19, 0.8);
  border: 1px solid rgba(91, 157, 255, 0.15);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.strategy-option:hover {
  background: rgba(8, 11, 19, 1);
  border-color: rgba(91, 157, 255, 0.3);
}

.strategy-option input[type="radio"] {
  margin-top: 4px;
  cursor: pointer;
}

.strategy-name {
  font-weight: 600;
  color: var(--text);
  font-size: 13px;
  display: block;
}

.strategy-desc {
  font-size: 12px;
  color: rgba(233, 238, 247, 0.6);
  display: block;
  margin-top: 2px;
}

.import-drop-zone {
  border: 2px dashed rgba(91, 157, 255, 0.3);
  border-radius: 10px;
  padding: 32px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 16px 0;
  background: rgba(91, 157, 255, 0.05);
}

.import-drop-zone:hover {
  border-color: rgba(91, 157, 255, 0.6);
  background: rgba(91, 157, 255, 0.1);
  transform: scale(1.02);
}

.import-drop-zone.drag-over {
  border-color: #5b9dff;
  background: rgba(91, 157, 255, 0.15);
  box-shadow: 0 0 24px rgba(91, 157, 255, 0.3);
}

.drop-icon {
  font-size: 48px;
  margin-bottom: 12px;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

.drop-text {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.drop-text strong {
  color: var(--text);
  font-size: 13px;
  font-weight: 700;
}

.drop-hint {
  font-size: 12px;
  color: rgba(233, 238, 247, 0.6);
}

.bu-analytics-modal {
  min-width: 500px;
  max-width: 700px;
}

@media (max-width: 750px) {
  .bu-analytics-modal {
    min-width: 90vw;
    max-width: 90vw;
  }
}

.modal-header-premium {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px;
  border-bottom: 1px solid rgba(91, 157, 255, 0.2);
  background: linear-gradient(135deg, rgba(91,157,255,0.1) 0%, transparent 100%);
}

.modal-title-premium {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  margin: 0;
}

.modal-close-premium {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
}

.modal-close-premium:hover {
  color: var(--text);
  background: rgba(91, 157, 255, 0.1);
}

.modal-body-premium {
  padding: 24px;
  overflow-y: auto;
  max-height: calc(100vh - 180px);
}

.modal-footer-premium {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 24px;
  border-top: 1px solid rgba(91, 157, 255, 0.2);
  background: rgba(8, 11, 19, 0.5);
}

.bu-export-info,
.import-source-info {
  margin-bottom: 24px;
  padding: 16px;
  background: rgba(91, 157, 255, 0.08);
  border-left: 4px solid #5b9dff;
  border-radius: 8px;
}

.export-bu-name,
.import-bu-name {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
  margin: 0 0 4px 0;
}

.export-bu-meta,
.import-bu-meta {
  font-size: 13px;
  color: rgba(233, 238, 247, 0.7);
  margin: 0;
}

.export-statistics-grid,
.import-statistics-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}

@media (max-width: 600px) {
  .export-statistics-grid,
  .import-statistics-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.stat-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  background: rgba(91, 157, 255, 0.08);
  border: 1px solid rgba(91, 157, 255, 0.15);
  border-radius: 8px;
  transition: all 0.3s ease;
}

.stat-card:hover {
  background: rgba(91, 157, 255, 0.15);
  border-color: rgba(91, 157, 255, 0.3);
  transform: translateY(-2px);
}

.stat-icon {
  font-size: 24px;
  line-height: 1;
}

.stat-content {
  flex: 1;
}

.stat-value {
  font-size: 16px;
  font-weight: 700;
  color: #5b9dff;
  line-height: 1.2;
}

.stat-label {
  font-size: 11px;
  color: rgba(233, 238, 247, 0.6);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 2px;
}

.export-details,
.merge-strategy-display {
  margin-bottom: 24px;
}

.details-title,
.strategy-title,
.preview-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.details-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  padding: 12px;
  background: rgba(8, 11, 19, 0.6);
  border-radius: 6px;
  border-left: 3px solid rgba(50, 230, 133, 0.3);
  font-size: 13px;
}

.detail-label {
  font-weight: 600;
  color: rgba(233, 238, 247, 0.7);
}

.detail-value {
  color: #32e685;
  text-align: right;
}

.export-warning,
.import-notice {
  display: flex;
  gap: 12px;
  padding: 16px;
  background: rgba(91, 157, 255, 0.08);
  border-left: 4px solid #5b9dff;
  border-radius: 8px;
  margin: 24px 0 0 0;
}

.warning-icon,
.notice-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.warning-text,
.notice-text {
  font-size: 13px;
  line-height: 1.6;
  color: var(--text);
}

.warning-text strong,
.notice-text strong {
  color: #5b9dff;
}

.apps-preview-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.app-preview-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: rgba(91, 157, 255, 0.05);
  border: 1px solid rgba(91, 157, 255, 0.1);
  border-radius: 6px;
  font-size: 12px;
}

.app-name {
  font-weight: 600;
  color: var(--text);
  flex: 1;
}

.app-status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}

.app-status-tbs {
  background: rgba(255, 95, 122, 0.2);
  color: #ff5f7a;
}

.app-status-wip {
  background: rgba(255, 209, 102, 0.2);
  color: #ffd166;
}

.app-status-clo {
  background: rgba(50, 230, 133, 0.2);
  color: #32e685;
}

.app-progress {
  font-size: 13px;
  font-weight: 700;
  color: #5b9dff;
  min-width: 50px;
  text-align: right;
}

.strategy-display {
  padding: 12px;
  background: rgba(91, 157, 255, 0.08);
  border-left: 4px solid #5b9dff;
  border-radius: 6px;
  font-size: 13px;
  line-height: 1.6;
  color: var(--text);
}

.btn-export,
.btn-import {
  background: linear-gradient(135deg, #5b9dff 0%, #4a7fd8 100%);
  border: none;
  font-weight: 700;
  transition: all 0.3s ease;
}

.btn-export:hover:not(:disabled),
.btn-import:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(91, 157, 255, 0.4);
}

.btn-export:disabled,
.btn-import:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ========== END BU ANALYTICS STYLING ========== */

/* ===== APPLICATIONS OVERVIEW - WORLD CLASS PREMIUM UPGRADE ===== */

/* KPI Card Styles */
.kpi-card {
  transition: all 0.3s ease;
  cursor: default;
  position: relative;
  overflow: hidden;
}

.kpi-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent);
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
  border-radius: 10px;
}

.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.kpi-card:hover::before {
  opacity: 1;
}

/* Status Pill Filter Buttons */
.status-pill-filter {
  transition: all 0.2s ease;
}

.status-pill-filter:hover {
  transform: translateY(-1px);
  filter: brightness(1.1);
}

.status-pill-filter.active {
  box-shadow: 0 0 12px currentColor, inset 0 0 12px rgba(255,255,255,0.1);
}

/* Search Input Premium */
.search-input-premium {
  transition: all 0.2s ease;
  font-family: system-ui, -apple-system, sans-serif;
}

.search-input-premium:focus {
  outline: none;
  background: rgba(91,157,255,0.1) !important;
  border-color: #5b9dff !important;
  box-shadow: 0 0 0 3px rgba(91,157,255,0.2);
}

/* App Table Premium Styling */
.app-table-premium.world-class {
  background: transparent;
}

.app-table-premium.world-class tbody tr {
  border-bottom: 1px solid var(--ring);
  transition: all 0.2s ease;
}

.app-table-premium.world-class tbody tr:hover {
  background: rgba(91,157,255,0.05);
}

/* Row color coding based on progress */
.app-row-complete {
  border-left: 3px solid #32e685;
}

.app-row-at-risk {
  border-left: 3px solid #ffd166;
}

.app-row-critical {
  border-left: 3px solid #ff5f7a;
}

/* Table cell styling */
.app-table-premium.world-class td {
  padding: 12px 14px;
  font-size: 13px;
  color: var(--text);
}

.app-table-premium.world-class td:first-child {
  font-weight: 600;
  color: #5b9dff;
}

/* Badge styling */
.badge-wave {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}

.badge-wave.w1 {
  background: rgba(50,230,133,0.2);
  color: #32e685;
}

.badge-wave.w2 {
  background: rgba(255,209,102,0.2);
  color: #ffd166;
}

.badge-wave.w3 {
  background: rgba(91,157,255,0.2);
  color: #5b9dff;
}

/* Status badge */
.status-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.status-badge.complete {
  background: rgba(50,230,133,0.2);
  color: #32e685;
}

.status-badge.in-progress {
  background: rgba(255,209,102,0.2);
  color: #ffd166;
}

.status-badge.to-start {
  background: rgba(255,95,122,0.2);
  color: #ff5f7a;
}

/* Mini Chart Bars */
.mini-bar {
  display: inline-block;
  height: 20px;
  background: linear-gradient(180deg, rgba(91,157,255,0.3), rgba(91,157,255,0.1));
  border-radius: 3px;
  transition: all 0.2s ease;
}

.mini-bar:hover {
  filter: brightness(1.2);
}

/* Animations */
@keyframes shimmer {
  0% { opacity: 0.5; }
  50% { opacity: 1; }
  100% { opacity: 0.5; }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.kpi-card {
  animation: slideIn 0.5s ease-out;
}

/* Responsive Design */
@media (max-width: 1200px) {
  .apps-metrics-dashboard {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)) !important;
  }
  
  .app-table-premium.world-class td {
    padding: 10px 8px;
    font-size: 12px;
  }
}

@media (max-width: 768px) {
  .apps-metrics-dashboard {
    grid-template-columns: 1fr 1fr !important;
  }
  
  .kpi-card {
    padding: 12px !important;
  }
  
  .app-table-premium.world-class {
    font-size: 12px;
  }
  
  .app-table-premium.world-class th,
  .app-table-premium.world-class td {
    padding: 8px 10px !important;
  }
}

/* ========== END APPLICATIONS OVERVIEW WORLD CLASS ========== */

/* ========== WAVES MODAL STYLES (Premium Input Dialog) ========== */
.waves-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(12px);
  animation: fadeIn 0.3s ease;
}

.waves-modal-overlay.active {
  display: flex;
}

.waves-modal-content {
  background: linear-gradient(135deg, rgba(91, 157, 255, 0.1), transparent), var(--panel);
  border: 1px solid rgba(91, 157, 255, 0.3);
  border-radius: 16px;
  box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(91, 157, 255, 0.15) inset;
  padding: 32px;
  max-width: 500px;
  width: 90%;
  animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.waves-modal-header {
  margin-bottom: 20px;
  text-align: center;
}

.waves-modal-header h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  color: var(--text);
  font-weight: 700;
}

.waves-modal-header p {
  margin: 0;
  font-size: 13px;
  color: #aaa;
}

.waves-modal-input-group {
  margin-bottom: 20px;
}

.waves-modal-input-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 12px;
  color: #aaa;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.waves-modal-input-group input {
  width: 100%;
  padding: 12px 14px;
  background: rgba(91, 157, 255, 0.05);
  border: 1px solid var(--ring);
  border-radius: 8px;
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
  transition: all 0.2s ease;
  box-sizing: border-box;
}

.waves-modal-input-group input:focus {
  outline: none;
  border-color: var(--primary);
  background: rgba(91, 157, 255, 0.08);
  box-shadow: 0 0 12px rgba(91, 157, 255, 0.2);
}

.waves-modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.waves-modal-btn {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
}

.waves-modal-btn-primary {
  background: linear-gradient(135deg, var(--primary), #4a88ff);
  color: white;
  box-shadow: 0 4px 15px rgba(91, 157, 255, 0.3);
}

.waves-modal-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(91, 157, 255, 0.4);
}

.waves-modal-btn-primary:active {
  transform: translateY(0);
}

.waves-modal-btn-secondary {
  background: transparent;
  border: 1px solid var(--ring);
  color: var(--text);
}

.waves-modal-btn-secondary:hover {
  background: var(--ring);
}

.waves-modal-confirm {
  background: linear-gradient(135deg, #32e685, #2cc778);
  color: white;
  box-shadow: 0 4px 15px rgba(50, 230, 133, 0.3);
}

.waves-modal-confirm:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(50, 230, 133, 0.4);
}

.waves-modal-danger {
  background: linear-gradient(135deg, #ff5f7a, #ff4562);
  color: white;
  box-shadow: 0 4px 15px rgba(255, 95, 122, 0.3);
}

.waves-modal-danger:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 95, 122, 0.4);
}

.waves-modal-message {
  text-align: center;
  margin-bottom: 20px;
  padding: 16px;
  background: rgba(91, 157, 255, 0.05);
  border-left: 3px solid var(--primary);
  border-radius: 8px;
  font-size: 13px;
  color: var(--text);
  line-height: 1.5;
}

.waves-modal-message.warning {
  background: rgba(255, 209, 102, 0.05);
  border-left-color: var(--warn);
  color: #ffd166;
}

.waves-modal-message.danger {
  background: rgba(255, 95, 122, 0.05);
  border-left-color: var(--danger);
  color: #ff5f7a;
}

.waves-modal-message.success {
  background: rgba(50, 230, 133, 0.05);
  border-left-color: var(--ok);
  color: #32e685;
}

/* ========== END WAVES MODAL STYLES ========== */

</style>
</head>
<body>
  <div class="wrapper">
    <header>
            <div class="h-title">
              <h1 id="mainTitleDisplay"></h1>
              <small id="subtitleDisplay"></small>
            </div>      <div class="controls" role="region" aria-label="Controles">
        <input id="q" type="search" placeholder="/ Search Business Unit… (HR, PAY, GDPA)" aria-label="Buscar" />
        <select id="status" aria-label="Filtro de estado">
          <option value="all">All</option>
          <option value="done">100%</option>
          <option value="wip">1–99%</option>
          <option value="todo">0%</option>
        </select>

        <button class="btn pill" data-sort="name" title="Order A→Z (tecla: s)">A→Z</button>
        <button class="btn pill" data-sort="progress" title="Order by Advance">Advance</button>

        <div class="switch" title="Theme light/dark">
          <span>🌙</span><input id="theme" class="toggle" type="checkbox" /><span>☀️</span>
        </div>

        <button id="cinema" class="btn pill" title="Cinematic Mode (key: x)">Cinematic</button>
        <button id="exportBars" class="btn pill" title="Exportar barras PNG">Bar PNG</button>
        <button id="exportSVG" class="btn pill" title="Exportar barras SVG">Bar SVG</button>
        <button id="exportCSV" class="btn pill" title="Exportar CSV">CSV</button>
        <button id="setupAdmin" class="btn pill" title="Administration">Setup</button>
      </div>
    </header>

    <!-- FIX: botón flotante para salir del modo cinemático -->
    <button id="exitCinema" class="btn pill exit-cinema" title="Turn off cinematic mode (Esc)">Exit</button>

    <section class="grid">
      <div class="card hero">
        <div class="inner">
          <h2>Progreso Global</h2>
          <svg id="heroGauge" viewBox="0 0 360 360" width="100%" height="100%" role="img" aria-label="Medidor global"></svg>
          <div class="val" style="inset:auto; top:50%; transform:translateY(-50%);">
            <div class="big" id="heroPct">—%</div>
            <div class="sub" id="heroCaption">Avg</div>
          </div>
          <div class="spark"></div>
        </div>
      </div>

      <div class="card constel pad">
        <h3>BU's Constellation</h3>
        <div class="tiles" id="tiles"></div>
        <p class="tip">Hover to activate spotlight · Click to lock focus · Press ESC to release</p>
      </div>

      <div class="card kpis">
        <div class="kpi"><div class="dot" style="background:var(--ok)"></div><h4>Completed</h4><div class="num" id="kpiDone">—</div></div>
        <div class="kpi"><div class="dot" style="background:var(--warn)"></div><h4>In Progress</h4><div class="num" id="kpiWip">—</div></div>
        <div class="kpi"><div class="dot" style="background:var(--danger)"></div><h4>About to Start</h4><div class="num" id="kpiTodo">—</div></div>
        <div class="kpi"><div class="dot" style="background:var(--accent)"></div><h4>Total Avg</h4><div class="num" id="kpiAvg">—%</div></div>
      </div>

      <div class="card bars pad">
        <h3>Ranking by Advance</h3>
        <svg id="bars" viewBox="0 0 1100 460" width="100%" height="100%" role="img" aria-label="Barras de avance"></svg>
      </div>
    </section>
  </div>

  
  <!-- ADMIN MODAL -->
  <div id="adminModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>📊 Project Administration</h2>
        <button class="modal-close" id="closeAdminModal">✕</button>
      </div>
      
      <!-- BU EDITOR MODAL (nested) -->
      <div id="buEditorModal" class="nested-modal">
        <div class="nested-modal-content">
          <div class="modal-header">
            <h3 id="buEditorTitle">Edit Business Unit</h3>
            <button class="modal-close" id="closeBUEditorModal">✕</button>
          </div>
          <div class="modal-body">
            <form id="buEditorForm">
              <div class="form-group">
                <label for="buNameInput">Business Unit Name <span style="color:var(--danger)">*</span></label>
                <div class="input-with-icon">
                  <span class="input-icon">✏️</span>
                  <input type="text" id="buNameInput" placeholder="Business Unit Name" required>
                </div>
                <small class="form-hint">The display name for this business unit (e.g., HR, IT, SALES)</small>
                <div id="buNameError" class="form-error"></div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="buDomainInput">Domain Code <span style="color:var(--danger)">*</span></label>
                  <div class="input-with-icon">
                    <span class="input-icon">🏢</span>
                    <input type="text" id="buDomainInput" placeholder="ABCD" maxlength="4" required pattern="[A-Z0-9]{1,4}">
                  </div>
                  <small class="form-hint">Short code (max 4 characters, uppercase)</small>
                  <div id="buDomainError" class="form-error"></div>
                </div>
                <div class="form-group">
                  <label for="buColorInput">Color Theme</label>
                  <div class="color-picker">
                    <input type="color" id="buColorInput" value="#5b9dff">
                    <span class="color-preview" id="colorPreview"></span>
                  </div>
                  <small class="form-hint">Choose a representative color</small>
                </div>
              </div>
              <div class="form-group">
                <label for="buFullnameInput">Full Name/Description <span style="color:var(--danger)">*</span></label>
                <div class="input-with-icon">
                  <span class="input-icon">📝</span>
                  <input type="text" id="buFullnameInput" placeholder="Business Unit Full Name" required>
                </div>
                <small class="form-hint">Complete name or description (e.g., Human Resources Department)</small>
                <div id="buFullnameError" class="form-error"></div>
              </div>
              <div class="form-group">
                <label for="buManagerInput">Manager/Lead Contact</label>
                <div class="input-with-icon">
                  <span class="input-icon">👤</span>
                  <input type="text" id="buManagerInput" placeholder="Manager Name">
                </div>
                <small class="form-hint">Optional: Name of the Business Unit leader</small>
              </div>
              <div class="form-group" id="buEditorStats"></div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary"><span class="btn-icon">💾</span> Save Changes</button>
                <button type="button" class="btn btn-secondary" id="buEditorCancel">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- APP EDITOR MODAL (nested) -->
      <div id="appEditorModal" class="nested-modal">
        <div class="nested-modal-content">
          <div class="modal-header">
            <h3 id="appEditorTitle">✨ Create New Application</h3>
            <button class="modal-close" id="closeAppEditorModal">✕</button>
          </div>
          <div class="modal-body">
            <form id="appEditorForm">
              <div class="form-group">
                <label for="appNameInput">Application Name <span style="color:var(--danger)">*</span></label>
                <div class="input-with-icon">
                  <span class="input-icon">📱</span>
                  <input type="text" id="appNameInput" placeholder="Application Name" required>
                </div>
                <small class="form-hint">Display name for this application</small>
                <div id="appNameError" class="form-error"></div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="appStatusInput">Status <span style="color:var(--danger)">*</span></label>
                  <select id="appStatusInput" required>
                    <option value="TBS">To Be Started (TBS)</option>
                    <option value="WIP">Work In Progress (WIP)</option>
                    <option value="CLO">Completed (CLO)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="appProgressInput">Progress %</label>
                  <input type="number" id="appProgressInput" min="0" max="100" value="0">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="appCriticalityInput">Criticality <span style="color:var(--danger)">*</span></label>
                  <select id="appCriticalityInput" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="appImpactInput">Business Impact <span style="color:var(--danger)">*</span></label>
                  <select id="appImpactInput" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="appPriorityInput">Priority <span style="color:var(--danger)">*</span></label>
                  <select id="appPriorityInput" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Weight (Auto-calculated)</label>
                  <div class="weight-preview">
                    <span class="auto-weight" id="weightPreview">1.48</span>
                    <small class="form-hint">Automatically calculated from Criticality × Impact × Priority</small>
                  </div>
                </div>
                <div class="form-group">
                  <label for="appWaveInput">Wave</label>
                  <select id="appWaveInput">
                    <!-- Populated dynamically by JavaScript -->
                  </select>
                </div>
              </div>
              <div class="form-group" id="appEditorStats"></div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary"><span class="btn-icon">💾</span> Create Application</button>
                <button type="button" class="btn btn-secondary" id="appEditorCancel">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="buses">📊 Business Units</button>
        <button class="modal-tab" data-tab="apps">📱 Applications</button>
        <button class="modal-tab" data-tab="app-overview">🔍 Applications Overview</button>
        <button class="modal-tab" data-tab="whitelabel">🏷️ Whitelabel</button>
        <button class="modal-tab" data-tab="formulas">⚙️ Calculation Formulas</button>
        <button class="modal-tab" data-tab="settings">🛠️ Settings</button>
      </div>
      
      <div class="modal-scroll-container">
      
      <!-- TAB: BUSINESS UNITS -->
      <div class="modal-tabpanel active" id="tab-buses">
        <div class="tab-header">
          <div>
            <h3>Business Units Management</h3>
            <p class="tab-description">Create, edit, and manage all business units for your project</p>
          </div>
          <button class="btn btn-primary" id="newBUBtn"><span class="btn-icon">✨</span> New Business Unit</button>
        </div>
        <div class="bu-list" id="buList"></div>
      </div>
      
      <!-- TAB: APPLICATIONS -->
      <div class="modal-tabpanel" id="tab-apps">
        <div class="tab-header">
          <div>
            <h3>Applications Management</h3>
            <p class="tab-description">Manage applications and their properties for each business unit</p>
          </div>
        </div>
        <div class="apps-selector-section">
          <div class="form-group" style="margin-bottom:0">
            <label for="appBUFilter">📱 Select Business Unit</label>
            <select id="appBUFilter" class="bu-selector-premium"></select>
          </div>
        </div>
        <div id="appEditorContainer"></div>
      </div>
      
      <!-- TAB: APPLICATIONS OVERVIEW -->
      <div class="modal-tabpanel" id="tab-app-overview">
        <div class="tab-header">
          <div>
            <h3>🔍 Applications Overview</h3>
            <p class="tab-description">Complete view of all applications across business units with intelligent filtering and advanced analytics</p>
          </div>
        </div>
        
        <!-- ENHANCED METRICS DASHBOARD -->
        <div class="apps-metrics-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; padding: 16px; background: rgba(91,157,255,0.02); border-radius: 12px; border: 1px solid var(--ring);">
          
          <!-- Total Applications KPI -->
          <div class="kpi-card" style="padding: 16px; border-radius: 10px; background: linear-gradient(135deg, rgba(50,230,133,0.1), transparent); border: 1px solid rgba(50,230,133,0.2);">
            <div style="font-size: 12px; color: #aaa; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Total Apps</div>
            <div style="font-size: 24px; font-weight: 700; color: #32e685;">
              <span id="statsTotalApps">0</span>
            </div>
            <div style="font-size: 11px; color: #777; margin-top: 4px;">
              <span id="statsAppsChange" style="color: #32e685;">↑ All</span>
            </div>
          </div>
          
          <!-- Completion Average KPI -->
          <div class="kpi-card" style="padding: 16px; border-radius: 10px; background: linear-gradient(135deg, rgba(255,209,102,0.1), transparent); border: 1px solid rgba(255,209,102,0.2);">
            <div style="font-size: 12px; color: #aaa; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Avg Completion</div>
            <div style="font-size: 24px; font-weight: 700; color: #ffd166;">
              <span id="statsCompletionPct">0</span>%
            </div>
            <div style="font-size: 11px; color: #777; margin-top: 4px;">
              <span id="statsCompletionTrend">→ Stable</span>
            </div>
          </div>
          
          <!-- Critical/At-Risk KPI -->
          <div class="kpi-card" style="padding: 16px; border-radius: 10px; background: linear-gradient(135deg, rgba(255,95,122,0.1), transparent); border: 1px solid rgba(255,95,122,0.2);">
            <div style="font-size: 12px; color: #aaa; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">At Risk</div>
            <div style="font-size: 24px; font-weight: 700; color: #ff5f7a;">
              <span id="statsAtRisk">0</span>
            </div>
            <div style="font-size: 11px; color: #777; margin-top: 4px;">
              <span id="statsRiskLabel">Below 50%</span>
            </div>
          </div>
          
          <!-- Wave Distribution KPI -->
          <div class="kpi-card" style="padding: 16px; border-radius: 10px; background: linear-gradient(135deg, rgba(91,157,255,0.1), transparent); border: 1px solid rgba(91,157,255,0.2);">
            <div style="font-size: 12px; color: #aaa; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Wave Status</div>
            <div style="font-size: 14px; font-weight: 600; color: #5b9dff; margin-top: 4px;">
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <span style="background: rgba(50,230,133,0.2); color: #32e685; padding: 2px 8px; border-radius: 4px; font-size: 11px;">W1: <span id="waveCount1">0</span></span>
                <span style="background: rgba(255,209,102,0.2); color: #ffd166; padding: 2px 8px; border-radius: 4px; font-size: 11px;">W2: <span id="waveCount2">0</span></span>
                <span style="background: rgba(91,157,255,0.2); color: #5b9dff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">W3: <span id="waveCount3">0</span></span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- ADVANCED CONTROLS -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
          <!-- Status Filter Pills -->
          <div style="display: flex; gap: 6px;">
            <button class="status-pill-filter" data-status="all" style="padding: 6px 12px; background: rgba(91,157,255,0.2); border: 1px solid rgba(91,157,255,0.3); border-radius: 20px; color: #5b9dff; font-size: 12px; cursor: pointer; font-weight: 600;">
              All
            </button>
            <button class="status-pill-filter" data-status="CLO" style="padding: 6px 12px; background: rgba(50,230,133,0.1); border: 1px solid rgba(50,230,133,0.2); border-radius: 20px; color: #32e685; font-size: 12px; cursor: pointer; font-weight: 600;">
              ✓ Complete
            </button>
            <button class="status-pill-filter" data-status="WIP" style="padding: 6px 12px; background: rgba(255,209,102,0.1); border: 1px solid rgba(255,209,102,0.2); border-radius: 20px; color: #ffd166; font-size: 12px; cursor: pointer; font-weight: 600;">
              🔄 In Progress
            </button>
            <button class="status-pill-filter" data-status="TBS" style="padding: 6px 12px; background: rgba(255,95,122,0.1); border: 1px solid rgba(255,95,122,0.2); border-radius: 20px; color: #ff5f7a; font-size: 12px; cursor: pointer; font-weight: 600;">
              ⏳ To Start
            </button>
          </div>
        </div>
        
        <!-- Search Bar -->
        <div class="search-box-wrapper" style="margin-bottom: 16px;">
          <input type="text" id="appsOverviewSearch" placeholder="🔎 Search by name, BU, or ID..." class="search-input-premium" style="width: 100%; padding: 10px 14px; background: rgba(91,157,255,0.05); border: 1px solid var(--ring); border-radius: 8px; color: var(--text); font-size: 13px;"/>
        </div>
        
        <!-- MINI VISUALIZATION PANELS -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
          
          <!-- Wave Distribution -->
          <div style="padding: 12px; background: rgba(91,157,255,0.02); border: 1px solid var(--ring); border-radius: 10px;">
            <div style="font-size: 11px; font-weight: 600; color: #aaa; margin-bottom: 8px; text-transform: uppercase;">Wave Distribution</div>
            <div id="waveDistChart" style="display: flex; gap: 2px; align-items: flex-end; height: 40px; justify-content: center;">
              <div style="flex: 1; background: rgba(50,230,133,0.3); height: 60%; border-radius: 2px;" title="Wave 1"></div>
              <div style="flex: 1; background: rgba(255,209,102,0.3); height: 40%; border-radius: 2px;" title="Wave 2"></div>
              <div style="flex: 1; background: rgba(91,157,255,0.3); height: 30%; border-radius: 2px;" title="Wave 3"></div>
            </div>
          </div>
          
          <!-- Status Breakdown -->
          <div style="padding: 12px; background: rgba(91,157,255,0.02); border: 1px solid var(--ring); border-radius: 10px;">
            <div style="font-size: 11px; font-weight: 600; color: #aaa; margin-bottom: 8px; text-transform: uppercase;">Status Breakdown</div>
            <div id="statusBreakChart" style="display: flex; gap: 2px; height: 40px;">
              <div style="flex: 1; background: rgba(50,230,133,0.4); border-radius: 2px; position: relative;" title="Complete"><span style="position: absolute; bottom: -18px; font-size: 10px; color: #32e685; left: 0; right: 0; text-align: center;">CLO</span></div>
              <div style="flex: 1; background: rgba(255,209,102,0.4); border-radius: 2px; position: relative;" title="In Progress"><span style="position: absolute; bottom: -18px; font-size: 10px; color: #ffd166; left: 0; right: 0; text-align: center;">WIP</span></div>
              <div style="flex: 1; background: rgba(255,95,122,0.4); border-radius: 2px; position: relative;" title="To Start"><span style="position: absolute; bottom: -18px; font-size: 10px; color: #ff5f7a; left: 0; right: 0; text-align: center;">TBS</span></div>
            </div>
          </div>
          
          <!-- Completion Range -->
          <div style="padding: 12px; background: rgba(91,157,255,0.02); border: 1px solid var(--ring); border-radius: 10px;">
            <div style="font-size: 11px; font-weight: 600; color: #aaa; margin-bottom: 8px; text-transform: uppercase;">Completion Range</div>
            <div style="display: flex; align-items: center; gap: 6px; height: 40px;">
              <div style="flex: 1; height: 4px; background: linear-gradient(90deg, #ff5f7a 0%, #ffd166 50%, #32e685 100%); border-radius: 2px;"></div>
              <div style="font-size: 12px; color: var(--text); font-weight: 600;"><span id="completionMin">0</span>% - <span id="completionMax">100</span>%</div>
            </div>
          </div>
        </div>
        
        <!-- Premium Table Container -->
        <div class="apps-table-container-premium" style="border-radius: 10px; border: 1px solid var(--ring); overflow: hidden;">
          <div class="table-header-info" style="padding: 12px 16px; background: rgba(91,157,255,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--ring);">
            <span class="table-info-icon">📋</span>
            <span class="table-info-text">Showing <strong id="appsCountDisplay">0</strong> applications</span>
          </div>
          
          <table class="app-table-premium world-class" id="appsOverviewTable" style="width: 100%; border-collapse: collapse;"><thead style="background: rgba(91,157,255,0.08); border-bottom: 2px solid var(--ring);">
              <tr>
                <th id="header-order" data-column="order" style="padding: 12px 14px; text-align: left; font-size: 12px; font-weight: 600; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid var(--ring); cursor: pointer; user-select: none; transition: all 0.2s ease;" title="Click to sort by Execution Order" onmouseover="this.style.color='#5b9dff'" onmouseout="this.style.color='#aaa'">🔢 Order</th>
                <th id="header-name" data-column="name" style="padding: 12px 14px; text-align: left; font-size: 12px; font-weight: 600; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid var(--ring); cursor: pointer; user-select: none; transition: all 0.2s ease;" title="Click to sort by Application Name" onmouseover="this.style.color='#5b9dff'" onmouseout="this.style.color='#aaa'">📱 Application</th>
                <th id="header-buId" data-column="buId" style="padding: 12px 14px; text-align: left; font-size: 12px; font-weight: 600; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; border-right: 1px solid var(--ring); cursor: pointer; user-select: none; transition: all 0.2s ease;" title="Click to sort by Business Unit" onmouseover="this.style.color='#5b9dff'" onmouseout="this.style.color='#aaa'">🏢 BU</th>
                <th id="header-waveId" data-column="waveId" style="cursor: pointer; user-select: none; transition: all 0.2s ease; color: #aaa;" title="Click to sort by Execution Wave" onmouseover="this.style.color='#5b9dff'" onmouseout="this.style.color='#aaa'">🌊 WAVE</th>
                <th id="header-weight" data-column="weight" style="cursor: pointer; user-select: none; transition: all 0.2s ease; color: #aaa;" title="Click to sort by Auto-calculated Weight" onmouseover="this.style.color='#5b9dff'" onmouseout="this.style.color='#aaa'">⚖️ AUTO-WEIGHT</th>
                <th id="header-factors" data-column="factors" style="cursor: pointer; user-select: none; transition: all 0.2s ease; color: #aaa;" title="Click to sort by Business Factors" onmouseover="this.style.color='#5b9dff'" onmouseout="this.style.color='#aaa'">🎯 FACTORS</th>
                <th id="header-progress" data-column="progress" style="cursor: pointer; user-select: none; transition: all 0.2s ease; color: #aaa;" title="Click to sort by Progress" onmouseover="this.style.color='#5b9dff'" onmouseout="this.style.color='#aaa'">📈 PROGRESS</th>
                <th id="header-status" data-column="status" style="cursor: pointer; user-select: none; transition: all 0.2s ease; color: #aaa;" title="Click to sort by Status" onmouseover="this.style.color='#5b9dff'" onmouseout="this.style.color='#aaa'">✓ STATUS</th>
              </tr>
            </thead>
            <tbody id="appsOverviewTableBody" style="background: transparent;">
              <!-- App data will be populated here -->
            </tbody>
          </table>
          
          <div class="table-empty-state" id="emptyState" style="display: none; padding: 40px 20px; text-align: center;">
            <div class="empty-state-icon">🔍</div>
            <div class="empty-state-title" style="font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 8px;">No applications found</div>
            <div class="empty-state-description" style="font-size: 13px; color: #aaa;">Try adjusting your filters or search criteria</div>
          </div>
        </div>
      </div>
      
      <!-- TAB: WHITELABEL -->
      <div class="modal-tabpanel" id="tab-whitelabel">
        <div class="tab-header">
          <div>
            <h3>Whitelabel Configuration</h3>
            <p class="tab-description">Customize branding, titles, and logos for your project</p>
          </div>
        </div>
        <div class="whitelabel-container">
          <!-- Title Section -->
          <div class="whitelabel-section">
            <h4 class="whitelabel-section-title">📝 Project Title</h4>
            <div class="form-group">
              <label>Main Title</label>
              <input type="text" id="wl-mainTitle" placeholder="" class="form-input"/>
              <p class="form-help">Appears in the main header</p>
            </div>
            <div class="form-group">
              <label>Subtitle</label>
              <input type="text" id="wl-subtitle" placeholder="" class="form-input"/>
              <p class="form-help">Appears below the main title</p>
            </div>
          </div>

          <!-- Logos Section -->
          <div class="whitelabel-section">
            <h4 class="whitelabel-section-title">🎨 Logos</h4>
            
            <!-- Left Logo -->
            <div class="form-group">
              <label>Left Logo</label>
              <div class="logo-upload-area" id="leftLogoArea">
                <div class="logo-preview" id="leftLogoPreview">
                  <span class="logo-placeholder">📷 Left Logo</span>
                </div>
                <input type="file" id="leftLogoInput" accept="image/*" style="display:none"/>
                <button type="button" class="btn btn-secondary" id="leftLogoBrowseBtn"><span class="btn-icon">📁</span> Upload Logo</button>
              </div>
              <p class="form-help">Recommended size: 200x80px (PNG/JPG)</p>
              <button type="button" class="btn btn-sm btn-danger" id="leftLogoClearBtn" style="margin-top:8px">Clear Logo</button>
            </div>

            <!-- Right Logo -->
            <div class="form-group">
              <label>Right Logo</label>
              <div class="logo-upload-area" id="rightLogoArea">
                <div class="logo-preview" id="rightLogoPreview">
                  <span class="logo-placeholder">📷 Right Logo</span>
                </div>
                <input type="file" id="rightLogoInput" accept="image/*" style="display:none"/>
                <button type="button" class="btn btn-secondary" id="rightLogoBrowseBtn"><span class="btn-icon">📁</span> Upload Logo</button>
              </div>
              <p class="form-help">Recommended size: 200x80px (PNG/JPG)</p>
              <button type="button" class="btn btn-sm btn-danger" id="rightLogoClearBtn" style="margin-top:8px">Clear Logo</button>
            </div>
          </div>

          <!-- Preview Section -->
          <div class="whitelabel-section">
            <h4 class="whitelabel-section-title">👁️ Live Preview</h4>
            <div class="whitelabel-preview">
              <div class="preview-header">
                <div class="preview-logo-left" id="previewLogoLeft">
                  <span>Logo</span>
                </div>
                <div class="preview-title">
                  <h2 id="previewMainTitle"></h2>
                  <p id="previewSubtitle"></p>
                </div>
                <div class="preview-logo-right" id="previewLogoRight">
                  <span>Logo</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="whitelabel-section">
            <button class="btn btn-primary" id="wl-saveBtn"><span class="btn-icon">💾</span> Save Whitelabel Config</button>
            <button class="btn btn-secondary" id="wl-resetBtn"><span class="btn-icon">↺</span> Reset to Defaults</button>
          </div>
        </div>
      </div>

      <!-- TAB: CALCULATION FORMULAS -->
      <div class="modal-tabpanel" id="tab-formulas">
        <div class="tab-header">
          <div>
            <h3>🚀 Enterprise Calculation Engine</h3>
            <p class="tab-description">Automatic weight calculation system powered by objective business intelligence</p>
          </div>
        </div>
        
        <!-- Hero Section: Automatic Weight System -->
        <div class="formula-hero-section">
          <div class="hero-content">
            <h2>Automatic Weight Calculation</h2>
            <p class="hero-subtitle">Enterprise-grade formula eliminates manual bias and ensures objective prioritization</p>
            
            <div class="formula-showcase">
              <div class="formula-box">
                <div class="formula-label">
                  Core Algorithm
                  <span class="factor-info-trigger" data-tooltip-id="factor27-tooltip">ℹ️</span>
                </div>
                <div class="formula-equation">
                  Weight = [<span class="highlight">(Criticality × Business Impact × Priority)</span> ÷ 27 ] × 3
                </div>
                <div class="formula-range">Range: 0.11 → 3.00 | Precision: 0.01</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Business Intelligence Dashboard -->
        <div class="business-intelligence-grid">
          
          <!-- 1. Status Inclusion Rules - Business Rules (TOP) -->
          <div class="bi-card status-inclusion">
            <div class="bi-header">
              <h4>� Status Inclusion Rules</h4>
              <div class="bi-badge rules">Business Rules</div>
            </div>
            <div class="inclusion-content">
              <div class="inclusion-grid">
                <div class="inclusion-item">
                  <div class="inclusion-header">
                    <input type="checkbox" id="include-tbs" class="inclusion-checkbox">
                    <label for="include-tbs" class="status-badge danger">TBS</label>
                    <span class="inclusion-name">To Be Started</span>
                  </div>
                  <div class="inclusion-desc">Future work • Include for full pipeline view</div>
                </div>
                
                <div class="inclusion-item">
                  <div class="inclusion-header">
                    <input type="checkbox" id="include-wip" class="inclusion-checkbox" checked>
                    <label for="include-wip" class="status-badge warn">WIP</label>
                    <span class="inclusion-name">Work In Progress</span>
                  </div>
                  <div class="inclusion-desc">Active work • Recommended for realistic progress</div>
                </div>
                
                <div class="inclusion-item">
                  <div class="inclusion-header">
                    <input type="checkbox" id="include-clo" class="inclusion-checkbox" checked>
                    <label for="include-clo" class="status-badge ok">CLO</label>
                    <span class="inclusion-name">Closed</span>
                  </div>
                  <div class="inclusion-desc">Completed work • Essential for progress tracking</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 2. Progress Calculation Method - Configuration (TOP) -->
          <div class="bi-card progress-config">
            <div class="bi-header">
              <h4>⚙️ Progress Calculation Method</h4>
              <div class="bi-badge config">Configuration</div>
            </div>
            <div class="config-content">
              <div class="method-selector">
                <div class="method-option">
                  <input type="radio" id="method-weighted" name="progress-method" value="weighted" checked>
                  <label for="method-weighted">
                    <div class="method-name">🎯 Weighted Average</div>
                    <div class="method-desc">Uses automatic weights from business factors</div>
                    <div class="method-formula">BU Progress = Σ(App Progress × Auto-Weight) / Σ(Auto-Weight)</div>
                  </label>
                </div>
                
                <div class="method-option">
                  <input type="radio" id="method-simple" name="progress-method" value="simple">
                  <label for="method-simple">
                    <div class="method-name">📊 Simple Average</div>
                    <div class="method-desc">All applications have equal influence</div>
                    <div class="method-formula">BU Progress = Σ(App Progress) / Count(Apps)</div>
                  </label>
                </div>
                
                <div class="method-option">
                  <input type="radio" id="method-minimum" name="progress-method" value="minimum">
                  <label for="method-minimum">
                    <div class="method-name">⚠️ Minimum Progress</div>
                    <div class="method-desc">Conservative bottleneck approach</div>
                    <div class="method-formula">BU Progress = MIN(App Progress)</div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- 3. Global Progress Formula - Enterprise (TOP) -->
          <div class="bi-card global-progress">
            <div class="bi-header">
              <h4>🌐 Global Progress Formula</h4>
              <div class="bi-badge global">Enterprise</div>
            </div>
            <div class="global-content">
              <div class="global-selector">
                <div class="global-option">
                  <input type="radio" id="global-weighted" name="global-method" value="weighted" checked>
                  <label for="global-weighted">
                    <div class="global-name">🎯 Weighted by BU Size</div>
                    <div class="global-formula">Global = Σ(BU Progress × BU App Count) / Σ(App Count)</div>
                  </label>
                </div>
                
                <div class="global-option">
                  <input type="radio" id="global-simple" name="global-method" value="simple">
                  <label for="global-simple">
                    <div class="global-name">📊 Simple BU Average</div>
                    <div class="global-formula">Global = Σ(BU Progress) / Count(BUs)</div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- 4. Business Factor Analysis - Live Data (BOTTOM) -->
          <div class="bi-card factor-analysis">
            <div class="bi-header">
              <h4>📊 Business Factor Analysis</h4>
              <div class="bi-badge">Live Data</div>
            </div>
            <div class="factor-matrix">
              <div class="factor-row">
                <div class="factor-name">🔥 Criticality</div>
                <div class="factor-scale">
                  <div class="scale-item danger">High<span>3</span></div>
                  <div class="scale-item warn">Med<span>2</span></div>
                  <div class="scale-item ok">Low<span>1</span></div>
                </div>
                <div class="factor-desc">Operational Impact</div>
              </div>
              
              <div class="factor-row">
                <div class="factor-name">💼 Business Impact</div>
                <div class="factor-scale">
                  <div class="scale-item danger">High<span>3</span></div>
                  <div class="scale-item warn">Med<span>2</span></div>
                  <div class="scale-item ok">Low<span>1</span></div>
                </div>
                <div class="factor-desc">Economic Value</div>
              </div>
              
              <div class="factor-row">
                <div class="factor-name">🎯 Priority</div>
                <div class="factor-scale">
                  <div class="scale-item danger">High<span>3</span></div>
                  <div class="scale-item warn">Med<span>2</span></div>
                  <div class="scale-item ok">Low<span>1</span></div>
                </div>
                <div class="factor-desc">Strategic Urgency</div>
              </div>
            </div>
          </div>

          <!-- 5. Weight Examples - Reference (BOTTOM) -->
          <div class="bi-card weight-examples">
            <div class="bi-header">
              <h4>💎 Weight Examples</h4>
              <div class="bi-badge examples">Reference</div>
            </div>
            <div class="examples-content">
              <div class="example-item max">
                <span class="auto-weight">3.00</span>
                <div class="example-details">
                  <div class="example-combo">High × High × High</div>
                  <div class="example-desc">Maximum business priority</div>
                </div>
              </div>
              
              <div class="example-item high">
                <span class="auto-weight">2.00</span>
                <div class="example-details">
                  <div class="example-combo">High × Medium × High</div>
                  <div class="example-desc">Critical urgent application</div>
                </div>
              </div>
              
              <div class="example-item standard">
                <span class="auto-weight">1.48</span>
                <div class="example-details">
                  <div class="example-combo">Medium × Medium × Medium</div>
                  <div class="example-desc">Standard business application</div>
                </div>
              </div>
              
              <div class="example-item low">
                <span class="auto-weight">0.67</span>
                <div class="example-details">
                  <div class="example-combo">Medium × Low × Low</div>
                  <div class="example-desc">Low priority maintenance</div>
                </div>
              </div>
              
              <div class="example-item min">
                <span class="auto-weight">0.11</span>
                <div class="example-details">
                  <div class="example-combo">Low × Low × Low</div>
                  <div class="example-desc">Minimum possible weight</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 6. Real-time Weight Calculator - Interactive (BOTTOM) -->
          <div class="bi-card weight-calculator">
            <div class="bi-header">
              <h4>🧮 Real-time Weight Calculator</h4>
              <div class="bi-badge calculator">Interactive</div>
            </div>
            <div class="calculator-content">
              <div class="calc-inputs">
                <div class="calc-input">
                  <label>Criticality</label>
                  <select id="calc-criticality">
                    <option value="1">🟢 Low</option>
                    <option value="2" selected>🟡 Medium</option>
                    <option value="3">🔴 High</option>
                  </select>
                </div>
                <div class="calc-input">
                  <label>Business Impact</label>
                  <select id="calc-impact">
                    <option value="1">🟢 Low</option>
                    <option value="2" selected>🟡 Medium</option>
                    <option value="3">🔴 High</option>
                  </select>
                </div>
                <div class="calc-input">
                  <label>Priority</label>
                  <select id="calc-priority">
                    <option value="High">🔴 High</option>
                    <option value="Medium" selected>🟡 Medium</option>
                    <option value="Low">🟢 Low</option>
                  </select>
                </div>
              </div>
              
              <div class="calc-result">
                <div class="result-label">Calculated Weight</div>
                <div class="result-value" id="calc-result">1.48</div>
                <div class="result-formula" id="calc-formula">[(2 × 2 × 2) ÷ 27] × 3</div>
              </div>
            </div>
          </div>

        </div>

        <!-- Save Changes Action -->
        <div class="formula-actions">
          <button class="btn-save-formulas" id="btn-save-formulas">
            <span class="btn-icon">💾</span>
            <span class="btn-text">Save Formula Changes</span>
          </button>
          <p class="formula-save-hint">All formula configurations will be saved to your dashboard settings</p>
        </div>
      </div>

      <!-- TAB: SETTINGS -->
      <div class="modal-tabpanel" id="tab-settings">
        <div class="tab-header">
          <div>
            <h3>🛠️ Advanced Settings</h3>
            <p class="tab-description">Complete dashboard configuration, data management, and system preferences</p>
          </div>
        </div>
        
        <!-- Settings Grid Container -->
        <div class="settings-master-grid">
          
          <!-- Data Management Section -->
          <div class="settings-category">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">💾</span>
                Data Management
              </h4>
              <p class="category-description">Import, export, and manage your project configuration</p>
            </div>
            
            <div class="settings-cards-grid">
              <!-- Export Configuration -->
              <div class="settings-card premium">
                <div class="settings-card-header">
                  <div class="settings-card-icon export">📤</div>
                  <div class="settings-card-title">Export Configuration</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Export your complete dashboard configuration with enriched metadata and analytics</p>
                  <div class="export-options">
                    <div class="export-option">
                      <label class="modern-checkbox">
                        <input type="checkbox" id="includeCalculatedMetrics" checked>
                        <span class="checkmark"></span>
                        Include calculated metrics & progress data
                      </label>
                    </div>
                    <div class="export-option">
                      <label class="modern-checkbox">
                        <input type="checkbox" id="includeAuditTrail" checked>
                        <span class="checkmark"></span>
                        Include audit trail & modification history
                      </label>
                    </div>
                    <div class="export-option">
                      <label class="modern-checkbox">
                        <input type="checkbox" id="includeSystemInfo">
                        <span class="checkmark"></span>
                        Include system info & environment details
                      </label>
                    </div>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-premium" id="exportAdminJSON" title="Export complete configuration">
                    <span class="btn-icon">📥</span>
                    <span class="btn-text">Export Configuration</span>
                    <span class="btn-glow"></span>
                  </button>
                </div>
              </div>
              
              <!-- Import Configuration -->
              <div class="settings-card premium">
                <div class="settings-card-header">
                  <div class="settings-card-icon import">📂</div>
                  <div class="settings-card-title">Import Configuration</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Import a previously exported configuration with full validation and integrity checks</p>
                  <div class="import-zone" id="importZone">
                    <div class="import-zone-content">
                      <div class="import-icon">📁</div>
                      <div class="import-text">
                        <strong>Drop JSON file here or click to browse</strong>
                        <span>Supports .json files up to 10MB</span>
                      </div>
                    </div>
                    <input type="file" id="importAdminJSON" accept=".json" class="import-file-input" />
                  </div>
                  <div class="import-validation-result" id="validationResult" style="display:none;">
                    <div class="validation-status">
                      <span class="status-icon">✅</span>
                      <span class="status-text">Configuration validated successfully</span>
                    </div>
                    <div class="validation-details"></div>
                  </div>
                </div>
              </div>
              
              <!-- Backup & Restore -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon backup">💿</div>
                  <div class="settings-card-title">Backup & Restore</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Create automatic backups and restore from previous versions</p>
                  <div class="backup-status">
                    <div class="backup-info">
                      <span class="backup-label">Last backup:</span>
                      <span class="backup-time" id="lastBackupTime">Never</span>
                    </div>
                    <div class="backup-size">
                      <span class="backup-label">Storage used:</span>
                      <span class="backup-value" id="storageUsed">0 KB</span>
                    </div>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-secondary" id="createBackupBtn">
                    <span class="btn-icon">💾</span>
                    Create Backup
                  </button>
                  <button class="btn btn-secondary" id="restoreBackupBtn">
                    <span class="btn-icon">⏮️</span>
                    Restore
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- System Preferences Section -->
          <div class="settings-category">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">⚙️</span>
                System Preferences
              </h4>
              <p class="category-description">Customize dashboard behavior and appearance</p>
            </div>
            
            <div class="settings-cards-grid">
              <!-- Performance Settings -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon performance">⚡</div>
                  <div class="settings-card-title">Performance</div>
                </div>
                <div class="settings-card-content">
                  <div class="settings-row">
                    <label class="settings-label">Animation Duration</label>
                    <div class="range-input-container">
                      <input type="range" id="animationSpeed" min="0.1" max="2" step="0.1" value="1" class="modern-range">
                      <span class="range-value" id="animationSpeedValue">1.0s</span>
                    </div>
                  </div>
                  <div class="settings-row">
                    <label class="settings-label">Auto-refresh Interval</label>
                    <select id="refreshInterval" class="modern-select">
                      <option value="0">Disabled</option>
                      <option value="5000">5 seconds</option>
                      <option value="10000">10 seconds</option>
                      <option value="30000" selected>30 seconds</option>
                      <option value="60000">1 minute</option>
                    </select>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableTransitions" checked>
                      <span class="checkmark"></span>
                      Enable smooth transitions
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Display Settings -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon display">🎨</div>
                  <div class="settings-card-title">Display</div>
                </div>
                <div class="settings-card-content">
                  <div class="settings-row">
                    <label class="settings-label">Theme Preference</label>
                    <div class="theme-selector">
                      <label class="theme-option">
                        <input type="radio" name="theme" value="auto" checked>
                        <span class="theme-preview auto">
                          <span class="theme-name">Auto</span>
                          <span class="theme-icon">🌓</span>
                        </span>
                      </label>
                      <label class="theme-option">
                        <input type="radio" name="theme" value="light">
                        <span class="theme-preview light">
                          <span class="theme-name">Light</span>
                          <span class="theme-icon">☀️</span>
                        </span>
                      </label>
                      <label class="theme-option">
                        <input type="radio" name="theme" value="dark">
                        <span class="theme-preview dark">
                          <span class="theme-name">Dark</span>
                          <span class="theme-icon">🌙</span>
                        </span>
                      </label>
                    </div>
                  </div>
                  <div class="settings-row">
                    <label class="settings-label">Density</label>
                    <select id="displayDensity" class="modern-select">
                      <option value="compact">Compact</option>
                      <option value="comfortable" selected>Comfortable</option>
                      <option value="spacious">Spacious</option>
                    </select>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="showTooltips" checked>
                      <span class="checkmark"></span>
                      Show helpful tooltips
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Notifications -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon notifications">🔔</div>
                  <div class="settings-card-title">Notifications</div>
                </div>
                <div class="settings-card-content">
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableNotifications" checked>
                      <span class="checkmark"></span>
                      Enable system notifications
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="notifyOnProgress">
                      <span class="checkmark"></span>
                      Notify when progress changes
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="notifyOnCompletion" checked>
                      <span class="checkmark"></span>
                      Notify when applications complete
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Security & Privacy Section -->
          <div class="settings-category">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">🔒</span>
                Security & Privacy
              </h4>
              <p class="category-description">Manage data security and privacy settings</p>
            </div>
            
            <div class="settings-cards-grid">
              <!-- Data Security -->
              <div class="settings-card security">
                <div class="settings-card-header">
                  <div class="settings-card-icon security">🛡️</div>
                  <div class="settings-card-title">Data Security</div>
                </div>
                <div class="settings-card-content">
                  <div class="security-status">
                    <div class="security-indicator active">
                      <span class="indicator-dot"></span>
                      <span class="indicator-text">Local storage encrypted</span>
                    </div>
                    <div class="security-indicator active">
                      <span class="indicator-dot"></span>
                      <span class="indicator-text">Session validation active</span>
                    </div>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableEncryption" checked>
                      <span class="checkmark"></span>
                      Encrypt local data storage
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableAuditLog" checked>
                      <span class="checkmark"></span>
                      Enable audit logging
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Privacy Controls -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon privacy">👁️</div>
                  <div class="settings-card-title">Privacy Controls</div>
                </div>
                <div class="settings-card-content">
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="shareUsageData">
                      <span class="checkmark"></span>
                      Share anonymous usage analytics
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableCrashReports">
                      <span class="checkmark"></span>
                      Send crash reports
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="settings-label">Data Retention Period</label>
                    <select id="dataRetention" class="modern-select">
                      <option value="30">30 days</option>
                      <option value="90" selected>90 days</option>
                      <option value="180">180 days</option>
                      <option value="365">1 year</option>
                      <option value="0">Indefinite</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Audit Trail -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon audit">📋</div>
                  <div class="settings-card-title">Audit Trail</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">View detailed log of all system changes and user actions</p>
                  <div class="audit-summary">
                    <div class="audit-stat">
                      <span class="audit-number" id="auditEntries">0</span>
                      <span class="audit-label">Total entries</span>
                    </div>
                    <div class="audit-stat">
                      <span class="audit-number" id="auditToday">0</span>
                      <span class="audit-label">Today</span>
                    </div>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-secondary" id="showAuditTrailBtn">
                    <span class="btn-icon">📋</span>
                    View Audit Trail
                  </button>
                  <button class="btn btn-secondary" id="exportAuditBtn">
                    <span class="btn-icon">📄</span>
                    Export Log
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- BU ANALYTICS EXPORT/IMPORT SECTION -->
          <div class="settings-category">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">📊</span>
                Team Collaboration
              </h4>
              <p class="category-description">Share Business Unit analytics with your team and integrate their data</p>
            </div>
            
            <!-- BU Analytics Card -->
            <div class="settings-cards-grid">
              <div class="settings-card bu-analytics-premium">
                <div class="settings-card-header">
                  <div class="settings-card-icon analytics">📊</div>
                  <div class="settings-card-title">BU Analytics Sharing</div>
                  <div class="analytics-badge">Team Collaboration</div>
                </div>
                
                <div class="settings-card-content">
                  <p class="settings-card-description">
                    Export analytics from a specific Business Unit and share with team members. Import their data to integrate into your main report.
                  </p>
                  
                  <!-- Main Actions Grid -->
                  <div class="bu-analytics-grid">
                    
                    <!-- Export Section -->
                    <div class="analytics-section export-section">
                      <div class="section-header">
                        <span class="section-icon">📤</span>
                        <h4 class="section-title">Export BU Analytics</h4>
                      </div>
                      
                      <div class="bu-selector-container">
                        <label class="selector-label">Select Business Unit</label>
                        <select id="buAnalyticsExportSelect" class="bu-analytics-select">
                          <option value="">-- Choose a Business Unit --</option>
                        </select>
                        <small class="selector-hint">📌 Select which BU's data to export</small>
                      </div>
                      
                      <div id="exportPreviewBox" class="preview-box" style="display:none;">
                        <div class="preview-header">
                          <span class="preview-icon">👁️</span>
                          <span class="preview-title">Export Preview</span>
                        </div>
                        <div class="preview-content">
                          <div class="preview-stat">
                            <span class="preview-label">Apps:</span>
                            <span class="preview-value" id="exportPreviewApps">0</span>
                          </div>
                          <div class="preview-stat">
                            <span class="preview-label">Avg Progress:</span>
                            <span class="preview-value" id="exportPreviewProgress">0%</span>
                          </div>
                          <div class="preview-stat">
                            <span class="preview-label">File Size:</span>
                            <span class="preview-value" id="exportPreviewSize">0 KB</span>
                          </div>
                        </div>
                      </div>
                      
                      <button class="btn btn-primary btn-export" id="exportBUAnalyticsBtn" disabled style="width:100%;margin-top:12px;">
                        <span class="btn-icon">📥</span>
                        <span class="btn-text">Export as JSON</span>
                      </button>
                    </div>
                    
                    <!-- Divider -->
                    <div class="analytics-divider"></div>
                    
                    <!-- Import Section -->
                    <div class="analytics-section import-section">
                      <div class="section-header">
                        <span class="section-icon">📥</span>
                        <h4 class="section-title">Import BU Analytics</h4>
                      </div>
                      
                      <div class="merge-strategy-container">
                        <label class="strategy-label">Merge Strategy</label>
                        <div class="strategy-options">
                          <label class="strategy-option">
                            <input type="radio" name="buMergeStrategy" value="replace" checked>
                            <span class="strategy-name">🔄 Replace</span>
                            <span class="strategy-desc">Replace entire BU data</span>
                          </label>
                          <label class="strategy-option">
                            <input type="radio" name="buMergeStrategy" value="merge">
                            <span class="strategy-name">🔗 Merge</span>
                            <span class="strategy-desc">Add new apps, update existing</span>
                          </label>
                          <label class="strategy-option">
                            <input type="radio" name="buMergeStrategy" value="append">
                            <span class="strategy-name">➕ Append</span>
                            <span class="strategy-desc">Add as new apps only</span>
                          </label>
                        </div>
                      </div>
                      
                      <div class="import-drop-zone" id="importDropZone">
                        <div class="drop-icon">📁</div>
                        <div class="drop-text">
                          <strong>Drop JSON file here or click to browse</strong>
                          <span class="drop-hint">Supports BU analytics files up to 5MB</span>
                        </div>
                      </div>
                      <input type="file" id="importBUAnalyticsFile" accept=".json" style="display:none;"/>
                      
                      <button class="btn btn-secondary btn-import" id="importBUAnalyticsBtn" disabled style="width:100%;margin-top:12px;">
                        <span class="btn-icon">📤</span>
                        <span class="btn-text">Select File to Import</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Waves Management Section -->
          <div class="settings-category">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">🌊</span>
                Waves Management
              </h4>
              <p class="category-description">Create and manage execution waves for your applications</p>
            </div>
            
            <div class="settings-card">
              <div class="settings-card-header">
                <div class="settings-card-icon">🌊</div>
                <div class="settings-card-title">Wave Catalog CRUD</div>
              </div>
              <div id="waveEditorContainer" style="min-height:300px;max-height:600px;overflow-y:auto;padding:12px;background:rgba(91,157,255,0.02);border:1px solid var(--ring);border-radius:8px">
                <!-- Waves table will be rendered here by AdminController.renderWavesEditor() -->
                <p style="text-align:center;color:#aaa;padding:24px">Loading waves...</p>
              </div>
            </div>
          </div>
          
          <!-- Danger Zone Section -->
          <div class="settings-category danger-zone">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">⚠️</span>
                Danger Zone
              </h4>
              <p class="category-description">Irreversible actions that affect your entire dashboard</p>
            </div>
            
            <div class="settings-cards-grid">
              <!-- Reset Configuration -->
              <div class="settings-card danger">
                <div class="settings-card-header">
                  <div class="settings-card-icon reset">🔄</div>
                  <div class="settings-card-title">Reset Configuration</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Reset all settings to factory defaults while preserving your data</p>
                  <div class="warning-box">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-text">This will reset all preferences, themes, and configurations to default values</div>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-warning" id="resetConfigBtn">
                    <span class="btn-icon">🔄</span>
                    Reset Settings
                  </button>
                </div>
              </div>
              
              <!-- Clear All Data -->
              <div class="settings-card danger">
                <div class="settings-card-header">
                  <div class="settings-card-icon delete">🗑️</div>
                  <div class="settings-card-title">Clear All Data</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Permanently delete all dashboard data including Business Units, Applications, and history</p>
                  <div class="danger-box">
                    <div class="danger-icon">🚨</div>
                    <div class="danger-text">
                      <strong>This action cannot be undone!</strong><br>
                      All Business Units, Applications, Progress data, and Settings will be permanently deleted.
                    </div>
                  </div>
                  <div class="deletion-checklist">
                    <label class="modern-checkbox danger">
                      <input type="checkbox" id="confirmDeletion1">
                      <span class="checkmark"></span>
                      I understand this will delete all Business Units
                    </label>
                    <label class="modern-checkbox danger">
                      <input type="checkbox" id="confirmDeletion2">
                      <span class="checkmark"></span>
                      I understand this will delete all Applications
                    </label>
                    <label class="modern-checkbox danger">
                      <input type="checkbox" id="confirmDeletion3">
                      <span class="checkmark"></span>
                      I have exported a backup if needed
                    </label>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-danger" id="clearAllDataBtn" disabled>
                    <span class="btn-icon">🗑️</span>
                    <span class="btn-text">Clear All Data</span>
                    <span class="btn-loading" style="display:none;">🔄</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- Settings Actions Footer -->
        <div class="settings-footer">
          <div class="settings-info">
            <div class="info-item">
              <span class="info-label">Configuration version:</span>
              <span class="info-value" id="configVersion">2.0.0</span>
            </div>
            <div class="info-item">
              <span class="info-label">Last modified:</span>
              <span class="info-value" id="lastModified">Never</span>
            </div>
            <div class="info-item">
              <span class="info-label">Storage used:</span>
              <span class="info-value" id="storageInfo">0 KB</span>
            </div>
          </div>
          <div class="settings-actions">
            <button class="btn btn-secondary" id="resetAllSettingsBtn">
              <span class="btn-icon">↺</span>
              Reset All Settings
            </button>
            <button class="btn btn-primary" id="saveSettingsBtn">
              <span class="btn-icon">💾</span>
              Save Changes
            </button>
          </div>
        </div>
      </div>
      
      <!-- Status Automation Confirmation Modal -->
      <div id="statusConfirmationModal" class="nested-modal">
        <div class="nested-modal-content" style="min-width:400px;max-width:600px">
          <h3 id="confirmTitle" style="margin:0 0 16px 0;font-size:20px;color:var(--text)">Confirm Status Change</h3>
          <p id="confirmMessage" style="margin:0 0 24px 0;color:var(--text-muted);line-height:1.6"></p>
          <div style="display:flex;gap:12px;margin-top:24px">
            <button id="confirmYes" class="btn btn-primary" style="flex:1">Yes, Proceed</button>
            <button id="confirmNo" class="btn btn-secondary" style="flex:1">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- BU Analytics Export Preview Modal -->
      <div id="buAnalyticsExportModal" class="nested-modal">
        <div class="nested-modal-content bu-analytics-modal">
          <div class="modal-header-premium">
            <h3 class="modal-title-premium">📊 Export Business Unit Analytics</h3>
            <button class="modal-close-premium" onclick="document.getElementById('buAnalyticsExportModal').classList.remove('active')">✕</button>
          </div>
          
          <div class="modal-body-premium">
            <div class="bu-export-info">
              <h4 id="exportBUName" class="export-bu-name">Business Unit Name</h4>
              <p id="exportBUMeta" class="export-bu-meta">Domain • Manager</p>
            </div>
            
            <div class="export-statistics-grid">
              <div class="stat-card">
                <div class="stat-icon">📱</div>
                <div class="stat-content">
                  <div class="stat-value" id="exportStatApps">0</div>
                  <div class="stat-label">Total Applications</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-content">
                  <div class="stat-value" id="exportStatComplete">0</div>
                  <div class="stat-label">Completed</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">🚧</div>
                <div class="stat-content">
                  <div class="stat-value" id="exportStatWIP">0</div>
                  <div class="stat-label">In Progress</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                  <div class="stat-value" id="exportStatProgress">0%</div>
                  <div class="stat-label">Avg Progress</div>
                </div>
              </div>
            </div>
            
            <div class="export-details">
              <h5 class="details-title">📋 Export Details</h5>
              <div class="details-list">
                <div class="detail-item">
                  <span class="detail-label">Format:</span>
                  <span class="detail-value">bu-analytics-v1.json</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Includes:</span>
                  <span class="detail-value">BU info, all apps, progress data, statistics</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Shareable:</span>
                  <span class="detail-value">✅ Yes - safe to send to teammates</span>
                </div>
              </div>
            </div>
            
            <div class="export-warning">
              <div class="warning-icon">ℹ️</div>
              <div class="warning-text">
                <strong>Export Ready</strong><br>
                Click "Download" to save this BU's analytics. Share the file with teammates to integrate their data.
              </div>
            </div>
          </div>
          
          <div class="modal-footer-premium">
            <button class="btn btn-secondary" onclick="document.getElementById('buAnalyticsExportModal').classList.remove('active')">
              Cancel
            </button>
            <button class="btn btn-primary" id="downloadBUAnalyticsBtn">
              <span class="btn-icon">⬇️</span>
              Download Analytics
            </button>
          </div>
        </div>
      </div>
      
      <!-- BU Analytics Import Preview Modal -->
      <div id="buAnalyticsImportModal" class="nested-modal">
        <div class="nested-modal-content bu-analytics-modal">
          <div class="modal-header-premium">
            <h3 class="modal-title-premium">📥 Import Business Unit Analytics</h3>
            <button class="modal-close-premium" onclick="document.getElementById('buAnalyticsImportModal').classList.remove('active')">✕</button>
          </div>
          
          <div class="modal-body-premium">
            <div class="import-source-info">
              <h4 id="importBUName" class="import-bu-name">Business Unit Name</h4>
              <p id="importBUMeta" class="import-bu-meta">Domain • Manager</p>
            </div>
            
            <div class="import-statistics-grid">
              <div class="stat-card">
                <div class="stat-icon">📱</div>
                <div class="stat-content">
                  <div class="stat-value" id="importStatApps">0</div>
                  <div class="stat-label">Applications</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-content">
                  <div class="stat-value" id="importStatComplete">0</div>
                  <div class="stat-label">Completed</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">🚧</div>
                <div class="stat-content">
                  <div class="stat-value" id="importStatWIP">0</div>
                  <div class="stat-label">In Progress</div>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-icon">📊</div>
                <div class="stat-content">
                  <div class="stat-value" id="importStatProgress">0%</div>
                  <div class="stat-label">Avg Progress</div>
                </div>
              </div>
            </div>
            
            <div class="merge-strategy-display">
              <h5 class="strategy-title">🔀 Merge Strategy</h5>
              <div id="importMergeStrategyDisplay" class="strategy-display"></div>
            </div>
            
            <div class="import-apps-preview">
              <h5 class="preview-title">📋 Applications to Import</h5>
              <div id="importAppsPreviewList" class="apps-preview-list" style="max-height:300px;overflow-y:auto;"></div>
            </div>
            
            <div class="import-notice">
              <div class="notice-icon">✅</div>
              <div class="notice-text">
                <strong>Ready to Import</strong><br>
                Review the data above and click "Confirm & Import" to integrate this BU's analytics.
              </div>
            </div>
          </div>
          
          <div class="modal-footer-premium">
            <button class="btn btn-secondary" onclick="document.getElementById('buAnalyticsImportModal').classList.remove('active')">
              Cancel
            </button>
            <button class="btn btn-primary" id="confirmBUImportBtn">
              <span class="btn-icon">✅</span>
              Confirm & Import
            </button>
          </div>
        </div>
      </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-primary" id="saveAdminBtn"><span class="btn-icon">💾</span> Save & Close</button>
        <button class="btn btn-secondary" id="cancelAdminBtn">Cancel</button>
      </div>
    </div>
  </div>

<!-- World-Class Tooltip Portal for Weight Factor 27 - Moved outside modal to be always accessible -->
<div id="factor27-tooltip" class="tooltip-portal" role="tooltip" aria-hidden="true">
  <div class="tooltip-content">
    <div class="tooltip-header">
      <h3>🎯 Why Factor 27?</h3>
      <button class="tooltip-close" aria-label="Close tooltip">✕</button>
    </div>
    <div class="tooltip-body">
      <div class="tooltip-section">
        <h4>📐 The Mathematics</h4>
        <p>The factor <strong>27</strong> represents the <strong>maximum possible product</strong> of your three priority dimensions:</p>
        <div class="formula-breakdown">
          <div class="factor-item">
            <span class="factor-name">Criticality</span>
            <span class="factor-range">1–3</span>
          </div>
          <div class="factor-item">
            <span class="factor-name">Business Impact</span>
            <span class="factor-range">1–3</span>
          </div>
          <div class="factor-item">
            <span class="factor-name">Priority</span>
            <span class="factor-range">1–3</span>
          </div>
        </div>
        <div class="math-proof">
          <span class="math-label">Maximum Product:</span>
          <span class="math-equation">3 × 3 × 3 = <strong>27</strong></span>
        </div>
      </div>

      <div class="tooltip-section">
        <h4>🔧 Why Is It Fixed?</h4>
        <div class="fixed-reasons">
          <div class="reason-card">
            <div class="reason-icon">1️⃣</div>
            <div class="reason-text">
              <strong>Normalization</strong>
              <p>Dividing by 27 converts any factor combination into the standardized <code>0–1</code> range, ensuring consistency across all calculations.</p>
            </div>
          </div>
          <div class="reason-card">
            <div class="reason-icon">2️⃣</div>
            <div class="reason-text">
              <strong>Controlled Scaling</strong>
              <p>Multiplying by 3 scales the normalized range to your final output range: <code>0.11–3.00</code>, maintaining mathematical integrity.</p>
            </div>
          </div>
          <div class="reason-card">
            <div class="reason-icon">3️⃣</div>
            <div class="reason-text">
              <strong>System Stability</strong>
              <p>Changing this value breaks the entire calibration. It guarantees minimum thresholds (1×1×1÷27×3 = 0.11) and maximum boundaries (3×3×3÷27×3 = 3.00).</p>
            </div>
          </div>
        </div>
      </div>

      <div class="tooltip-section">
        <h4>📊 Real-World Examples</h4>
        <div class="examples-grid">
          <div class="example-item">
            <div class="example-title">Lowest Priority</div>
            <div class="example-formula">[(1×1×1) ÷ 27] × 3</div>
            <div class="example-result">= 0.11</div>
          </div>
          <div class="example-item">
            <div class="example-title">Balanced</div>
            <div class="example-formula">[(2×2×2) ÷ 27] × 3</div>
            <div class="example-result">= 0.89</div>
          </div>
          <div class="example-item">
            <div class="example-title">Highest Priority</div>
            <div class="example-formula">[(3×3×3) ÷ 27] × 3</div>
            <div class="example-result">= 3.00</div>
          </div>
        </div>
      </div>

      <div class="tooltip-footer">
        <p><strong>💡 Key Insight:</strong> This fixed factor ensures that your prioritization system remains mathematically consistent and predictable, regardless of how many applications or workflows you manage.</p>
      </div>
    </div>
  </div>
  <div class="tooltip-backdrop" aria-hidden="true"></div>
</div>

  <!-- JavaScript Modules - Embedded directly to avoid CORS issues -->
  <!-- No external scripts - all code embedded inline to avoid CORS errors -->
<script>
/* ========== Data Loader Module - CRITICAL DATA INITIALIZATION ========== */
const DataLoader = {
  // EMBEDDED DATA - Direct JSON object to eliminate CORS issues
  EMBEDDED_DATA: {"business_units_catalog":[{"BU_ID":1,"BU_DOMAIN":"CORF","BU_NAME":"COMM","BU_FULLNAME":"Communications"},{"BU_ID":2,"BU_DOMAIN":"CORF","BU_NAME":"HR","BU_FULLNAME":"Human Resources"},{"BU_ID":3,"BU_DOMAIN":"CORF","BU_NAME":"PAY","BU_FULLNAME":"Payroll & Time Keeping"},{"BU_ID":4,"BU_DOMAIN":"CORF","BU_NAME":"ACC","BU_FULLNAME":"Accounting"},{"BU_ID":5,"BU_DOMAIN":"CORF","BU_NAME":"INV","BU_FULLNAME":"Invoicing"},{"BU_ID":6,"BU_DOMAIN":"CORF","BU_NAME":"CUSTI1","BU_FULLNAME":"Customs I (CCCCCS)"},{"BU_ID":7,"BU_DOMAIN":"CORF","BU_NAME":"CUSTI1","BU_FULLNAME":"Customs II (MX Applications)"},{"BU_ID":8,"BU_DOMAIN":"P&S","BU_NAME":"P&S","BU_FULLNAME":"Parts & Services"},{"BU_ID":9,"BU_DOMAIN":"P&S","BU_NAME":"PSC","BU_FULLNAME":"Purchase & Supply Chain"},{"BU_ID":10,"BU_DOMAIN":"GDPA","BU_NAME":"CDA3","BU_FULLNAME":"Global Digital Platforms and Automation"},{"BU_ID":11,"BU_DOMAIN":"SPP","BU_NAME":"SPP","BU_FULLNAME":"Standard Procedures & Performance"},{"BU_ID":12,"BU_DOMAIN":"EDSC","BU_NAME":"EDSC","BU_FULLNAME":"Engineering"}],"apps_catalog":[{"APP_ID":1,"BU_ID":10,"WAVE_ID":1,"APP_NAME":"XXX_APPLICATION_1_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"High","APP_BUSINESS_IMPACT":"High","APP_COMPLETION_PROGRESS":100.0,"APP_STATUS":"Completed"},{"APP_ID":2,"BU_ID":10,"WAVE_ID":1,"APP_NAME":"XXX_APPLICATION_2_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"Medium","APP_BUSINESS_IMPACT":"Medium","APP_COMPLETION_PROGRESS":100.0,"APP_STATUS":"Completed"},{"APP_ID":3,"BU_ID":1,"WAVE_ID":1,"APP_NAME":"XXX_APPLICATION_3_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"Medium","APP_BUSINESS_IMPACT":"Medium","APP_COMPLETION_PROGRESS":83.56,"APP_STATUS":"WIP"},{"APP_ID":4,"BU_ID":10,"WAVE_ID":2,"APP_NAME":"XXX_APPLICATION_4_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"Medium","APP_BUSINESS_IMPACT":"Medium","APP_COMPLETION_PROGRESS":0.0,"APP_STATUS":"TBS"},{"APP_ID":5,"BU_ID":2,"WAVE_ID":2,"APP_NAME":"XXX_APPLICATION_5_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"Low","APP_BUSINESS_IMPACT":"Low","APP_COMPLETION_PROGRESS":22.1,"APP_STATUS":"WIP"},{"APP_ID":6,"BU_ID":10,"WAVE_ID":2,"APP_NAME":"XXX_APPLICATION_6_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"High","APP_BUSINESS_IMPACT":"Low","APP_COMPLETION_PROGRESS":7.8,"APP_STATUS":"Completed"},{"APP_ID":7,"BU_ID":3,"WAVE_ID":2,"APP_NAME":"XXX_APPLICATION_7_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"Low","APP_BUSINESS_IMPACT":"High","APP_COMPLETION_PROGRESS":0.0,"APP_STATUS":"TBS"},{"APP_ID":8,"BU_ID":3,"WAVE_ID":3,"APP_NAME":"XXX_APPLICATION_8_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"Medium","APP_BUSINESS_IMPACT":"High","APP_COMPLETION_PROGRESS":53.3,"APP_STATUS":"WIP"},{"APP_ID":9,"BU_ID":10,"WAVE_ID":3,"APP_NAME":"XXX_APPLICATION_9_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"High","APP_BUSINESS_IMPACT":"Low","APP_COMPLETION_PROGRESS":0.0,"APP_STATUS":"TBS"},{"APP_ID":10,"BU_ID":11,"WAVE_ID":3,"APP_NAME":"XXX_APPLICATION_10_XXX","APP_PRIORITY_ORDER":null,"APP_CRITICALITY":"High","APP_BUSINESS_IMPACT":"Medium","APP_COMPLETION_PROGRESS":75.0,"APP_STATUS":"WIP"}],"waves_catalog":[{"WAVE_ID":1,"DESCRIPTION":"Wave 1"},{"WAVE_ID":2,"DESCRIPTION":"Wave 2"},{"WAVE_ID":3,"DESCRIPTION":"Wave 3"}]},
  
  getWaveCatalog() {
    /**
     * Phase 3: Dynamic Wave Resolution
     * Returns personalized waves from StorageManager if available
     * Falls back to EMBEDDED_DATA waves if none exist
     * 
     * This enables:
     * - User-defined custom waves
     * - Wave names persist across page reloads
     * - Runtime wave modifications (add/rename/delete)
     */
    try {
      // Check if StorageManager is initialized and has custom waves
      if (window.Dashboard && window.Dashboard.StorageManager) {
        const customWaves = Dashboard.StorageManager.getWaves();
        
        // If custom waves exist, convert them to EMBEDDED_DATA format and use them
        if (customWaves && customWaves.length > 0) {
          console.log('📊 [DataLoader] Using custom waves from StorageManager:', customWaves.length, 'waves');
          return customWaves.map(wave => ({
            WAVE_ID: wave.id,
            DESCRIPTION: wave.name
          }));
        }
      }
    } catch (err) {
      console.warn('⚠️ [DataLoader] Error reading custom waves:', err.message);
    }
    
    // Fallback to embedded data
    console.log('📊 [DataLoader] Using embedded waves from EMBEDDED_DATA');
    return this.EMBEDDED_DATA.waves_catalog || [];
  },
  
  async loadData() {
    try {
      // Use embedded data (eliminates all CORS issues)
      const jsonData = this.EMBEDDED_DATA;
      console.log('✅ [DataLoader] Using embedded data (zero-CORS architecture)');
      
      // Transform Business Units
      const businessUnits = (jsonData.business_units_catalog || []).map(bu => ({
        id: bu.BU_ID,
        key: bu.BU_DOMAIN,
        name: bu.BU_NAME,
        domain: bu.BU_DOMAIN,
        fullname: bu.BU_FULLNAME,
        apps: []
      }));
      
      // Transform Applications
      const apps = (jsonData.apps_catalog || []).map(app => ({
        id: app.APP_ID,
        buId: app.BU_ID,
        waveId: app.WAVE_ID,
        name: app.APP_NAME,
        status: app.APP_STATUS === "Completed" ? "CLO" : app.APP_STATUS === "WIP" ? "WIP" : "TBS",
        progress: app.APP_COMPLETION_PROGRESS || 0,
        criticality: app.APP_CRITICALITY || "Medium",
        impact: app.APP_BUSINESS_IMPACT || "Medium",
        priority: app.APP_PRIORITY || "Medium",
        order: app.APP_ID
      }));
      
      // ✅ Phase 3: Transform Waves - Use dynamic catalog instead of hardcoded EMBEDDED_DATA
      const waveCatalog = this.getWaveCatalog();  // Dynamic OR fallback to embedded
      const waves = (waveCatalog || []).map(wave => ({
        id: wave.WAVE_ID,
        name: wave.DESCRIPTION
      }));
      
      // PERSIST to localStorage (single source of truth)
      Dashboard.StorageManager.saveConfig({
        buses: businessUnits,
        apps: apps,
        waves: waves
      });
      
      console.log('✅ [DataLoader] Data persisted to localStorage:', { 
        buses: businessUnits.length, 
        apps: apps.length, 
        waves: waves.length 
      });
      return { businessUnits, apps, waves };
    } catch (error) {
      console.error("❌ [DataLoader] Error loading data:", error);
      return { businessUnits: [], apps: [], waves: [] };
    }
  }
};

if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.DataLoader = DataLoader;

/* ========== Storage Manager Module ========== */
const StorageManager = {
  STORAGE_KEY: 'dashboard_config_v1',
  CLEARED_FLAG: 'dashboard_user_cleared_v1',
  
  init() {
    // CRITICAL: Load embedded data FIRST before checking storage
    console.log('🚀 [StorageManager.init] Starting initialization...');
    
    // =========== SISTEMA DE DETECCIÓN DE BORRADO INTENCIONAL ===========
    console.log('🔍 [StorageManager.init] Verificando estado de los datos...');
    console.log('📊 [DIAGNÓSTICO INICIAL]', {
      localStorage_STORAGE_KEY: localStorage.getItem(this.STORAGE_KEY),
      localStorage_Keys: Object.keys(localStorage),
      DATA_length: DATA ? DATA.length : 'undefined',
      Dashboard_DATA_length: window.Dashboard && window.Dashboard.DATA ? window.Dashboard.DATA.length : 'undefined'
    });
    
    // 1. SOLO inicializar si no hay datos
    if (!localStorage.getItem(this.STORAGE_KEY)) {
      console.log('🔄 [StorageManager.init] No hay datos existentes, inicializando dashboard por defecto');
      console.log('📊 [INICIALIZACIÓN] Usando DATA con', DATA.length, 'elementos:', JSON.stringify(DATA));
      
      // Solo inicializar si DATA tiene elementos (de lo contrario, mantener vacío)
      if (DATA && DATA.length > 0) {
        this.saveConfig({
          buses: DATA.map((d, i) => ({
            id: i + 1,
            key: d.key,
            name: d.name,
            domain: 'CORF',
            fullname: d.name + ' Department',
            apps: []
          })),
          apps: [],
          waves: [
            { id: 1, name: 'Wave 1' },
            { id: 2, name: 'Wave 2' },
            { id: 3, name: 'Wave 3' },
            { id: 4, name: 'Wave 4' },
            { id: 5, name: 'Wave 5' }
          ]
        });
        console.log('✅ [StorageManager.init] Dashboard inicializado con datos por defecto');
      } else {
        console.log('✅ [StorageManager.init] DATA está vacío, manteniendo estado vacío');
        this.saveConfig({ buses: [], apps: [], waves: [] });
      }
    } else {
      console.log('ℹ️ [StorageManager.init] Datos existentes encontrados en localStorage');
    }
    
    // CRITICAL: Rebuild DATA array from storage (not from hardcode)
    console.log('🔄 [StorageManager.init] Reconstruyendo DATA desde storage...');
    rebuildDATAFromStorage();
  },
  
  loadConfig() {
    const config = localStorage.getItem(this.STORAGE_KEY);
    return config ? JSON.parse(config) : this.getDefaultConfig();
  },
  
  saveConfig(config) {
    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
  },
  
  getDefaultConfig() {
    return { buses: [], apps: [], waves: [] };
  },
  
  getBUs() {
    return this.loadConfig().buses || [];
  },
  
  getApps() {
    return this.loadConfig().apps || [];
  },
  
  getAppsByBU(buId) {
    return this.getApps().filter(app => app.buId === buId);
  },
  
  addBU(bu) {
    const config = this.loadConfig();
    bu.id = Math.max(...config.buses.map(b => b.id), 0) + 1;
    
    // Ensure all new properties are set with defaults
    bu.key = bu.domain; // Keep key and domain in sync
    bu.color = bu.color || '#5b9dff';
    bu.manager = bu.manager || '';
    
    config.buses.push(bu);
    this.saveConfig(config);
    return bu;
  },
  
  updateBU(buId, updates) {
    const config = this.loadConfig();
    const bu = config.buses.find(b => b.id === buId);
    if (bu) {
      // Ensure we preserve custom properties like color and manager
      Object.assign(bu, updates);
      // Make sure key and domain stay in sync
      bu.key = bu.domain;
    }
    this.saveConfig(config);
  },
  
  deleteBU(buId) {
    const config = this.loadConfig();
    config.buses = config.buses.filter(b => b.id !== buId);
    config.apps = config.apps.filter(a => a.buId !== buId);
    this.saveConfig(config);
  },
  
  addApp(app) {
    const config = this.loadConfig();
    app.id = Math.max(...config.apps.map(a => a.id || 0), 0) + 1;
    
    // Ensure all required fields have default values if not provided
    app.name = app.name || 'Unnamed App';
    app.buId = app.buId || null; // This should be caught by validation
    app.status = app.status || 'TBS';
    app.progress = app.progress || 0;
    app.criticality = app.criticality || 'Medium';
    app.impact = app.impact || 'Medium';
    app.priority = app.priority || 'Medium';
    app.order = app.order || 0;
    app.waveId = app.waveId || 1;  // Default to first wave ID
    app.weight = app.weight || 1;
    
    // Only add if it has a valid buId
    if (app.buId !== null && app.buId !== undefined) {
      config.apps.push(app);
      this.saveConfig(config);
    }
    
    return app;
  },
  
  updateApp(appId, updates) {
    const config = this.loadConfig();
    const app = config.apps.find(a => a.id === appId);
    if (app) Object.assign(app, updates);
    this.saveConfig(config);
  },
  
  deleteApp(appId) {
    const config = this.loadConfig();
    config.apps = config.apps.filter(a => a.id !== appId);
    this.saveConfig(config);
  },
  
  getWaves() {
    return this.loadConfig().waves || [];
  },
  
  addWave(wave) {
    const config = this.loadConfig();
    wave.id = Math.max(...config.waves.map(w => w.id), 0) + 1;
    config.waves.push(wave);
    this.saveConfig(config);
    return wave;
  },
  
  updateWave(waveId, updates) {
    const config = this.loadConfig();
    const wave = config.waves.find(w => w.id === waveId);
    if (wave) Object.assign(wave, updates);
    this.saveConfig(config);
  },
  
  deleteWave(waveId) {
    const config = this.loadConfig();
    const appsInWave = config.apps.filter(a => a.waveId === waveId);
    if (appsInWave.length > 0) {
      throw new Error('Cannot delete Wave ' + waveId + ': ' + appsInWave.length + ' application(s) still assigned');
    }
    config.waves = config.waves.filter(w => w.id !== waveId);
    this.saveConfig(config);
  },
  
  getAllApps() {
    return this.getApps();
  },
  
  getBUById(buId) {
    return this.getBUs().find(bu => bu.id === buId);
  },
  
  getWaveNameById(waveId) {
    const wave = this.getWaves().find(w => w.id === waveId);
    return wave ? wave.name : `Wave ${waveId}`;  // Fallback if not found
  },
  
  markAsCleared() {
    // Mark in sessionStorage so page reload doesn't auto-recreate data
    console.log('🚫 Marking data as INTENTIONALLY CLEARED');
    sessionStorage.clear(); // Limpiar cualquier valor previo
    sessionStorage.setItem(this.CLEARED_FLAG, 'INTENTIONALLY_CLEARED_BY_USER');
    
    // Verificar que se guardó correctamente
    const verifyFlag = sessionStorage.getItem(this.CLEARED_FLAG);
    console.log('✅ Verification - CLEARED_FLAG saved as:', verifyFlag);
  },
  
  // Función emergencia para restablecer datos si es necesario
  resetClearedFlag() {
    console.log('🔄 Resetting cleared flag - allowing data initialization');
    sessionStorage.removeItem(this.CLEARED_FLAG);
    return !sessionStorage.getItem(this.CLEARED_FLAG);
  },
  
  reassignApp(appId, newBuId) {
    console.log(`📋 [StorageManager] Reassigning app ${appId} to BU ${newBuId}`);
    
    const config = this.loadConfig();
    const app = config.apps.find(a => a.id === appId);
    
    if (!app) {
      console.error(`❌ App ${appId} not found`);
      return false;
    }
    
    const oldBuId = app.buId;
    const oldBU = config.buses.find(b => b.id === oldBuId);
    const newBU = config.buses.find(b => b.id === newBuId);
    
    if (!newBU) {
      console.error(`❌ Target BU ${newBuId} not found`);
      return false;
    }
    
    // Create audit entry
    const auditEntry = {
      timestamp: new Date().toISOString(),
      action: 'APP_REASSIGNED',
      appId: appId,
      appName: app.name,
      fromBuId: oldBuId,
      fromBuName: oldBU ? oldBU.name : 'Unknown',
      toBuId: newBuId,
      toBuName: newBU.name,
      status: app.status,
      progress: app.progress
    };
    
    // Update app
    app.buId = newBuId;
    
    // Initialize audit trail if doesn't exist
    if (!config.auditTrail) {
      config.auditTrail = [];
    }
    
    config.auditTrail.push(auditEntry);
    
    this.saveConfig(config);
    
    console.log(`✅ App reassigned: ${app.name} (${oldBU?.name} → ${newBU.name})`);
    console.log('📊 Audit entry:', auditEntry);
    
    return true;
  },
  
  getAuditTrail() {
    const config = this.loadConfig();
    return config.auditTrail || [];
  },
  
  clearAuditTrail() {
    const config = this.loadConfig();
    config.auditTrail = [];
    this.saveConfig(config);
    console.log('🗑️ Audit trail cleared');
  }
};

// Export module for namespace compatibility
if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.StorageManager = StorageManager;

// Load initial data from DataLoader (now that both are registered)
if (window.Dashboard && window.Dashboard.DataLoader) {
  window.Dashboard.DataLoader.loadData().then(result => {
    console.log('✅ [DataLoader] Data loaded and persisted to localStorage');
    rebuildDATAFromStorage();
  }).catch(err => {
    console.error('❌ [DataLoader] Failed to load data:', err);
  });
} else {
  console.warn('⚠️ [DataLoader] DataLoader not available');
}

/* ========== Progress Calculator Module ========== */
// REPLACEMENT FOR HARDCODED DATA ARRAY
// This is now DYNAMICALLY built from StorageManager, not hardcoded
// The old const DATA = [...] is REMOVED entirely

const DATA = [];  // Empty by default, populated from StorageManager

// Function to rebuild DATA from storage (single source of truth)
function rebuildDATAFromStorage() {
  DATA.length = 0;  // Clear array
  const buses = Dashboard.StorageManager.getBUs();
  
  buses.forEach(bus => {
    const apps = Dashboard.StorageManager.getAppsByBU(bus.id);
    let progress = 0;
    
    if (apps.length > 0) {
      const totalWeight = apps.reduce((sum, app) => sum + (app.weight || 1), 0);
      const weightedSum = apps.reduce((sum, app) => {
        return sum + ((app.progress || 0) * (app.weight || 1));
      }, 0);
      progress = totalWeight > 0 ? Math.round((weightedSum / totalWeight) * 100) / 100 : 0;
    }
    
    DATA.push({
      key: bus.key,
      name: bus.name,
      progress: progress
    });
  });
  
  console.log('🔄 [DATA] Rebuilt from storage:', JSON.stringify(DATA));
  return DATA;
}

const ProgressCalculator = {
  /**
   * Calculates automatic weight based on business factors
   * Formula: (Criticality × Business Impact × Priority) ÷ 27 * 3
   * Range: 0.11 to 3.0 (enterprise-grade scaling)
   */
  calculateAppWeight(app) {
    // Business factor weights (enterprise standard)
    const criticalityWeights = { Low: 1, Medium: 2, High: 3 };
    const businessImpactWeights = { Low: 1, Medium: 2, High: 3 };
    const priorityWeights = { Low: 1, Medium: 2, High: 3 };
    
    // Get values with defaults
    const criticality = criticalityWeights[app.criticality] || 2;
    const businessImpact = businessImpactWeights[app.impact] || 2;
    
    // Priority calculation: Use priority field if available, otherwise calculate from order
    let priority;
    if (app.priority && priorityWeights[app.priority]) {
      priority = priorityWeights[app.priority];
    } else {
      // Legacy: Priority calculation from order value 1-10 mapped to 1-3 scale
      // Order 1-3 = High priority (3), 4-7 = Medium (2), 8-10 = Low (1)
      const order = app.order || 5;
      priority = order <= 3 ? 3 : order <= 7 ? 2 : 1;
    }
    
    // Automatic weight calculation: normalized to 0.11-3.0 range
    const rawWeight = (criticality * businessImpact * priority) / 27 * 3;
    
    // Round to 2 decimals for precision
    return Math.round(rawWeight * 100) / 100;
  },
  
  calculateBUProgress(buId) {
    const apps = Dashboard.StorageManager.getAppsByBU(buId);
    if (apps.length === 0) return 0;
    
    // Get status inclusion configuration from checkboxes
    const includesTBS = document.getElementById('include-tbs')?.checked || false;
    const includesWIP = document.getElementById('include-wip')?.checked || true;
    const includesCLO = document.getElementById('include-clo')?.checked || true;
    
    // Filter apps based on status inclusion rules (DYNAMIC - not hardcoded)
    const activeApps = apps.filter(app => {
      if (app.status === 'TBS') return includesTBS;
      if (app.status === 'WIP') return includesWIP;
      if (app.status === 'CLO') return includesCLO;
      return true; // Include any other status by default
    });
    
    if (activeApps.length === 0) return 0;
    
    const weightedSum = activeApps.reduce((sum, app) => {
      const weight = this.calculateAppWeight(app); // Use automatic weight
      const progress = app.progress || 0;
      return sum + (progress * weight);
    }, 0);
    
    const totalWeight = activeApps.reduce((sum, app) => {
      return sum + this.calculateAppWeight(app); // Use automatic weight
    }, 0);
    
    return totalWeight > 0 ? Math.round((weightedSum / totalWeight) * 100) / 100 : 0;
  },
  
  recalculateAllBUsProgress() {
    const buses = Dashboard.StorageManager.getBUs();
    const updated = buses.map(bu => ({
      ...bu,
      computedProgress: this.calculateBUProgress(bu.id)
    }));
    return updated;
  },
  
  getEnhancedDATA() {
    // Devuelve DATA actualizado con progreso computado desde storage
    const buses = this.recalculateAllBUsProgress();
    return buses.map(bu => ({
      key: bu.key,
      name: bu.name,
      progress: bu.computedProgress || 0
    }));
  }
};

// Export module for namespace compatibility
if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.ProgressCalculator = ProgressCalculator;
window.Dashboard.DATA = DATA;

/* ========== UI Controller Module ========== */
const UIController = {
  state: { q: '', status: 'all', sort: 'progress', theme: 'dark', pinned: null },

  init() {
    // Load whitelabel titles from localStorage on UI init
    applyWhitelabelTitles();
    
    this.setupEventListeners();
    this.apply();
  },

  setupEventListeners() {
    // Controls
    document.querySelector('#q').addEventListener('input', e => {
      this.state.q = e.target.value;
      this.apply();
    });

    document.querySelector('#status').addEventListener('change', e => {
      this.state.status = e.target.value;
      this.apply();
    });

    Array.from(document.querySelectorAll('button[data-sort]')).forEach(b => b.addEventListener('click', e => {
      this.state.sort = e.target.dataset.sort;
      this.apply();
    }));

    document.querySelector('#theme').addEventListener('change', e => {
      const theme = e.target.checked ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      this.state.theme = theme;
      this.apply();
    });

    document.querySelector('#cinema').addEventListener('click', () => document.body.classList.toggle('cinematic'));
    document.querySelector('#exitCinema').addEventListener('click', () => {
      document.body.classList.remove('cinematic');
    });

    document.addEventListener('keydown', (ev) => {
      if (ev.key === '/' && document.activeElement.id !== 'q') {
        ev.preventDefault();
        document.querySelector('#q').focus();
      }
      if (ev.key === 'Enter' && document.activeElement.id === 'q') {
        ev.preventDefault();
        document.querySelector('#q').value = '';
        this.state.q = '';
        this.apply();
      }
      if (ev.key === 's') {
        this.state.sort = (this.state.sort === 'name' ? 'progress' : 'name');
        this.apply();
      }
      if (ev.key === 'x') {
        document.body.classList.toggle('cinematic');
      }
      // FIX: ESC primero limpia selección; si no hay selección, sale del modo cinemático
      if (ev.key === 'Escape') {
        if (this.state.pinned) {
          this.state.pinned = null;
          this.apply();
        } else if (document.body.classList.contains('cinematic')) {
          document.body.classList.remove('cinematic');
        }
      }
    });

    document.querySelector('#exportBars').addEventListener('click', () => this.svgToPNG(document.querySelector('#bars'), 2400, 1000, 'ranking_avance.png'));
    document.querySelector('#exportSVG').addEventListener('click', () => {
      const svg = document.querySelector('#bars').cloneNode(true);
      const sty = document.createElement('style');
      sty.textContent = `text{fill:${this.getCSS('--text')};font-family:${getComputedStyle(document.body).fontFamily}}`;
      svg.insertBefore(sty, svg.firstChild);
      const s = `<?xml version="1.0"?>` + new XMLSerializer().serializeToString(svg);
      this.download('ranking_avance.svg', s, 'image/svg+xml');
    });
    
    document.querySelector('#exportCSV').addEventListener('click', () => {
      const rows = Dashboard.DATA.map(d => `${d.name},${d.progress}`).join('\n');
      this.download('avance_por_area.csv', 'area,progress\n' + rows, 'text/csv');
    });

    // Click en hero gauge para ver apps detail
    document.querySelector('#heroGauge').addEventListener('click', () => {
      if (this.state.pinned) {
        const pinned = Dashboard.DATA.find(d => d.name === this.state.pinned);
        if (pinned) {
          const buId = Dashboard.StorageManager.getBUs().find(bu => bu.name === pinned.name)?.id;
          if (buId) {
            Dashboard.AdminController.currentBUId = buId;
            Dashboard.AdminController.openModal();
            Dashboard.AdminController.switchTab('apps');
            setTimeout(() => {
              const busSelect = document.querySelector('#appBUFilter');
              if (busSelect) busSelect.value = Dashboard.AdminController.currentBUId;
              Dashboard.AdminController.renderAppsEditor();
            }, 100);
          }
        }
      }
    });
  },

  getCSS(v) {
    return getComputedStyle(document.documentElement).getPropertyValue(v).trim();
  },

  fmt(n) {
    return `${n.toFixed(0)}%`;
  },

  color(p) {
    if (p === 100) return this.getCSS('--ok');
    if (p === 0) return this.getCSS('--danger');
    if (p >= 50) return this.getCSS('--warn');
    return this.getCSS('--low');
  },

  filtered() {
    let arr = Dashboard.DATA.filter(d => d.name.toLowerCase().includes(this.state.q.toLowerCase()));
    if (this.state.status === 'done') arr = arr.filter(d => d.progress === 100);
    if (this.state.status === 'wip') arr = arr.filter(d => d.progress > 0 && d.progress < 100);
    if (this.state.status === 'todo') arr = arr.filter(d => d.progress === 0);

    if (this.state.sort === 'name') arr.sort((a, b) => a.name.localeCompare(b.name));
    if (this.state.sort === 'progress') arr.sort((a, b) => b.progress - a.progress || a.name.localeCompare(b.name));
    return arr;
  },

  drawHero(avg) {
    const svg = document.querySelector('#heroGauge');
    svg.innerHTML = '';
    const W = 360, H = 360, cx = W / 2, cy = H / 2, r = 130, sw = 28, C = 2 * Math.PI * r;
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
    const lg = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
    lg.id = 'g';
    lg.setAttribute('x1', '0');
    lg.setAttribute('y1', '0');
    lg.setAttribute('x2', '1');
    lg.setAttribute('y2', '1');
    const stops = [['0%', '#4fd1ff'], ['50%', '#7affb3'], ['100%', '#ffd166']];
    stops.forEach(([o, c]) => {
      const s = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      s.setAttribute('offset', o);
      s.setAttribute('stop-color', c);
      lg.appendChild(s);
    });
    const f = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
    f.id = 'glow';
    f.innerHTML = '<feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>';
    defs.appendChild(lg);
    defs.appendChild(f);
    svg.appendChild(defs);

    const track = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    track.setAttribute('cx', cx);
    track.setAttribute('cy', cy);
    track.setAttribute('r', r);
    track.setAttribute('fill', 'none');
    track.setAttribute('stroke', this.getCSS('--ring'));
    track.setAttribute('stroke-width', sw);
    svg.appendChild(track);

    // grid
    for (let i = 0; i <= 10; i++) {
      const a = (i / 10) * Math.PI * 2 - Math.PI / 2, R = r + sw / 2, r2 = R + 8;
      const x1 = cx + Math.cos(a) * R, y1 = cy + Math.sin(a) * R, x2 = cx + Math.cos(a) * r2, y2 = cy + Math.sin(a) * r2;
      const L = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      L.setAttribute('x1', x1);
      L.setAttribute('y1', y1);
      L.setAttribute('x2', x2);
      L.setAttribute('y2', y2);
      L.setAttribute('stroke', this.getCSS('--grid'));
      L.setAttribute('stroke-width', (i % 5 === 0) ? 2 : 1);
      svg.appendChild(L);
    }

    const arc = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    arc.setAttribute('cx', cx);
    arc.setAttribute('cy', cy);
    arc.setAttribute('r', r);
    arc.setAttribute('fill', 'none');
    arc.setAttribute('stroke', 'url(#g)');
    arc.setAttribute('stroke-width', sw);
    arc.setAttribute('stroke-linecap', 'round');
    arc.setAttribute('transform', `rotate(-90 ${cx} ${cy})`);
    const target = C * (1 - avg / 100);
    const t0 = performance.now();
    const dur = 800;
    function step(t) {
      const k = Math.min(1, (t - t0) / dur);
      const ease = .5 * (1 - Math.cos(Math.PI * k));
      arc.setAttribute('stroke-dasharray', `${C} ${C}`);
      arc.setAttribute('stroke-dashoffset', target + (C - target) * (1 - ease));
      requestAnimationFrame(step);
    }
    arc.setAttribute('filter', 'url(#glow)');
    svg.appendChild(arc);

    const comet = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    comet.setAttribute('r', '6');
    comet.setAttribute('fill', '#ffffff');
    comet.setAttribute('opacity', '.9');
    svg.appendChild(comet);

    function step2() {
      const ang = -Math.PI / 2 + 2 * Math.PI * (avg / 100);
      const rr = r;
      const x = cx + Math.cos(ang) * rr, y = cy + Math.sin(ang) * rr;
      comet.setAttribute('cx', x);
      comet.setAttribute('cy', y);
      requestAnimationFrame(step2);
    }
    requestAnimationFrame(step);
    requestAnimationFrame(step2);
  },

  orbTile(d) {
    const wrap = document.createElement('div');
    wrap.className = 'tile';
    if (this.state.pinned === d.name) wrap.classList.add('pinned');
    wrap.dataset.name = d.name;
    wrap.dataset.progress = d.progress;

    const svgNS = 'http://www.w3.org/2000/svg';
    const svg = document.createElementNS(svgNS, 'svg');
    svg.setAttribute('viewBox', '0 0 100 100');
    svg.setAttribute('class', 'orb');

    const defs = document.createElementNS(svgNS, 'defs');
    const g = document.createElementNS(svgNS, 'linearGradient');
    g.id = 'g-' + d.name.replace(/\W/g, '');
    g.setAttribute('x1', '0');
    g.setAttribute('y1', '0');
    g.setAttribute('x2', '1');
    g.setAttribute('y2', '1');
    [['0%', '#5bdcff'], ['50%', this.color(Math.max(1, d.progress))], ['100%', '#ffd166']].forEach(([o, c]) => {
      const s = document.createElementNS(svgNS, 'stop');
      s.setAttribute('offset', o);
      s.setAttribute('stop-color', c);
      g.appendChild(s);
    });
    defs.appendChild(g);
    svg.appendChild(defs);

    const r = 34, cx = 50, cy = 50, sw = 10, C = 2 * Math.PI * r;
    const track = document.createElementNS(svgNS, 'circle');
    track.setAttribute('cy', cy);
    track.setAttribute('cx', cx);
    track.setAttribute('r', r);
    track.setAttribute('fill', 'none');
    track.setAttribute('stroke', this.getCSS('--ring'));
    track.setAttribute('stroke-width', sw);
    svg.appendChild(track);

    const fg = document.createElementNS(svgNS, 'circle');
    fg.setAttribute('cy', cy);
    fg.setAttribute('cx', cx);
    fg.setAttribute('r', r);
    fg.setAttribute('fill', 'none');
    fg.setAttribute('stroke', `url(#${g.id})`);
    fg.setAttribute('stroke-width', sw);
    fg.setAttribute('stroke-linecap', 'round');
    fg.setAttribute('transform', `rotate(-90 ${cx} ${cy})`);
    const target = C * (1 - d.progress / 100);
    const t0 = performance.now();
    const dur = 600 + d.progress * 2;
    function anim(t) {
      const k = Math.min(1, (t - t0) / dur);
      const ease = .5 * (1 - Math.cos(Math.PI * k));
      fg.setAttribute('stroke-dashoffset', target + (C - target) * (1 - ease));
      if (k < 1) requestAnimationFrame(anim);
    }
    fg.setAttribute('stroke-dasharray', `${C} ${C}`);
    svg.appendChild(fg);
    requestAnimationFrame(anim);

    const sat = document.createElementNS(svgNS, 'circle');
    sat.setAttribute('r', '3');
    sat.setAttribute('fill', '#fff');
    svg.appendChild(sat);
    function anim2() {
      const ang = -Math.PI / 2 + 2 * Math.PI * (d.progress / 100);
      const x = cx + Math.cos(ang) * r, y = cy + Math.sin(ang) * r;
      sat.setAttribute('cx', x);
      sat.setAttribute('cy', y);
      requestAnimationFrame(anim2);
    }
    requestAnimationFrame(anim2);

    const info = document.createElement('div');
    info.innerHTML = `<div class="name">${d.name}</div><div class="meta">${d.progress}%</div>`;
    const spot = document.createElement('div');
    spot.className = 'spot';
    wrap.appendChild(svg);
    wrap.appendChild(info);
    wrap.appendChild(spot);

    wrap.addEventListener('mouseenter', () => this.spotlight(d.name, true));
    wrap.addEventListener('mouseleave', () => this.spotlight(d.name, false));
    wrap.addEventListener('click', () => {
      this.state.pinned = (this.state.pinned === d.name ? null : d.name);
      this.apply();
    });

    return wrap;
  },

  spotlight(name, on) {
    if (this.state.pinned) return; // si hay selección, ignorar hover
    Array.from(document.querySelectorAll('#tiles .tile')).forEach(t => {
      t.style.opacity = on ? (t.dataset.name === name ? '1' : '.25') : '1';
    });
  },

  drawBars(items) {
    const svg = document.querySelector('#bars');
    svg.innerHTML = '';
    const W = 1100, H = 460, M = { t: 40, r: 24, b: 40, l: 150 };
    const w = W - M.l - M.r, h = H - M.t - M.b;
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

    // grid + etiquetas
    for (let i = 0; i <= 10; i++) {
      const x = M.l + (i / 10) * w;
      const L = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      L.setAttribute('x1', x);
      L.setAttribute('y1', M.t);
      L.setAttribute('x2', x);
      L.setAttribute('y2', M.t + h);
      L.setAttribute('stroke', this.getCSS('--grid'));
      L.setAttribute('stroke-width', (i % 2 === 0) ? 2 : 1);
      svg.appendChild(L);

      const T = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      T.setAttribute('x', x);
      T.setAttribute('y', M.t - 10);
      T.setAttribute('text-anchor', 'middle');
      T.setAttribute('font-size', '11');
      T.textContent = (i * 10) + '%';
      T.setAttribute('fill', this.getCSS('--text'));
      svg.appendChild(T);
    }

    const barH = Math.min(26, h / items.length - 10);
    items.forEach((d, i) => {
      const y = M.t + i * (barH + 10);

      const lab = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      lab.setAttribute('x', M.l - 12);
      lab.setAttribute('y', y + barH / 2);
      lab.setAttribute('text-anchor', 'end');
      lab.setAttribute('dominant-baseline', 'middle');
      lab.setAttribute('font-size', '13');
      lab.textContent = d.name;
      lab.setAttribute('fill', this.getCSS('--text'));
      svg.appendChild(lab);

      const track = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      track.setAttribute('x', M.l);
      track.setAttribute('y', y);
      track.setAttribute('width', w);
      track.setAttribute('height', barH);
      track.setAttribute('rx', '8');
      track.setAttribute('fill', this.getCSS('--ring'));
      svg.appendChild(track);

      const defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      if (!svg.querySelector('defs')) svg.appendChild(defs);
      const gid = 'gb' + i;
      const gr = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
      gr.id = gid;
      gr.setAttribute('x1', '0');
      gr.setAttribute('y1', '0');
      gr.setAttribute('x2', '1');
      gr.setAttribute('y2', '0');
      [['0%', this.color(Math.max(1, d.progress))], ['100%', '#ffd166']].forEach(([o, c]) => {
        const s = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        s.setAttribute('offset', o);
        s.setAttribute('stop-color', c);
        gr.appendChild(s);
      });
      defs.appendChild(gr);

      const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bar.setAttribute('x', M.l);
      bar.setAttribute('y', y);
      bar.setAttribute('width', '0');
      bar.setAttribute('height', barH);
      bar.setAttribute('fill', `url(#${gid})`);
      bar.style.filter = 'drop-shadow(0 2px 10px rgba(0,0,0,.2))';
      bar.dataset.target = w * d.progress / 100;
      svg.appendChild(bar);

      const gloss = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      gloss.setAttribute('x', M.l);
      gloss.setAttribute('y', y);
      gloss.setAttribute('width', '0');
      gloss.setAttribute('height', Math.max(2, barH * 0.35));
      gloss.setAttribute('rx', '6');
      gloss.setAttribute('fill', '#fff');
      gloss.setAttribute('opacity', '0.18');
      svg.appendChild(gloss);

      const v = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      v.setAttribute('x', M.l + 4);
      v.setAttribute('y', y + barH / 2);
      v.setAttribute('dominant-baseline', 'middle');
      v.setAttribute('font-size', '12');
      v.setAttribute('fill', this.getCSS('--text'));
      v.textContent = this.fmt(d.progress);
      svg.appendChild(v);
    });

    // ✅ FIX: seleccionar solo las barras animables por su data-attribute
    const bars = Array.from(svg.querySelectorAll('rect[data-target]'));
    const glosses = Array.from(svg.querySelectorAll('rect[rx="6"]'));
    bars.forEach((el, idx) => {
      const target = +el.dataset.target;
      const t0 = performance.now();
      const dur = 600;
      function step(t) {
        const k = Math.min(1, (t - t0) / dur);
        const ease = 1 - Math.pow(1 - k, 3);
        const w = Math.max(0, target * ease);
        el.setAttribute('width', w);
        if (glosses[idx]) glosses[idx].setAttribute('width', Math.max(0, w - 6));
        if (k < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    });
  },

  updateKPIs(items) {
    console.log('🔍 [updateKPIs] Actualizando KPIs con', items.length, 'items');
    
    const done = items.filter(d => d.progress === 100).length;
    const wip = items.filter(d => d.progress > 0 && d.progress < 100).length;
    const todo = items.filter(d => d.progress === 0).length;
    
    console.log('📊 [KPI] Conteo:', { done, wip, todo });
    
    const avg = Dashboard.DATA.length > 0 
      ? Dashboard.DATA.reduce((s, d) => s + (d.progress || 0), 0) / Dashboard.DATA.length 
      : 0;
      
    console.log('📊 [KPI] Promedio calculado:', avg);
    
    document.querySelector('#kpiDone').textContent = done;
    document.querySelector('#kpiWip').textContent = wip;
    document.querySelector('#kpiTodo').textContent = todo;
    document.querySelector('#kpiAvg').textContent = avg.toFixed(2) + '%';
  },

  renderTiles(items) {
    const box = document.querySelector('#tiles');
    box.innerHTML = '';
    items.forEach(d => box.appendChild(this.orbTile(d))); // posiciones fijas
    if (this.state.pinned) {
      Array.from(document.querySelectorAll('#tiles .tile')).forEach(t => t.style.opacity = (t.dataset.name === this.state.pinned ? '1' : '.18'));
    }
  },

  updateWaveDistributionChart() {
    /**
     * Update wave distribution chart titles dynamically
     * Instead of hardcoded 'Wave 1', 'Wave 2', 'Wave 3'
     */
    const waves = Dashboard.StorageManager.getWaves();
    const chartDivs = document.querySelector('#waveDistChart')?.querySelectorAll('div');
    
    if (!chartDivs || chartDivs.length === 0) return;
    
    // Update each bar title with dynamic wave name
    chartDivs.forEach((div, index) => {
      if (index < waves.length) {
        div.setAttribute('title', waves[index].name);
      }
    });
  },

  apply() {
    console.log('🔍 [UIController.apply] Iniciando actualización de UI');
    
    // CRITICAL: Rebuild DATA from storage first (single source of truth)
    rebuildDATAFromStorage();
    console.log('📊 [APPLY] DATA after rebuild:', JSON.stringify(DATA));
    
    // Get data from StorageManager (the single source of truth)
    const busesFromStorage = Dashboard.StorageManager.getBUs();
    console.log('📊 [STORAGE] BUs in storage:', JSON.stringify(busesFromStorage));
    console.log('🧹 [CLEARED] Flag state:', sessionStorage.getItem(Dashboard.StorageManager.CLEARED_FLAG));
    
    // If storage is empty (user cleared data), use empty items
    if (busesFromStorage.length === 0) {
      console.log('✅ [APPLY] Storage is empty - showing empty dashboard');
      const items = [];
      this.drawHero(0);
      document.querySelector('#heroPct').textContent = '0';
      document.querySelector('#heroCaption').textContent = 'Empty';
      this.renderTiles(items);
      this.drawBars(items);
      this.updateKPIs(items);
      return;
    }
    
    const items = this.filtered();
    const avgGlobal = DATA.length > 0 
      ? DATA.reduce((s, d) => s + (d.progress || 0), 0) / DATA.length 
      : 0;
    
    console.log('📊 [CALCULO] Progreso global:', avgGlobal, 'Items filtrados:', items.length);
    
    let heroValue = avgGlobal;
    let heroText = 'Avg';
    if (this.state.pinned) {
      const sel = Dashboard.DATA.find(d => d.name === this.state.pinned);
      if (sel) {
        heroValue = sel.progress;
        heroText = sel.name;
      }
    }
    this.drawHero(heroValue);
    document.querySelector('#heroPct').textContent = this.fmt(heroValue);
    document.querySelector('#heroCaption').textContent = heroText;

    this.renderTiles(items);
    this.drawBars(items);
    this.updateKPIs(items);
    this.updateWaveDistributionChart();  // ✅ Update wave chart titles dynamically
  },

  download(filename, text, type = 'text/plain') {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], { type }));
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  },

  svgToPNG(svgEl, w = 2200, h = 920, filename = 'chart.png') {
    const svg = new XMLSerializer().serializeToString(svgEl);
    const img = new Image();
    img.onload = function() {
      const c = document.createElement('canvas');
      c.width = w;
      c.height = h;
      const ctx = c.getContext('2d');
      ctx.fillStyle = UIController.getCSS('--bg');
      ctx.fillRect(0, 0, w, h);
      ctx.drawImage(img, 0, 0, w, h);
      c.toBlob(b => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      }, 'image/png');
    };
    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
  }
};

// Export module for namespace compatibility
if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.UIController = UIController;

/* ========== Whitelabel Dynamic Loader ========== */
function applyWhitelabelTitles() {
  const mainTitle = localStorage.getItem('wl_mainTitle');
  const subtitle = localStorage.getItem('wl_subtitle');
  
  const h1 = document.querySelector('#mainTitleDisplay');
  const small = document.querySelector('#subtitleDisplay');
  
  // CRITICAL: Only set if values exist in localStorage
  // NO fallbacks, NO defaults - only what's in persistent storage
  if (mainTitle !== null && h1) {
    h1.textContent = mainTitle;
  }
  if (subtitle !== null && small) {
    small.textContent = subtitle;
  }
}

/* ========== Admin Controller Module ========== */
const AdminController = {
  currentBUId: null,
  
  init() {
    // Load whitelabel titles dynamically
    applyWhitelabelTitles();
    
    // Initialize state
    this.currentOverviewFilters = { field: 'all', value: 'all' };
    this.currentOverviewSearch = '';
    this.currentSort = { column: null, direction: 'asc' };
    
    this.setupEventListeners();
    this.renderBUList();
  },
  
  setupEventListeners() {
    document.querySelector('#setupAdmin').addEventListener('click', () => this.openModal());
    document.querySelector('#closeAdminModal').addEventListener('click', () => this.closeModal());
    document.querySelector('#cancelAdminBtn').addEventListener('click', () => this.closeModal());
    document.querySelector('#saveAdminBtn').addEventListener('click', () => this.saveAndClose());
    
    // Weight Factor Tooltip
    const tooltipTrigger = document.querySelector('[data-tooltip-id="factor27-tooltip"]');
    const tooltip = document.getElementById('factor27-tooltip');
    const tooltipClose = tooltip?.querySelector('.tooltip-close');
    const tooltipBackdrop = tooltip?.querySelector('.tooltip-backdrop');

    if (tooltipTrigger) {
      tooltipTrigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = tooltip.getAttribute('aria-hidden') === 'false';
        tooltip.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
        tooltipTrigger.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
        if (!isOpen) {
          document.body.style.overflow = 'hidden';
          setTimeout(() => tooltip.querySelector('.tooltip-close')?.focus(), 50);
        } else {
          document.body.style.overflow = '';
        }
      });

      tooltipTrigger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          tooltipTrigger.click();
        }
      });
    }

    if (tooltipClose) {
      tooltipClose.addEventListener('click', () => {
        tooltip.setAttribute('aria-hidden', 'true');
        tooltipTrigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        tooltipTrigger.focus();
      });
    }

    if (tooltipBackdrop) {
      tooltipBackdrop.addEventListener('click', () => {
        tooltip.setAttribute('aria-hidden', 'true');
        tooltipTrigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        tooltipTrigger.focus();
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && tooltip && tooltip.getAttribute('aria-hidden') === 'false') {
        tooltip.setAttribute('aria-hidden', 'true');
        tooltipTrigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        tooltipTrigger.focus();
      }
    });

    // Save Formula Changes button
    const saveFFormulasBtn = document.getElementById('btn-save-formulas');
    if (saveFFormulasBtn) {
      saveFFormulasBtn.addEventListener('click', () => {
        console.log('💾 Saving formula changes...');
        // Collect current formula settings
        const formulaConfig = {
          timestamp: new Date().toISOString(),
          progressMethod: document.querySelector('input[name="progress-method"]:checked')?.value || 'weighted',
          globalMethod: document.getElementById('formula-global-method')?.value || 'weighted',
          statusInclusions: {
            tbs: document.getElementById('include-tbs')?.checked || false,
            wip: document.getElementById('include-wip')?.checked || true,
            done: document.getElementById('include-done')?.checked || true
          }
        };
        
        // Save to localStorage
        const config = Dashboard.StorageManager.loadConfig();
        config.formulaSettings = formulaConfig;
        Dashboard.StorageManager.saveConfig(config);
        
        // Visual feedback
        saveFFormulasBtn.style.background = 'linear-gradient(135deg,#32e685,#28c26e)';
        saveFFormulasBtn.innerHTML = '<span class="btn-icon">✅</span><span class="btn-text">Changes Saved!</span>';
        
        setTimeout(() => {
          saveFFormulasBtn.style.background = 'linear-gradient(135deg,#5b9dff,#4a8fd7)';
          saveFFormulasBtn.innerHTML = '<span class="btn-icon">💾</span><span class="btn-text">Save Formula Changes</span>';
        }, 2000);
        
        console.log('✅ Formula settings saved:', formulaConfig);
      });
    }
    
    // Tabs
    Array.from(document.querySelectorAll('.modal-tab')).forEach(tab => {
      tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
    });
    
    // Formula Tab event listeners
    document.getElementById('save-formula-config')?.addEventListener('click', () => this.saveFormulaConfig());
    document.getElementById('reset-formula-config')?.addEventListener('click', () => this.resetFormulaConfig());
    document.getElementById('test-formula-config')?.addEventListener('click', () => this.testFormulaConfig());
    
    // Formula dropdown change events
    document.getElementById('formula-progress-method')?.addEventListener('change', () => this.updateFormulaLabels());
    document.getElementById('formula-global-method')?.addEventListener('change', () => this.updateFormulaLabels());
    
    // BU Editor Modal (click outside to close)
    document.getElementById('buEditorModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('buEditorModal')) {
        this.closeBUEditorModal();
      }
    });
    
    // New BU button
    document.querySelector('#newBUBtn').addEventListener('click', () => this.newBU());
    
    // App filter
    document.querySelector('#appBUFilter').addEventListener('change', (e) => {
      this.currentBUId = parseInt(e.target.value);
      this.renderAppsEditor();
    });
    
    // Applications Overview filtering handled by AppsOverviewWorldClass module
    
    // Settings
    document.querySelector('#exportAdminJSON').addEventListener('click', () => this.exportConfig());
    document.querySelector('#importAdminJSON').addEventListener('change', (e) => this.importConfig(e));
    document.querySelector('#showAuditTrailBtn').addEventListener('click', () => this.showAuditTrail());
    document.querySelector('#clearAllDataBtn').addEventListener('click', () => this.clearAllData());
    
    // Whitelabel
    this.setupWhitelabelListeners();
  },
  
  setupWhitelabelListeners() {
    // Left logo
    document.querySelector('#leftLogoBrowseBtn').addEventListener('click', () => {
      document.querySelector('#leftLogoInput').click();
    });
    document.querySelector('#leftLogoInput').addEventListener('change', (e) => {
      this.handleLogoUpload(e, 'left');
    });
    document.querySelector('#leftLogoClearBtn').addEventListener('click', () => {
      this.clearLogo('left');
    });
    
    // Right logo
    document.querySelector('#rightLogoBrowseBtn').addEventListener('click', () => {
      document.querySelector('#rightLogoInput').click();
    });
    document.querySelector('#rightLogoInput').addEventListener('change', (e) => {
      this.handleLogoUpload(e, 'right');
    });
    document.querySelector('#rightLogoClearBtn').addEventListener('click', () => {
      this.clearLogo('right');
    });
    
    // Title inputs - update preview in real time (NO defaults - only what user enters)
    document.querySelector('#wl-mainTitle').addEventListener('input', (e) => {
      document.querySelector('#previewMainTitle').textContent = e.target.value;
    });
    document.querySelector('#wl-subtitle').addEventListener('input', (e) => {
      document.querySelector('#previewSubtitle').textContent = e.target.value;
    });
    
    // Save and reset buttons
    document.querySelector('#wl-saveBtn').addEventListener('click', () => this.saveWhitelabelConfig());
    document.querySelector('#wl-resetBtn').addEventListener('click', () => this.resetWhitelabelDefaults());
    
    // Load current whitelabel config on tab open
    this.loadWhitelabelConfig();
  },
  
  handleLogoUpload(event, side) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target.result;
      const preview = document.querySelector(side === 'left' ? '#leftLogoPreview' : '#rightLogoPreview');
      const previewDisplay = document.querySelector(side === 'left' ? '#previewLogoLeft' : '#previewLogoRight');
      
      // Clear existing content and add image
      preview.innerHTML = `<img src="${dataUrl}" alt="Logo"/>`;
      previewDisplay.innerHTML = `<img src="${dataUrl}" alt="Logo"/>`;
      
      // Store the data URL
      if (side === 'left') {
        localStorage.setItem('wl_leftLogo', dataUrl);
      } else {
        localStorage.setItem('wl_rightLogo', dataUrl);
      }
    };
    reader.readAsDataURL(file);
  },
  
  clearLogo(side) {
    const preview = document.querySelector(side === 'left' ? '#leftLogoPreview' : '#rightLogoPreview');
    const previewDisplay = document.querySelector(side === 'left' ? '#previewLogoLeft' : '#previewLogoRight');
    
    preview.innerHTML = '<span class="logo-placeholder">📷 ' + (side === 'left' ? 'Left' : 'Right') + ' Logo</span>';
    previewDisplay.innerHTML = '<span>' + (side === 'left' ? 'Logo' : 'Logo') + '</span>';
    
    if (side === 'left') {
      localStorage.removeItem('wl_leftLogo');
      document.querySelector('#leftLogoInput').value = '';
    } else {
      localStorage.removeItem('wl_rightLogo');
      document.querySelector('#rightLogoInput').value = '';
    }
  },
  
  loadWhitelabelConfig() {
    // Load titles (no defaults, only if they exist)
    const mainTitle = localStorage.getItem('wl_mainTitle');
    const subtitle = localStorage.getItem('wl_subtitle');
    
    const mainTitleInput = document.querySelector('#wl-mainTitle');
    const subtitleInput = document.querySelector('#wl-subtitle');
    const previewMainTitle = document.querySelector('#previewMainTitle');
    const previewSubtitle = document.querySelector('#previewSubtitle');
    
    if (mainTitle !== null) {
      mainTitleInput.value = mainTitle;
      previewMainTitle.textContent = mainTitle;
    } else {
      mainTitleInput.value = '';
      previewMainTitle.textContent = '';
    }
    
    if (subtitle !== null) {
      subtitleInput.value = subtitle;
      previewSubtitle.textContent = subtitle;
    } else {
      subtitleInput.value = '';
      previewSubtitle.textContent = '';
    }
    
    // Load logos
    const leftLogo = localStorage.getItem('wl_leftLogo');
    const rightLogo = localStorage.getItem('wl_rightLogo');
    
    if (leftLogo) {
      const leftPreview = document.querySelector('#leftLogoPreview');
      leftPreview.innerHTML = `<img src="${leftLogo}" alt="Left Logo"/>`;
      const leftDisplay = document.querySelector('#previewLogoLeft');
      leftDisplay.innerHTML = `<img src="${leftLogo}" alt="Left Logo"/>`;
    }
    
    if (rightLogo) {
      const rightPreview = document.querySelector('#rightLogoPreview');
      rightPreview.innerHTML = `<img src="${rightLogo}" alt="Right Logo"/>`;
      const rightDisplay = document.querySelector('#previewLogoRight');
      rightDisplay.innerHTML = `<img src="${rightLogo}" alt="Right Logo"/>`;
    }
  },
  
  saveWhitelabelConfig() {
    const mainTitle = document.querySelector('#wl-mainTitle').value;
    const subtitle = document.querySelector('#wl-subtitle').value;
    
    // Only save if values are provided (no defaults)
    if (mainTitle) {
      localStorage.setItem('wl_mainTitle', mainTitle);
    } else {
      localStorage.removeItem('wl_mainTitle');
    }
    
    if (subtitle) {
      localStorage.setItem('wl_subtitle', subtitle);
    } else {
      localStorage.removeItem('wl_subtitle');
    }
    
    // Apply changes dynamically to H1 and subtitle
    applyWhitelabelTitles();
    
    alert('✅ Whitelabel configuration saved successfully!');
    console.log('Whitelabel config saved:', { mainTitle, subtitle });
  },
  
  resetWhitelabelDefaults() {
    if (!confirm('Are you sure you want to reset all whitelabel settings to defaults?')) return;
    
    localStorage.removeItem('wl_mainTitle');
    localStorage.removeItem('wl_subtitle');
    localStorage.removeItem('wl_leftLogo');
    localStorage.removeItem('wl_rightLogo');
    
    // Clear UI
    document.querySelector('#wl-mainTitle').value = '';
    document.querySelector('#wl-subtitle').value = '';
    this.clearLogo('left');
    this.clearLogo('right');
    this.loadWhitelabelConfig();
    
    alert('✅ Whitelabel settings reset to defaults');
  },
  
  openModal() {
    document.querySelector('#adminModal').classList.add('active');
    this.renderBUList();
    this.renderBUFilter();
    this.initBUAnalytics();
    
    // Initialize waves editor for settings tab
    this.renderWavesEditor();
    
    // Si hay una BU seleccionada, actualizar el dropdown para reflejarla
    if (this.currentBUId) {
      const buFilter = document.querySelector('#appBUFilter');
      buFilter.value = this.currentBUId;
      
      // También marcar la tarjeta correspondiente como seleccionada
      const buCards = document.querySelectorAll('.bu-card');
      buCards.forEach(card => {
        const buId = parseInt(card.getAttribute('data-bu-id') || '0');
        if (buId === this.currentBUId) {
          card.classList.add('selected');
        }
      });
      
      // Actualizar la vista de aplicaciones
      this.renderAppsEditor();
    }
    
    // Modal content now uses consistent responsive sizing via CSS
    
  },
  
  closeModal() {
    document.querySelector('#adminModal').classList.remove('active');
  },
  
  switchTab(tabName) {
    Array.from(document.querySelectorAll('.modal-tab')).forEach(t => t.classList.remove('active'));
    Array.from(document.querySelectorAll('.modal-tabpanel')).forEach(p => p.classList.remove('active'));
    document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
    document.querySelector('#tab-' + tabName).classList.add('active');
    
    // Modal content uses responsive CSS sizing - no JS overrides needed
    
    // Initialize specific tab content
    if (tabName === 'app-overview') {
      console.log('Switching to Applications Overview tab');
      // Initialize filters and render table
      this.currentOverviewFilters = { field: 'all', value: 'all' };
      const filterField = document.querySelector('#overviewFilterField');
      if (filterField) filterField.value = 'all';
      const filterValue = document.querySelector('#overviewFilterValue');
      if (filterValue) filterValue.value = 'all';
    } else if (tabName === 'formulas') {
      console.log('🚀 Switching to Enterprise Calculation Formulas tab');
      // Initialize the new enterprise formula calculator
      setTimeout(() => {
        this.initializeFormulaCalculator();
        this.renderApplicationsImpactMatrix();
      }, 100);
      // Load formula configuration
      this.loadFormulaConfig();
    }
    
    // Solo renderizar la vista de aplicaciones si estamos en esa pestaña
    if (tabName === 'app-overview') {
      // Applications Overview is now handled by AppsOverviewWorldClass module
      // this.renderAppsOverview();
    }
  },
  
  renderBUList() {
    const buses = Dashboard.StorageManager.getBUs();
    const container = document.querySelector('#buList');
    container.innerHTML = '';
    
    buses.forEach(bu => {
      const apps = Dashboard.StorageManager.getAppsByBU(bu.id);
      const progress = Dashboard.ProgressCalculator.calculateBUProgress(bu.id);
      const card = document.createElement('div');
      card.className = 'bu-card';
      // Añadir data-bu-id para facilitar la selección al reabrir el modal
      card.setAttribute('data-bu-id', bu.id);
      // Add a class if the BU has no apps
      if (apps.length === 0) {
        card.classList.add('empty');
      }
      // Marcar como seleccionada si coincide con currentBUId
      if (this.currentBUId === bu.id) {
        card.classList.add('selected');
      }

      // Calculate the number of apps by status
      const appsDone = apps.filter(app => app.progress === 100 || app.status === 'CLO').length;
      const appsWIP = apps.filter(app => app.progress > 0 && app.progress < 100 && app.status !== 'CLO').length;
      const appsTodo = apps.filter(app => app.progress === 0 || app.status === 'TBS').length;
      
      // Get color based on progress
      const getColor = (p) => {
        if (p === 100) return 'var(--ok)';
        if (p === 0) return 'var(--danger)';
        if (p >= 50) return 'var(--warn)';
        return 'var(--low)';
      };
      
      card.innerHTML = `
        <div class="bu-card-actions">
          <button class="bu-card-btn edit-bu-btn" title="Edit" data-buid="${bu.id}">✏️</button>
          <button class="bu-card-btn delete-bu-btn" title="Delete" data-buid="${bu.id}">🗑️</button>
        </div>
        <div class="bu-card-name">
          <span class="bu-card-icon" style="background:${getColor(progress)};color:#fff;border-radius:4px;">${bu.domain.charAt(0)}</span>
          ${bu.name} ${apps.length === 0 ? '<span class="bu-empty-badge">Empty</span>' : ''}
        </div>
        <div class="bu-card-meta"><span class="bu-card-icon" title="Domain">🏢</span>${bu.domain} · ${bu.fullname}</div>
        <div class="bu-card-meta">
          <span class="bu-card-icon" title="Applications">📱</span>Apps: ${apps.length} 
          ${apps.length > 0 ? `<span title="Completed">✅ ${appsDone}</span> <span title="In Progress">⏳ ${appsWIP}</span> <span title="To Start">🔜 ${appsTodo}</span>` : ''}
        </div>
        <div class="bu-card-progress">
          <div class="bu-card-progress-bar" style="width:${progress}%; background:${getColor(progress)}"></div>
        </div>
        <div class="bu-card-meta"><span class="bu-card-icon" title="Progress">📊</span>Progress: <strong>${progress.toFixed(1)}%</strong></div>
      `;
      // Add click event for selecting the BU
      card.addEventListener('click', (e) => {
        // Don't select if clicking on the action buttons
        if (!e.target.closest('.bu-card-btn')) {
          this.selectBU(bu.id, card);
        }
      });
      
      // Add event handlers for edit and delete buttons
      const editBtn = card.querySelector('.edit-bu-btn');
      const deleteBtn = card.querySelector('.delete-bu-btn');
      
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent BU selection
        this.editBU(bu.id);
      });
      
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent BU selection
        this.deleteBU(bu.id);
      });
      container.appendChild(card);
    });
  },
  
  selectBU(buId, element) {
    Array.from(document.querySelectorAll('.bu-card')).forEach(c => c.classList.remove('selected'));
    element.classList.add('selected');
    this.currentBUId = buId;
  },
  
  newBU() {
    this.openBUEditorModal();
  },
  
  openBUEditorModal(buId = null) {
    // Get BU data if editing, or set defaults for new BU
    const isNewBU = buId === null;
    let bu = { 
      name: '', 
      domain: '', 
      fullname: '', 
      manager: '',
      color: '#5b9dff'
    };
    
    if (!isNewBU) {
      bu = Dashboard.StorageManager.getBUById(buId);
      if (!bu) return;
      
      // Set default values if they're missing
      if (!bu.color) bu.color = '#5b9dff';
      if (!bu.manager) bu.manager = '';
    }
    
    // Set the modal title and adjust style based on operation
    const buEditorTitle = document.getElementById('buEditorTitle');
    buEditorTitle.textContent = isNewBU ? '✨ Create New Business Unit' : '✏️ Edit Business Unit';
    
    // Set form values
    document.getElementById('buNameInput').value = bu.name;
    document.getElementById('buDomainInput').value = bu.domain;
    document.getElementById('buFullnameInput').value = bu.fullname;
    
    // Set color and manager if available
    const colorInput = document.getElementById('buColorInput');
    colorInput.value = bu.color || '#5b9dff';
    document.getElementById('colorPreview').style.backgroundColor = colorInput.value;
    
    // Manager field (might be new)
    const managerInput = document.getElementById('buManagerInput');
    if (managerInput) managerInput.value = bu.manager || '';
    
    // Setup color picker interaction
    colorInput.addEventListener('input', function() {
      document.getElementById('colorPreview').style.backgroundColor = this.value;
    });
    
    // Show statistics if editing an existing BU
    if (!isNewBU) {
      const apps = Dashboard.StorageManager.getAppsByBU(buId);
      const progress = Dashboard.ProgressCalculator.calculateBUProgress(buId);
      
      // Calculate apps by status
      const appsDone = apps.filter(app => app.progress === 100 || app.status === 'CLO').length;
      const appsWIP = apps.filter(app => app.progress > 0 && app.progress < 100 && app.status !== 'CLO').length;
      const appsTodo = apps.filter(app => app.progress === 0 || app.status === 'TBS').length;
      
      const statsDiv = document.getElementById('buEditorStats');
      
      statsDiv.innerHTML = `
        <div class="form-stats">
          <div class="form-stats-title">Business Unit Statistics</div>
          <div class="form-stats-item">
            <span>Applications Total:</span>
            <span><strong>${apps.length}</strong></span>
          </div>
          <div class="form-stats-item">
            <span>Applications by Status:</span>
            <span>
              <span title="Completed" style="margin-right:8px">✅ ${appsDone}</span>
              <span title="In Progress" style="margin-right:8px">⏳ ${appsWIP}</span>
              <span title="To Start">🔜 ${appsTodo}</span>
            </span>
          </div>
          <div class="form-stats-item">
            <span>Overall Progress:</span>
            <span>
              <div style="width:100px;height:10px;background:var(--ring);border-radius:5px;overflow:hidden;display:inline-block;vertical-align:middle;margin-right:8px">
                <div style="height:100%;background:${this.getProgressColor(progress)};width:${progress}%"></div>
              </div>
              <strong>${progress.toFixed(1)}%</strong>
            </span>
          </div>
          <div class="form-stats-item">
            <span>Status:</span>
            <span>${progress === 100 ? 
              '<span style="color:var(--ok)">✅ Complete</span>' : 
              progress > 0 ? '<span style="color:var(--warn)">🚧 In Progress</span>' : 
              '<span style="color:var(--danger)">🔜 Not Started</span>'
            }</span>
          </div>
        </div>
      `;
    } else {
      document.getElementById('buEditorStats').innerHTML = '';
    }
    
    // Show the modal with animation
    const modal = document.getElementById('buEditorModal');
    modal.classList.add('active');
    
    // Focus on the first input with delay to allow animation to complete
    setTimeout(() => document.getElementById('buNameInput').focus(), 300);
    
    // Setup form validation and submission
    const form = document.getElementById('buEditorForm');
    
    // Remove any existing event listeners
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Set up real-time validation
    const nameInput = document.getElementById('buNameInput');
    const domainInput = document.getElementById('buDomainInput');
    const fullnameInput = document.getElementById('buFullnameInput');
    
    // Validate name field
    nameInput.addEventListener('input', () => {
      const name = nameInput.value.trim();
      const nameError = document.getElementById('buNameError');
      
      if (name.length === 0) {
        nameError.textContent = "Business Unit name is required";
      } else if (name.length < 2) {
        nameError.textContent = "Name must be at least 2 characters";
      } else {
        nameError.textContent = "";
      }
    });
    
    // Validate domain field
    domainInput.addEventListener('input', () => {
      const domain = domainInput.value.trim();
      const domainError = document.getElementById('buDomainError');
      
      if (domain.length === 0) {
        domainError.textContent = "Domain code is required";
      } else if (!/^[A-Z0-9]{1,4}$/.test(domain)) {
        domainError.textContent = "Domain must be 1-4 uppercase letters/numbers";
        domainInput.value = domain.toUpperCase(); // Auto convert to uppercase
      } else {
        domainError.textContent = "";
      }
    });
    
    // Validate fullname field
    fullnameInput.addEventListener('input', () => {
      const fullname = fullnameInput.value.trim();
      const fullnameError = document.getElementById('buFullnameError');
      
      if (fullname.length === 0) {
        fullnameError.textContent = "Full name is required";
      } else if (fullname.length < 4) {
        fullnameError.textContent = "Full name must be at least 4 characters";
      } else {
        fullnameError.textContent = "";
      }
    });
    
    // Add submit event listener with validation
    newForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      // Get form values
      const name = nameInput.value.trim();
      const domain = domainInput.value.trim();
      const fullname = fullnameInput.value.trim();
      const color = colorInput.value;
      const manager = document.getElementById('buManagerInput')?.value?.trim() || '';
      
      // Validate all fields
      let isValid = true;
      
      // Name validation
      if (name.length === 0) {
        document.getElementById('buNameError').textContent = "Business Unit name is required";
        isValid = false;
      } else if (name.length < 2) {
        document.getElementById('buNameError').textContent = "Name must be at least 2 characters";
        isValid = false;
      } else {
        document.getElementById('buNameError').textContent = "";
      }
      
      // Domain validation
      if (domain.length === 0) {
        document.getElementById('buDomainError').textContent = "Domain code is required";
        isValid = false;
      } else if (!/^[A-Z0-9]{1,4}$/.test(domain)) {
        document.getElementById('buDomainError').textContent = "Domain must be 1-4 uppercase letters/numbers";
        isValid = false;
      } else {
        document.getElementById('buDomainError').textContent = "";
      }
      
      // Fullname validation
      if (fullname.length === 0) {
        document.getElementById('buFullnameError').textContent = "Full name is required";
        isValid = false;
      } else if (fullname.length < 4) {
        document.getElementById('buFullnameError').textContent = "Full name must be at least 4 characters";
        isValid = false;
      } else {
        document.getElementById('buFullnameError').textContent = "";
      }
      
      if (!isValid) {
        return; // Stop submission if any validation fails
      }
      
      // Update or create BU with all fields
      if (isNewBU) {
        Dashboard.StorageManager.addBU({
          key: domain,
          name,
          domain,
          fullname,
          color,
          manager
        });
      } else {
        Dashboard.StorageManager.updateBU(buId, {
          key: domain,
          name,
          domain,
          fullname,
          color,
          manager
        });
      }
      
      // Show success message with animation
      const successMessage = document.createElement('div');
      successMessage.className = 'form-success';
      successMessage.textContent = `Business Unit ${isNewBU ? 'created' : 'updated'} successfully!`;
      newForm.appendChild(successMessage);
      
      // Close modal with a small delay to show success message
      setTimeout(() => {
        this.closeBUEditorModal();
        
        // Refresh UI
        this.renderBUList();
        this.renderBUFilter();
        
        // If apps tab is visible and this BU is selected, refresh the apps editor
        if (!isNewBU && this.currentBUId === buId && document.querySelector('#tab-apps.active')) {
          this.renderAppsEditor();
        }
        
        // Refresh the UI controller to update visualizations
        Dashboard.UIController.apply();
      }, 800);
    });
    
    // Setup cancel button
    document.getElementById('buEditorCancel').addEventListener('click', () => {
      this.closeBUEditorModal();
    });
    
    // Setup close button
    document.getElementById('closeBUEditorModal').addEventListener('click', () => {
      this.closeBUEditorModal();
    });
  },
  
  // Helper function to get color based on progress
  getProgressColor(progress) {
    if (progress === 100) return 'var(--ok)';
    if (progress === 0) return 'var(--danger)';
    if (progress >= 50) return 'var(--warn)';
    return 'var(--low)';
  },
  
  closeBUEditorModal() {
    document.getElementById('buEditorModal').classList.remove('active');
  },
  
  editBU(buId) {
    this.openBUEditorModal(buId);
  },
  
  deleteBU(buId) {
    const bu = Dashboard.StorageManager.getBUById(buId);
    if (!bu) return;
    
    const apps = Dashboard.StorageManager.getAppsByBU(buId);
    
    // Confirm deletion
    const message = apps.length > 0 ? 
      `Are you sure you want to delete the Business Unit "${bu.name}" and all its ${apps.length} applications?` :
      `Are you sure you want to delete the Business Unit "${bu.name}"?`;
      
    if (!confirm(message)) return;
    
    // Delete the BU
    Dashboard.StorageManager.deleteBU(buId);
    
    // Reset current BU ID if it was deleted
    if (this.currentBUId === buId) {
      this.currentBUId = null;
    }
    
    // Refresh the BU list
    this.renderBUList();
    
    // Refresh BU filter in apps tab
    this.renderBUFilter();
    
    // Clear apps editor if this BU was selected
    if (document.querySelector('#tab-apps.active')) {
      const container = document.querySelector('#appEditorContainer');
      container.innerHTML = '<p>Please select a Business Unit</p>';
    }
  },
  
  renderBUFilter() {
    const buses = Dashboard.StorageManager.getBUs();
    const select = document.querySelector('#appBUFilter');
    select.innerHTML = '<option value="">-- Select BU --</option>';
    buses.forEach(bu => {
      const opt = document.createElement('option');
      opt.value = bu.id;
      opt.textContent = bu.name;
      select.appendChild(opt);
    });
  },

  /**
   * Validate progress input - Must be integer 0-100
   */
  validateProgressInput(value) {
    if (typeof value !== 'number') {
      return { valid: false, error: 'Progress must be a number' };
    }
    if (!Number.isInteger(value)) {
      return { valid: false, error: 'Progress must be a whole number (0-100)' };
    }
    if (value < 0 || value > 100) {
      return { valid: false, error: 'Progress must be between 0 and 100' };
    }
    if (isNaN(value)) {
      return { valid: false, error: 'Progress is not a valid number' };
    }
    return { valid: true, error: null };
  },

  /**
   * Detect transition type based on old and new progress values
   */
  detectProgressTransition(oldProgress, newProgress) {
    const validation = this.validateProgressInput(newProgress);
    if (!validation.valid) {
      return { type: 'INVALID', requiresPopup: true, error: validation.error };
    }
    if (oldProgress === newProgress) {
      return { type: 'NONE', requiresPopup: false };
    }
    if (oldProgress < 100 && newProgress === 100) {
      return { type: 'COMPLETION', requiresPopup: true, celebration: true };
    }
    if (oldProgress === 0 && newProgress > 0) {
      return { type: 'START', requiresPopup: true };
    }
    if (oldProgress > 0 && newProgress === 0) {
      return { type: 'RESET', requiresPopup: true };
    }
    if (oldProgress === 100 && newProgress < 100) {
      return { type: 'REOPEN', requiresPopup: true, sadness: true };
    }
    if (oldProgress > 0 && oldProgress < 100 && newProgress > 0 && newProgress < 100) {
      return { type: 'UPDATE', requiresPopup: false };
    }
    return { type: 'INVALID', requiresPopup: true, error: 'Invalid progress transition' };
  },

  /**
   * Show progress confirmation popup with 4 types
   */
  showProgressPopup(type, oldProgress, newProgress, app) {
    return new Promise((resolve) => {
      const backdrop = document.createElement('div');
      backdrop.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000';
      const popup = document.createElement('div');
      popup.style.cssText = 'background:var(--panel);border:2px solid var(--ring);border-radius:16px;padding:24px;max-width:400px;min-width:300px;box-shadow:0 10px 40px rgba(0,0,0,0.5)';
      let title, message, confirmText, confirmStyle, themeColor;
      switch (type) {
        case 'START':
          title = '🚀 Start Activity';
          message = `Change status from 'To Be Started' to 'In Progress'? (${oldProgress}% → ${newProgress}%)`;
          confirmText = 'Start Task';
          confirmStyle = 'background:var(--primary);color:white';
          themeColor = 'var(--primary)';
          break;
        case 'COMPLETION':
          title = '🎉 Congratulations!';
          message = `You've completed this task! Confirm to mark as Completed? (${oldProgress}% → 100%)`;
          confirmText = 'Celebrate & Complete';
          confirmStyle = 'background:#FFD700;color:black;font-weight:bold';
          themeColor = '#FFD700';
          break;
        case 'REOPEN':
          title = '😢 Reopening Completed Task';
          message = `Are you sure? This will change status back to 'In Progress'. (100% → ${newProgress}%)`;
          confirmText = 'Reopen Task';
          confirmStyle = 'background:var(--text);color:var(--bg);opacity:0.8';
          themeColor = 'var(--text)';
          break;
        case 'RESET':
          title = '⚠️ Reset Activity to Zero';
          message = `This will mark the task as 'Not Started' and remove all progress. (${oldProgress}% → 0%)`;
          confirmText = 'Reset to Zero';
          confirmStyle = 'background:#FF9500;color:white';
          themeColor = '#FF9500';
          break;
        default:
          resolve(false);
          return;
      }
      popup.innerHTML = `<div style="border-bottom:3px solid ${themeColor};margin-bottom:16px;padding-bottom:12px"><h3 style="margin:0;color:var(--text);font-size:20px">${title}</h3><p style="margin:8px 0 0 0;color:var(--text);opacity:0.7;font-size:14px;font-weight:normal">App: <strong>${app.name}</strong></p></div><p style="color:var(--text);margin:16px 0;line-height:1.5">${message}</p><div style="display:flex;gap:12px;margin-top:24px;justify-content:flex-end"><button id="popupCancel" style="padding:8px 16px;border:1px solid var(--ring);background:transparent;color:var(--text);border-radius:8px;cursor:pointer;font-size:14px">Cancel</button><button id="popupConfirm" style="padding:8px 16px;border:none;${confirmStyle};border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold">✓ ${confirmText}</button></div>`;
      backdrop.appendChild(popup);
      document.body.appendChild(backdrop);
      const cleanup = () => { backdrop.remove(); };
      popup.querySelector('#popupCancel').addEventListener('click', () => {
        cleanup();
        resolve(false);
      });
      popup.querySelector('#popupConfirm').addEventListener('click', () => {
        cleanup();
        resolve(true);
      });
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          cleanup();
          resolve(false);
        }
      });
      const escHandler = (e) => {
        if (e.key === 'Escape') {
          document.removeEventListener('keydown', escHandler);
          cleanup();
          resolve(false);
        }
      };
      document.addEventListener('keydown', escHandler);
    });
  },

  async handleProgressChange(appId, inputElement) {
    const oldVal = Dashboard.StorageManager.getApps().find(a => a.id === appId)?.progress || 0;
    const newVal = parseInt(inputElement.value, 10);
    const confirmed = await this.onProgressEdit(appId, newVal, oldVal);
    if (!confirmed) {
      inputElement.value = oldVal;
    }
  },

  async onProgressEdit(appId, newProgressValue, originalValue) {
    const app = Dashboard.StorageManager.getAllApps().find(a => a.id === appId);
    if (!app) {
      return false;
    }
    
    const oldProgress = originalValue !== undefined ? originalValue : (app.progress || 0);
    const newProgress = parseInt(newProgressValue, 10);
    
    const validation = this.validateProgressInput(newProgress);
    if (!validation.valid) {
      return false;
    }
    
    const transition = this.detectProgressTransition(oldProgress, newProgress);
    
    if (transition.type === 'INVALID') {
      return false;
    }
    
    if (transition.type === 'NONE') {
      return false;
    }
    
    if (transition.requiresPopup) {
      const confirmed = await this.showProgressPopup(transition.type, oldProgress, newProgress, app);
      if (!confirmed) {
        return false;
      }
    }
    
    let newStatus = app.status;
    if (transition.type === 'START') {
      newStatus = 'WIP';
    } else if (transition.type === 'COMPLETION') {
      newStatus = 'CLO';
    } else if (transition.type === 'REOPEN') {
      newStatus = 'WIP';
    } else if (transition.type === 'RESET') {
      newStatus = 'TBS';
    } else if (transition.type === 'UPDATE') {
      newStatus = 'WIP';
    }
    
    // Mandatory synchronization: Progress value ALWAYS dictates Status
    if (newProgress === 0) {
      newStatus = 'TBS';  // Progress=0 must always be To Be Started
    } else if (newProgress === 100) {
      newStatus = 'CLO';  // Progress=100 must always be Closed
    } else if (newProgress > 0 && newProgress < 100) {
      newStatus = 'WIP';  // Progress(1-99) must always be Work In Progress
    }
    
    const updates = {
      progress: newProgress,
      status: newStatus,
      updatedAt: new Date().toISOString(),
      updatedBy: 'Local Edit'
    };
    
    Dashboard.StorageManager.updateApp(appId, updates);
    this.renderAppsEditor();
    Dashboard.UIController.apply();
    return true;
  },

  showStatusConfirmation(appId, type, newProgress, appName = '') {
    const modal = document.getElementById('statusConfirmationModal');
    const titleEl = document.getElementById('confirmTitle');
    const messageEl = document.getElementById('confirmMessage');
    const yesBtn = document.getElementById('confirmYes');
    const noBtn = document.getElementById('confirmNo');
    
    if (!modal || !titleEl || !messageEl || !yesBtn || !noBtn) {
      console.error('Status confirmation modal elements not found');
      return;
    }
    
    let title, message, newStatus;
    
    if (type === 'start') {
      title = '🚀 Start Application?';
      message = `Ready to start "<strong>${appName}</strong>"? This will change status from <strong>TBS</strong> to <strong>WIP</strong>.`;
      newStatus = 'WIP';
    } else if (type === 'complete') {
      title = '✅ Mark as Complete?';
      message = `Ready to mark "<strong>${appName}</strong>" as complete? This will change status from <strong>WIP</strong> to <strong>CLO</strong>.`;
      newStatus = 'CLO';
    } else {
      return;
    }
    
    titleEl.textContent = title;
    messageEl.innerHTML = message;
    
    const newYesBtn = yesBtn.cloneNode(true);
    const newNoBtn = noBtn.cloneNode(true);
    yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
    noBtn.parentNode.replaceChild(newNoBtn, noBtn);
    
    const updatedYesBtn = document.getElementById('confirmYes');
    const updatedNoBtn = document.getElementById('confirmNo');
    
    updatedYesBtn.addEventListener('click', () => {
      this.handleStatusTransition(appId, newStatus, newProgress);
      modal.classList.remove('active');
    });
    
    updatedNoBtn.addEventListener('click', () => {
      modal.classList.remove('active');
      const appRow = document.querySelector(`tr[data-app-id="${appId}"]`);
      if (appRow) {
        const progressInput = appRow.querySelector('input[type="number"]');
        if (progressInput) {
          const currentApp = Dashboard.StorageManager.getAllApps().find(a => a.id === appId);
          progressInput.value = currentApp ? (currentApp.progress || 0) : 0;
        }
      }
    });
    
    modal.classList.add('active');
  },

  handleStatusTransition(appId, newStatus, newProgress) {
    Dashboard.StorageManager.updateApp(appId, {
      status: newStatus,
      progress: newProgress
    });
    this.renderAppsEditor();
    Dashboard.UIController.apply();
  },

  // Helper function to generate wave options dynamically
  generateWaveOptions(currentWave = null) {
    const config = Dashboard.StorageManager.loadConfig();
    let options = '';
    
    if (config.waves && config.waves.length > 0) {
      config.waves.forEach(wave => {
        const isSelected = (currentWave || config.waves[0].name) === wave.name;
        options += `<option value="${wave.name}" ${isSelected ? 'selected' : ''}>🌊 ${wave.name}</option>`;
      });
    } else {
      // Fallback if no waves in dataset - use StorageManager to get first wave dynamically
      const allWaves = Dashboard.StorageManager.getWaves();
      if (allWaves.length > 0) {
        const firstWave = allWaves[0];
        options = `<option value="${firstWave.name}" ${!currentWave || currentWave === firstWave.name ? 'selected' : ''}>🌊 ${firstWave.name}</option>`;
      } else {
        // If no waves at all, create placeholder
        options = `<option value="No Waves">No Waves Available</option>`;
      }
    }
    
    return options;
  },
  
  renderAppsEditor() {
    if (!this.currentBUId) return;
    const bu = Dashboard.StorageManager.getBUs().find(b => b.id === this.currentBUId);
    const apps = Dashboard.StorageManager.getAppsByBU(this.currentBUId);
    const container = document.querySelector('#appEditorContainer');
    
    let html = `<div class="apps-editor-header">
      <h3>${bu.name} Applications</h3>
      <button class="btn btn-primary" onclick="Dashboard.AdminController.openAppEditorModal(${this.currentBUId})"><span class="btn-icon">✨</span> Add Application</button>
    </div>
    <div class="apps-table-wrapper">
      <table class="app-table">
        <thead>
          <tr>
            <th title="Application Name">App Name</th>
            <th title="Execution Wave">🌊 Wave</th>
            <th title="Execution Order">🔢 Order</th>
            <th title="Status: TBS/WIP/CLO">Status</th>
            <th title="Progress Percentage">Progress %</th>
            <th title="Weight Factor (Auto-calculated)">Weight <small>(Auto)</small></th>
            <th title="Criticality Level">Criticality</th>
            <th title="Business Impact">Impact</th>
            <th title="Priority Order">Priority</th>
            <th title="Actions">Actions</th>
          </tr>
        </thead>
        <tbody>`;
    
    if (apps.length === 0) {
      html += `<tr class="empty-row"><td colspan="10" style="text-align:center;padding:40px;color:var(--muted)">
        <div style="font-size:32px;margin-bottom:8px">📭</div>
        <div>No applications yet. <button class="link-btn" onclick="Dashboard.AdminController.openAppEditorModal(${this.currentBUId})" style="color:var(--primary);text-decoration:underline;cursor:pointer;background:none;border:none;padding:0;font:inherit">Create one now</button></div>
      </td></tr>`;
    } else {
      apps.forEach(app => {
        const statusBadge = app.status === 'CLO' ? '✅' : app.status === 'WIP' ? '🚧' : '🔜';
        const criticalityColor = app.criticality === 'High' ? 'var(--danger)' : app.criticality === 'Medium' ? 'var(--warn)' : 'var(--ok)';
        const impactColor = app.impact === 'High' ? 'var(--danger)' : app.impact === 'Medium' ? 'var(--warn)' : 'var(--ok)';
        
        html += `
        <tr data-app-id="${app.id}">
          <td><input type="text" class="cell-input" value="${app.name}" onchange="Dashboard.AdminController.updateApp(${app.id}, {name: this.value})"/></td>
          <td><select class="cell-select" onchange="Dashboard.AdminController.updateApp(${app.id}, {wave: this.value})">
            ${this.generateWaveOptions(app.wave)}
          </select></td>
          <td><input type="number" class="cell-input order-input" min="1" max="100" value="${app.order || 0}" onchange="Dashboard.AdminController.updateApp(${app.id}, {order: parseInt(this.value)})" style="width:80px;text-align:center;font-weight:600;"/></td>
          <td><span class="cell-status-badge" data-status="${app.status}" style="padding:6px 12px;border-radius:8px;font-weight:600;font-size:14px;display:inline-block;${app.status === 'TBS' ? 'background:rgba(255,95,122,0.15);color:#ff5f7a' : app.status === 'WIP' ? 'background:rgba(255,209,102,0.15);color:#ffd166' : 'background:rgba(50,230,133,0.15);color:#32e685'}">${app.status === 'TBS' ? '🔜 TBS' : app.status === 'WIP' ? '🚧 WIP' : '✅ CLO'}</span></td>
          <td><div class="progress-cell"><input type="number" class="cell-input" min="0" max="100" value="${app.progress || 0}" onchange="Dashboard.AdminController.handleProgressChange(${app.id}, this)"/><div class="mini-progress" style="width:${app.progress}%;background:${app.progress === 100 ? 'var(--ok)' : app.progress >= 50 ? 'var(--warn)' : 'var(--low)'}"></div></div></td>
          <td><span class="auto-weight">${Dashboard.ProgressCalculator.calculateAppWeight(app).toFixed(2)}</span></td>
          <td><select class="cell-select" onchange="Dashboard.AdminController.updateApp(${app.id}, {criticality: this.value})">
            <option value="Low" ${app.criticality === 'Low' ? 'selected' : ''}>🟢 Low</option>
            <option value="Medium" ${app.criticality === 'Medium' ? 'selected' : ''}>🟡 Medium</option>
            <option value="High" ${app.criticality === 'High' ? 'selected' : ''}>🔴 High</option>
          </select></td>
          <td><select class="cell-select" onchange="Dashboard.AdminController.updateApp(${app.id}, {impact: this.value})">
            <option value="Low" ${app.impact === 'Low' ? 'selected' : ''}>🟢 Low</option>
            <option value="Medium" ${app.impact === 'Medium' ? 'selected' : ''}>🟡 Medium</option>
            <option value="High" ${app.impact === 'High' ? 'selected' : ''}>🔴 High</option>
          </select></td>
          <td><select class="cell-select" onchange="Dashboard.AdminController.updateApp(${app.id}, {priority: this.value})">
            <option value="Low" ${app.priority === 'Low' ? 'selected' : ''}>🟢 Low</option>
            <option value="Medium" ${app.priority === 'Medium' ? 'selected' : ''}>🟡 Medium</option>
            <option value="High" ${app.priority === 'High' ? 'selected' : ''}>🔴 High</option>
          </select></td>
          <td style="display: flex; gap: 8px;">
            <button class="btn btn-info btn-sm" onclick="Dashboard.AdminController.openReassignModal(${app.id})">🔄 Reassign</button>
            <button class="btn btn-danger btn-sm" onclick="Dashboard.AdminController.deleteApp(${app.id})">🗑️ Delete</button>
          </td>
        </tr>`;
      });
    }
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
  },
  
  openAppEditorModal(buId = null) {
    // If no buId provided, use current selected
    if (buId === null) buId = this.currentBUId;
    if (!buId) return;
    
    // Set modal title
    document.getElementById('appEditorTitle').textContent = '✨ Create New Application';
    
    // Reset form
    document.getElementById('appNameInput').value = '';
    document.getElementById('appStatusInput').value = 'TBS';
    document.getElementById('appProgressInput').value = 0;
    document.getElementById('appCriticalityInput').value = 'Medium';
    document.getElementById('appImpactInput').value = 'Medium';
    document.getElementById('appPriorityInput').value = 'Medium';
    
    // Initialize progress state for modal transitions
    let modalProgressState = {
      currentProgress: 0,
      previousStatus: 'TBS'
    };
    
    // Populate Wave dropdown dynamically from dataset
    const config = Dashboard.StorageManager.loadConfig();
    const waveSelect = document.getElementById('appWaveInput');
    waveSelect.innerHTML = ''; // Clear existing options
    
    if (config.waves && config.waves.length > 0) {
      config.waves.forEach(wave => {
        const option = document.createElement('option');
        option.value = wave.name;
        option.textContent = wave.name;
        waveSelect.appendChild(option);
      });
      waveSelect.value = config.waves[0].name; // Select first wave by default
    } else {
      // Fallback if no waves in dataset - use StorageManager dynamically
      const allWaves = Dashboard.StorageManager.getWaves();
      if (allWaves.length > 0) {
        allWaves.forEach(wave => {
          const option = document.createElement('option');
          option.value = wave.name;
          option.textContent = wave.name;
          waveSelect.appendChild(option);
        });
        waveSelect.value = allWaves[0].name; // Select first wave by default
      } else {
        // No waves available at all
        const option = document.createElement('option');
        option.value = 'No Waves';
        option.textContent = 'No Waves Available';
        waveSelect.appendChild(option);
        waveSelect.value = 'No Waves';
      }
    }
    
    // Function to recalculate weight preview
    const recalculateWeightPreview = () => {
      const criticality = document.getElementById('appCriticalityInput').value;
      const impact = document.getElementById('appImpactInput').value;
      const priority = document.getElementById('appPriorityInput').value;
      const order = 5; // Default middle priority
      
      const mockApp = { criticality, impact, priority, order };
      const weight = Dashboard.ProgressCalculator.calculateAppWeight(mockApp);
      document.getElementById('weightPreview').textContent = weight.toFixed(2);
    };
    
    // Initial calculation
    recalculateWeightPreview();
    
    // Clear errors
    document.getElementById('appNameError').textContent = '';
    
    // Clear stats
    document.getElementById('appEditorStats').innerHTML = '';
    
    // Show modal
    const modal = document.getElementById('appEditorModal');
    modal.classList.add('active');
    
    // Focus on first input
    setTimeout(() => document.getElementById('appNameInput').focus(), 300);
    
    // Setup form submission
    const form = document.getElementById('appEditorForm');
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Add event listeners to recalculate on change (AFTER cloning form to bind to new elements)
    document.getElementById('appCriticalityInput').addEventListener('change', recalculateWeightPreview);
    document.getElementById('appImpactInput').addEventListener('change', recalculateWeightPreview);
    document.getElementById('appPriorityInput').addEventListener('change', recalculateWeightPreview);
    
    // Real-time validation
    document.getElementById('appNameInput').addEventListener('input', () => {
      const name = document.getElementById('appNameInput').value.trim();
      const nameError = document.getElementById('appNameError');
      if (name.length === 0) {
        nameError.textContent = "Application name is required";
      } else if (name.length < 3) {
        nameError.textContent = "Name must be at least 3 characters";
      } else {
        nameError.textContent = "";
      }
    });
    
    // Progress change handler with transition validation
    document.getElementById('appProgressInput').addEventListener('change', async (e) => {
      const newProgress = parseInt(e.target.value, 10) || 0;
      const oldProgress = modalProgressState.currentProgress;
      
      // Validate transition
      const transition = this.detectProgressTransition(oldProgress, newProgress);
      
      if (transition.type === 'INVALID') {
        e.target.value = oldProgress;
        console.warn('Invalid transition:', transition.error);
        return;
      }
      
      if (transition.type === 'NONE') {
        return; // No change needed
      }
      
      // Show popup if transition requires confirmation
      if (transition.requiresPopup) {
        const appName = document.getElementById('appNameInput').value.trim() || 'New Application';
        const confirmed = await this.showProgressPopup(transition.type, oldProgress, newProgress, { name: appName });
        if (!confirmed) {
          e.target.value = oldProgress;
          return;
        }
      }
      
      // Update status based on transition
      let newStatus = 'WIP';
      if (transition.type === 'START') {
        newStatus = 'WIP';
      } else if (transition.type === 'COMPLETION') {
        newStatus = 'CLO';
      } else if (transition.type === 'REOPEN') {
        newStatus = 'WIP';
      } else if (transition.type === 'RESET') {
        newStatus = 'TBS';
      } else if (transition.type === 'UPDATE') {
        newStatus = 'WIP';
      }
      
      // Update modal state
      modalProgressState.currentProgress = newProgress;
      modalProgressState.previousStatus = newStatus;
      document.getElementById('appStatusInput').value = newStatus;
    });
    
    // Form submission
    newForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const name = document.getElementById('appNameInput').value.trim();
      const status = document.getElementById('appStatusInput').value;
      const progress = parseInt(document.getElementById('appProgressInput').value) || 0;
      const criticality = document.getElementById('appCriticalityInput').value;
      const impact = document.getElementById('appImpactInput').value;
      const priority = document.getElementById('appPriorityInput').value;
      const wave = document.getElementById('appWaveInput').value;
      
      // Validate
      let isValid = true;
      if (name.length === 0) {
        document.getElementById('appNameError').textContent = "Application name is required";
        isValid = false;
      } else if (name.length < 3) {
        document.getElementById('appNameError').textContent = "Name must be at least 3 characters";
        isValid = false;
      }
      
      if (!isValid) return;
      
      // Get next priority
      const allApps = Dashboard.StorageManager.getAllApps();
      const maxPriority = allApps.length > 0 ? Math.max(...allApps.map(app => parseInt(app.order) || 0)) : 0;
      
      // Create app
      Dashboard.StorageManager.addApp({
        buId,
        name,
        status,
        progress,
        criticality,
        impact,
        priority,
        wave,
        order: maxPriority + 1
      });
      
      // Close modal
      this.closeAppEditorModal();
      
      // Refresh UI
      this.renderAppsEditor();
      if (document.querySelector('#tab-app-overview.active')) {
        // Applications Overview is now handled by AppsOverviewWorldClass module
        // this.renderAppsOverview();
      }
      
      // Show success
      Dashboard.UIController.apply();
    });
    
    // Cancel button
    document.getElementById('appEditorCancel').addEventListener('click', () => {
      this.closeAppEditorModal();
    });
    
    // Close button
    document.getElementById('closeAppEditorModal').addEventListener('click', () => {
      this.closeAppEditorModal();
    });
    
    // Click outside to close
    document.getElementById('appEditorModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('appEditorModal')) {
        this.closeAppEditorModal();
      }
    });
  },
  
  closeAppEditorModal() {
    document.getElementById('appEditorModal').classList.remove('active');
  },
  
  newApp(buId) {
    this.openAppEditorModal(buId);
  },
  
  updateApp(appId, updates) {
    Dashboard.StorageManager.updateApp(appId, updates);
    this.renderAppsEditor();
    // Refresh main dashboard when weight-affecting factors change
    if (updates.criticality || updates.impact || updates.order || updates.progress) {
      Dashboard.UIController.apply();
    }
    // Also refresh the overview table if it's visible (now handled by AppsOverviewWorldClass)
    if (document.querySelector('#tab-app-overview.active')) {
      // this.renderAppsOverview();
    }
  },
  
  deleteApp(appId) {
    if (confirm('Delete this application?')) {
      Dashboard.StorageManager.deleteApp(appId);
      this.renderAppsEditor();
      // Also refresh the overview table if it's visible (now handled by AppsOverviewWorldClass)
      if (document.querySelector('#tab-app-overview.active')) {
        // this.renderAppsOverview();
      }
    }
  },
  
  openReassignModal(appId) {
    console.log(`🔄 Opening reassign modal for app ${appId}`);
    
    const config = Dashboard.StorageManager.loadConfig();
    const app = config.apps.find(a => a.id === appId);
    
    if (!app) {
      console.error(`❌ App ${appId} not found`);
      return;
    }
    
    const currentBU = config.buses.find(b => b.id === app.buId);
    const otherBUs = config.buses.filter(b => b.id !== app.buId);
    
    // Create modal content
    let html = `
      <div style="padding: 24px;">
        <h3 style="margin: 0 0 16px 0; color: var(--text);">🔄 Reassign Application</h3>
        <div style="background: var(--ring); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <p style="margin: 0 0 8px 0;"><strong>App:</strong> ${app.name}</p>
          <p style="margin: 0 0 8px 0;"><strong>Current BU:</strong> ${currentBU?.name || 'Unknown'}</p>
          <p style="margin: 0;"><strong>Status:</strong> ${app.status} (${app.progress}%)</p>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 12px; color: var(--text); font-weight: 600;">Assign to Business Unit:</label>
          <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
    `;
    
    otherBUs.forEach(bu => {
      const buApps = config.apps.filter(a => a.buId === bu.id).length;
      html += `
        <button onclick="Dashboard.AdminController.confirmReassign(${appId}, ${bu.id})" 
                style="padding: 12px; background: var(--panel); border: 1px solid var(--ring); color: var(--text); border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.3s;">
          <strong>${bu.name}</strong> <span style="float: right; opacity: 0.6;">${buApps} apps</span>
        </button>
      `;
    });
    
    html += `
          </div>
        </div>
      </div>
    `;
    
    // Insert into modal
    const modalContent = document.querySelector('.nested-modal-content');
    if (modalContent) {
      modalContent.innerHTML = html;
      document.querySelector('.nested-modal').classList.add('active');
    }
  },
  
  confirmReassign(appId, newBuId) {
    console.log(`✅ Confirming reassign: app ${appId} → BU ${newBuId}`);
    
    const success = Dashboard.StorageManager.reassignApp(appId, newBuId);
    
    if (success) {
      // Close modal
      document.querySelector('.nested-modal').classList.remove('active');
      
      // Refresh UI
      this.renderAppsEditor();
      Dashboard.UIController.apply();
      
      // Show notification
      alert(`✅ App reassigned successfully`);
    } else {
      alert('❌ Failed to reassign app');
    }
  },
  
  showAuditTrail() {
    console.log('📋 Opening audit trail');
    
    const trail = Dashboard.StorageManager.getAuditTrail();
    
    let html = `
      <div style="padding: 24px;">
        <h3 style="margin: 0 0 16px 0; color: var(--text);">📋 Audit Trail</h3>
        <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    if (trail.length === 0) {
      html += '<p style="color: var(--text); opacity: 0.7;">No audit entries yet</p>';
    } else {
      trail.forEach(entry => {
        html += `
          <div style="background: var(--ring); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <strong style="color: var(--primary);">${entry.action}</strong>
              <span style="opacity: 0.6; font-size: 12px;">${new Date(entry.timestamp).toLocaleString()}</span>
            </div>
            <div style="opacity: 0.8; font-size: 14px;">
              <p style="margin: 4px 0;">📱 App: <strong>${entry.appName}</strong> (${entry.status}, ${entry.progress}%)</p>
              <p style="margin: 4px 0;">🔄 ${entry.fromBuName} → ${entry.toBuName}</p>
            </div>
          </div>
        `;
      });
    }
    
    html += `
        </div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button class="btn btn-danger btn-sm" onclick="Dashboard.StorageManager.clearAuditTrail(); Dashboard.AdminController.showAuditTrail();">Clear Audit Trail</button>
          <button class="btn btn-secondary" onclick="document.querySelector('.nested-modal').classList.remove('active')">Close</button>
        </div>
      </div>
    `;
    
    const modalContent = document.querySelector('.nested-modal-content');
    if (modalContent) {
      modalContent.innerHTML = html;
      document.querySelector('.nested-modal').classList.add('active');
    }
  },
  
  exportConfig() {
    const config = Dashboard.StorageManager.loadConfig();
    
    // Build whitelabel object only if values exist
    const whitelabel = {};
    const mainTitle = localStorage.getItem('wl_mainTitle');
    const subtitle = localStorage.getItem('wl_subtitle');
    const leftLogo = localStorage.getItem('wl_leftLogo');
    const rightLogo = localStorage.getItem('wl_rightLogo');
    
    if (mainTitle !== null) whitelabel.mainTitle = mainTitle;
    if (subtitle !== null) whitelabel.subtitle = subtitle;
    if (leftLogo !== null) whitelabel.leftLogo = leftLogo;
    if (rightLogo !== null) whitelabel.rightLogo = rightLogo;
    
    // Build formula configuration object
    const formulaConfigStr = localStorage.getItem('dashboard_formula_config');
    const formulaConfig = {};
    if (formulaConfigStr) {
      try {
        Object.assign(formulaConfig, JSON.parse(formulaConfigStr));
      } catch (err) {
        console.warn('Could not parse formula config during export:', err);
      }
    }
    
    // Enrich buses with calculated progress
    const enrichedConfig = {
      ...config,
      ...(Object.keys(whitelabel).length > 0 && { whitelabel }),
      ...(Object.keys(formulaConfig).length > 0 && { formulaConfig }),
      buses: config.buses.map(bu => ({
        ...bu,
        calculatedProgress: Dashboard.ProgressCalculator.calculateBUProgress(bu.id),
        appCount: config.apps.filter(app => app.buId === bu.id).length,
        weightedMetrics: this.calculateBUWeightedMetrics(bu.id)
      })),
      apps: config.apps.map(app => ({
        ...app,
        buName: config.buses.find(b => b.id === app.buId)?.name || 'Unknown',
        calculatedWeight: app.weight || 1,
        calculatedProgress: app.progress || 0
      })),
      exportMetadata: {
        exportedAt: new Date().toISOString(),
        version: '2.1',
        schema: 'dashboard_config_v1_enriched_with_formulas',
        totalBUs: config.buses.length,
        totalApps: config.apps.length,
        totalWaves: config.waves.length,
        includesFormulaConfig: Object.keys(formulaConfig).length > 0,
        includesWhitelabelConfig: Object.keys(whitelabel).length > 0
      }
    };
    
    const json = JSON.stringify(enrichedConfig, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dashboard_config_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
    
    console.log('✅ Configuration exported successfully with formula settings');
  },
  
  calculateBUWeightedMetrics(buId) {
    const apps = Dashboard.StorageManager.getAppsByBU(buId);
    if (apps.length === 0) return { totalWeight: 0, weightedSum: 0, averageProgress: 0 };
    
    const totalWeight = apps.reduce((sum, app) => sum + (app.weight || 1), 0);
    const weightedSum = apps.reduce((sum, app) => sum + ((app.progress || 0) * (app.weight || 1)), 0);
    const averageProgress = totalWeight > 0 ? Math.round((weightedSum / totalWeight) * 100) / 100 : 0;
    
    return {
      totalWeight,
      weightedSum,
      averageProgress
    };
  },
  
  // Applications Overview tab functionality is now handled by AppsOverviewWorldClass module
  
  getImpactEmoji(impact) {
    return impact === 'High' ? '🔴' : (impact === 'Low' ? '🟢' : '🔵');
  },

  getStatusEmoji(status) {
    return status === 'CLO' ? '✅' : (status === 'WIP' ? '⏱️' : '📋');
  },

  updateFilterBadges() {
    const container = document.querySelector('#activeFiltersBadges');
    const list = document.querySelector('#activeFiltersList');
    
    if (!container || !list) return;
    
    const hasFilters = (this.currentOverviewFilters.field !== 'all' && this.currentOverviewFilters.value !== 'all') || this.currentOverviewSearch;
    
    if (hasFilters) {
      container.style.display = 'flex';
      let badges = '';
      
      if (this.currentOverviewSearch) {
        badges += `<span class="active-filter-badge">🔎 "<strong>${this.currentOverviewSearch}</strong>" <span class="remove-filter" onclick="Dashboard.AdminController.clearSearch()">✕</span></span>`;
      }
      
      if (this.currentOverviewFilters.field !== 'all' && this.currentOverviewFilters.value !== 'all') {
        const fieldLabel = this.currentOverviewFilters.field;
        badges += `<span class="active-filter-badge">${fieldLabel}: <strong>${this.currentOverviewFilters.value}</strong> <span class="remove-filter" onclick="Dashboard.AdminController.clearFieldFilter()">✕</span></span>`;
      }
      
      list.innerHTML = badges;
    } else {
      container.style.display = 'none';
    }
  },

  clearSearch() {
    const searchInput = document.querySelector('#appsOverviewSearch');
    if (searchInput) searchInput.value = '';
    this.currentOverviewSearch = '';
    // this.renderAppsOverviewTable();
    // this.updateAppsOverviewStats();
  },

  clearFieldFilter() {
    this.currentOverviewFilters = { field: 'all', value: 'all' };
    const filterField = document.querySelector('#overviewFilterField');
    const filterValue = document.querySelector('#overviewFilterValue');
    if (filterField) filterField.value = 'all';
    if (filterValue) filterValue.value = 'all';
    // this.renderAppsOverviewTable();
    // this.updateAppsOverviewStats();
  },

  // Applications Overview filtering delegated to AppsOverviewWorldClass module
  
  importConfig(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedConfig = JSON.parse(e.target.result);
        
        // Validate schema
        if (!importedConfig.buses || !importedConfig.apps || !importedConfig.waves) {
          throw new Error('Invalid configuration schema. Missing required fields: buses, apps, or waves');
        }
        
        // Extract and restore whitelabel config if present (only if values exist)
        if (importedConfig.whitelabel) {
          if (importedConfig.whitelabel.mainTitle) {
            localStorage.setItem('wl_mainTitle', importedConfig.whitelabel.mainTitle);
          }
          if (importedConfig.whitelabel.subtitle) {
            localStorage.setItem('wl_subtitle', importedConfig.whitelabel.subtitle);
          }
          if (importedConfig.whitelabel.leftLogo) {
            localStorage.setItem('wl_leftLogo', importedConfig.whitelabel.leftLogo);
          }
          if (importedConfig.whitelabel.rightLogo) {
            localStorage.setItem('wl_rightLogo', importedConfig.whitelabel.rightLogo);
          }
        }
        
        // Extract and restore formula config if present
        let formulaConfigImported = false;
        if (importedConfig.formulaConfig) {
          try {
            // Validate formula config structure
            const fc = importedConfig.formulaConfig;
            if (fc.progressMethod && fc.weights && fc.criticalityMultipliers) {
              localStorage.setItem('dashboard_formula_config', JSON.stringify({
                progressMethod: fc.progressMethod,
                globalMethod: fc.globalMethod || 'weighted',
                statusInclusion: fc.statusInclusion !== undefined ? fc.statusInclusion : true,
                weights: fc.weights,
                criticalityMultipliers: fc.criticalityMultipliers,
                timestamp: new Date().toISOString()
              }));
              formulaConfigImported = true;
              console.log('✅ Formula configuration imported successfully');
            } else {
              console.warn('⚠️ Formula config is incomplete, skipping import');
            }
          } catch (fcErr) {
            console.warn('⚠️ Could not import formula config:', fcErr.message);
          }
        }
        
        // Extract only the essential data (remove calculated fields)
        const cleanConfig = {
          buses: importedConfig.buses.map(bu => ({
            id: bu.id,
            key: bu.key,
            name: bu.name,
            domain: bu.domain,
            fullname: bu.fullname,
            color: bu.color || '#5b9dff',
            manager: bu.manager || ''
          })),
          apps: importedConfig.apps.map(app => ({
            id: app.id,
            buId: app.buId,
            name: app.name,
            status: app.status || 'TBS',
            progress: app.progress || 0,
            weight: app.weight || 1,
            criticality: app.criticality || 'Medium'
          })),
          waves: importedConfig.waves.map(wave => ({
            id: wave.id,
            name: wave.name
          }))
        };
        
        // Validate data integrity
        const appBUIds = new Set(cleanConfig.apps.map(a => a.buId));
        const buIds = new Set(cleanConfig.buses.map(b => b.id));
        
        for (let buId of appBUIds) {
          if (!buIds.has(buId)) {
            throw new Error(`Invalid reference: app references non-existent Business Unit ID ${buId}`);
          }
        }
        
        // Save configuration
        Dashboard.StorageManager.saveConfig(cleanConfig);
        
        // Verify import
        const verifyConfig = Dashboard.StorageManager.loadConfig();
        const importSummary = {
          busesCount: verifyConfig.buses.length,
          appsCount: verifyConfig.apps.length,
          wavesCount: verifyConfig.waves.length,
          formulaConfigImported
        };
        
        console.log('✅ Configuration imported successfully', importSummary);
        
        let alertMsg = '✅ Configuration imported successfully:\n\n' +
              `  • Business Units: ${verifyConfig.buses.length}\n` +
              `  • Applications: ${verifyConfig.apps.length}\n` +
              `  • Waves: ${verifyConfig.waves.length}`;
        
        if (formulaConfigImported) {
          alertMsg += '\n  • Formula Config: Imported ✓';
        }
        
        alert(alertMsg);
        
        location.reload();
      } catch (err) {
        console.error('Import error:', err);
        alert('❌ Import failed:\n\n' + err.message);
      }
    };
    reader.readAsText(file);
  },
  
  saveAndClose() {
    this.closeModal();
    Dashboard.UIController.apply();
    alert('✅ Changes saved');
  },
  
  clearAllData() {
    console.log('🔍 [clearAllData] Iniciando proceso de borrado de datos');
    
    // Double confirmation to prevent accidents
    const confirmed = confirm('⚠️ DANGER ZONE ⚠️\n\nThis will permanently delete ALL data:\n• Business Units\n• Applications\n• Waves\n\nThis action CANNOT be undone.\n\nAre you sure?');
    
    if (!confirmed) {
      console.log('❌ [clearAllData] Usuario canceló la primera confirmación');
      return;
    }
    
    const secondConfirmation = confirm('⚠️ FINAL WARNING ⚠️\n\nType OK to confirm deletion of all data.');
    if (secondConfirmation === false) {
      console.log('❌ [clearAllData] Usuario canceló la segunda confirmación');
      return;
    }
    
    try {
      console.log('🧹 [clearAllData] INICIANDO BORRADO COMPLETO DE DATOS');
      
      // Diagnóstico pre-borrado
      console.log('📊 [DIAGNÓSTICO PRE-BORRADO]', {
        localStorage_STORAGE_KEY: localStorage.getItem(Dashboard.StorageManager.STORAGE_KEY),
        localStorage_Keys: Object.keys(localStorage),
        Dashboard_DATA: JSON.stringify(Dashboard.DATA),
        sessionStorage_CLEARED_FLAG: sessionStorage.getItem(Dashboard.StorageManager.CLEARED_FLAG)
      });
      
      // 1. Mark as cleared BEFORE deletion - CRITICAL STEP
      Dashboard.StorageManager.markAsCleared();
      
      // 2. Clear localStorage completely
      localStorage.clear(); // Borrar TODO, no solo la clave específica
      
      // 3. Verificación múltiple
      const verification1 = localStorage.getItem(Dashboard.StorageManager.STORAGE_KEY);
      const verification2 = Object.keys(localStorage).length;
      
      console.log('📊 [VERIFICACIÓN POST-BORRADO]:', { 
        configDataExists: verification1 !== null, 
        remainingStorageItems: verification2,
        clearedFlag: sessionStorage.getItem(Dashboard.StorageManager.CLEARED_FLAG)
      });
      
      if (verification1 !== null) {
        throw new Error('Failed to clear dashboard data - configuration still exists');
      }
      
      // 4. CRUCIAL: Resetear el arreglo DATA hardcodeado
      console.log('🔄 [clearAllData] Reseteando DATA hardcodeado...');
      // Vaciar el arreglo manteniendo la referencia
      while (DATA.length > 0) {
        DATA.pop();
      }
      
      // Vaciar también la copia en el namespace Dashboard
      if (window.Dashboard && window.Dashboard.DATA) {
        while (window.Dashboard.DATA.length > 0) {
          window.Dashboard.DATA.pop();
        }
      }
      
      console.log('✅ [clearAllData] DATA hardcodeado reseteado:', DATA);
      
      // 5. Resetear variables de estado
      this.currentBUId = null;
      
      // 6. Crear un objeto vacío para usar después de la recarga
      const emptyConfig = { buses: [], apps: [], waves: [] };
      localStorage.setItem('temp_empty_dashboard_config', JSON.stringify(emptyConfig));
      
      console.log('✅ [clearAllData] BORRADO COMPLETO EXITOSO - Dashboard reiniciado');
      
      // 8. Reload after showing success message (no hardcoded UI messages)
      location.reload();
    } catch (err) {
      console.error('Clear All Data Error:', err);
      // No hardcoded UI messages - just log to console
    }
  },
  
  // Enterprise Formula Configuration Functions
  initializeFormulaCalculator() {
    console.log('🚀 Initializing Enterprise Formula Calculator');
    
    // Real-time weight calculator
    const calcCriticality = document.getElementById('calc-criticality');
    const calcImpact = document.getElementById('calc-impact');
    const calcPriority = document.getElementById('calc-priority');
    const calcResult = document.getElementById('calc-result');
    const calcFormula = document.getElementById('calc-formula');
    
    if (calcCriticality && calcImpact && calcPriority && calcResult && calcFormula) {
      const updateCalculator = () => {
        const criticality = parseInt(calcCriticality.value);
        const impact = parseInt(calcImpact.value);
        const priorityValue = calcPriority.value;
        
        // Convert priority to numeric value
        let priority;
        if (priorityValue === 'High') priority = 3;
        else if (priorityValue === 'Medium') priority = 2;
        else priority = 1; // Low
        
        // Calculate weight using enterprise formula
        const weight = ((criticality * impact * priority) / 27 * 3).toFixed(2);
        
        // Update display
        calcResult.textContent = weight;
        calcFormula.textContent = `[(${criticality} × ${impact} × ${priority}) ÷ 27] × 3`;
        
        // Add animation effect
        calcResult.style.transform = 'scale(1.1)';
        setTimeout(() => {
          calcResult.style.transform = 'scale(1)';
        }, 200);
      };
      
      // Event listeners
      calcCriticality.addEventListener('change', updateCalculator);
      calcImpact.addEventListener('change', updateCalculator);
      calcPriority.addEventListener('change', updateCalculator);
      
      // Initial calculation
      updateCalculator();
    }
    
    // Method selection handling
    const methodRadios = document.querySelectorAll('#tab-formulas input[name="progress-method"]');
    methodRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        console.log(`📊 Progress method changed to: ${e.target.value}`);
        this.updateProgressMethodDisplay(e.target.value);
      });
    });
    
    // Global method selection
    const globalRadios = document.querySelectorAll('#tab-formulas input[name="global-method"]');
    globalRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        console.log(`🌐 Global method changed to: ${e.target.value}`);
        this.updateGlobalMethodDisplay(e.target.value);
      });
    });
    
    // Status inclusion checkboxes
    const statusCheckboxes = document.querySelectorAll('#tab-formulas .inclusion-checkbox');
    statusCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        console.log(`🔄 Status inclusion changed: ${e.target.id} = ${e.target.checked}`);
        this.updateStatusInclusion();
      });
    });
  },
  
  updateProgressMethodDisplay(method) {
    // Visual feedback for method selection
    const methodOptions = document.querySelectorAll('.method-option');
    methodOptions.forEach(option => {
      const input = option.querySelector('input[type="radio"]');
      if (input && input.value === method) {
        option.classList.add('active');
      } else {
        option.classList.remove('active');
      }
    });
  },
  
  updateGlobalMethodDisplay(method) {
    // Visual feedback for global method selection
    const globalOptions = document.querySelectorAll('.global-option');
    globalOptions.forEach(option => {
      const input = option.querySelector('input[type="radio"]');
      if (input && input.value === method) {
        option.classList.add('active');
      } else {
        option.classList.remove('active');
      }
    });
  },
  
  updateStatusInclusion() {
    // Get current status inclusion settings
    const includesTBS = document.getElementById('include-tbs')?.checked || false;
    const includesWIP = document.getElementById('include-wip')?.checked || true;
    const includesCLO = document.getElementById('include-clo')?.checked || true;
    
    console.log('📋 Status Inclusion Updated:', { includesTBS, includesWIP, includesCLO });
    
    // Store in configuration
    this.statusInclusionConfig = {
      TBS: includesTBS,
      WIP: includesWIP,
      CLO: includesCLO
    };
    
    // CRITICAL: Trigger recalculation with new status inclusion rules
    console.log('🔄 Recalculating BU progress with new status inclusion rules...');
    Dashboard.UIController.apply();
  },
  
  saveFormulaConfig() {
    console.log('💾 Saving Enterprise Formula Configuration');
    
    // Collect all settings from the new interface
    const formulaConfig = {
      progressMethod: document.querySelector('#tab-formulas input[name="progress-method"]:checked')?.value || 'weighted',
      globalMethod: document.querySelector('#tab-formulas input[name="global-method"]:checked')?.value || 'weighted',
      statusInclusion: {
        TBS: document.getElementById('include-tbs')?.checked || false,
        WIP: document.getElementById('include-wip')?.checked || true,
        CLO: document.getElementById('include-clo')?.checked || true
      },
      automaticWeights: true, // Flag for automatic weight system
      weightFormula: 'enterprise', // Enterprise formula identifier
      timestamp: new Date().toISOString()
    };
    
    // Save to localStorage
    localStorage.setItem('dashboard_formula_config_v2', JSON.stringify(formulaConfig));
    
    // Apply changes immediately
    Dashboard.UIController.apply();
    
    console.log('✅ Enterprise Formula Configuration Saved Successfully');
  },
  
  resetFormulaConfig() {
    console.log('🔄 Resetting Enterprise Formula Configuration');
    
    // Default enterprise configuration
    const defaultConfig = {
      progressMethod: 'weighted',
      globalMethod: 'weighted',
      statusInclusion: {
        TBS: false,
        WIP: true,
        CLO: true
      },
      weights: {
        min: 0.5,
        max: 3.0,
        default: 1.0
      },
      criticalityMultipliers: {
        low: 1.0,
        medium: 1.0,
        high: 1.2
      },
      timestamp: new Date().toISOString()
    };
    
    // Reset form values
    document.getElementById('formula-progress-method').value = defaultConfig.progressMethod;
    document.getElementById('formula-global-method').value = defaultConfig.globalMethod;
    document.getElementById('include-status-tbs').checked = defaultConfig.statusInclusion.TBS;
    document.getElementById('include-status-wip').checked = defaultConfig.statusInclusion.WIP;
    document.getElementById('include-status-clo').checked = defaultConfig.statusInclusion.CLO;
    document.getElementById('weight-min').value = defaultConfig.weights.min;
    document.getElementById('weight-max').value = defaultConfig.weights.max;
    document.getElementById('weight-default').value = defaultConfig.weights.default;
    document.getElementById('crit-low').value = defaultConfig.criticalityMultipliers.low;
    document.getElementById('crit-medium').value = defaultConfig.criticalityMultipliers.medium;
    document.getElementById('crit-high').value = defaultConfig.criticalityMultipliers.high;
    
    // Save to localStorage
    localStorage.setItem('dashboard_formula_config', JSON.stringify(defaultConfig));
    
    // Show confirmation
    alert('⚠️ Formula configuration reset to defaults');
    
    // Show/hide appropriate formula labels
    this.updateFormulaLabels();
  },
  
  testFormulaConfig() {
    console.log('Testing formula configuration');
    
    // Get current configuration from form
    const formulaConfig = {
      progressMethod: document.getElementById('formula-progress-method').value,
      globalMethod: document.getElementById('formula-global-method').value,
      statusInclusion: {
        TBS: document.getElementById('include-status-tbs').checked,
        WIP: document.getElementById('include-status-wip').checked,
        CLO: document.getElementById('include-status-clo').checked
      }
    };
    
    // Get data
    const buses = Dashboard.StorageManager.getBUs();
    const apps = Dashboard.StorageManager.getAllApps();
    
    // Generate test results
    let results = '<div style="padding: 16px; max-height: 500px; overflow-y: auto;">';
    results += '<h3>Formula Test Results</h3>';
    results += '<p>Testing calculation with current configuration:</p>';
    results += '<ul>';
    results += `<li>Progress Method: <strong>${formulaConfig.progressMethod}</strong></li>`;
    results += `<li>Global Method: <strong>${formulaConfig.globalMethod}</strong></li>`;
    results += `<li>Include TBS: <strong>${formulaConfig.statusInclusion.TBS}</strong></li>`;
    results += `<li>Include WIP: <strong>${formulaConfig.statusInclusion.WIP}</strong></li>`;
    results += `<li>Include CLO: <strong>${formulaConfig.statusInclusion.CLO}</strong></li>`;
    results += '</ul>';
    
    // Calculate for each BU
    results += '<table style="width:100%; border-collapse: collapse; margin-top: 16px;">';
    results += '<thead><tr style="background: var(--ring);"><th style="text-align:left; padding: 8px;">Business Unit</th><th style="text-align:center; padding: 8px;">Apps</th><th style="text-align:center; padding: 8px;">Progress</th></tr></thead>';
    results += '<tbody>';
    
    let totalApps = 0;
    let weightedSum = 0;
    let buSum = 0;
    
    buses.forEach(bu => {
      const buApps = apps.filter(app => app.buId === bu.id);
      const buAppCount = buApps.length;
      totalApps += buAppCount;
      
      // Only include statuses based on configuration
      const filteredApps = buApps.filter(app => {
        if (app.status === 'TBS' && !formulaConfig.statusInclusion.TBS) return false;
        if (app.status === 'WIP' && !formulaConfig.statusInclusion.WIP) return false;
        if (app.status === 'CLO' && !formulaConfig.statusInclusion.CLO) return false;
        return true;
      });
      
      // Calculate BU progress based on selected method
      let buProgress = 0;
      
      if (filteredApps.length > 0) {
        if (formulaConfig.progressMethod === 'weighted') {
          const totalWeight = filteredApps.reduce((sum, app) => sum + (app.weight || 1), 0);
          const weightedSum = filteredApps.reduce((sum, app) => sum + ((app.progress || 0) * (app.weight || 1)), 0);
          buProgress = totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0;
        } else if (formulaConfig.progressMethod === 'simple') {
          buProgress = Math.round(filteredApps.reduce((sum, app) => sum + (app.progress || 0), 0) / filteredApps.length);
        } else if (formulaConfig.progressMethod === 'minimum') {
          buProgress = Math.min(...filteredApps.map(app => app.progress || 0));
        }
      }
      
      weightedSum += buProgress * buAppCount;
      buSum += buProgress;
      
      // Set background color based on progress
      const bgColor = buProgress === 100 ? 'rgba(50, 230, 133, 0.15)' : 
                     buProgress >= 50 ? 'rgba(255, 209, 102, 0.15)' : 
                     'rgba(255, 95, 122, 0.15)';
      
      results += `<tr style="background: ${bgColor}; border-bottom: 1px solid var(--ring);">
                   <td style="padding: 8px;">${bu.name}</td>
                   <td style="text-align:center; padding: 8px;">${buAppCount}</td>
                   <td style="text-align:center; padding: 8px;">${buProgress}%</td>
                 </tr>`;
    });
    
    results += '</tbody></table>';
    
    // Calculate global progress
    const globalProgress = formulaConfig.globalMethod === 'weighted' 
      ? (totalApps > 0 ? Math.round(weightedSum / totalApps) : 0)
      : (buses.length > 0 ? Math.round(buSum / buses.length) : 0);
    
    results += `<div style="margin-top: 24px; background: var(--ring); padding: 16px; border-radius: 8px;">
                 <h4 style="margin-top:0;">Global Progress: ${globalProgress}%</h4>
                 <p>Calculated using: ${formulaConfig.globalMethod === 'weighted' ? 'Weighted by BU Size' : 'Simple BU Average'}</p>
                 <div style="background: var(--panel); height: 24px; width: 100%; border-radius: 12px; overflow: hidden; margin-top: 8px;">
                   <div style="background: ${globalProgress === 100 ? 'var(--ok)' : globalProgress >= 50 ? 'var(--warn)' : 'var(--danger)'}; 
                               height: 100%; width: ${globalProgress}%"></div>
                 </div>
               </div>`;
    
    results += '</div>';
    
    // Show results in modal
    const nestedModal = document.querySelector('.nested-modal') || document.createElement('div');
    nestedModal.className = 'nested-modal';
    nestedModal.style.opacity = '1';
    nestedModal.style.pointerEvents = 'auto';
    
    nestedModal.innerHTML = `
      <div class="nested-modal-content" style="background: var(--panel); border: 1px solid var(--ring); 
          width: 80%; max-width: 800px; border-radius: var(--radius); box-shadow: 0 10px 50px rgba(0,0,0,0.5);">
        ${results}
        <div style="padding: 16px; display: flex; justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="document.querySelector('.nested-modal').style.opacity='0'; document.querySelector('.nested-modal').style.pointerEvents='none';">
            Close
          </button>
        </div>
      </div>
    `;
    
    if (!document.body.contains(nestedModal)) {
      document.body.appendChild(nestedModal);
    }
    
    nestedModal.style.opacity = '1';
    nestedModal.style.pointerEvents = 'auto';
  },
  
  loadFormulaConfig() {
    console.log('Loading formula configuration from localStorage');
    
    // Try to get saved configuration from localStorage
    const savedConfigStr = localStorage.getItem('dashboard_formula_config');
    
    // If no saved config, just load empty form (don't reset to defaults)
    if (!savedConfigStr) {
      console.log('No saved formula configuration found, showing empty form');
      // Do NOT call resetFormulaConfig() here - let user decide via UI button
      this.initializeEmptyFormulaForm();
      return;
    }
    
    try {
      // Parse saved configuration
      const config = JSON.parse(savedConfigStr);
      
      // Apply to form inputs
      document.getElementById('formula-progress-method').value = config.progressMethod || 'weighted';
      document.getElementById('formula-global-method').value = config.globalMethod || 'weighted';
      
      // Status inclusion
      if (config.statusInclusion) {
        document.getElementById('include-status-tbs').checked = config.statusInclusion.TBS || false;
        document.getElementById('include-status-wip').checked = config.statusInclusion.WIP !== undefined ? config.statusInclusion.WIP : true;
        document.getElementById('include-status-clo').checked = config.statusInclusion.CLO !== undefined ? config.statusInclusion.CLO : true;
      }
      
      // Weights
      if (config.weights) {
        document.getElementById('weight-min').value = config.weights.min || 0.5;
        document.getElementById('weight-max').value = config.weights.max || 3.0;
        document.getElementById('weight-default').value = config.weights.default || 1.0;
      }
      
      // Criticality multipliers
      if (config.criticalityMultipliers) {
        document.getElementById('crit-low').value = config.criticalityMultipliers.low || 1.0;
        document.getElementById('crit-medium').value = config.criticalityMultipliers.medium || 1.0;
        document.getElementById('crit-high').value = config.criticalityMultipliers.high || 1.2;
      }
      
      // Update formula displays
      this.updateFormulaLabels();
      
      console.log('✅ Formula configuration loaded successfully');
    } catch (err) {
      console.error('Failed to load formula configuration:', err);
      // On error, show empty form - don't auto-reset
      this.initializeEmptyFormulaForm();
    }
  },

  initializeEmptyFormulaForm() {
    console.log('Initializing empty formula form');
    
    // Set form to empty state (NOT defaults)
    document.getElementById('formula-progress-method').value = 'weighted';
    document.getElementById('formula-global-method').value = 'weighted';
    document.getElementById('include-status-tbs').checked = false;
    document.getElementById('include-status-wip').checked = true;
    document.getElementById('include-status-clo').checked = true;
    document.getElementById('weight-min').value = '0.5';
    document.getElementById('weight-max').value = '3.0';
    document.getElementById('weight-default').value = '1.0';
    document.getElementById('crit-low').value = '1.0';
    document.getElementById('crit-medium').value = '1.0';
    document.getElementById('crit-high').value = '1.2';
    
    // Update labels
    this.updateFormulaLabels();
  },
  
  updateFormulaLabels() {
    // Show/hide appropriate formula labels based on selected method
    const progressMethod = document.getElementById('formula-progress-method').value;
    const globalMethod = document.getElementById('formula-global-method').value;
    
    // Update progress method formula labels
    document.querySelectorAll('.math-formula.weighted, .math-formula.simple, .math-formula.minimum').forEach(el => {
      el.style.display = 'none';
    });
    document.querySelector('.math-formula.' + progressMethod).style.display = 'block';
    
    // Update global method formula labels
    document.querySelectorAll('.math-formula.global-weighted, .math-formula.global-simple').forEach(el => {
      el.style.display = 'none';
    });
    document.querySelector('.math-formula.global-' + globalMethod).style.display = 'block';
  },

  renderApplicationsImpactMatrix() {
    console.log('🚀 Rendering Applications Impact Matrix...');
    
    const matrixBody = document.getElementById('matrixTableBody');
    const waveContainer = document.getElementById('waveCardsContainer');
    
    if (!matrixBody || !waveContainer) {
      console.warn('⚠️ Matrix containers not found');
      return;
    }
    
    // Get all applications
    const allApps = [];
    const buses = Dashboard.StorageManager.getBUs();
    const waveMap = new Map();
    
    buses.forEach(bu => {
      const apps = Dashboard.StorageManager.getAppsByBU(bu.id);
      apps.forEach(app => {
        allApps.push({
          ...app,
          buId: bu.id,
          buName: bu.name,
          wave: Dashboard.StorageManager.getWaveNameById(app.waveId)
        });
        
        // Build wave map
        const wave = Dashboard.StorageManager.getWaveNameById(app.waveId);
        if (!waveMap.has(wave)) {
          waveMap.set(wave, []);
        }
        waveMap.get(wave).push(app);
      });
    });
    
    // Sort apps by order
    allApps.sort((a, b) => {
      const orderA = parseInt(a.order) || 0;
      const orderB = parseInt(b.order) || 0;
      return orderA - orderB;
    });
    
    // Render matrix table
    matrixBody.innerHTML = '';
    allApps.forEach((app, idx) => {
      const weight = Dashboard.ProgressCalculator.calculateAppWeight(app);
      const criticality = app.criticality || 'Medium';
      const impact = app.impact || 'Medium';
      const priority = app.priority || 'Medium';
      const status = app.status || 'TBS';
      const progress = app.progress || 0;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <span class="matrix-order">${parseInt(app.order) || 0}</span>
        </td>
        <td>
          <span class="matrix-app-name">${app.name}</span>
        </td>
        <td>
          <span class="matrix-bu-name">${app.buName}</span>
        </td>
        <td>
          <span class="matrix-wave">🌊 ${app.wave}</span>
        </td>
        <td>
          <span class="matrix-weight">${weight.toFixed(2)}</span>
        </td>
        <td>
          <div class="matrix-factors">
            <span class="factor-badge criticality">${criticality}</span>
            <span class="factor-badge impact">${impact}</span>
            <span class="factor-badge priority">${priority}</span>
          </div>
        </td>
        <td>
          <div class="matrix-progress-bar">
            <div class="matrix-progress-container">
              <div class="matrix-progress-value" style="width: ${progress}%"></div>
            </div>
            <span class="matrix-progress-label">${progress}%</span>
          </div>
        </td>
        <td>
          <span class="matrix-status">${this.getStatusEmoji(status)} ${status}</span>
        </td>
      `;
      matrixBody.appendChild(row);
    });
    
    // Render wave summary cards
    waveContainer.innerHTML = '';
    const sortedWaves = Array.from(waveMap.keys()).sort();
    
    sortedWaves.forEach(wave => {
      const waveApps = waveMap.get(wave);
      const completedApps = waveApps.filter(a => a.status === 'CLO').length;
      const wipApps = waveApps.filter(a => a.status === 'WIP').length;
      const avgProgress = waveApps.length > 0
        ? Math.round(waveApps.reduce((sum, a) => sum + (a.progress || 0), 0) / waveApps.length)
        : 0;
      
      const card = document.createElement('div');
      card.className = 'wave-card';
      card.innerHTML = `
        <div class="wave-card-header">
          <h4 class="wave-card-title">${wave}</h4>
          <span class="wave-badge">${waveApps.length} apps</span>
        </div>
        <div class="wave-card-stats">
          <div class="wave-stat">
            <div class="wave-stat-value">${completedApps}</div>
            <div class="wave-stat-label">Completed</div>
          </div>
          <div class="wave-stat">
            <div class="wave-stat-value">${wipApps}</div>
            <div class="wave-stat-label">In Progress</div>
          </div>
          <div class="wave-stat">
            <div class="wave-stat-value">${avgProgress}%</div>
            <div class="wave-stat-label">Avg Progress</div>
          </div>
          <div class="wave-stat">
            <div class="wave-stat-value">${waveApps.length}</div>
            <div class="wave-stat-label">Total</div>
          </div>
        </div>
      `;
      waveContainer.appendChild(card);
    });
    
    console.log('✅ Applications Impact Matrix rendered successfully');
  },

  // ========== BU ANALYTICS EXPORT/IMPORT FUNCTIONS ==========
  
  initBUAnalytics() {
    console.log('🚀 Initializing BU Analytics...');
    this.buAnalyticsData = null;
    
    // Use setTimeout to ensure DOM is ready
    setTimeout(() => {
      console.log('📋 Setting up BU Analytics event listeners...');
      this.setupBUAnalyticsEventListeners();
      
      console.log('📊 Populating BU selector dropdown...');
      this.populateBUSelectDropdown();
    }, 50);
  },

  setupBUAnalyticsEventListeners() {
    // Export
    const buSelect = document.getElementById('buAnalyticsExportSelect');
    if (buSelect) {
      buSelect.addEventListener('change', (e) => {
        console.log('📊 BU selected:', e.target.value);
        this.onBUSelectForExport(parseInt(e.target.value));
      });
      console.log('✅ Export selector listener attached');
    } else {
      console.warn('⚠️ Export selector not found');
    }
    
    const exportBtn = document.getElementById('exportBUAnalyticsBtn');
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        console.log('📥 Export button clicked');
        this.showBUAnalyticsExportModal();
      });
      console.log('✅ Export button listener attached');
    }
    
    const downloadBtn = document.getElementById('downloadBUAnalyticsBtn');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        console.log('⬇️ Download button clicked');
        this.downloadBUAnalytics();
      });
      console.log('✅ Download button listener attached');
    }
    
    // Import
    const dropZone = document.getElementById('importDropZone');
    if (dropZone) {
      dropZone.addEventListener('click', () => {
        document.getElementById('importBUAnalyticsFile').click();
      });
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
          this.handleBUAnalyticsFileImport(e.dataTransfer.files[0]);
        }
      });
      console.log('✅ Import drop-zone listeners attached');
    }
    
    const fileInput = document.getElementById('importBUAnalyticsFile');
    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          console.log('📁 File selected for import');
          this.handleBUAnalyticsFileImport(e.target.files[0]);
        }
      });
      console.log('✅ File input listener attached');
    }
    
    const confirmBtn = document.getElementById('confirmBUImportBtn');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', () => {
        console.log('✅ Confirm import button clicked');
        this.confirmBUAnalyticsImport();
      });
      console.log('✅ Confirm import button listener attached');
    }
    
    console.log('✅ All BU Analytics event listeners setup complete');
  },

  populateBUSelectDropdown() {
    const select = document.getElementById('buAnalyticsExportSelect');
    if (!select) {
      console.warn('⚠️ buAnalyticsExportSelect not found, retrying...');
      setTimeout(() => this.populateBUSelectDropdown(), 100);
      return;
    }
    
    const buses = Dashboard.StorageManager.getBUs();
    console.log('📊 BUs found:', buses.length, buses);
    
    select.innerHTML = '<option value="">-- Choose a Business Unit --</option>';
    
    buses.forEach(bu => {
      const opt = document.createElement('option');
      opt.value = bu.id;
      opt.textContent = `${bu.name} (${bu.key})`;
      select.appendChild(opt);
      console.log('✅ Added BU option:', bu.name);
    });
    
    console.log('✅ BU selector populated with', buses.length, 'BUs');
  },

  onBUSelectForExport(buId) {
    const btn = document.getElementById('exportBUAnalyticsBtn');
    const previewBox = document.getElementById('exportPreviewBox');
    
    if (!buId) {
      btn.disabled = true;
      previewBox.style.display = 'none';
      return;
    }
    
    const bu = Dashboard.StorageManager.getBUs().find(b => b.id === buId);
    const apps = Dashboard.StorageManager.getAppsByBU(buId);
    
    const completed = apps.filter(a => a.status === 'CLO').length;
    const avgProgress = apps.length > 0
      ? Math.round(apps.reduce((sum, a) => sum + (a.progress || 0), 0) / apps.length)
      : 0;
    
    const jsonStr = JSON.stringify({ bu, apps }, null, 2);
    const fileSize = (new Blob([jsonStr]).size / 1024).toFixed(1);
    
    document.getElementById('exportPreviewApps').textContent = apps.length;
    document.getElementById('exportPreviewProgress').textContent = avgProgress + '%';
    document.getElementById('exportPreviewSize').textContent = fileSize + ' KB';
    
    previewBox.style.display = 'block';
    btn.disabled = false;
    this.buAnalyticsData = { bu, apps };
  },

  showBUAnalyticsExportModal() {
    if (!this.buAnalyticsData) return;
    
    const { bu, apps } = this.buAnalyticsData;
    const completed = apps.filter(a => a.status === 'CLO').length;
    const wip = apps.filter(a => a.status === 'WIP').length;
    const avgProgress = apps.length > 0
      ? Math.round(apps.reduce((sum, a) => sum + (a.progress || 0), 0) / apps.length)
      : 0;
    
    document.getElementById('exportBUName').textContent = bu.name;
    document.getElementById('exportBUMeta').textContent = `${bu.domain} • ${bu.manager || 'No manager'}`;
    document.getElementById('exportStatApps').textContent = apps.length;
    document.getElementById('exportStatComplete').textContent = completed;
    document.getElementById('exportStatWIP').textContent = wip;
    document.getElementById('exportStatProgress').textContent = avgProgress + '%';
    
    document.getElementById('buAnalyticsExportModal').classList.add('active');
  },

  downloadBUAnalytics() {
    if (!this.buAnalyticsData) return;
    
    const { bu, apps } = this.buAnalyticsData;
    const completed = apps.filter(a => a.status === 'CLO').length;
    const wip = apps.filter(a => a.status === 'WIP').length;
    const tbs = apps.filter(a => a.status === 'TBS').length;
    const avgProgress = apps.length > 0
      ? Math.round(apps.reduce((sum, a) => sum + (a.progress || 0), 0) / apps.length * 10) / 10
      : 0;
    
    const exportData = {
      format: 'bu-analytics-v1',
      exportedAt: new Date().toISOString(),
      buData: {
        id: bu.id,
        key: bu.key,
        name: bu.name,
        domain: bu.domain,
        fullname: bu.fullname,
        color: bu.color || '#5b9dff',
        manager: bu.manager || ''
      },
      apps: apps.map(app => ({
        id: app.id,
        buId: app.buId,
        name: app.name,
        status: app.status,
        progress: app.progress || 0,
        weight: app.weight || 1,
        criticality: app.criticality || 'Medium',
        businessImpact: app.businessImpact || app.impact || 'Medium',
        priority: app.priority || 'Medium'
      })),
      statistics: {
        totalApps: apps.length,
        completedApps: completed,
        wipApps: wip,
        tbsApps: tbs,
        averageProgress: avgProgress,
        weightedProgress: Dashboard.ProgressCalculator.calculateBUProgress(bu.id)
      }
    };
    
    const json = JSON.stringify(exportData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bu-analytics_${bu.key}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    document.getElementById('buAnalyticsExportModal').classList.remove('active');
    console.log('✅ BU Analytics exported:', bu.name);
  },

  handleBUAnalyticsFileImport(file) {
    if (!file.name.endsWith('.json')) {
      alert('❌ Please select a valid .json file');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        // Validate format
        if (data.format !== 'bu-analytics-v1') {
          throw new Error('Invalid file format. Expected bu-analytics-v1');
        }
        
        if (!data.buData || !Array.isArray(data.apps)) {
          throw new Error('Invalid file structure');
        }
        
        this.showBUAnalyticsImportPreview(data);
      } catch (err) {
        alert('❌ Error reading file:\n\n' + err.message);
        console.error('Import error:', err);
      }
    };
    reader.readAsText(file);
  },

  showBUAnalyticsImportPreview(data) {
    const { buData, apps, statistics } = data;
    
    document.getElementById('importBUName').textContent = buData.name;
    document.getElementById('importBUMeta').textContent = `${buData.domain} • ${buData.manager || 'No manager'}`;
    document.getElementById('importStatApps').textContent = apps.length;
    document.getElementById('importStatComplete').textContent = statistics.completedApps || 0;
    document.getElementById('importStatWIP').textContent = statistics.wipApps || 0;
    document.getElementById('importStatProgress').textContent = statistics.averageProgress.toFixed(1) + '%';
    
    const strategy = document.querySelector('input[name="buMergeStrategy"]:checked').value;
    const strategyText = {
      'replace': '🔄 Replace - This will overwrite the entire Business Unit with the imported data',
      'merge': '🔗 Merge - New apps will be added, existing apps will be updated',
      'append': '➕ Append - All apps will be added as new items'
    };
    
    document.getElementById('importMergeStrategyDisplay').textContent = strategyText[strategy];
    
    const appsList = document.getElementById('importAppsPreviewList');
    appsList.innerHTML = '';
    
    apps.forEach(app => {
      const item = document.createElement('div');
      item.className = 'app-preview-item';
      
      const statusBadges = {
        'TBS': 'app-status-tbs',
        'WIP': 'app-status-wip',
        'CLO': 'app-status-clo'
      };
      
      item.innerHTML = `
        <span class="app-name">${app.name}</span>
        <span class="app-status-badge ${statusBadges[app.status]}">${app.status}</span>
        <span class="app-progress">${app.progress}%</span>
      `;
      appsList.appendChild(item);
    });
    
    this.pendingImportData = data;
    document.getElementById('buAnalyticsImportModal').classList.add('active');
  },

  confirmBUAnalyticsImport() {
    if (!this.pendingImportData) return;
    
    const { buData, apps } = this.pendingImportData;
    const strategy = document.querySelector('input[name="buMergeStrategy"]:checked').value;
    
    try {
      if (strategy === 'replace') {
        this.mergeStrategyReplace(buData, apps);
      } else if (strategy === 'merge') {
        this.mergeStrategyMerge(buData, apps);
      } else if (strategy === 'append') {
        this.mergeStrategyAppend(buData, apps);
      }
      
      document.getElementById('buAnalyticsImportModal').classList.remove('active');
      alert(`✅ Successfully imported ${apps.length} applications from ${buData.name}`);
      this.renderAppsEditor();
      Dashboard.UIController.apply();
      console.log('✅ BU Analytics imported:', buData.name);
      
    } catch (err) {
      alert('❌ Import failed:\n\n' + err.message);
      console.error('Merge error:', err);
    }
  },

  mergeStrategyReplace(buData, apps) {
    // Find or create the BU
    let bu = Dashboard.StorageManager.getBUs().find(b => b.id === buData.id);
    
    if (!bu) {
      // Create new BU
      bu = Dashboard.StorageManager.addBU({
        key: buData.key,
        name: buData.name,
        domain: buData.domain,
        fullname: buData.fullname,
        color: buData.color,
        manager: buData.manager
      });
    }
    
    // Remove old apps for this BU
    const config = Dashboard.StorageManager.loadConfig();
    config.apps = config.apps.filter(a => a.buId !== bu.id);
    
    // Add new apps
    apps.forEach(app => {
      config.apps.push({
        id: Math.max(...config.apps.map(a => a.id || 0)) + 1,
        buId: bu.id,
        name: app.name,
        status: app.status,
        progress: app.progress,
        weight: app.weight,
        criticality: app.criticality,
        businessImpact: app.businessImpact,
        priority: app.priority
      });
    });
    
    Dashboard.StorageManager.saveConfig(config);
  },

  mergeStrategyMerge(buData, apps) {
    // Find or create the BU
    let bu = Dashboard.StorageManager.getBUs().find(b => b.id === buData.id);
    
    if (!bu) {
      bu = Dashboard.StorageManager.addBU({
        key: buData.key,
        name: buData.name,
        domain: buData.domain,
        fullname: buData.fullname,
        color: buData.color,
        manager: buData.manager
      });
    }
    
    const config = Dashboard.StorageManager.loadConfig();
    const existingApps = config.apps.filter(a => a.buId === bu.id);
    
    apps.forEach(importedApp => {
      const existing = existingApps.find(a => a.name === importedApp.name);
      
      if (existing) {
        // Update existing
        existing.status = importedApp.status;
        existing.progress = importedApp.progress;
        existing.criticality = importedApp.criticality;
        existing.businessImpact = importedApp.businessImpact;
        existing.priority = importedApp.priority;
      } else {
        // Add new
        config.apps.push({
          id: Math.max(...config.apps.map(a => a.id || 0)) + 1,
          buId: bu.id,
          name: importedApp.name,
          status: importedApp.status,
          progress: importedApp.progress,
          weight: importedApp.weight,
          criticality: importedApp.criticality,
          businessImpact: importedApp.businessImpact,
          priority: importedApp.priority
        });
      }
    });
    
    Dashboard.StorageManager.saveConfig(config);
  },

  mergeStrategyAppend(buData, apps) {
    // Find or create the BU
    let bu = Dashboard.StorageManager.getBUs().find(b => b.id === buData.id);
    
    if (!bu) {
      bu = Dashboard.StorageManager.addBU({
        key: buData.key,
        name: buData.name,
        domain: buData.domain,
        fullname: buData.fullname,
        color: buData.color,
        manager: buData.manager
      });
    }
    
    const config = Dashboard.StorageManager.loadConfig();
    
    // Add all apps as new (with new IDs)
    apps.forEach(app => {
      config.apps.push({
        id: Math.max(...config.apps.map(a => a.id || 0)) + 1,
        buId: bu.id,
        name: `${app.name} (imported)`,
        status: app.status,
        progress: app.progress,
        weight: app.weight,
        criticality: app.criticality,
        businessImpact: app.businessImpact,
        priority: app.priority
      });
    });
    
    Dashboard.StorageManager.saveConfig(config);
  },
  
  // ========== END BU ANALYTICS FUNCTIONS ==========
  
  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    Object.assign(notification.style, {
      position: 'fixed',
      top: '20px',
      right: '20px',
      padding: '16px 24px',
      borderRadius: '8px',
      color: 'white',
      fontWeight: '500',
      zIndex: '10000',
      animation: 'slideInRight 0.3s ease',
      maxWidth: '400px',
      boxShadow: '0 8px 24px rgba(0,0,0,0.3)'
    });
    
    const colors = {
      success: '#32e685',
      error: '#ff5f7a',
      warning: '#ffd166',
      info: '#5b9dff'
    };
    
    notification.style.background = colors[type] || colors.info;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 3000);
  },
  
  /**
   * Waves CRUD Operations
   */
  renderWavesEditor() {
    const waves = Dashboard.StorageManager.getWaves();
    const container = document.querySelector('#waveEditorContainer');
    
    if (!container) return;
    
    let html = `<h3 style="margin:0 0 12px 0;color:var(--text);font-size:16px">Waves Management</h3>
      <button class="btn btn-primary" onclick="Dashboard.AdminController.newWave()" style="margin-bottom:12px;padding:8px 12px;font-size:13px">+ Add Wave</button>
      <table class="wave-table" style="width:100%;border-collapse:collapse;margin-top:12px">
        <thead style="background:rgba(91,157,255,0.1);border-bottom:2px solid var(--ring)">
          <tr>
            <th style="padding:12px;text-align:left;font-size:12px;font-weight:600;color:#aaa;border-right:1px solid var(--ring)">ID</th>
            <th style="padding:12px;text-align:left;font-size:12px;font-weight:600;color:#aaa;border-right:1px solid var(--ring)">Wave Name</th>
            <th style="padding:12px;text-align:left;font-size:12px;font-weight:600;color:#aaa;border-right:1px solid var(--ring)">Apps Count</th>
            <th style="padding:12px;text-align:center;font-size:12px;font-weight:600;color:#aaa">Actions</th>
          </tr>
        </thead>
        <tbody>`;
    
    waves.forEach(wave => {
      const appCount = Dashboard.StorageManager.getApps().filter(a => a.waveId === wave.id).length;
      const deleteBtn = appCount > 0 
        ? `<button class="btn btn-sm" disabled style="opacity:0.5;cursor:not-allowed;padding:4px 8px;font-size:11px" title="Cannot delete: wave has ${appCount} app(s)">Delete</button>`
        : `<button class="btn btn-danger btn-sm" onclick="Dashboard.AdminController.deleteWave(${wave.id})" style="padding:4px 8px;font-size:11px">Delete</button>`;
      html += `<tr style="border-bottom:1px solid var(--ring);transition:background 0.2s;height:44px">
          <td style="padding:12px;font-size:13px;color:var(--text);border-right:1px solid var(--ring)">${wave.id}</td>
          <td style="padding:12px;border-right:1px solid var(--ring)">
            <input type="text" value="${wave.name}" onchange="Dashboard.AdminController.updateWave(${wave.id}, {name: this.value})" style="width:100%;padding:6px;background:rgba(91,157,255,0.05);border:1px solid var(--ring);border-radius:6px;color:var(--text);font-size:13px"/>
          </td>
          <td style="padding:12px;font-size:13px;color:var(--text);border-right:1px solid var(--ring);text-align:center">${appCount}</td>
          <td style="padding:12px;text-align:center">${deleteBtn}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    html += `<div style="margin-top:16px;padding:12px;background:rgba(91,157,255,0.05);border:1px solid var(--ring);border-radius:8px;font-size:12px;color:#aaa">
      <strong>ℹ️ Total Waves:</strong> ${waves.length} | <strong>Total Apps:</strong> ${Dashboard.StorageManager.getApps().length}
    </div>`;
    
    container.innerHTML = html;
  },
  
  newWave() {
    this.showWaveModal({
      title: '🌊 Create New Wave',
      message: 'Enter a descriptive name for this wave',
      inputPlaceholder: 'e.g., Wave Q4 2025',
      confirmText: 'Create Wave',
      type: 'input',
      onConfirm: (name) => {
        if (!name || name.trim().length === 0) {
          this.showWaveAlert('Wave name cannot be empty', 'danger');
          return;
        }
        try {
          Dashboard.StorageManager.addWave({ name: name.trim() });
          this.renderWavesEditor();
          // ✅ Phase 3: Trigger UI refresh so wave changes propagate
          Dashboard.UIController.apply();
          this.showWaveAlert('✅ Wave created successfully', 'success');
        } catch (err) {
          this.showWaveAlert('❌ Error: ' + err.message, 'danger');
        }
      }
    });
  },
  
  showWaveModal(config) {
    const overlay = document.querySelector('.waves-modal-overlay') || this.createWaveModalOverlay();
    const content = overlay.querySelector('.waves-modal-content');
    
    let html = `
      <div class="waves-modal-header">
        <h3>${config.title}</h3>
        <p>${config.message}</p>
      </div>
    `;
    
    if (config.type === 'input') {
      html += `
        <div class="waves-modal-input-group">
          <label>Wave Name</label>
          <input type="text" id="waveInputValue" placeholder="${config.inputPlaceholder}" autofocus style="font-size:14px" />
        </div>
      `;
    } else if (config.type === 'confirm') {
      html += `
        <div class="waves-modal-message warning">
          ${config.message}
        </div>
      `;
    }
    
    html += `
      <div class="waves-modal-actions">
        <button class="waves-modal-btn waves-modal-btn-secondary" onclick="document.querySelector('.waves-modal-overlay').classList.remove('active')">Cancel</button>
    `;
    
    if (config.type === 'input') {
      html += `<button class="waves-modal-btn waves-modal-btn-primary" id="waveConfirmBtn">✓ ${config.confirmText}</button>`;
    } else if (config.type === 'confirm') {
      html += `<button class="waves-modal-btn waves-modal-danger" id="waveConfirmBtn">${config.confirmText}</button>`;
    }
    
    html += `</div>`;
    
    content.innerHTML = html;
    overlay.classList.add('active');
    
    const confirmBtn = document.getElementById('waveConfirmBtn');
    const input = document.getElementById('waveInputValue');
    
    if (input) {
      input.focus();
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') confirmBtn.click();
      });
    }
    
    confirmBtn.onclick = () => {
      overlay.classList.remove('active');
      const value = input ? input.value : true;
      config.onConfirm(value);
    };
    
    document.querySelector('.waves-modal-overlay').addEventListener('click', (e) => {
      if (e.target === overlay) overlay.classList.remove('active');
    });
  },
  
  createWaveModalOverlay() {
    const overlay = document.createElement('div');
    overlay.className = 'waves-modal-overlay';
    overlay.innerHTML = `<div class="waves-modal-content"></div>`;
    document.body.appendChild(overlay);
    return overlay;
  },
  
  showWaveAlert(message, type = 'info') {
    const overlay = document.querySelector('.waves-modal-overlay') || this.createWaveModalOverlay();
    const content = overlay.querySelector('.waves-modal-content');
    
    content.innerHTML = `
      <div class="waves-modal-header">
        <h3>${type === 'success' ? '✅ Success' : type === 'danger' ? '❌ Error' : 'ℹ️ Notice'}</h3>
      </div>
      <div class="waves-modal-message ${type}">
        ${message}
      </div>
      <div class="waves-modal-actions">
        <button class="waves-modal-btn ${type === 'success' ? 'waves-modal-confirm' : 'waves-modal-btn-primary'}" onclick="document.querySelector('.waves-modal-overlay').classList.remove('active')">
          ${type === 'success' ? '👍 Got it' : 'OK'}
        </button>
      </div>
    `;
    
    overlay.classList.add('active');
  },
  
  updateWave(waveId, updates) {
    try {
      Dashboard.StorageManager.updateWave(waveId, updates);
      this.renderWavesEditor();
      // ✅ Phase 3: Trigger UI refresh so wave changes propagate
      Dashboard.UIController.apply();
    } catch (err) {
      this.showWaveAlert('❌ Error: ' + err.message, 'danger');
    }
  },
  
  deleteWave(waveId) {
    this.showWaveModal({
      title: '🗑️ Delete Wave',
      message: 'Are you sure? This action cannot be undone.',
      confirmText: '🗑️ Delete Forever',
      type: 'confirm',
      onConfirm: () => {
        try {
          Dashboard.StorageManager.deleteWave(waveId);
          this.renderWavesEditor();
          // ✅ Phase 3: Trigger UI refresh so wave changes propagate
          Dashboard.UIController.apply();
          this.showWaveAlert('✅ Wave deleted successfully', 'success');
        } catch (err) {
          this.showWaveAlert('❌ ' + err.message, 'danger');
        }
      }
    });
  }
}

// Export module for namespace compatibility
if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.AdminController = AdminController;


/* StorageManager is the ONLY source of truth */

// Settings Tab Enhanced Functionality

/* World-Class Settings Manager */
const AdvancedSettingsManager = {
  SETTINGS_KEY: 'dashboard_advanced_settings_v1',
  BACKUP_KEY: 'dashboard_backup_v1',
  AUDIT_KEY: 'dashboard_audit_log_v1',
  
  defaultSettings: {
    performance: {
      animationSpeed: 1.0,
      refreshInterval: 30000,
      enableTransitions: true
    },
    display: {
      theme: 'auto',
      density: 'comfortable',
      showTooltips: true
    },
    notifications: {
      enableNotifications: true,
      notifyOnProgress: false,
      notifyOnCompletion: true
    },
    security: {
      enableEncryption: true,
      enableAuditLog: true
    },
    privacy: {
      shareUsageData: false,
      enableCrashReports: false,
      dataRetention: 90
    },
    export: {
      includeCalculatedMetrics: true,
      includeAuditTrail: true,
      includeSystemInfo: false
    }
  },
  
  init() {
    this.loadSettings();
    this.setupSettingsEventListeners();
    this.updateSettingsUI();
    this.initializeDragAndDrop();
    this.updateSystemInfo();
    this.loadAuditTrail();
  },
  
  loadSettings() {
    const stored = localStorage.getItem(this.SETTINGS_KEY);
    this.settings = stored ? { ...this.defaultSettings, ...JSON.parse(stored) } : { ...this.defaultSettings };
    return this.settings;
  },
  
  saveSettings() {
    localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(this.settings));
    this.logAuditEvent('settings_changed', 'Settings configuration updated');
    this.showNotification('⚙️ Settings saved successfully', 'success');
    this.updateSystemInfo();
  },
  
  setupSettingsEventListeners() {
    // Performance Settings
    const animationSpeed = document.getElementById('animationSpeed');
    const animationSpeedValue = document.getElementById('animationSpeedValue');
    const refreshInterval = document.getElementById('refreshInterval');
    const enableTransitions = document.getElementById('enableTransitions');
    
    if (animationSpeed) {
      animationSpeed.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        this.settings.performance.animationSpeed = value;
        animationSpeedValue.textContent = value.toFixed(1) + 's';
        this.applyAnimationSpeed(value);
      });
    }
    
    if (refreshInterval) {
      refreshInterval.addEventListener('change', (e) => {
        this.settings.performance.refreshInterval = parseInt(e.target.value);
        this.setupAutoRefresh();
      });
    }
    
    if (enableTransitions) {
      enableTransitions.addEventListener('change', (e) => {
        this.settings.performance.enableTransitions = e.target.checked;
        this.applyTransitionSettings(e.target.checked);
      });
    }
    
    // Display Settings
    const themeInputs = document.querySelectorAll('input[name="theme"]');
    const displayDensity = document.getElementById('displayDensity');
    const showTooltips = document.getElementById('showTooltips');
    
    themeInputs.forEach(input => {
      input.addEventListener('change', (e) => {
        if (e.target.checked) {
          this.settings.display.theme = e.target.value;
          this.applyTheme(e.target.value);
        }
      });
    });
    
    if (displayDensity) {
      displayDensity.addEventListener('change', (e) => {
        this.settings.display.density = e.target.value;
        this.applyDensity(e.target.value);
      });
    }
    
    if (showTooltips) {
      showTooltips.addEventListener('change', (e) => {
        this.settings.display.showTooltips = e.target.checked;
        this.toggleTooltips(e.target.checked);
      });
    }
    
    // Action Buttons
    const createBackupBtn = document.getElementById('createBackupBtn');
    const restoreBackupBtn = document.getElementById('restoreBackupBtn');
    const showAuditTrailBtn = document.getElementById('showAuditTrailBtn');
    const exportAuditBtn = document.getElementById('exportAuditBtn');
    const resetConfigBtn = document.getElementById('resetConfigBtn');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const resetAllSettingsBtn = document.getElementById('resetAllSettingsBtn');
    
    if (createBackupBtn) {
      createBackupBtn.addEventListener('click', () => this.createBackup());
    }
    
    if (restoreBackupBtn) {
      restoreBackupBtn.addEventListener('click', () => this.restoreBackup());
    }
    
    if (showAuditTrailBtn) {
      showAuditTrailBtn.addEventListener('click', () => this.showAuditTrail());
    }
    
    if (exportAuditBtn) {
      exportAuditBtn.addEventListener('click', () => this.exportAuditLog());
    }
    
    if (resetConfigBtn) {
      resetConfigBtn.addEventListener('click', () => this.resetConfiguration());
    }
    
    if (saveSettingsBtn) {
      saveSettingsBtn.addEventListener('click', () => this.saveSettings());
    }
    
    if (resetAllSettingsBtn) {
      resetAllSettingsBtn.addEventListener('click', () => this.resetAllSettings());
    }
    
    // Clear All Data Enhanced
    const confirmationCheckboxes = document.querySelectorAll('#confirmDeletion1, #confirmDeletion2, #confirmDeletion3');
    const clearAllDataBtn = document.getElementById('clearAllDataBtn');
    
    confirmationCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const allChecked = Array.from(confirmationCheckboxes).every(cb => cb.checked);
        if (clearAllDataBtn) {
          clearAllDataBtn.disabled = !allChecked;
        }
      });
    });
  },
  
  updateSettingsUI() {
    // Update Performance UI
    const animationSpeed = document.getElementById('animationSpeed');
    const animationSpeedValue = document.getElementById('animationSpeedValue');
    const refreshInterval = document.getElementById('refreshInterval');
    const enableTransitions = document.getElementById('enableTransitions');
    
    if (animationSpeed) {
      animationSpeed.value = this.settings.performance.animationSpeed;
      animationSpeedValue.textContent = this.settings.performance.animationSpeed.toFixed(1) + 's';
    }
    
    if (refreshInterval) {
      refreshInterval.value = this.settings.performance.refreshInterval;
    }
    
    if (enableTransitions) {
      enableTransitions.checked = this.settings.performance.enableTransitions;
    }
    
    // Update Display UI
    const themeInput = document.querySelector(`input[name="theme"][value="${this.settings.display.theme}"]`);
    const displayDensity = document.getElementById('displayDensity');
    const showTooltips = document.getElementById('showTooltips');
    
    if (themeInput) {
      themeInput.checked = true;
    }
    
    if (displayDensity) {
      displayDensity.value = this.settings.display.density;
    }
    
    if (showTooltips) {
      showTooltips.checked = this.settings.display.showTooltips;
    }
  },
  
  initializeDragAndDrop() {
    const importZone = document.getElementById('importZone');
    const importFileInput = document.getElementById('importAdminJSON');
    
    if (importZone && importFileInput) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        importZone.addEventListener(eventName, this.preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        importZone.addEventListener(eventName, () => importZone.classList.add('dragover'), false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        importZone.addEventListener(eventName, () => importZone.classList.remove('dragover'), false);
      });
      
      importZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          this.handleFileImport(files[0]);
        }
      });
      
      importZone.addEventListener('click', () => importFileInput.click());
      
      importFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          this.handleFileImport(e.target.files[0]);
        }
      });
    }
  },
  
  preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  },
  
  handleFileImport(file) {
    if (!file.type.includes('json')) {
      this.showNotification('❌ Please select a valid JSON file', 'error');
      return;
    }
    
    if (file.size > 10 * 1024 * 1024) { // 10MB limit
      this.showNotification('❌ File size too large. Maximum 10MB allowed.', 'error');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const config = JSON.parse(e.target.result);
        this.validateAndImportConfig(config);
      } catch (error) {
        this.showNotification('❌ Invalid JSON file format', 'error');
        console.error('Import error:', error);
      }
    };
    reader.readAsText(file);
  },
  
  validateAndImportConfig(config) {
    const validationResult = this.validateConfigStructure(config);
    const validationResultEl = document.getElementById('validationResult');
    
    if (validationResult.isValid) {
      validationResultEl.style.display = 'block';
      validationResultEl.querySelector('.status-text').textContent = 'Configuration validated successfully';
      validationResultEl.querySelector('.validation-details').innerHTML = `
        <div>• Business Units: ${config.buses?.length || 0}</div>
        <div>• Applications: ${config.apps?.length || 0}</div>
        <div>• Waves: ${config.waves?.length || 0}</div>
      `;
      
      this.showImportConfirmationDialog(config);
      this.logAuditEvent('config_validated', 'Configuration file validated for import');
    } else {
      validationResultEl.style.display = 'block';
      validationResultEl.classList.add('error');
      validationResultEl.querySelector('.status-icon').textContent = '❌';
      validationResultEl.querySelector('.status-text').textContent = 'Validation failed';
      validationResultEl.querySelector('.validation-details').innerHTML = validationResult.errors.map(error => `<div>• ${error}</div>`).join('');
      this.logAuditEvent('config_validation_failed', `Validation errors: ${validationResult.errors.join(', ')}`);
    }
  },
  
  validateConfigStructure(config) {
    const errors = [];
    
    if (!config.buses || !Array.isArray(config.buses)) {
      errors.push('Missing or invalid "buses" array');
    }
    
    if (!config.apps || !Array.isArray(config.apps)) {
      errors.push('Missing or invalid "apps" array');
    }
    
    if (!config.waves || !Array.isArray(config.waves)) {
      errors.push('Missing or invalid "waves" array');
    }
    
    if (config.buses && config.apps) {
      const buIds = new Set(config.buses.map(bu => bu.id));
      config.apps.forEach((app, index) => {
        if (!buIds.has(app.buId)) {
          errors.push(`App at index ${index} references non-existent Business Unit ID ${app.buId}`);
        }
      });
    }
    
    return {
      isValid: errors.length === 0,
      errors
    };
  },
  
  showImportConfirmationDialog(config) {
    const confirmation = confirm(`Import this configuration?\n\nThis will replace all current data:\n• ${config.buses.length} Business Units\n• ${config.apps.length} Applications\n• ${config.waves.length} Waves\n\nClick OK to proceed or Cancel to abort.`);
    
    if (confirmation) {
      Dashboard.StorageManager.saveConfig(config);
      this.showNotification('✅ Configuration imported successfully', 'success');
      this.logAuditEvent('config_imported', `Imported ${config.buses.length} BUs, ${config.apps.length} apps, ${config.waves.length} waves`);
      
      setTimeout(() => {
        location.reload();
      }, 1500);
    }
  },
  
  createBackup() {
    const config = Dashboard.StorageManager.loadConfig();
    const backup = {
      timestamp: new Date().toISOString(),
      version: '2.0.0',
      data: config,
      settings: this.settings
    };
    
    localStorage.setItem(this.BACKUP_KEY, JSON.stringify(backup));
    this.showNotification('💾 Backup created successfully', 'success');
    this.logAuditEvent('backup_created', 'Manual backup created');
    this.updateBackupInfo();
  },
  
  restoreBackup() {
    const backup = localStorage.getItem(this.BACKUP_KEY);
    if (!backup) {
      this.showNotification('❌ No backup found', 'error');
      return;
    }
    
    const confirmation = confirm('Restore from backup?\n\nThis will replace all current data with the backup version.\n\nClick OK to proceed or Cancel to abort.');
    
    if (confirmation) {
      try {
        const backupData = JSON.parse(backup);
        Dashboard.StorageManager.saveConfig(backupData.data);
        this.settings = backupData.settings || this.defaultSettings;
        localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(this.settings));
        
        this.showNotification('✅ Backup restored successfully', 'success');
        this.logAuditEvent('backup_restored', `Restored backup from ${backupData.timestamp}`);
        
        setTimeout(() => {
          location.reload();
        }, 1500);
      } catch (error) {
        this.showNotification('❌ Failed to restore backup', 'error');
        console.error('Restore error:', error);
      }
    }
  },
  
  updateBackupInfo() {
    const backup = localStorage.getItem(this.BACKUP_KEY);
    const lastBackupTime = document.getElementById('lastBackupTime');
    
    if (backup && lastBackupTime) {
      try {
        const backupData = JSON.parse(backup);
        const date = new Date(backupData.timestamp);
        lastBackupTime.textContent = date.toLocaleString();
      } catch (error) {
        lastBackupTime.textContent = 'Invalid backup';
      }
    }
  },
  
  updateSystemInfo() {
    const configVersion = document.getElementById('configVersion');
    const lastModified = document.getElementById('lastModified');
    const storageInfo = document.getElementById('storageInfo');
    const storageUsed = document.getElementById('storageUsed');
    
    if (configVersion) {
      configVersion.textContent = '2.0.0';
    }
    
    if (lastModified) {
      const config = Dashboard.StorageManager.loadConfig();
      lastModified.textContent = config.lastModified ? new Date(config.lastModified).toLocaleString() : 'Never';
    }
    
    let totalSize = 0;
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key)) {
        totalSize += localStorage[key].length;
      }
    }
    
    const sizeKB = (totalSize / 1024).toFixed(1);
    
    if (storageInfo) {
      storageInfo.textContent = `${sizeKB} KB`;
    }
    
    if (storageUsed) {
      storageUsed.textContent = `${sizeKB} KB`;
    }
  },
  
  logAuditEvent(action, description) {
    if (!this.settings.security.enableAuditLog) return;
    
    const auditLog = JSON.parse(localStorage.getItem(this.AUDIT_KEY) || '[]');
    const event = {
      timestamp: new Date().toISOString(),
      action,
      description,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    auditLog.push(event);
    
    const retentionDays = this.settings.privacy.dataRetention;
    if (retentionDays > 0) {
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
      const filteredLog = auditLog.filter(entry => new Date(entry.timestamp) > cutoffDate);
      localStorage.setItem(this.AUDIT_KEY, JSON.stringify(filteredLog));
    } else {
      localStorage.setItem(this.AUDIT_KEY, JSON.stringify(auditLog));
    }
    
    this.updateAuditStats();
  },
  
  loadAuditTrail() {
    this.updateAuditStats();
  },
  
  updateAuditStats() {
    const auditLog = JSON.parse(localStorage.getItem(this.AUDIT_KEY) || '[]');
    const auditEntries = document.getElementById('auditEntries');
    const auditToday = document.getElementById('auditToday');
    
    if (auditEntries) {
      auditEntries.textContent = auditLog.length;
    }
    
    if (auditToday) {
      const today = new Date().toDateString();
      const todayEntries = auditLog.filter(entry => new Date(entry.timestamp).toDateString() === today);
      auditToday.textContent = todayEntries.length;
    }
  },
  
  showAuditTrail() {
    const auditLog = JSON.parse(localStorage.getItem(this.AUDIT_KEY) || '[]');
    
    if (auditLog.length === 0) {
      this.showNotification('📋 No audit entries found', 'info');
      return;
    }
    
    const auditHTML = auditLog.slice(-50).reverse().map(entry => `
      <div class="audit-entry">
        <div class="audit-timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
        <div class="audit-action">${entry.action}</div>
        <div class="audit-description">${entry.description}</div>
      </div>
    `).join('');
    
    const auditModal = document.createElement('div');
    auditModal.className = 'audit-modal-overlay';
    auditModal.innerHTML = `
      <div class="audit-modal-content">
        <div class="audit-modal-header">
          <h3>📋 Audit Trail (Last 50 entries)</h3>
          <button class="audit-modal-close">✕</button>
        </div>
        <div class="audit-modal-body">
          ${auditHTML}
        </div>
      </div>
    `;
    
    document.body.appendChild(auditModal);
    
    auditModal.querySelector('.audit-modal-close').addEventListener('click', () => {
      document.body.removeChild(auditModal);
    });
    
    auditModal.addEventListener('click', (e) => {
      if (e.target === auditModal) {
        document.body.removeChild(auditModal);
      }
    });
    
    this.logAuditEvent('audit_trail_viewed', 'User viewed audit trail');
  },
  
  exportAuditLog() {
    const auditLog = JSON.parse(localStorage.getItem(this.AUDIT_KEY) || '[]');
    
    if (auditLog.length === 0) {
      this.showNotification('📋 No audit entries to export', 'info');
      return;
    }
    
    const exportData = {
      exportedAt: new Date().toISOString(),
      version: '2.0.0',
      totalEntries: auditLog.length,
      entries: auditLog
    };
    
    const json = JSON.stringify(exportData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dashboard_audit_log_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    this.showNotification('📄 Audit log exported successfully', 'success');
    this.logAuditEvent('audit_log_exported', `Exported ${auditLog.length} audit entries`);
  },
  
  resetConfiguration() {
    const confirmation = confirm('Reset all settings to default?\n\nThis will not affect your data (Business Units, Applications) but will reset all preferences and configurations.\n\nClick OK to proceed or Cancel to abort.');
    
    if (confirmation) {
      this.settings = { ...this.defaultSettings };
      this.saveSettings();
      this.updateSettingsUI();
      this.showNotification('🔄 Settings reset to defaults', 'success');
      this.logAuditEvent('settings_reset', 'All settings reset to default values');
    }
  },
  
  resetAllSettings() {
    this.resetConfiguration();
  },
  
  applyAnimationSpeed(speed) {
    document.documentElement.style.setProperty('--animation-duration', `${speed}s`);
  },
  
  applyTransitionSettings(enabled) {
    document.documentElement.style.setProperty('--transitions-enabled', enabled ? 'all 0.3s ease' : 'none');
  },
  
  applyTheme(theme) {
    if (theme === 'auto') {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    } else {
      document.documentElement.setAttribute('data-theme', theme);
    }
    this.logAuditEvent('theme_changed', `Theme changed to ${theme}`);
  },
  
  applyDensity(density) {
    document.documentElement.setAttribute('data-density', density);
    this.logAuditEvent('density_changed', `Display density changed to ${density}`);
  },
  
  toggleTooltips(enabled) {
    document.documentElement.style.setProperty('--tooltips-enabled', enabled ? 'block' : 'none');
  },
  
  // ========== BU ANALYTICS EXPORT/IMPORT FUNCTIONS ==========
  
  initBUAnalytics() {
    console.log('🚀 Initializing BU Analytics...');
    this.buAnalyticsData = null;
    
    // Use setTimeout to ensure DOM is ready
    setTimeout(() => {
      console.log('📋 Setting up BU Analytics event listeners...');
      this.setupBUAnalyticsEventListeners();
      
      console.log('📊 Populating BU selector dropdown...');
      this.populateBUSelectDropdown();
    }, 50);
  },

  setupBUAnalyticsEventListeners() {
    // Export
    const buSelect = document.getElementById('buAnalyticsExportSelect');
    if (buSelect) {
      buSelect.addEventListener('change', (e) => {
        console.log('📊 BU selected:', e.target.value);
        this.onBUSelectForExport(parseInt(e.target.value));
      });
      console.log('✅ Export selector listener attached');
    } else {
      console.warn('⚠️ Export selector not found');
    }
    
    const exportBtn = document.getElementById('exportBUAnalyticsBtn');
    if (exportBtn) {
      exportBtn.addEventListener('click', () => {
        console.log('📥 Export button clicked');
        this.showBUAnalyticsExportModal();
      });
      console.log('✅ Export button listener attached');
    }
    
    const downloadBtn = document.getElementById('downloadBUAnalyticsBtn');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        console.log('⬇️ Download button clicked');
        this.downloadBUAnalytics();
      });
      console.log('✅ Download button listener attached');
    }
    
    // Import
    const dropZone = document.getElementById('importDropZone');
    if (dropZone) {
      dropZone.addEventListener('click', () => {
        document.getElementById('importBUAnalyticsFile').click();
      });
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
          this.handleBUAnalyticsFileImport(e.dataTransfer.files[0]);
        }
      });
      console.log('✅ Import drop-zone listeners attached');
    }
    
    const fileInput = document.getElementById('importBUAnalyticsFile');
    if (fileInput) {
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          console.log('📁 File selected for import');
          this.handleBUAnalyticsFileImport(e.target.files[0]);
        }
      });
      console.log('✅ File input listener attached');
    }
    
    const confirmBtn = document.getElementById('confirmBUImportBtn');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', () => {
        console.log('✅ Confirm import button clicked');
        this.confirmBUAnalyticsImport();
      });
      console.log('✅ Confirm import button listener attached');
    }
    
    console.log('✅ All BU Analytics event listeners setup complete');
  },

  populateBUSelectDropdown() {
    const select = document.getElementById('buAnalyticsExportSelect');
    if (!select) {
      console.warn('⚠️ buAnalyticsExportSelect not found, retrying...');
      setTimeout(() => this.populateBUSelectDropdown(), 100);
      return;
    }
    
    const buses = Dashboard.StorageManager.getBUs();
    console.log('📊 BUs found:', buses.length, buses);
    
    select.innerHTML = '<option value="">-- Choose a Business Unit --</option>';
    
    buses.forEach(bu => {
      const opt = document.createElement('option');
      opt.value = bu.id;
      opt.textContent = `${bu.name} (${bu.key})`;
      select.appendChild(opt);
      console.log('✅ Added BU option:', bu.name);
    });
    
    console.log('✅ BU selector populated with', buses.length, 'BUs');
  },

  onBUSelectForExport(buId) {
    const btn = document.getElementById('exportBUAnalyticsBtn');
    const previewBox = document.getElementById('exportPreviewBox');
    
    if (!buId) {
      btn.disabled = true;
      previewBox.style.display = 'none';
      return;
    }
    
    const bu = Dashboard.StorageManager.getBUs().find(b => b.id === buId);
    const apps = Dashboard.StorageManager.getAppsByBU(buId);
    
    const completed = apps.filter(a => a.status === 'CLO').length;
    const avgProgress = apps.length > 0
      ? Math.round(apps.reduce((sum, a) => sum + (a.progress || 0), 0) / apps.length)
      : 0;
    
    const jsonStr = JSON.stringify({ bu, apps }, null, 2);
    const fileSize = (new Blob([jsonStr]).size / 1024).toFixed(1);
    
    document.getElementById('exportPreviewApps').textContent = apps.length;
    document.getElementById('exportPreviewProgress').textContent = avgProgress + '%';
    document.getElementById('exportPreviewSize').textContent = fileSize + ' KB';
    
    previewBox.style.display = 'block';
    btn.disabled = false;
    this.buAnalyticsData = { bu, apps };
  },

  showBUAnalyticsExportModal() {
    if (!this.buAnalyticsData) return;
    
    const { bu, apps } = this.buAnalyticsData;
    const completed = apps.filter(a => a.status === 'CLO').length;
    const wip = apps.filter(a => a.status === 'WIP').length;
    const avgProgress = apps.length > 0
      ? Math.round(apps.reduce((sum, a) => sum + (a.progress || 0), 0) / apps.length)
      : 0;
    
    document.getElementById('exportBUName').textContent = bu.name;
    document.getElementById('exportBUMeta').textContent = `${bu.domain} • ${bu.manager || 'No manager'}`;
    document.getElementById('exportStatApps').textContent = apps.length;
    document.getElementById('exportStatComplete').textContent = completed;
    document.getElementById('exportStatWIP').textContent = wip;
    document.getElementById('exportStatProgress').textContent = avgProgress + '%';
    
    document.getElementById('buAnalyticsExportModal').classList.add('active');
  },

  downloadBUAnalytics() {
    if (!this.buAnalyticsData) return;
    
    const { bu, apps } = this.buAnalyticsData;
    const completed = apps.filter(a => a.status === 'CLO').length;
    const wip = apps.filter(a => a.status === 'WIP').length;
    const tbs = apps.filter(a => a.status === 'TBS').length;
    const avgProgress = apps.length > 0
      ? Math.round(apps.reduce((sum, a) => sum + (a.progress || 0), 0) / apps.length * 10) / 10
      : 0;
    
    const exportData = {
      format: 'bu-analytics-v1',
      exportedAt: new Date().toISOString(),
      buData: {
        id: bu.id,
        key: bu.key,
        name: bu.name,
        domain: bu.domain,
        fullname: bu.fullname,
        color: bu.color || '#5b9dff',
        manager: bu.manager || ''
      },
      apps: apps.map(app => ({
        id: app.id,
        buId: app.buId,
        name: app.name,
        status: app.status,
        progress: app.progress || 0,
        weight: app.weight || 1,
        criticality: app.criticality || 'Medium',
        businessImpact: app.businessImpact || app.impact || 'Medium',
        priority: app.priority || 'Medium'
      })),
      statistics: {
        totalApps: apps.length,
        completedApps: completed,
        wipApps: wip,
        tbsApps: tbs,
        averageProgress: avgProgress,
        weightedProgress: Dashboard.ProgressCalculator.calculateBUProgress(bu.id)
      }
    };
    
    const json = JSON.stringify(exportData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bu-analytics_${bu.key}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    document.getElementById('buAnalyticsExportModal').classList.remove('active');
    console.log('✅ BU Analytics exported:', bu.name);
  },

  handleBUAnalyticsFileImport(file) {
    if (!file.name.endsWith('.json')) {
      alert('❌ Please select a valid .json file');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        
        // Validate format
        if (data.format !== 'bu-analytics-v1') {
          throw new Error('Invalid file format. Expected bu-analytics-v1');
        }
        
        if (!data.buData || !Array.isArray(data.apps)) {
          throw new Error('Invalid file structure');
        }
        
        this.showBUAnalyticsImportPreview(data);
      } catch (err) {
        alert('❌ Error reading file:\n\n' + err.message);
        console.error('Import error:', err);
      }
    };
    reader.readAsText(file);
  },

  showBUAnalyticsImportPreview(data) {
    const { buData, apps, statistics } = data;
    
    document.getElementById('importBUName').textContent = buData.name;
    document.getElementById('importBUMeta').textContent = `${buData.domain} • ${buData.manager || 'No manager'}`;
    document.getElementById('importStatApps').textContent = apps.length;
    document.getElementById('importStatComplete').textContent = statistics.completedApps || 0;
    document.getElementById('importStatWIP').textContent = statistics.wipApps || 0;
    document.getElementById('importStatProgress').textContent = statistics.averageProgress.toFixed(1) + '%';
    
    const strategy = document.querySelector('input[name="buMergeStrategy"]:checked').value;
    const strategyText = {
      'replace': '🔄 Replace - This will overwrite the entire Business Unit with the imported data',
      'merge': '🔗 Merge - New apps will be added, existing apps will be updated',
      'append': '➕ Append - All apps will be added as new items'
    };
    
    document.getElementById('importMergeStrategyDisplay').textContent = strategyText[strategy];
    
    const appsList = document.getElementById('importAppsPreviewList');
    appsList.innerHTML = '';
    
    apps.forEach(app => {
      const item = document.createElement('div');
      item.className = 'app-preview-item';
      
      const statusBadges = {
        'TBS': 'app-status-tbs',
        'WIP': 'app-status-wip',
        'CLO': 'app-status-clo'
      };
      
      item.innerHTML = `
        <span class="app-name">${app.name}</span>
        <span class="app-status-badge ${statusBadges[app.status]}">${app.status}</span>
        <span class="app-progress">${app.progress}%</span>
      `;
      appsList.appendChild(item);
    });
    
    this.pendingImportData = data;
    document.getElementById('buAnalyticsImportModal').classList.add('active');
  },

  confirmBUAnalyticsImport() {
    if (!this.pendingImportData) return;
    
    const { buData, apps } = this.pendingImportData;
    const strategy = document.querySelector('input[name="buMergeStrategy"]:checked').value;
    
    try {
      if (strategy === 'replace') {
        this.mergeStrategyReplace(buData, apps);
      } else if (strategy === 'merge') {
        this.mergeStrategyMerge(buData, apps);
      } else if (strategy === 'append') {
        this.mergeStrategyAppend(buData, apps);
      }
      
      document.getElementById('buAnalyticsImportModal').classList.remove('active');
      alert(`✅ Successfully imported ${apps.length} applications from ${buData.name}`);
      this.renderAppsEditor();
      Dashboard.UIController.apply();
      console.log('✅ BU Analytics imported:', buData.name);
      
    } catch (err) {
      alert('❌ Import failed:\n\n' + err.message);
      console.error('Merge error:', err);
    }
  },

  mergeStrategyReplace(buData, apps) {
    // Find or create the BU
    let bu = Dashboard.StorageManager.getBUs().find(b => b.id === buData.id);
    
    if (!bu) {
      // Create new BU
      bu = Dashboard.StorageManager.addBU({
        key: buData.key,
        name: buData.name,
        domain: buData.domain,
        fullname: buData.fullname,
        color: buData.color,
        manager: buData.manager
      });
    }
    
    // Remove old apps for this BU
    const config = Dashboard.StorageManager.loadConfig();
    config.apps = config.apps.filter(a => a.buId !== bu.id);
    
    // Add new apps
    apps.forEach(app => {
      config.apps.push({
        id: Math.max(...config.apps.map(a => a.id || 0)) + 1,
        buId: bu.id,
        name: app.name,
        status: app.status,
        progress: app.progress,
        weight: app.weight,
        criticality: app.criticality,
        businessImpact: app.businessImpact,
        priority: app.priority
      });
    });
    
    Dashboard.StorageManager.saveConfig(config);
  },

  mergeStrategyMerge(buData, apps) {
    // Find or create the BU
    let bu = Dashboard.StorageManager.getBUs().find(b => b.id === buData.id);
    
    if (!bu) {
      bu = Dashboard.StorageManager.addBU({
        key: buData.key,
        name: buData.name,
        domain: buData.domain,
        fullname: buData.fullname,
        color: buData.color,
        manager: buData.manager
      });
    }
    
    const config = Dashboard.StorageManager.loadConfig();
    const existingApps = config.apps.filter(a => a.buId === bu.id);
    
    apps.forEach(importedApp => {
      const existing = existingApps.find(a => a.name === importedApp.name);
      
      if (existing) {
        // Update existing
        existing.status = importedApp.status;
        existing.progress = importedApp.progress;
        existing.criticality = importedApp.criticality;
        existing.businessImpact = importedApp.businessImpact;
        existing.priority = importedApp.priority;
      } else {
        // Add new
        config.apps.push({
          id: Math.max(...config.apps.map(a => a.id || 0)) + 1,
          buId: bu.id,
          name: importedApp.name,
          status: importedApp.status,
          progress: importedApp.progress,
          weight: importedApp.weight,
          criticality: importedApp.criticality,
          businessImpact: importedApp.businessImpact,
          priority: importedApp.priority
        });
      }
    });
    
    Dashboard.StorageManager.saveConfig(config);
  },

  mergeStrategyAppend(buData, apps) {
    // Find or create the BU
    let bu = Dashboard.StorageManager.getBUs().find(b => b.id === buData.id);
    
    if (!bu) {
      bu = Dashboard.StorageManager.addBU({
        key: buData.key,
        name: buData.name,
        domain: buData.domain,
        fullname: buData.fullname,
        color: buData.color,
        manager: buData.manager
      });
    }
    
    const config = Dashboard.StorageManager.loadConfig();
    
    // Add all apps as new (with new IDs)
    apps.forEach(app => {
      config.apps.push({
        id: Math.max(...config.apps.map(a => a.id || 0)) + 1,
        buId: bu.id,
        name: `${app.name} (imported)`,
        status: app.status,
        progress: app.progress,
        weight: app.weight,
        criticality: app.criticality,
        businessImpact: app.businessImpact,
        priority: app.priority
      });
    });
    
    Dashboard.StorageManager.saveConfig(config);
  },
  
  // ========== END BU ANALYTICS FUNCTIONS ==========

  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    Object.assign(notification.style, {
      position: 'fixed',
      top: '20px',
      right: '20px',
      padding: '16px 24px',
      borderRadius: '8px',
      color: 'white',
      fontWeight: '500',
      zIndex: '10000',
      animation: 'slideInRight 0.3s ease',
      maxWidth: '400px',
      boxShadow: '0 8px 24px rgba(0,0,0,0.3)'
    });
    
    const colors = {
      success: '#32e685',
      error: '#ff5f7a',
      warning: '#ffd166',
      info: '#5b9dff'
    };
    
    notification.style.background = colors[type] || colors.info;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 300);
    }, 4000);
  }
};

// Initialize Advanced Settings when the admin modal is opened
document.addEventListener('DOMContentLoaded', () => {
  const initAdvancedSettings = () => {
    if (window.Dashboard && window.Dashboard.AdminController) {
      const originalSwitchTab = Dashboard.AdminController.switchTab;
      Dashboard.AdminController.switchTab = function(tabName) {
        originalSwitchTab.call(this, tabName);
        
        if (tabName === 'settings') {
          setTimeout(() => {
            AdvancedSettingsManager.init();
          }, 100);
        }
      };
      
      const originalExportConfig = Dashboard.AdminController.exportConfig;
      Dashboard.AdminController.exportConfig = function() {
        const config = Dashboard.StorageManager.loadConfig();
        const settings = AdvancedSettingsManager.loadSettings();
        
        const enrichedConfig = {
          ...config,
          exportMetadata: {
            exportedAt: new Date().toISOString(),
            version: '2.0.0',
            schema: 'dashboard_config_v2_enhanced',
            totalBUs: config.buses.length,
            totalApps: config.apps.length,
            totalWaves: config.waves.length
          }
        };
        
        if (settings.export.includeCalculatedMetrics) {
          enrichedConfig.buses = config.buses.map(bu => ({
            ...bu,
            calculatedProgress: Dashboard.ProgressCalculator.calculateBUProgress(bu.id),
            appCount: config.apps.filter(app => app.buId === bu.id).length
          }));
          
          enrichedConfig.apps = config.apps.map(app => ({
            ...app,
            buName: config.buses.find(b => b.id === app.buId)?.name || 'Unknown',
            calculatedWeight: Dashboard.ProgressCalculator.calculateAppWeight(app)
          }));
        }
        
        if (settings.export.includeAuditTrail) {
          const auditLog = JSON.parse(localStorage.getItem(AdvancedSettingsManager.AUDIT_KEY) || '[]');
          enrichedConfig.auditTrail = auditLog.slice(-100);
        }
        
        if (settings.export.includeSystemInfo) {
          enrichedConfig.systemInfo = {
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString(),
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            language: navigator.language,
            settings: settings
          };
        }
        
        const json = JSON.stringify(enrichedConfig, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dashboard_enhanced_config_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        AdvancedSettingsManager.logAuditEvent('config_exported', 'Enhanced configuration exported');
        AdvancedSettingsManager.showNotification('📥 Enhanced configuration exported successfully', 'success');
      };
    } else {
      setTimeout(initAdvancedSettings, 100);
    }
  };
  
  initAdvancedSettings();
});

const notificationStyles = document.createElement('style');
notificationStyles.textContent = `
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
  
  .audit-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(10px);
  }
  
  .audit-modal-content {
    background: var(--panel);
    border: 1px solid var(--ring);
    border-radius: 16px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .audit-modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--ring);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .audit-modal-header h3 {
    margin: 0;
    color: var(--text);
    font-size: 20px;
  }
  
  .audit-modal-close {
    background: none;
    border: none;
    color: var(--text);
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s ease;
  }
  
  .audit-modal-close:hover {
    background: var(--ring);
  }
  
  .audit-modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }
  
  .audit-entry {
    padding: 16px;
    border: 1px solid var(--ring);
    border-radius: 8px;
    margin-bottom: 12px;
    background: rgba(91,157,255,0.02);
    transition: background 0.2s ease;
  }
  
  .audit-entry:hover {
    background: rgba(91,157,255,0.05);
  }
  
  .audit-timestamp {
    font-size: 12px;
    color: rgba(233, 238, 247, 0.7);
    margin-bottom: 4px;
  }
  
  .audit-action {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 4px;
  }
  
  .audit-description {
    font-size: 14px;
    color: var(--text);
  }
`;

document.head.appendChild(notificationStyles);

// End Settings Tab Functionality

/**
 * Applications Overview World-Class Module
 * Enhanced KPI metrics, filtering, and visualization
 */
(function() {
    'use strict';

    const AppsOverviewWorldClass = {
        filteredData: [],
        activeStatusFilter: 'all',
        currentSearchQuery: '',

        init: function() {
            console.log('[AppsOverview] Initializing module...');
            
            // Initialize state properties
            this.activeWaveFilter = 'all';
            this.sortOrder = 'none';
            this.sortColumn = 'order';  // Track which column is being sorted
            
            const tabElement = document.getElementById('tab-app-overview');
            if (!tabElement) {
                console.warn('[AppsOverview] tab-app-overview element not found');
                return;
            }
            console.log('[AppsOverview] Tab found, binding events...');
            this.bindEvents();
            console.log('[AppsOverview] Events bound, refreshing data...');
            this.refresh();
            console.log('[AppsOverview] Initialization complete - Filters: Wave=%s, Sort=%s by %s', this.activeWaveFilter, this.sortOrder, this.sortColumn);
        },

        bindEvents: function() {
            // Status filter buttons
            document.querySelectorAll('.status-pill-filter').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.status-pill-filter').forEach(b => {
                        b.style.background = b.dataset.status === 'all' 
                            ? 'rgba(91,157,255,0.2)' 
                            : b.dataset.status === 'CLO' 
                                ? 'rgba(50,230,133,0.1)' 
                                : b.dataset.status === 'WIP'
                                    ? 'rgba(255,209,102,0.1)'
                                    : 'rgba(255,95,122,0.1)';
                    });
                    e.target.style.background = 'rgba(91,157,255,0.35)';
                    this.activeStatusFilter = e.target.dataset.status;
                    this.filterAndRender();
                });
            });

            // Search input
            const searchInput = document.getElementById('appsOverviewSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    this.currentSearchQuery = e.target.value.toLowerCase();
                    this.filterAndRender();
                });
            }

            // Column header sorting - WORLD CLASS IMPLEMENTATION (clickable headers)
            const headers = document.querySelectorAll('th[data-column]');
            headers.forEach(header => {
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const columnName = header.dataset.column;
                    this.cycleSortOrder(columnName);
                });
            });
        },
        
        cycleSortOrder: function(columnName) {
            // columnName parameter: 'order', 'name', 'buId', 'waveId', 'weight', 'factors', 'progress', 'status'
            // If clicking same column, cycle sort order; if new column, start with 'asc'
            if (this.sortColumn === columnName) {
                // Cycle: asc → desc → none → asc
                if (this.sortOrder === 'asc') {
                    this.sortOrder = 'desc';
                } else if (this.sortOrder === 'desc') {
                    this.sortOrder = 'none';
                } else {
                    this.sortOrder = 'asc';
                }
            } else {
                // New column selected, start with ascending
                this.sortColumn = columnName;
                this.sortOrder = 'asc';
            }

            // Update ALL headers to reflect current sort state
            const headers = document.querySelectorAll('th[data-column]');
            headers.forEach(header => {
                const col = header.dataset.column;
                const isCurrentColumn = col === this.sortColumn;
                
                if (isCurrentColumn) {
                    // Add sort indicator to active column
                    let headerContent = header.textContent.replace(/\s+[▲▼]/, ''); // Remove old indicator
                    const indicator = this.sortOrder === 'asc' ? ' ▲' : this.sortOrder === 'desc' ? ' ▼' : '';
                    header.textContent = headerContent + indicator;
                    
                    // Highlight active column
                    header.style.color = '#5b9dff';
                    header.style.fontWeight = '700';
                    header.style.borderBottomWidth = '2px';
                    header.style.borderBottomColor = '#5b9dff';
                    header.style.borderBottomStyle = 'solid';
                } else {
                    // Reset non-active columns
                    let headerContent = header.textContent.replace(/\s+[▲▼]/, ''); // Remove indicator
                    header.textContent = headerContent;
                    
                    header.style.color = '#aaa';
                    header.style.fontWeight = '600';
                    header.style.borderBottomWidth = '';
                    header.style.borderBottomColor = '';
                    header.style.borderBottomStyle = '';
                }
            });

            this.filterAndRender();
        },

        filterAndRender: function() {
            this.refresh();
        },

        refresh: function() {
            const config = Dashboard.StorageManager.loadConfig();
            const apps = config.apps || [];
            const buses = config.buses || [];
            const waves = config.waves || [];

            // Filter data - WORLD CLASS with Wave + Status + Search
            let filtered = apps.filter(app => {
                const matchesStatus = this.activeStatusFilter === 'all' || app.status === this.activeStatusFilter;
                const matchesSearch = !this.currentSearchQuery || 
                    app.name.toLowerCase().includes(this.currentSearchQuery) ||
                    app.id.toString().toLowerCase().includes(this.currentSearchQuery);
                const matchesWave = this.activeWaveFilter === 'all' || app.wave === this.activeWaveFilter;
                return matchesStatus && matchesSearch && matchesWave;
            });

            // Sort data - WORLD CLASS multi-column sorting
            if (this.sortOrder === 'asc') {
                filtered = filtered.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch(this.sortColumn) {
                        case 'order':
                            valueA = a.order || Infinity;
                            valueB = b.order || Infinity;
                            return valueA - valueB;
                        
                        case 'name':
                            valueA = (a.name || '').toLowerCase();
                            valueB = (b.name || '').toLowerCase();
                            return valueA.localeCompare(valueB);
                        
                        case 'buId':
                            // Lookup BU name for comparison
                            const buA = config.buses?.find(bu => bu.id === a.buId);
                            const buB = config.buses?.find(bu => bu.id === b.buId);
                            valueA = (buA?.name || '').toLowerCase();
                            valueB = (buB?.name || '').toLowerCase();
                            return valueA.localeCompare(valueB);
                        
                        case 'waveId':
                            // Lookup Wave name for comparison
                            const waveA = config.waves?.find(w => w.id === a.waveId);
                            const waveB = config.waves?.find(w => w.id === b.waveId);
                            valueA = (waveA?.name || '').toLowerCase();
                            valueB = (waveB?.name || '').toLowerCase();
                            return valueA.localeCompare(valueB);
                        
                        case 'weight':
                            valueA = a.weight || 1;
                            valueB = b.weight || 1;
                            return valueA - valueB;
                        
                        case 'factors':
                            valueA = (Array.isArray(a.factors) ? a.factors.length : 0);
                            valueB = (Array.isArray(b.factors) ? b.factors.length : 0);
                            return valueA - valueB;
                        
                        case 'progress':
                            valueA = a.progress || 0;
                            valueB = b.progress || 0;
                            return valueA - valueB;
                        
                        case 'status':
                            // Sort order: CLO (Complete) → WIP (In Progress) → TBS (To Start)
                            const statusOrder = { 'CLO': 0, 'WIP': 1, 'TBS': 2 };
                            valueA = statusOrder[a.status] !== undefined ? statusOrder[a.status] : 3;
                            valueB = statusOrder[b.status] !== undefined ? statusOrder[b.status] : 3;
                            return valueA - valueB;
                        
                        default:
                            return 0;
                    }
                });
            } else if (this.sortOrder === 'desc') {
                filtered = filtered.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch(this.sortColumn) {
                        case 'order':
                            valueA = a.order || Infinity;
                            valueB = b.order || Infinity;
                            return valueB - valueA;
                        
                        case 'name':
                            valueA = (a.name || '').toLowerCase();
                            valueB = (b.name || '').toLowerCase();
                            return valueB.localeCompare(valueA);
                        
                        case 'buId':
                            const buA = config.buses?.find(bu => bu.id === a.buId);
                            const buB = config.buses?.find(bu => bu.id === b.buId);
                            valueA = (buA?.name || '').toLowerCase();
                            valueB = (buB?.name || '').toLowerCase();
                            return valueB.localeCompare(valueA);
                        
                        case 'waveId':
                            const waveA = config.waves?.find(w => w.id === a.waveId);
                            const waveB = config.waves?.find(w => w.id === b.waveId);
                            valueA = (waveA?.name || '').toLowerCase();
                            valueB = (waveB?.name || '').toLowerCase();
                            return valueB.localeCompare(valueA);
                        
                        case 'weight':
                            valueA = a.weight || 1;
                            valueB = b.weight || 1;
                            return valueB - valueA;
                        
                        case 'factors':
                            valueA = (Array.isArray(a.factors) ? a.factors.length : 0);
                            valueB = (Array.isArray(b.factors) ? b.factors.length : 0);
                            return valueB - valueA;
                        
                        case 'progress':
                            valueA = a.progress || 0;
                            valueB = b.progress || 0;
                            return valueB - valueA;
                        
                        case 'status':
                            const statusOrder = { 'CLO': 0, 'WIP': 1, 'TBS': 2 };
                            valueA = statusOrder[a.status] !== undefined ? statusOrder[a.status] : 3;
                            valueB = statusOrder[b.status] !== undefined ? statusOrder[b.status] : 3;
                            return valueB - valueA;
                        
                        default:
                            return 0;
                    }
                });
            }

            this.filteredData = filtered;

            // Update metrics
            this.updateMetrics(apps, config);
            
            // Update charts
            this.updateCharts(filtered);
            
            // Render table
            this.renderTable(filtered, buses);
            
            // Show/hide empty state
            const tbody = document.getElementById('appsOverviewTableBody');
            const emptyState = document.getElementById('emptyState');
            if (tbody && emptyState) {
                if (filtered.length === 0) {
                    tbody.innerHTML = '';
                    emptyState.style.display = 'block';
                } else {
                    emptyState.style.display = 'none';
                }
            }
        },

        updateMetrics: function(apps, config) {
            try {
                const total = apps.length;
                const atRisk = apps.filter(a => {
                    const progress = a.progress || 0;
                    return progress > 0 && progress < 50;
                }).length;
                
                const avgCompletion = total > 0 
                    ? Math.round(apps.reduce((sum, a) => sum + (a.progress || 0), 0) / total)
                    : 0;

                const el_total = document.getElementById('statsTotalApps');
                const el_completion = document.getElementById('statsCompletionPct');
                const el_risk = document.getElementById('statsAtRisk');
                
                if (el_total) el_total.textContent = total;
                if (el_completion) el_completion.textContent = avgCompletion;
                if (el_risk) el_risk.textContent = atRisk;
                
                // Wave counts - Dynamic from StorageManager
                const wavesList = Dashboard.StorageManager.getWaves();
                const waves = {};
                apps.forEach(a => {
                    const wave = a.waveId ? wavesList.find(w => w.id === a.waveId)?.name : 'Unknown';
                    waves[wave] = (waves[wave] || 0) + 1;
                });

                // Update wave count elements dynamically
                wavesList.slice(0, 3).forEach((wave, index) => {
                    const el_wave = document.getElementById(`waveCount${index + 1}`);
                    if (el_wave) el_wave.textContent = waves[wave.name] || 0;
                });
            } catch (error) {
                console.error('[AppsOverview] Error updating metrics:', error);
            }
        },

        updateCharts: function(apps) {
            try {
                const total = apps.length;
                
                // Status breakdown
                const statuses = { CLO: 0, WIP: 0, TBS: 0 };
                apps.forEach(a => statuses[a.status || 'TBS']++);
                
                const statusChart = document.getElementById('statusBreakChart');
                if (statusChart) {
                    statusChart.innerHTML = `
                        <div style="flex: ${statuses.CLO || 1}; background: rgba(50,230,133,0.4); border-radius: 2px;" title="Complete"></div>
                        <div style="flex: ${statuses.WIP || 1}; background: rgba(255,209,102,0.4); border-radius: 2px;" title="In Progress"></div>
                        <div style="flex: ${statuses.TBS || 1}; background: rgba(255,95,122,0.4); border-radius: 2px;" title="To Start"></div>
                    `;
                }

                // Update count display
                const totalDisplay = document.getElementById('appsTotalDisplay');
                const countDisplay = document.getElementById('appsCountDisplay');
                if (totalDisplay) totalDisplay.textContent = apps.length;
                if (countDisplay) countDisplay.textContent = apps.length;
            } catch (error) {
                console.error('[AppsOverview] Error updating charts:', error);
            }
        },

        renderTable: function(apps, buses) {
            const tbody = document.getElementById('appsOverviewTableBody');
            if (!tbody) {
                console.warn('[AppsOverview] tbody not found');
                return;
            }

            try {
                tbody.innerHTML = apps.map(app => {
                    const bu = buses.find(b => b.id === app.buId);
                    const buName = bu ? bu.name : 'N/A';
                    const progress = app.progress || 0;
                    const factors = Array.isArray(app.factors) ? app.factors : [];
                    const wave = Dashboard.StorageManager.getWaveNameById(app.waveId);
                    
                    let statusBadge = '⏳ To Start';
                    let statusColor = 'to-start';
                    if (app.status === 'CLO') {
                        statusBadge = '✓ Complete';
                        statusColor = 'complete';
                    } else if (app.status === 'WIP') {
                        statusBadge = '🔄 In Progress';
                        statusColor = 'in-progress';
                    }

                    // Dynamic wave color based on wave index
                    const waveIndex = Dashboard.StorageManager.getWaves().findIndex(w => w.id === app.waveId);
                    const waveColor = waveIndex === 0 ? 'w1' : waveIndex === 1 ? 'w2' : 'w3';

                    return `
                        <tr class="app-row-${statusColor}">
                            <td style="color: #5b9dff; font-weight: 600;">${app.order || '—'}</td>
                            <td>${app.name || 'Unnamed'}</td>
                            <td>${buName}</td>
                            <td style="text-align: center;"><span class="badge-wave ${waveColor}">${wave}</span></td>
                            <td style="text-align: center;"><strong>${(app.weight || 1).toFixed(1)}</strong></td>
                            <td style="text-align: center;"><span style="font-size: 11px; color: #aaa;">${factors.length}</span></td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="flex: 1; height: 6px; background: rgba(91,157,255,0.2); border-radius: 3px; overflow: hidden;">
                                        <div style="height: 100%; background: ${progress === 100 ? '#32e685' : progress > 50 ? '#ffd166' : '#ff5f7a'}; width: ${progress}%; transition: width 0.3s ease;"></div>
                                    </div>
                                    <span style="font-weight: 600; min-width: 40px; text-align: right;">${Math.round(progress)}%</span>
                                </div>
                            </td>
                            <td style="text-align: center;"><span class="status-badge ${statusColor}">${statusBadge}</span></td>
                        </tr>
                    `;
                }).join('');
                console.log(`[AppsOverview] Rendered ${apps.length} applications`);
            } catch (error) {
                console.error('[AppsOverview] Error rendering table:', error);
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: 20px; color: #ff5f7a;">Error rendering table: ${error.message}</td></tr>`;
            }
        }
    };

    if (!window.Dashboard) window.Dashboard = {};
    window.Dashboard.AppsOverviewWorldClass = AppsOverviewWorldClass;

})();

/* Main entry point - AFTER all modules are defined */
document.addEventListener('DOMContentLoaded', function() {
    // Initialize StorageManager FIRST to detect cleared state
    Dashboard.StorageManager.init();
    
    // Initialize other modules in the correct order
    Dashboard.AdminController.init();
    Dashboard.UIController.init();
    
    // Initialize Applications Overview World-Class module
    if (typeof Dashboard.AppsOverviewWorldClass !== 'undefined') {
        Dashboard.AppsOverviewWorldClass.init();
    }
});
</script>
</body>
</html>