<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ¬∑ Avance por √Årea (Ultra)</title>
  
  
  
<style>
/* Admin Panel Styles */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  backdrop-filter:blur(10px);
  animation:fadeIn 0.3s ease;
  box-sizing:border-box;
  width:100vw;
  height:100vh;
}
.modal-overlay.active{display:flex}
.modal-content{
  background:linear-gradient(135deg,rgba(91,157,255,0.05),transparent),var(--panel);
  border:1px solid var(--ring);
  box-shadow:0 20px 70px rgba(0,0,0,0.7), 0 0 0 1px rgba(91,157,255,0.1) inset;
  border-radius:calc(var(--radius) * 1.2);
  box-sizing:border-box !important;
  max-width:90% !important;
  width:90% !important;
  min-width:320px;
  height:auto;
  min-height:400px;
  max-height:90vh;
  overflow:hidden;
  position:relative;
  animation:slideInUp .5s cubic-bezier(0.34, 1.56, 0.64, 1);
  display:flex;
  flex-direction:column;
  margin:0 auto;
}
@media (max-width: 1024px) {
  .modal-content{
    width:95vw !important;
    max-height:92vh;
    min-height:350px;
  }
}
@media (max-width: 768px) {
  .modal-content{
    width:98vw !important;
    max-height:95vh;
    min-height:300px;
    border-radius:var(--radius);
  }
}
.nested-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:99999;opacity:0;pointer-events:none;transition:opacity 0.3s;backdrop-filter:blur(8px)}
.nested-modal.active{opacity:1;pointer-events:auto}
.nested-modal-content{
  background:linear-gradient(135deg,rgba(91,157,255,0.05),transparent),var(--panel);
  border:1px solid var(--ring);
  border-radius:var(--radius);
  box-shadow:0 25px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(91,157,255,0.15) inset;
  width:600px;
  max-width:92%;
  max-height:90vh;
  padding:0;
  position:relative;
  animation:popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.5);
  overflow-y:auto;
  overflow-x:hidden;
  display:flex;
  flex-direction:column;
}
/* Premium scrollbar for nested modal content */
.nested-modal-content::-webkit-scrollbar{width:8px}
.nested-modal-content::-webkit-scrollbar-track{background:rgba(14,22,39,0.4);border-radius:4px;margin:4px 0}
.nested-modal-content::-webkit-scrollbar-thumb{background:linear-gradient(180deg, rgba(91,157,255,0.6), rgba(50,230,133,0.4));border-radius:4px;transition:background 0.3s ease}
.nested-modal-content::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg, rgba(91,157,255,0.8), rgba(50,230,133,0.6))}
@media (min-width: 1800px) {
  .modal-content{max-width:none;width:90vw}
}
@media (max-width: 1200px) {
  .modal-content{width:92vw;max-width:none}
}
@media (max-width: 768px) {
  .modal-content{width:98%;margin:0;border-radius:var(--radius)}
  .modal-tabpanel.active{padding:20px 16px}
  .modal-header{padding:18px 20px}
}
@keyframes popIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}
@keyframes fadeOutIn{0%{opacity:1}50%{opacity:0}100%{opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes glowPulse{0%{box-shadow:0 0 0 rgba(91,157,255,0)}50%{box-shadow:0 0 15px rgba(91,157,255,0.3)}100%{box-shadow:0 0 0 rgba(91,157,255,0)}}
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:0;
  padding:16px 24px 12px 24px;
  background:linear-gradient(135deg,rgba(91,157,255,0.1),rgba(91,157,255,0.02));
  position:sticky;
  top:0;
  z-index:10;
  border-bottom:1px solid rgba(91,157,255,0.2);
  backdrop-filter:blur(12px);
}
.modal-header h2{
  margin:0;
  font-size:22px;
  color:var(--text);
  font-weight:700;
  letter-spacing:0.5px;
  display:flex;
  align-items:center;
  gap:12px;
}
.modal-header h2::before{
  /* Remove duplicate icon */
  content:"";
  display:none;
}
.modal-close{
  appearance:none;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--muted);
  font-size:18px;
  cursor:pointer;
  padding:0;
  width:36px;
  height:36px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:12px;
  transition:all 0.2s ease;
}
.modal-close:hover{
  color:var(--text);
  background:rgba(255,95,122,0.15);
  transform:rotate(90deg);
}
/* Modal body with padding for nested modals */
.modal-body{
  flex:1;
  overflow-y:auto;
  padding:20px;
  display:flex;
  flex-direction:column;
}
.modal-tabs{
  display:flex;
  gap:4px;
  padding:8px 32px 0 32px;
  margin-top:0;
  border-bottom:1px solid var(--ring);
  background:linear-gradient(180deg,rgba(14,22,39,0.95),rgba(20,30,60,0.3));
  overflow-x:auto;
  scrollbar-width:thin;
  scrollbar-color:rgba(91,157,255,0.3) transparent;
  position:sticky;
  top:0;
  z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  flex-shrink:0;
  min-height:60px;
  height:60px;
  backdrop-filter:blur(10px);
}
.modal-tabs::-webkit-scrollbar {
  height: 4px;
}
.modal-tabs::-webkit-scrollbar-track {
  background: transparent;
}
.modal-tabs::-webkit-scrollbar-thumb {
  background: rgba(91,157,255,0.3);
  border-radius: 2px;
}
.modal-tab{
  appearance:none;
  background:none;
  border:none;
  color:var(--muted);
  padding:16px 24px;
  cursor:pointer;
  border-bottom:2px solid transparent;
  font-size:14px;
  font-weight:500;
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
  white-space:nowrap;
  letter-spacing:0.2px;
  flex-shrink:0;
  min-width:max-content;
  display:flex;
  align-items:center;
  gap:8px;
  border-radius:8px 8px 0 0;
  margin:0 2px;
}
.modal-tab:hover{
  color:#ffffff;
  background:linear-gradient(135deg, rgba(91,157,255,0.25), rgba(91,157,255,0.15));
  border-bottom-color:rgba(91,157,255,0.6);
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(91,157,255,0.3);
}
.modal-tab.active{
  color:#ffffff;
  border-bottom-color:var(--primary);
  background:rgba(91,157,255,0.15);
  font-weight:600;
}
.modal-tab.active::after{
  content:"";
  position:absolute;
  bottom:-2px;
  left:0;
  width:100%;
  height:3px;
  background:var(--primary);
  box-shadow:0 0 12px 2px rgba(91,157,255,0.6);
  animation:glowPulse 2s infinite;
}
@media (max-width: 768px) {
  .modal-tabs{
    padding:0 16px;
    gap:0;
  }
  .modal-tab{
    padding:18px 12px;
    font-size:13px;
  }
}
.modal-tabpanel{display:none;animation:fadeIn 0.4s ease}
.modal-tabpanel.active{
  display:block;
  padding:32px;
}
@media (max-width: 1024px) {
  .modal-tabpanel.active{
    padding:24px;
  }
}
@media (max-width: 768px) {
  .modal-tabpanel.active{
    padding:16px;
  }
}

/* Tab Headers */
.tab-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:24px;
  margin-bottom:28px;
  padding-bottom:20px;
  border-bottom:1px solid var(--ring);
}
.tab-header h3{
  margin:0 0 8px 0;
  font-size:20px;
  color:var(--text);
  font-weight:700;
}
.tab-description{
  margin:0;
  font-size:13px;
  color:var(--muted);
  line-height:1.5;
}
@media (max-width: 768px) {
  .tab-header{
    flex-direction:column;
    gap:16px;
    margin-bottom:20px;
    padding-bottom:16px;
  }
  .tab-header h3{
    font-size:18px;
  }
  .tab-header button{
    width:100%;
  }
}

/* Filters Bar */
.filters-bar{display:flex;gap:12px;margin-bottom:24px;padding:16px;background:var(--bg-2);border-radius:10px;border:1px solid var(--ring)}
.filter-select{appearance:none;background:var(--bg);border:1px solid var(--ring);color:var(--text);padding:10px 12px;border-radius:8px;font-size:13px;cursor:pointer;transition:all 0.2s ease;min-width:200px}
.filter-select:hover,.filter-select:focus{border-color:var(--primary);box-shadow:0 0 8px rgba(91,157,255,.2);outline:none}

/* Settings Styles */
.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.settings-section{background:var(--bg-2);border:1px solid var(--ring);border-radius:10px;padding:20px;transition:all 0.2s ease}
/* Enterprise Formula Styles */
.formula-hero-section{background:linear-gradient(135deg, var(--primary)20, var(--ok)10);border:2px solid var(--primary);border-radius:20px;padding:40px;margin-bottom:32px;position:relative;overflow:hidden}
.formula-hero-section::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 20% 20%, var(--primary)15 0%, transparent 50%),radial-gradient(circle at 80% 80%, var(--ok)15 0%, transparent 50%);pointer-events:none}
.hero-content{position:relative;z-index:1;text-align:center}
.hero-icon{font-size:48px;margin-bottom:16px;display:block;animation:pulse 2s infinite}
@keyframes pulse{0%, 100%{transform:scale(1)}50%{transform:scale(1.1)}}
.hero-content h2{color:var(--text);font-size:32px;font-weight:700;margin:0 0 12px 0;background:linear-gradient(135deg, var(--primary), var(--ok));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.hero-subtitle{color:var(--text-secondary);font-size:16px;margin:0 0 32px 0}
.formula-showcase{display:flex;justify-content:center}
.formula-box{background:var(--bg);border:2px solid var(--primary);border-radius:16px;padding:24px;width:100%;max-width:900px;box-shadow:0 8px 32px rgba(91, 157, 255, 0.2)}
.formula-label{color:var(--primary);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.formula-equation{font-family:'Segoe UI', system-ui;font-size:20px;font-weight:600;color:var(--text);margin-bottom:8px}
.formula-equation .highlight{color:var(--primary);background:var(--primary)20;padding:2px 8px;border-radius:6px}
.formula-range{color:var(--text-secondary);font-size:14px;font-family:'Courier New', monospace}
.business-intelligence-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:20px;max-width:100%;overflow:hidden}
.bi-card{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:0;overflow:hidden;transition:all 0.3s ease;position:relative}
.bi-card:hover{border-color:var(--primary);box-shadow:0 8px 32px rgba(91, 157, 255, 0.1);transform:translateY(-2px)}
.bi-header{background:linear-gradient(135deg, var(--bg), var(--panel));border-bottom:1px solid var(--ring);padding:20px;display:flex;align-items:center;justify-content:space-between}
.bi-header h4{color:var(--text);font-size:16px;font-weight:600;margin:0}
.bi-badge{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;background:var(--primary);color:white}
.bi-badge.calculator{background:var(--ok)}
.bi-badge.config{background:var(--warn)}
.bi-badge.rules{background:var(--danger)}
.bi-badge.global{background:linear-gradient(135deg, var(--primary), var(--ok))}
.bi-badge.examples{background:var(--text-secondary)}
/* Priority Badge Styling - World-class visual consistency */
.priority-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:12px;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap;transition:all 0.2s ease;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.priority-badge.priority-high{background:linear-gradient(135deg, var(--danger), #ff7a8f);color:white;border:1px solid var(--danger)}
.priority-badge.priority-high:hover{box-shadow:0 4px 12px rgba(255,95,122,0.3);transform:translateY(-1px)}
.priority-badge.priority-medium{background:linear-gradient(135deg, var(--warn), #ffe599);color:#000;border:1px solid var(--warn)}
.priority-badge.priority-medium:hover{box-shadow:0 4px 12px rgba(255,209,102,0.3);transform:translateY(-1px)}
.priority-badge.priority-low{background:linear-gradient(135deg, var(--ok), #5fff99);color:#000;border:1px solid var(--ok)}
.priority-badge.priority-low:hover{box-shadow:0 4px 12px rgba(50,230,133,0.3);transform:translateY(-1px)}
#appsOverviewTableBody td:nth-child(5){text-align:center;vertical-align:middle}
.factor-matrix{padding:20px}
.factor-row{display:grid;grid-template-columns:1fr 2fr 1fr;align-items:center;gap:16px;padding:16px 0;border-bottom:1px solid var(--ring)}
.factor-row:last-child{border-bottom:none}
.factor-name{color:var(--text);font-weight:600;font-size:14px}
.factor-scale{display:flex;gap:8px}
.scale-item{flex:1;padding:8px;border-radius:8px;text-align:center;font-size:12px;font-weight:600;position:relative}
.scale-item.danger{background:var(--danger);color:white}
.scale-item.warn{background:var(--warn);color:white}
.scale-item.ok{background:var(--ok);color:white}
.scale-item span{position:absolute;top:-8px;right:-8px;background:var(--bg);border:2px solid currentColor;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700}
.factor-desc{color:var(--text-secondary);font-size:12px;text-align:center}
.calculator-content{padding:20px}
.calc-inputs{display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:16px;margin-bottom:24px}
.calc-input label{display:block;color:var(--text);font-size:12px;font-weight:600;margin-bottom:6px}
.calc-input select,.calc-input input{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--ring);border-radius:8px;color:var(--text);font-size:14px}
.calc-result{background:linear-gradient(135deg, var(--primary)20, var(--ok)10);border:2px solid var(--primary);border-radius:12px;padding:20px;text-align:center}
.result-label{color:var(--text-secondary);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.result-value{color:var(--primary);font-size:36px;font-weight:700;margin-bottom:8px}
.result-formula{color:var(--text);font-family:'Courier New', monospace;font-size:14px}
.config-content,.inclusion-content,.global-content{padding:20px}
.method-selector{display:flex;flex-direction:column;gap:16px}
.method-option{position:relative}
.method-option input[type="radio"]{position:absolute;opacity:0;pointer-events:none}
.method-option label{display:block;background:var(--bg);border:2px solid var(--ring);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.3s ease}
.method-option input[type="radio"]:checked + label{border-color:var(--primary);background:var(--primary)10}
.method-name{color:var(--text);font-weight:600;font-size:14px;margin-bottom:4px}
.method-desc{color:var(--text-secondary);font-size:12px;margin-bottom:8px}
.method-formula{color:var(--primary);font-family:'Courier New', monospace;font-size:12px;background:var(--bg);padding:8px 12px;border-radius:6px;border:1px solid var(--ring)}
.inclusion-grid{display:flex;flex-direction:column;gap:16px}
.inclusion-item{background:var(--bg);border:1px solid var(--ring);border-radius:10px;padding:16px}
.inclusion-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.inclusion-checkbox{width:18px;height:18px;accent-color:var(--primary)}
.status-badge{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.status-badge.danger{background:var(--danger);color:white}
.status-badge.warn{background:var(--warn);color:white}
.status-badge.ok{background:var(--ok);color:white}
.inclusion-name{color:var(--text);font-weight:600;font-size:14px}
.inclusion-desc{color:var(--text-secondary);font-size:12px;margin-left:30px}
.global-selector{display:flex;flex-direction:column;gap:16px}
.global-option{position:relative}
.global-option input[type="radio"]{position:absolute;opacity:0;pointer-events:none}
.global-option label{display:block;background:var(--bg);border:2px solid var(--ring);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.3s ease}
.global-option input[type="radio"]:checked + label{border-color:var(--primary);background:var(--primary)10}
.global-name{color:var(--text);font-weight:600;font-size:14px;margin-bottom:8px}
.global-formula{color:var(--primary);font-family:'Courier New', monospace;font-size:12px;background:var(--panel);padding:8px 12px;border-radius:6px;border:1px solid var(--ring)}
.examples-content{padding:20px}
.example-item{display:flex;align-items:center;gap:16px;background:var(--bg);border:1px solid var(--ring);border-radius:10px;padding:16px;margin-bottom:12px;transition:all 0.3s ease}
.example-item:last-child{margin-bottom:0}
.example-item:hover{border-color:var(--primary);background:var(--primary)05}
.example-item .auto-weight{background:var(--primary);color:white;padding:8px 16px;border-radius:20px;font-weight:700;font-size:16px;min-width:60px;text-align:center;box-shadow:0 4px 12px rgba(91, 157, 255, 0.3)}
.example-item.max .auto-weight{background:var(--danger)}
.example-item.high .auto-weight{background:var(--warn)}
.example-item.standard .auto-weight{background:var(--primary)}
.example-item.low .auto-weight{background:var(--text-secondary)}
.example-item.min .auto-weight{background:var(--ok)}
.example-details{flex:1}
.example-combo{color:var(--text);font-weight:600;font-size:14px;margin-bottom:4px}
.example-desc{color:var(--text-secondary);font-size:12px}
.formula-label{font-family:monospace;background:rgba(0,0,0,0.2);padding:8px;border-radius:6px;display:block;margin-top:8px}
.math-formula{color:var(--text)}
.status-config{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.status-badge{display:inline-block;padding:2px 8px;border-radius:4px;margin-right:8px;font-weight:500;font-size:0.85em}
.status-badge.danger{background:var(--danger);color:white}
.status-badge.warn{background:var(--warn);color:#000}
.status-badge.ok{background:var(--ok);color:#000}
.weight-config{display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:16px}
.formula-actions{grid-column:1/-1;display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
@media (max-width:1200px){.business-intelligence-grid{grid-template-columns:repeat(2, 1fr);gap:18px}}@media (max-width:768px){.business-intelligence-grid{grid-template-columns:1fr;gap:16px}.formula-box{min-width:auto;width:100%}.calc-inputs{grid-template-columns:1fr}.factor-row{grid-template-columns:1fr;gap:8px}.factor-scale{order:2}.factor-desc{order:3;text-align:left}}
.bi-card.factor-analysis{background:linear-gradient(135deg, var(--panel), var(--bg))}
.bi-card.weight-calculator{background:linear-gradient(135deg, var(--primary)05, var(--panel))}
.bi-card.progress-config{background:linear-gradient(135deg, var(--warn)05, var(--panel))}
.bi-card.status-inclusion{background:linear-gradient(135deg, var(--danger)05, var(--panel))}
.bi-card.global-progress{background:linear-gradient(135deg, var(--ok)05, var(--panel))}
.bi-card.weight-examples{background:linear-gradient(135deg, var(--text-secondary)05, var(--panel))}
.calc-input select:focus,.calc-input input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary)20;outline:none}
.method-option:hover label{border-color:var(--primary);background:var(--primary)05}
.global-option:hover label{border-color:var(--primary);background:var(--primary)05}
.inclusion-item:hover{border-color:var(--primary);background:var(--primary)03}
.formula-hero-section .hero-content h2{text-shadow:0 2px 4px rgba(0,0,0,0.1)}
.result-value{text-shadow:0 2px 8px rgba(91, 157, 255, 0.3);transition:all 0.3s ease}
.auto-weight{transition:all 0.3s ease;box-shadow:0 2px 8px rgba(91, 157, 255, 0.2)}
.bi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg, var(--primary), var(--ok));opacity:0;transition:opacity 0.3s ease}
.bi-card:hover::before{opacity:1}
.settings-section:hover{border-color:var(--primary);background:var(--bg)}
.settings-section.danger{border-color:var(--danger);background:rgba(255,95,122,0.05)}
.settings-section-title{margin:0 0 8px 0;font-size:15px;color:var(--text);font-weight:600}
.settings-description{margin:0 0 16px 0;font-size:12px;color:var(--muted);line-height:1.5}

/* Whitelabel Styles */
.whitelabel-container{display:flex;flex-direction:column;gap:24px}
.whitelabel-section{background:var(--bg-2);border:1px solid var(--ring);border-radius:10px;padding:24px;transition:all 0.2s ease}
.whitelabel-section:hover{border-color:var(--primary)}
.whitelabel-section-title{margin:0 0 16px 0;font-size:16px;color:var(--text);font-weight:600}
.form-group{margin-bottom:16px;display:flex;flex-direction:column;gap:8px}
.form-group label{font-size:13px;font-weight:500;color:var(--text)}
.form-input{padding:10px 12px;border:1px solid var(--ring);border-radius:8px;background:var(--bg);color:var(--text);font-size:14px;transition:all 0.2s ease}
.form-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(91,157,255,0.1)}
.form-help{font-size:11px;color:var(--muted);margin:0}
.logo-upload-area{display:flex;flex-direction:column;gap:12px;align-items:center;padding:16px;border:2px dashed var(--ring);border-radius:8px;background:rgba(91,157,255,0.02);transition:all 0.2s ease}
.logo-upload-area:hover{border-color:var(--primary);background:rgba(91,157,255,0.05)}
.logo-preview{width:100%;height:100px;background:var(--bg);border:1px solid var(--ring);border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
.logo-preview img{max-width:100%;max-height:100%;object-fit:contain}
.logo-placeholder{font-size:12px;color:var(--muted)}
.whitelabel-preview{background:var(--bg);border:1px solid var(--ring);border-radius:8px;overflow:hidden;box-shadow:inset 0 0 20px rgba(0,0,0,0.2)}
.preview-header{display:flex;align-items:center;justify-content:space-between;padding:24px;gap:20px;background:linear-gradient(135deg,rgba(91,157,255,0.08),rgba(91,157,255,0.01))}
.preview-logo-left,.preview-logo-right{width:120px;height:60px;background:var(--bg-2);border:1px solid var(--ring);border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;color:var(--muted)}
.preview-logo-left img,.preview-logo-right img{max-width:100%;max-height:100%;object-fit:contain}
.preview-title{flex:1;text-align:center}
.preview-title h2{margin:0 0 4px 0;font-size:20px;color:var(--text);font-weight:700}
.preview-title p{margin:0;font-size:12px;color:var(--muted)}
.btn-sm{padding:6px 12px;font-size:12px}

/* Applications Table Container */
.apps-table-container{
  max-height:70vh;
  overflow-y:auto;
  overflow-x:hidden;
  border:1px solid var(--ring);
  border-radius:10px;
  background:var(--bg);
  box-shadow:inset 0 0 20px rgba(0,0,0,0.2);
  scrollbar-width:thin;
  scrollbar-color:rgba(91,157,255,0.3) rgba(0,0,0,0.1);
}

/* Modal Footer */
.modal-footer{display:flex;gap:16px;justify-content:flex-end;padding:24px 32px;border-top:1px solid var(--ring);background:var(--bg-2);margin-top:auto;flex-shrink:0}
@media (max-width: 768px) {
  .modal-footer{padding:16px 20px;flex-direction:column;gap:10px}
  .modal-footer button {width:100%}
}

/* Modal Scroll Container */
.modal-scroll-container{
  flex:1;
  overflow-y:auto;
  overflow-x:hidden;
  scrollbar-width:thin;
  scrollbar-color:rgba(91,157,255,0.3) rgba(0,0,0,0.1);
  padding-bottom:20px;
}
.modal-scroll-container::-webkit-scrollbar {
  width: 8px;
}
.modal-scroll-container::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.1);
  border-radius: 4px;
}
.modal-scroll-container::-webkit-scrollbar-thumb {
  background: rgba(91,157,255,0.3);
  border-radius: 4px;
}
.modal-scroll-container::-webkit-scrollbar-thumb:hover {
  background: rgba(91,157,255,0.5);
}

/* Applications Selector Section */
.apps-selector-section{background:var(--glass);border:1px solid var(--ring);border-radius:10px;padding:20px;margin-bottom:24px}
.bu-selector-premium{appearance:none;background:var(--bg-2);border:1px solid var(--ring);color:var(--text);padding:12px 14px;border-radius:8px;font-size:14px;width:100%;cursor:pointer;transition:all 0.2s ease;font-weight:600}
.bu-selector-premium:hover,.bu-selector-premium:focus{border-color:var(--primary);background:var(--bg);box-shadow:0 0 12px rgba(91,157,255,.25);outline:none}

/* Apps Editor Container */
#appEditorContainer h3{font-size:18px;color:var(--text);font-weight:700;margin:0 0 16px 0;display:flex;align-items:center;gap:8px}
#appEditorContainer h3:before{content:"üìã";font-size:20px}

/* Apps Editor Header */
.apps-editor-header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid var(--ring)}

/* Apps Table Wrapper */
.apps-table-wrapper{border:1px solid var(--ring);border-radius:10px;overflow:hidden}
.cell-input{appearance:none;background:transparent;border:none;color:var(--text);padding:2px;font-size:12px;width:100%;font-family:inherit}
.cell-input:focus{outline:none;background:var(--ring);border-radius:4px;padding:2px 4px}
.cell-select{appearance:none;background:transparent;border:none;color:var(--text);padding:2px;font-size:12px;width:100%;cursor:pointer;font-family:inherit}
.cell-select:focus{outline:none;background:var(--ring);border-radius:4px;padding:2px 4px}
.progress-cell{position:relative}
.progress-cell input{width:100%}
.mini-progress{position:absolute;bottom:0;left:0;height:2px;border-radius:1px;opacity:0.6;transition:width 0.3s ease}
.empty-row{background:var(--bg-2)!important}
.bu-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
@media (min-width: 1400px) {
  .bu-list{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
}
@media (max-width: 768px) {
  .bu-list{grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
}
.bu-card{padding:16px;border:1px solid var(--ring);border-radius:14px;background:linear-gradient(160deg, var(--glass), transparent), var(--bg-2);cursor:pointer;transition:all .3s cubic-bezier(0.17, 0.67, 0.83, 0.67);position:relative;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,0.08);overflow:hidden;animation:fadeIn 0.5s ease-out}
.bu-card::before{content:'';position:absolute;left:0;top:0;width:4px;height:100%;background:var(--primary);opacity:0;transition:opacity .2s ease}
.bu-card:hover{background:linear-gradient(160deg, var(--glass), transparent), var(--bg);border-color:var(--primary);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.12)}
.bu-card.selected{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), var(--ring)}
.bu-card.selected::before{opacity:1}
.bu-card-name{font-weight:700;margin-bottom:6px;font-size:16px;display:flex;align-items:center;gap:6px}
.bu-card-meta{font-size:12px;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:4px}
.bu-card-meta:last-child{margin-top:8px;padding-top:8px;border-top:1px dashed var(--ring)}
.bu-card-actions{position:absolute;top:12px;right:12px;display:flex;gap:6px;z-index:5;opacity:0.6;transition:opacity 0.2s, transform 0.2s}
.bu-card:hover .bu-card-actions{opacity:1;transform:translateY(0)}
.bu-card-btn{appearance:none;background:rgba(0,0,0,0.1);border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(2px);color:var(--text);cursor:pointer;font-size:14px;padding:0;width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:transform 0.2s, color 0.2s, background-color 0.2s, box-shadow 0.2s}
.bu-card-btn:hover{color:var(--primary);transform:scale(1.1);background:var(--bg);box-shadow:0 3px 6px rgba(0,0,0,0.15)}
.bu-card-btn.edit-bu-btn:hover{color:var(--primary)}
.bu-card-btn.delete-bu-btn:hover{color:var(--danger)}
.bu-empty-badge{font-size:10px;background:var(--ring);color:var(--muted);padding:3px 7px;border-radius:10px;vertical-align:middle;font-weight:500}
.bu-card.empty{opacity:0.85;border-style:dashed}
.bu-card-progress{position:relative;height:6px;background:var(--ring);border-radius:3px;margin-top:10px;overflow:hidden}
.bu-card-progress-bar{position:absolute;left:0;top:0;height:100%;background:var(--primary);border-radius:3px}
.bu-card-icon{display:inline-block;width:14px;height:14px;line-height:14px;font-size:12px;text-align:center}
.app-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  margin-top:0;
  background:var(--bg);
  table-layout:auto;
}
.app-table th{
  text-align:left;
  padding:16px 18px;
  border-bottom:2px solid var(--ring);
  font-size:14px;
  color:var(--text);
  font-weight:700;
  background:linear-gradient(180deg, var(--bg-2), rgba(14, 22, 39, 0.8));
  cursor:pointer;
  user-select:none;
  transition:all 0.2s ease;
  position:sticky;
  top:0;
  z-index:5;
}
.app-table th:hover{
  background:linear-gradient(180deg, rgba(91,157,255,0.1), rgba(14, 22, 39, 0.9));
  color:var(--primary);
}
.app-table td{
  padding:14px 18px;
  border-bottom:1px solid var(--ring);
  font-size:14px;
}
.app-table tr{background-color:var(--bg);transition:background-color 0.2s ease}
.app-table tr:hover{background:var(--bg-2)}
.app-table input[type=text],.app-table input[type=number],.app-table select{appearance:none;background:var(--bg-2);border:1px solid var(--ring);color:var(--text);padding:8px 10px;border-radius:6px;font-size:13px;width:100%;transition:border-color 0.2s ease}
.app-table input:focus,.app-table select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 8px rgba(91,157,255,.2)}

@media (min-width: 1400px) {
  .app-table th, .app-table td {padding: 16px 14px}
  .app-table input[type=text],.app-table input[type=number],.app-table select {padding: 8px 12px;font-size:14px}
}
@media (max-width: 768px) {
  .app-table {display: block; overflow-x: auto; white-space: nowrap}
  .app-table th, .app-table td {padding: 10px 8px}
}

/* ===== APPLICATIONS MANAGEMENT PREMIUM ENHANCEMENT ===== */

.apps-stats-dashboard{display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;margin-bottom:20px;background:linear-gradient(135deg, rgba(91,157,255,0.08), rgba(50,230,133,0.05));padding:16px;border-radius:12px;border:1px solid var(--ring);animation:slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)}
.stat-card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;background:var(--panel);border:1px solid var(--ring);border-radius:10px;transition:all 0.3s ease;cursor:default}
.stat-card:hover{transform:translateY(-2px);border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), var(--panel);box-shadow:0 4px 12px rgba(91,157,255,0.15)}
.stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:700}
.stat-value{font-size:20px;font-weight:800;color:var(--primary);line-height:1}
.stat-icon{font-size:16px;opacity:0.7}

.apps-search-filter-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.apps-search-input{flex:1;min-width:200px;appearance:none;background:var(--panel);border:1px solid var(--ring);color:var(--text);padding:10px 14px;border-radius:8px;font-size:13px;transition:all 0.3s ease;backdrop-filter:blur(2px)}
.apps-search-input::placeholder{color:var(--muted);opacity:0.5}
.apps-search-input:focus{outline:none;border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), var(--panel);box-shadow:0 0 12px rgba(91,157,255,0.2)}

.apps-filter-button{appearance:none;background:var(--panel);border:1px solid var(--ring);color:var(--text);padding:10px 12px;border-radius:8px;font-size:13px;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:6px;white-space:nowrap}
.apps-filter-button:hover{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), var(--panel);color:var(--primary)}
.apps-filter-button.active{background:var(--primary);border-color:var(--primary);color:var(--bg);font-weight:600}

.apps-active-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center;min-height:28px}
.apps-active-filters.hidden{display:none}
.filter-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg, var(--primary), rgba(91,157,255,0.7));color:white;padding:6px 10px;border-radius:6px;font-size:12px;font-weight:600;animation:popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)}
.filter-badge-remove{cursor:pointer;opacity:0.7;transition:opacity 0.2s ease;font-weight:700;padding:0 2px}
.filter-badge-remove:hover{opacity:1}

.apps-table-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:linear-gradient(90deg, rgba(91,157,255,0.05), rgba(50,230,133,0.03));border-bottom:1px solid var(--ring);margin-bottom:0}
.apps-table-info{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
.apps-table-info-icon{font-size:16px}
.apps-count-display{font-weight:700;color:var(--primary)}

.apps-table-container-premium{border:none;border-radius:12px;overflow:hidden;background:linear-gradient(135deg, var(--bg) 0%, rgba(14, 22, 39, 0.95) 100%);box-shadow:0 8px 32px rgba(0,0,0,0.3), 0 0 1px rgba(91,157,255,0.1) inset;animation:fadeIn 0.4s ease-out;position:relative;backdrop-filter:blur(10px)}

.app-table-premium{width:100%;border-collapse:separate;border-spacing:0;background:transparent}
.app-table-premium th{text-align:left;padding:14px 14px;border-bottom:2px solid rgba(91,157,255,0.2);font-size:11px;color:var(--primary);font-weight:800;background:linear-gradient(90deg, rgba(91,157,255,0.08), rgba(50,230,133,0.03));cursor:pointer;user-select:none;transition:all 0.3s ease;position:sticky;top:0;z-index:5;text-transform:uppercase;letter-spacing:0.5px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.app-table-premium th:hover{background:linear-gradient(90deg, rgba(91,157,255,0.15), rgba(50,230,133,0.08));color:#5b9dff;transform:translateY(-1px)}
.app-table-premium td{padding:12px 14px;border-bottom:1px solid rgba(91,157,255,0.08);font-size:13px;vertical-align:middle;height:48px;transition:all 0.2s ease}
.app-table-premium tr{background-color:transparent;transition:all 0.3s ease}
.app-table-premium tbody tr{background:rgba(14, 22, 39, 0.5);backdrop-filter:blur(4px)}
.app-table-premium tbody tr:nth-child(odd){background:rgba(91,157,255,0.02)}
.app-table-premium tbody tr:hover{background:linear-gradient(90deg, rgba(91,157,255,0.12), rgba(50,230,133,0.05));box-shadow:inset 0 0 20px rgba(91,157,255,0.1), 0 4px 12px rgba(91,157,255,0.15);transform:scale(1.001)}
.app-table-premium tbody tr:active{background:rgba(91,157,255,0.2)}

.app-table-premium input[type=text],.app-table-premium input[type=number],.app-table-premium select{appearance:none;background:linear-gradient(135deg, rgba(14,22,39,0.8), rgba(20,30,50,0.9));border:1.5px solid rgba(91,157,255,0.3);color:var(--text);padding:7px 10px;border-radius:6px;font-size:13px;width:100%;transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);font-family:inherit;cursor:pointer;line-height:1.4;box-shadow:0 2px 4px rgba(0,0,0,0.2) inset}
.app-table-premium input[type=text]::placeholder{color:rgba(233,238,247,0.4)}
.app-table-premium input:focus,.app-table-premium select:focus{outline:none;border-color:var(--primary);background:linear-gradient(135deg, rgba(91,157,255,0.1), rgba(50,230,133,0.05));box-shadow:0 0 16px rgba(91,157,255,0.4), inset 0 0 8px rgba(91,157,255,0.15), 0 2px 4px rgba(0,0,0,0.2) inset;transform:translateY(-1px)}
.app-table-premium input:hover:not(:focus),.app-table-premium select:hover:not(:focus){border-color:rgba(91,157,255,0.5);background:linear-gradient(135deg, rgba(20,30,50,0.95), rgba(25,35,55,0.95))}

/* Column-specific optimizations - Professional proportions with BU column */
/* APP NAME column - ultra compact matching red line exactly */
.app-table-premium tbody tr td:nth-child(1) input{font-size:11px;font-weight:700;padding:4px 5px;letter-spacing:0.1px;width:100%;text-transform:uppercase;background:linear-gradient(135deg, rgba(91,157,255,0.08), rgba(50,230,133,0.03)) !important;border:1.5px solid rgba(91,157,255,0.3) !important;color:#b8d4ff;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.app-table-premium th:nth-child(1){width:45px;padding:14px 4px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:10px}
.app-table-premium td:nth-child(1){width:45px;padding:12px 4px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}

/* BU column - new column after APP NAME */
.bu-badge{display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(50,230,133,0.25), rgba(91,157,255,0.15));padding:4px 8px;border-radius:5px;font-weight:800;color:var(--ok);border:1.5px solid rgba(50,230,133,0.4);font-size:11px;text-align:center;text-shadow:0 1px 1px rgba(0,0,0,0.2);transition:all 0.3s ease}
.bu-badge:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(50,230,133,0.25)}
.app-table-premium th:nth-child(2){width:52px;padding:14px 6px}
.app-table-premium td:nth-child(2){width:52px;padding:12px 6px;text-align:center}

/* ORDER column - slightly larger for clarity */
.app-table-premium tbody tr td:nth-child(3) input{width:45px !important;max-width:45px;text-align:center;font-weight:600;font-size:13px}
.app-table-premium th:nth-child(3){width:58px;padding:12px 6px}
.app-table-premium td:nth-child(3){width:58px;padding:10px 6px}

/* WAVE column - balanced and visible */
.app-table-premium th:nth-child(4){width:88px;padding:12px 8px}
.app-table-premium td:nth-child(4){width:88px;padding:10px 8px}

/* STATUS column - more visible */
.app-table-premium th:nth-child(5){width:78px;padding:12px 6px}
.app-table-premium td:nth-child(5){width:78px;padding:10px 6px}

/* PROGRESS % column - expanded for better display */
.app-table-premium th:nth-child(6){width:145px;padding:12px 8px}
.app-table-premium td:nth-child(6){width:145px;padding:10px 8px}

/* WEIGHT column - more visible */
.app-table-premium th:nth-child(7){width:68px;padding:12px 6px}
.app-table-premium td:nth-child(7){width:68px;padding:10px 6px;text-align:center}

/* CRITICALITY, IMPACT, PRIORITY columns - larger and more comfortable */
.app-table-premium td:nth-child(8) select,
.app-table-premium td:nth-child(9) select,
.app-table-premium td:nth-child(10) select{padding:5px 6px;font-size:11px}
.app-table-premium th:nth-child(8){width:82px;padding:12px 6px}
.app-table-premium td:nth-child(8){width:82px;padding:10px 6px}
.app-table-premium th:nth-child(9){width:77px;padding:12px 6px}
.app-table-premium td:nth-child(9){width:77px;padding:10px 6px}
.app-table-premium th:nth-child(10){width:77px;padding:12px 6px}
.app-table-premium td:nth-child(10){width:77px;padding:10px 6px}

/* ACTIONS column - optimized */
.app-table-premium th:nth-child(11){width:82px;padding:12px 6px}
.app-table-premium td:nth-child(11){width:82px;padding:10px 6px}

.cell-status-badge{padding:5px 10px !important;border-radius:6px !important;font-weight:800 !important;font-size:11px !important;display:inline-flex !important;align-items:center;justify-content:center;animation:slideIn 0.3s ease-out;border:1.5px solid;white-space:nowrap;line-height:1.2;box-shadow:0 4px 8px rgba(0,0,0,0.2);transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);cursor:default;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.cell-status-badge:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.3)}
.cell-status-badge[data-status="TBS"]{background:linear-gradient(135deg, rgba(255, 95, 122, 0.3), rgba(255, 95, 122, 0.15));color:#ff5f7a;border-color:rgba(255, 95, 122, 0.6);box-shadow:0 4px 8px rgba(255, 95, 122, 0.2)}
.cell-status-badge[data-status="TBS"]:hover{background:linear-gradient(135deg, rgba(255, 95, 122, 0.4), rgba(255, 95, 122, 0.25));box-shadow:0 6px 16px rgba(255, 95, 122, 0.3)}
.cell-status-badge[data-status="WIP"]{background:linear-gradient(135deg, rgba(255, 209, 102, 0.3), rgba(255, 209, 102, 0.15));color:#ffd166;border-color:rgba(255, 209, 102, 0.6);box-shadow:0 4px 8px rgba(255, 209, 102, 0.2)}
.cell-status-badge[data-status="WIP"]:hover{background:linear-gradient(135deg, rgba(255, 209, 102, 0.4), rgba(255, 209, 102, 0.25));box-shadow:0 6px 16px rgba(255, 209, 102, 0.3)}
.cell-status-badge[data-status="CLO"]{background:linear-gradient(135deg, rgba(50, 230, 133, 0.3), rgba(50, 230, 133, 0.15));color:#32e685;border-color:rgba(50, 230, 133, 0.6);box-shadow:0 4px 8px rgba(50, 230, 133, 0.2)}
.cell-status-badge[data-status="CLO"]:hover{background:linear-gradient(135deg, rgba(50, 230, 133, 0.4), rgba(50, 230, 133, 0.25));box-shadow:0 6px 16px rgba(50, 230, 133, 0.3)}

.progress-cell-premium{position:relative;display:flex;align-items:center;gap:6px;width:100%;height:100%;background:linear-gradient(90deg, rgba(91,157,255,0.03), transparent);border-radius:4px;padding:0 4px}
.progress-cell-premium input[type=number]{flex-shrink:0;width:55px !important;max-width:55px;height:32px;padding:6px 8px !important;font-size:13px !important;text-align:center;font-weight:700;background:linear-gradient(135deg, rgba(91,157,255,0.15), rgba(50,230,133,0.05));border:1.5px solid rgba(91,157,255,0.4) !important;box-shadow:0 2px 6px rgba(91,157,255,0.2) inset;letter-spacing:0.5px}
.progress-bar-mini{position:relative;flex:1;height:32px;background:linear-gradient(90deg, rgba(91,157,255,0.1), rgba(50,230,133,0.05));border-radius:6px;overflow:hidden;min-width:65px;border:1.5px solid rgba(91,157,255,0.25);display:flex;align-items:center;justify-content:flex-start;padding:0 3px;box-shadow:0 2px 6px rgba(0,0,0,0.15) inset}
.progress-bar-fill{position:absolute;top:0;left:0;height:100%;background:linear-gradient(90deg, var(--primary), rgba(91,157,255,0.6), var(--ok));border-radius:5px;transition:width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:white;opacity:0;z-index:1;padding:0 3px;box-shadow:0 0 10px rgba(91,157,255,0.5), inset 0 1px 2px rgba(255,255,255,0.2);text-shadow:0 1px 2px rgba(0,0,0,0.5)}
.progress-bar-fill.show-label{opacity:1}

/* APP NAME column - optimized for readability */
.app-table-premium tbody tr td:nth-child(1) input{font-size:13px;font-weight:600;padding:6px 8px;letter-spacing:0.3px}
.app-table-premium th:nth-child(1){width:auto;min-width:220px;padding:12px 12px}
.app-table-premium td:nth-child(1){width:auto;min-width:220px;padding:10px 12px}

.auto-weight{display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(91,157,255,0.25), rgba(50,230,133,0.15));padding:6px 12px;border-radius:7px;font-weight:800;color:var(--primary);border:1.5px solid rgba(91,157,255,0.4);font-size:13px;min-width:60px;text-align:center;letter-spacing:0.3px;box-shadow:0 4px 8px rgba(91,157,255,0.15);transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);text-shadow:0 1px 1px rgba(0,0,0,0.2)}
.auto-weight:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(91,157,255,0.25)}

.apps-empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;text-align:center;color:var(--muted);background:linear-gradient(135deg, rgba(91,157,255,0.03), rgba(50,230,133,0.02))}
.apps-empty-state-icon{font-size:48px;margin-bottom:16px;opacity:0.6;animation:fadeIn 0.5s ease-out}
.apps-empty-state-title{font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px}
.apps-empty-state-description{font-size:13px;color:var(--muted);margin-bottom:16px}

.app-actions-cell{display:flex;gap:8px;align-items:center}
.btn-app-action{appearance:none;background:linear-gradient(135deg, rgba(91,157,255,0.15), rgba(50,230,133,0.08));border:1.5px solid rgba(91,157,255,0.3);color:var(--text);padding:7px 11px;border-radius:6px;font-size:12px;cursor:pointer;transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);white-space:nowrap;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,0.15);text-shadow:0 1px 1px rgba(0,0,0,0.2)}
.btn-app-action:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.25)}
.btn-app-action.reassign{border-color:var(--primary);color:var(--primary);background:linear-gradient(135deg, rgba(91,157,255,0.25), rgba(91,157,255,0.1))}
.btn-app-action.reassign:hover{background:linear-gradient(135deg, rgba(91,157,255,0.35), rgba(91,157,255,0.2));box-shadow:0 4px 12px rgba(91,157,255,0.3)}
.btn-app-action.delete{border-color:var(--danger);color:var(--danger);background:linear-gradient(135deg, rgba(255,95,122,0.25), rgba(255,95,122,0.1))}
.btn-app-action.delete:hover{background:linear-gradient(135deg, rgba(255,95,122,0.35), rgba(255,95,122,0.2));box-shadow:0 4px 12px rgba(255,95,122,0.3)}

@media (max-width: 1024px) {
  .apps-table-container-premium{overflow-x:auto}
  .app-table-premium{min-width:800px}
  .apps-search-filter-bar{flex-direction:column}
  .apps-search-input{min-width:100%}
}

@media (max-width: 768px) {
  .apps-stats-dashboard{grid-template-columns:repeat(2, 1fr);gap:8px;padding:12px}
  .stat-card{padding:10px}
  .stat-label{font-size:10px}
  .stat-value{font-size:18px}
  .app-table-premium th,.app-table-premium td{padding:10px 12px;font-size:12px}
  .app-table-premium input[type=text],.app-table-premium input[type=number],.app-table-premium select{font-size:11px;padding:6px 8px}
  .btn-app-action{padding:5px 8px;font-size:11px}
}

/* ===== APPLICATIONS CARD-BASED LAYOUT (WORLD-CLASS DESIGN) ===== */

/* Container for card grid */
.apps-cards-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap:20px;margin-top:20px;animation:fadeIn 0.5s ease}

/* Premium Application Card */
.app-card{background:linear-gradient(135deg, rgba(91,157,255,0.08), rgba(50,230,133,0.03));border:1.5px solid rgba(91,157,255,0.2);border-radius:14px;padding:20px;transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);position:relative;overflow:hidden;cursor:pointer;display:flex;flex-direction:column;height:100%;min-height:280px}

/* Card background gradient effect */
.app-card:before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle, rgba(91,157,255,0.1) 0%, transparent 70%);opacity:0;transition:opacity 0.4s ease;pointer-events:none}

/* Card hover state */
.app-card:hover{border-color:rgba(91,157,255,0.4);box-shadow:0 12px 40px rgba(91,157,255,0.2), inset 0 0 20px rgba(91,157,255,0.05);transform:translateY(-8px);background:linear-gradient(135deg, rgba(91,157,255,0.12), rgba(50,230,133,0.06))}

.app-card:hover:before{opacity:1}

/* Card header with app name (prominent) */
.app-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;gap:12px;position:relative;z-index:1}

.app-card-title{flex:1}

.app-card-name{font-size:16px;font-weight:700;color:var(--text);margin:0;word-break:break-word;line-height:1.3;letter-spacing:0.2px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}

.app-card-wave{font-size:11px;color:rgba(233,238,247,0.6);margin-top:4px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}

/* Status badge in card header */
.app-card-status{display:flex;align-items:center;gap:6px;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600;white-space:nowrap;background:rgba(14,22,39,0.5);backdrop-filter:blur(4px)}

.app-card-status.tbs{color:#ffd166;border:1px solid rgba(255,209,102,0.3)}
.app-card-status.wip{color:#5b9dff;border:1px solid rgba(91,157,255,0.3)}
.app-card-status.clo{color:#32e685;border:1px solid rgba(50,230,133,0.3)}

/* Card body metrics */
.app-card-metrics{flex:1;margin-bottom:16px;position:relative;z-index:1}

.app-metric{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(91,157,255,0.1)}

.app-metric:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}

.app-metric-item{display:flex;flex-direction:column;gap:4px}

.app-metric-label{font-size:10px;color:rgba(233,238,247,0.5);text-transform:uppercase;letter-spacing:0.4px;font-weight:600}

.app-metric-value{font-size:13px;color:var(--text);font-weight:700;display:flex;align-items:center;gap:6px}

.app-metric-value.progress{font-size:14px;color:var(--primary)}

/* Progress bar in card */
.app-card-progress{margin-bottom:12px;position:relative;z-index:1}

.app-card-progress-label{display:flex;justify-content:space-between;margin-bottom:6px;font-size:11px;font-weight:600}

.app-card-progress-label-value{color:var(--text)}
.app-card-progress-label-percent{color:var(--primary)}

.app-card-progress-bar{height:6px;background:rgba(91,157,255,0.1);border-radius:3px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,0.2)}

.app-card-progress-fill{height:100%;background:linear-gradient(90deg, var(--primary), var(--ok));border-radius:3px;transition:width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);box-shadow:0 0 8px rgba(91,157,255,0.4)}

/* Card actions footer */
.app-card-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:auto;position:relative;z-index:1}

.app-card-action-btn{padding:8px 12px;border:none;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;gap:6px;background:rgba(91,157,255,0.1);color:var(--primary);border:1px solid rgba(91,157,255,0.2)}

.app-card-action-btn:hover{background:rgba(91,157,255,0.2);border-color:rgba(91,157,255,0.4);transform:scale(1.05)}

.app-card-action-btn.edit{background:rgba(91,157,255,0.15);border-color:var(--primary)}

.app-card-action-btn.danger{background:rgba(255,95,122,0.1);color:var(--danger);border-color:rgba(255,95,122,0.2)}

.app-card-action-btn.danger:hover{background:rgba(255,95,122,0.2);border-color:var(--danger)}

/* Empty state */
.apps-empty-grid-state{grid-column:1 / -1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center}

.apps-empty-grid-state-icon{font-size:64px;margin-bottom:16px}

.apps-empty-grid-state-title{font-size:18px;color:var(--text);font-weight:700;margin-bottom:8px}

.apps-empty-grid-state-description{font-size:13px;color:rgba(233,238,247,0.6);margin-bottom:20px;max-width:400px}

/* Responsive adjustments for cards */
@media (max-width: 1024px) {
  .apps-cards-grid{grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px}
  .app-card{min-height:260px;padding:16px}
  .app-card-name{font-size:15px}
}

@media (max-width: 768px) {
  .apps-cards-grid{grid-template-columns:repeat(auto-fill, minmax(240px, 1fr));gap:12px}
  .app-card{min-height:240px;padding:14px}
  .app-card-name{font-size:14px}
  .app-metric{grid-template-columns:1fr;gap:8px}
  .app-card-progress-label{font-size:10px}
}

@media (max-width: 480px) {
  .apps-cards-grid{grid-template-columns:1fr;gap:12px}
  .app-card{min-height:auto}
}

/* ===== APPLICATIONS OVERVIEW PREMIUM UPGRADE ===== */

/* Stats Section */
.apps-overview-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
  background: var(--glass);
  padding: 16px;
  border-radius: 12px;
  border: 1px solid var(--ring);
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

.stat-label {
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

.stat-value {
  font-size: 24px;
  font-weight: 900;
  color: var(--primary);
  font-family: 'Courier New', monospace;
}

/* Premium Filters Bar */
.filters-bar-premium {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
  padding: 12px;
  background: var(--bg-2);
  border-radius: 10px;
  border: 1px solid var(--ring);
  flex-wrap: wrap;
  align-items: center;
}

.search-box-wrapper {
  flex: 1;
  min-width: 200px;
}

.search-input-premium {
  width: 100%;
  padding: 10px 16px;
  background: var(--bg);
  border: 1px solid var(--ring);
  border-radius: 8px;
  color: var(--text);
  font-size: 13px;
  transition: all 0.2s ease;
  font-family: inherit;
}

.search-input-premium:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 12px rgba(91, 157, 255, 0.2);
  background: var(--bg-2);
}

.search-input-premium::placeholder {
  color: var(--muted);
}

.filter-select-premium {
  padding: 10px 12px;
  background: var(--bg);
  border: 1px solid var(--ring);
  border-radius: 8px;
  color: var(--text);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: inherit;
  min-width: 140px;
}

.filter-select-premium:hover,
.filter-select-premium:focus {
  border-color: var(--primary);
  background: var(--bg-2);
  outline: none;
}

/* Active Filters Display */
.active-filters-container {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  padding: 8px 12px;
  background: rgba(91, 157, 255, 0.08);
  border-radius: 8px;
  border-left: 3px solid var(--primary);
  flex-wrap: wrap;
  align-items: center;
}

.active-filters-label {
  font-weight: 600;
  color: var(--muted);
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

#activeFiltersList {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.active-filter-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: var(--primary);
  color: white;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.active-filter-badge .remove-filter {
  cursor: pointer;
  font-weight: bold;
  opacity: 0.7;
  transition: opacity 0.2s;
}

.active-filter-badge .remove-filter:hover {
  opacity: 1;
}

/* Premium Table Container */
.apps-table-container-premium {
  border: 1px solid var(--ring);
  border-radius: 12px;
  overflow: hidden;
  background: var(--bg);
  max-height: 600px;
  overflow-y: auto;
}

.table-header-info {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: var(--bg-2);
  border-bottom: 1px solid var(--ring);
  font-size: 13px;
  color: var(--muted);
}

.table-info-icon {
  font-size: 16px;
}

.table-info-text strong {
  color: var(--text);
  font-weight: 600;
}

/* Premium Table Styles */
.app-table-premium {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;
}

.app-table-premium th {
  background: linear-gradient(135deg, var(--bg-2), var(--bg));
  border-bottom: 2px solid var(--ring);
  padding: 14px;
  text-align: left;
  font-weight: 600;
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: sticky;
  top: 0;
  z-index: 10;
  user-select: none;
  cursor: pointer;
  transition: all 0.2s ease;
}

.app-table-premium th.sortable:hover {
  background: linear-gradient(135deg, var(--ring), var(--bg-2));
  color: var(--primary);
}

.col-icon {
  margin-right: 4px;
}

.sort-indicator {
  opacity: 0;
  margin-left: 4px;
  transition: opacity 0.2s;
  font-size: 11px;
}

.app-table-premium th.sort-asc .sort-indicator,
.app-table-premium th.sort-desc .sort-indicator {
  opacity: 1;
}

.app-table-premium th.sort-asc .sort-indicator::after {
  content: "‚Üë";
}

.app-table-premium th.sort-desc .sort-indicator::after {
  content: "‚Üì";
}

.app-table-premium td {
  padding: 12px 14px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  font-size: 13px;
  vertical-align: middle;
}

.app-table-premium tbody tr {
  background: var(--bg);
  transition: all 0.15s ease;
}

.app-table-premium tbody tr:hover {
  background: var(--bg-2);
  box-shadow: inset 0 0 8px rgba(91, 157, 255, 0.1);
}

.app-table-premium tbody tr.critical:hover {
  box-shadow: inset 0 0 8px rgba(255, 95, 122, 0.1);
}

.app-table-premium tbody tr.high:hover {
  box-shadow: inset 0 0 8px rgba(255, 209, 102, 0.1);
}

/* Row classes for criticality highlighting */
.app-table-premium tbody tr.critical {
  border-left: 3px solid var(--danger);
}

.app-table-premium tbody tr.high {
  border-left: 3px solid var(--warn);
}

.app-table-premium tbody tr.medium {
  border-left: 3px solid var(--primary);
}

.app-table-premium tbody tr.low {
  border-left: 3px solid var(--ok);
}

/* Priority Badge */
.priority-badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.priority-badge-premium.high {
  background: rgba(255, 95, 122, 0.15);
  color: var(--danger);
}

.priority-badge-premium.medium {
  background: rgba(255, 209, 102, 0.15);
  color: var(--warn);
}

.priority-badge-premium.low {
  background: rgba(50, 230, 133, 0.15);
  color: var(--ok);
}

/* Criticality Badge */
.criticality-badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.criticality-badge-premium.critical {
  background: rgba(255, 95, 122, 0.15);
  color: var(--danger);
}

.criticality-badge-premium.high {
  background: rgba(255, 209, 102, 0.15);
  color: var(--warn);
}

.criticality-badge-premium.medium {
  background: rgba(91, 157, 255, 0.15);
  color: var(--primary);
}

.criticality-badge-premium.low {
  background: rgba(50, 230, 133, 0.15);
  color: var(--ok);
}

/* Status Badge */
.status-badge-premium {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.status-badge-premium.tbs {
  background: rgba(255, 95, 122, 0.15);
  color: var(--danger);
}

.status-badge-premium.wip {
  background: rgba(255, 209, 102, 0.15);
  color: var(--warn);
}

.status-badge-premium.clo {
  background: rgba(50, 230, 133, 0.15);
  color: var(--ok);
}

/* Progress Bar Premium */
.progress-cell-premium {
  min-width: 150px;
}

.progress-container {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 11px;
  font-weight: 600;
}

.progress-percentage {
  color: var(--text);
}

.progress-bar-premium {
  width: 100%;
  height: 6px;
  background: var(--ring);
  border-radius: 3px;
  overflow: hidden;
  position: relative;
}

.progress-bar-premium.shimmer::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.progress-value-premium {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), #4d86ff);
  border-radius: 3px;
  transition: width 0.3s ease;
  box-shadow: 0 0 8px rgba(91, 157, 255, 0.4);
}

/* Empty State */
.table-empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  text-align: center;
  color: var(--muted);
  background: var(--bg-2);
  border-top: 1px solid var(--ring);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.empty-state-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
}

.empty-state-description {
  font-size: 13px;
  color: var(--muted);
}

/* Responsive Design */
@media (max-width: 1024px) {
  .filters-bar-premium {
    flex-direction: column;
  }

  .search-box-wrapper {
    min-width: 100%;
  }

  .filter-select-premium {
    min-width: 100%;
  }

  .app-table-premium th,
  .app-table-premium td {
    padding: 10px 8px;
    font-size: 12px;
  }

  .col-icon {
    display: none;
  }
}

@media (max-width: 768px) {
  .apps-overview-stats {
    grid-template-columns: 1fr;
  }

  .apps-table-container-premium {
    border-radius: 8px;
    max-height: 400px;
  }

  .app-table-premium {
    font-size: 12px;
  }

  .app-table-premium th,
  .app-table-premium td {
    padding: 8px 6px;
  }
}

.form-group{margin-bottom:20px}
.form-group label{display:block;margin-bottom:8px;font-size:13px;color:var(--text);font-weight:600;letter-spacing:0.3px}
.form-group input,.form-group select,.form-group textarea{appearance:none;background:var(--bg-2);border:1px solid var(--ring);color:var(--text);padding:12px;border-radius:8px;font-size:14px;width:100%;font-family:inherit;transition:all 0.2s ease}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 12px rgba(91,157,255,.25);background:var(--bg)}
.form-group input:hover,.form-group select:hover,.form-group textarea:hover{border-color:var(--primary);background:var(--bg)}
/* APP NAME Input Field - Premium Width Optimization */
#appNameInput{max-width:400px;width:100%;transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)}
.form-hint{display:block;font-size:12px;color:var(--muted);margin-top:6px;font-style:italic}
.form-actions{display:flex;gap:12px;margin-top:30px;justify-content:flex-end}
.form-error{color:var(--danger);font-size:12px;margin-top:6px;display:flex;align-items:center;gap:4px}
.form-error:before{content:"‚ö†Ô∏è";font-size:12px}
.form-success{color:var(--ok);font-size:12px;margin-top:6px;display:flex;align-items:center;gap:4px}
.form-success:before{content:"‚úÖ";font-size:12px}
.form-stats{background:var(--glass);border:1px solid var(--ring);border-radius:10px;padding:16px;margin-top:16px}
.form-stats-title{font-weight:600;font-size:15px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.form-stats-title:before{content:"üìä";font-size:15px}
.form-stats-item{display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px;padding:4px 0;border-bottom:1px dashed var(--ring)}
.form-stats-item:last-child{border-bottom:none}
.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}

/* Premium Form Sections */
.app-editor-form-premium {
  max-width: 600px;
}

.form-section {
  background: linear-gradient(135deg, rgba(91,157,255,0.05), rgba(50,230,133,0.03));
  border: 1px solid var(--ring);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  animation: slideInTable 0.4s ease-out;
  transition: all 0.3s ease;
}

.form-section:hover {
  border-color: var(--primary);
  background: linear-gradient(135deg, rgba(91,157,255,0.08), rgba(50,230,133,0.05));
  box-shadow: 0 4px 12px rgba(91,157,255,0.1);
}

.form-section-header {
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 2px solid rgba(91,157,255,0.2);
}

.form-section-header h4 {
  font-size: 15px;
  font-weight: 700;
  color: var(--primary);
  margin: 0 0 3px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-section-header p {
  font-size: 11px;
  color: var(--muted);
  margin: 0;
  font-weight: 500;
}

.form-group {
  margin-bottom: 12px;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.required {
  color: var(--danger);
  font-weight: 700;
}

.progress-input-wrapper,
.order-input-wrapper {
  display: flex;
  align-items: center;
  gap: 8px;
}

.progress-input-wrapper input,
.order-input-wrapper input {
  flex: 1;
}

.progress-unit {
  font-weight: 700;
  color: var(--primary);
  font-size: 14px;
}

.form-row.three-cols {
  grid-template-columns: repeat(3, 1fr);
}

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .form-row.three-cols {
    grid-template-columns: 1fr;
  }
}

/* Weight Preview Section */
.weight-preview-section {
  background: linear-gradient(135deg, rgba(91,157,255,0.1), rgba(50,230,133,0.08));
  border: 2px solid var(--primary);
}

.weight-display-box {
  background: var(--bg);
  border: 2px dashed var(--primary);
  border-radius: 10px;
  padding: 24px;
  text-align: center;
  transition: all 0.3s ease;
}

.weight-display-box:hover {
  background: linear-gradient(135deg, rgba(91,157,255,0.05), rgba(50,230,133,0.03));
  box-shadow: 0 4px 12px rgba(91,157,255,0.15);
}

.weight-value-large {
  font-size: 48px;
  font-weight: 800;
  color: var(--primary);
  line-height: 1;
  margin-bottom: 8px;
  text-shadow: 0 2px 4px rgba(91,157,255,0.2);
}

.weight-formula {
  font-size: 12px;
  color: var(--muted);
  font-weight: 600;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
  font-family: 'Courier New', monospace;
}

/* Form Actions Premium */
.form-actions-premium {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  justify-content: flex-end;
  padding-top: 12px;
  border-top: 1px solid var(--ring);
}

.btn-lg {
  padding: 14px 28px !important;
  font-size: 15px !important;
  font-weight: 700 !important;
}

/* Responsive */
@media (max-width: 480px) {
  .form-section {
    padding: 16px;
    margin-bottom: 12px;
  }
  
  .form-section-header h4 {
    font-size: 14px;
  }
  
  .form-actions-premium {
    flex-direction: column;
  }
  
  .form-actions-premium .btn {
    width: 100%;
  }
  
  .weight-value-large {
    font-size: 36px;
  }
}


.input-with-icon{position:relative;display:flex;align-items:center}
.input-with-icon .input-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none;opacity:0.7}
.input-with-icon input{padding-left:36px}

.color-picker{display:flex;align-items:center;gap:10px;background:var(--bg-2);border:1px solid var(--ring);border-radius:8px;padding:6px 12px;transition:all 0.2s ease}
.color-picker:hover{border-color:var(--primary);background:var(--bg)}
.color-picker input[type="color"]{-webkit-appearance:none;appearance:none;border:none;background:none;width:30px;height:30px;padding:0;cursor:pointer}
.color-picker input[type="color"]::-webkit-color-swatch-wrapper{padding:0}
.color-picker input[type="color"]::-webkit-color-swatch{border:none;border-radius:50%}
.color-preview{display:inline-block;width:24px;height:24px;border-radius:50%;background:var(--primary)}

.btn-icon{margin-right:6px;font-size:14px}
.status-badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase}
.status-tbs{background:rgba(255,95,122,.2);color:var(--danger)}
.status-wip{background:rgba(255,209,102,.2);color:var(--warn)}
.status-clo{background:rgba(50,230,133,.2);color:var(--ok)}
.btn-group{display:flex;gap:8px;margin-top:16px}
.btn-primary{
  appearance:none;
  background:linear-gradient(135deg,var(--primary),#4d86ff);
  border:none;
  color:white;
  padding:12px 24px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:all .3s cubic-bezier(.25,.8,.25,1);
  box-shadow:0 4px 15px rgba(91,157,255,0.3);
  display:inline-flex;
  align-items:center;
  gap:8px;
  position:relative;
  overflow:hidden;
}
.btn-primary:hover{
  filter:brightness(1.15);
  box-shadow:0 6px 20px rgba(91,157,255,0.4);
  transform:translateY(-2px);
}
.btn-primary:hover::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: rgba(255,255,255,0.1);
  transform: rotate(30deg);
  animation: btn-shine 1.5s ease-in-out;
}
.btn-primary:active{
  transform:translateY(0);
  filter:brightness(0.95);
}
@keyframes btn-shine {
  0% {
    transform: translateX(-100%) rotate(30deg);
  }
  100% {
    transform: translateX(100%) rotate(30deg);
  }
}
.btn-secondary{
  appearance:none;
  background:rgba(255,255,255,0.03);
  border:1px solid var(--ring);
  color:var(--text);
  padding:12px 24px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  transition:all .3s cubic-bezier(.25,.8,.25,1);
  display:inline-flex;
  align-items:center;
  gap:8px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.btn-secondary:hover{
  background:rgba(91,157,255,0.08);
  border-color:var(--primary);
  color:var(--primary);
  box-shadow:0 4px 15px rgba(0,0,0,0.15);
}
.btn-danger{appearance:none;background:linear-gradient(135deg,var(--danger),#ff4757);border:none;color:white;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all .2s ease;box-shadow:0 4px 12px rgba(255,95,122,0.3);display:inline-flex;align-items:center;gap:6px}
.btn-danger:hover{filter:brightness(1.15);box-shadow:0 6px 16px rgba(255,95,122,0.4);transform:translateY(-1px)}
.btn-info{appearance:none;background:linear-gradient(135deg,var(--primary),#4a90e2);border:none;color:white;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all .2s ease;box-shadow:0 4px 12px rgba(91,157,255,0.3);display:inline-flex;align-items:center;gap:6px}
.btn-info:hover{filter:brightness(1.15);box-shadow:0 6px 16px rgba(91,157,255,0.4);transform:translateY(-1px)}
.btn-sm{padding:8px 12px;font-size:12px}

/* Dashboard Specific Styles */
/* --- HERO GAUGE --- */
.hero{grid-column:span 5;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.hero .inner{width:100%;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;position:relative}
.hero h2{position:absolute;top:16px;left:16px;margin:0;font-size:16px;color:var(--muted)}
.hero .val{position:absolute;text-align:center;inset:auto;top:50%;transform:translateY(-50%)}
.hero .val .big{font-size:48px;font-weight:900;letter-spacing:.5px}
.hero .val .sub{color:var(--muted)}
.spark{position:absolute;inset:auto 10% 6% auto;background:radial-gradient(circle at 30% 30%, #fff, #fff0 60%);filter:blur(12px);width:120px;height:120px;opacity:.2}

/* --- CONSTELLATION GRID --- */
.constel{grid-column:span 7;padding:16px}
.constel h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
.tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.tile{position:relative;padding:10px 12px 12px 12px;border-radius:14px;background:linear-gradient(160deg, var(--glass), transparent);border:1px solid var(--ring);display:flex;align-items:center;gap:12px;overflow:hidden;transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);cursor:pointer}
.tile:hover{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), linear-gradient(135deg, rgba(91,157,255,0.15), transparent);box-shadow:0 0 20px rgba(91,157,255,0.3), 0 8px 24px rgba(0,0,0,0.4)}
.tile.pinned{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), linear-gradient(135deg, rgba(91,157,255,0.2), transparent);box-shadow:0 0 24px rgba(91,157,255,0.4), 0 12px 32px rgba(0,0,0,0.5)}
.tile .name{font-weight:700}
.tile .meta{font-size:12px;color:var(--muted)}
.tile .orb{width:80px;height:80px;flex:0 0 auto}
.tile .spot{position:absolute;inset:-20% -10% auto auto;width:120px;height:120px;background:radial-gradient(closest-side, rgba(91,157,255,.25), transparent);filter:blur(12px);opacity:0;transition:opacity 0.3s ease;pointer-events:none}
.tile:hover .spot{opacity:1;animation:spotlightPulse 2s ease-in-out infinite}
.tile.pinned .spot{opacity:1;animation:spotlightGlow 0.6s ease-out}
@keyframes spotlightPulse{0%{opacity:0.6}50%{opacity:1}100%{opacity:0.6}}
@keyframes spotlightGlow{0%{transform:scale(0.8);opacity:0}50%{opacity:1}100%{transform:scale(1);opacity:0.8}}

/* --- RANKED BARS --- */
.bars{grid-column:span 12;padding:16px}
.bars h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
.tip{color:var(--muted);font-size:12px}

/* --- KPIs STRIP --- */
.kpis{grid-column:span 12;display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
.kpi{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(180deg, var(--glass), transparent), var(--panel);border:1px solid var(--ring);border-radius:14px}
.kpi .dot{width:12px;height:12px;border-radius:50%}
.kpi h4{margin:0;font-size:12px;color:var(--muted)}
.kpi .num{font-size:24px;font-weight:900}

/* Main CSS styles */
:root{
  --bg:#080b13;
  --bg-2:#0d1320;
  --panel:#0e1627;
  --glass:rgba(255,255,255,.06);

  --text:#e9eef7;
  --muted:#9fb0c7;

  --grid:#22133d;
  --ring:#1a2a48;

  --ok:#32e685;
  --warn:#ffd166;
  --low:#693bff;
  --danger:#ff5f7a;

  --accent:#78bfae;
  --primary:#5b9dff;

  --white:#fff;
  --black:#000;

  --shadow:0 10px 40px rgba(0,0,0,.35);
  --radius:16px;
  --gap:16px;
}

[data-theme="light"]{
  --bg:#f6f8fc;
  --bg-2:#eef2f9;
  --panel:#ffffff;
  --glass:rgba(20,30,60,.08);

  --text:#0e1726;
  --muted:#4b5b78;

  --grid:#d6deea;
  --ring:#c8d4e8;

  --shadow:0 10px 28px rgba(15,45,90,.12);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1400px 700px at 10% -10%, #20355f00, #0b1220), var(--bg);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
}

.wrapper{max-width:1280px;margin:0 auto;padding:20px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
.h-title h1{margin:0;font-size:22px;letter-spacing:.3px}
.h-title small{color:var(--muted)}

.controls{display:flex;gap:8px;flex-wrap:wrap}
.controls>*{
  background:var(--panel);
  border:1px solid var(--ring);
  color:var(--text);
  border-radius:10px;
  padding:10px 12px;
  box-shadow:var(--shadow)
}
.controls input[type=search]{
  min-width:240px;background:transparent;outline:none;border:none
}

.btn{cursor:pointer;user-select:none}
.btn:hover{filter:brightness(1.08)}

.pill{border-radius:9999px;border:1px solid var(--ring);background:var(--panel);padding:6px 10px;color:var(--muted);font-size:12px}

.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
.card{
  background:linear-gradient(180deg, var(--glass), transparent), var(--panel);
  border:1px solid var(--ring);
  border-radius:var(--radius);
  box-shadow:var(--shadow)
}
.card.pad{padding:16px}

/* --- HERO GAUGE (Backup Block) --- */
.hero{grid-column:span 5;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.hero .inner{width:100%;display:flex;align-items:center;justify-content:center;aspect-ratio:1/1;position:relative}
.hero h2{position:absolute;top:16px;left:16px;margin:0;font-size:16px;color:var(--muted)}
.hero .val{position:absolute;text-align:center;inset:auto;top:50%;transform:translateY(-50%)}
.hero .val .big{font-size:48px;font-weight:900;letter-spacing:.5px}
.hero .val .sub{color:var(--muted)}
.spark{position:absolute;inset:auto 10% 6% auto;background:radial-gradient(circle at 30% 30%, #fff, #fff0 60%);filter:blur(12px);width:120px;height:120px;opacity:.2}

/* --- CONSTELLATION GRID (Backup Block) --- */
.constel{grid-column:span 7;padding:16px}
.constel h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
.tiles{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.tile{position:relative;padding:10px 12px 12px 12px;border-radius:14px;background:linear-gradient(160deg, var(--glass), transparent);border:1px solid var(--ring);display:flex;align-items:center;gap:12px;overflow:hidden;transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);cursor:pointer}
.tile:hover{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), linear-gradient(135deg, rgba(91,157,255,0.15), transparent);box-shadow:0 0 20px rgba(91,157,255,0.3), 0 8px 24px rgba(0,0,0,0.4)}
.tile.pinned{border-color:var(--primary);background:linear-gradient(160deg, var(--glass), transparent), linear-gradient(135deg, rgba(91,157,255,0.2), transparent);box-shadow:0 0 24px rgba(91,157,255,0.4), 0 12px 32px rgba(0,0,0,0.5)}
.tile .name{font-weight:700}
.tile .meta{font-size:12px;color:var(--muted)}
.tile .orb{width:80px;height:80px;flex:0 0 auto}
.tile .spot{position:absolute;inset:-20% -10% auto auto;width:120px;height:120px;background:radial-gradient(closest-side, rgba(91,157,255,.25), transparent);filter:blur(12px);opacity:0;transition:opacity 0.3s ease;pointer-events:none}
.tile:hover .spot{opacity:1;animation:spotlightPulse 2s ease-in-out infinite}
.tile.pinned .spot{opacity:1;animation:spotlightGlow 0.6s ease-out}

/* --- RANKED BARS --- */
.bars{grid-column:span 12;padding:16px}
.bars h3{margin:0 0 8px 0;font-size:16px;color:var(--muted)}
.tip{color:var(--muted);font-size:12px}

/* --- KPIs STRIP --- */
.kpis{grid-column:span 12;display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap)}
.kpi{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(180deg, var(--glass), transparent), var(--panel);border:1px solid var(--ring);border-radius:14px}
.kpi .dot{width:12px;height:12px;border-radius:50%}
.kpi h4{margin:0;font-size:12px;color:var(--muted)}
.kpi .num{font-size:24px;font-weight:900}

/* --- Cinematic mode --- */
body.cinematic .wrapper{max-width:none}
body.cinematic .controls{display:none}
body.cinematic header{margin-bottom:0}
body.cinematic .grid{gap:12px}
body.cinematic .hero{grid-column:span 7}
body.cinematic .constel{grid-column:span 5}
/* FIX (cinema): reduce indicador principal para evitar scroll */
body.cinematic .hero .inner{max-width:420px}
body.cinematic .hero .val .big{font-size:36px}
body.cinematic .hero .val .sub{font-size:12px}

/* --- Exit Cinematic floating button --- */
.exit-cinema{position:fixed;top:16px;right:16px;z-index:10000;display:none}
body.cinematic .exit-cinema{display:inline-flex}

/* --- Theme toggle --- */
.switch{display:inline-flex;gap:8px;align-items:center}
.toggle{appearance:none;width:44px;height:24px;border:1px solid var(--ring);border-radius:20px;background:var(--bg-2);position:relative;outline:none;cursor:pointer}
.toggle::after{content:"";position:absolute;inset:3px auto auto 3px;width:18px;height:18px;border-radius:50%;background:linear-gradient(180deg,#2bc3ff,#4d86ff);box-shadow:0 2px 8px rgba(0,0,0,.4);transition:transform .2s ease}
.toggle:checked::after{transform:translateX(20px)}

/* --- Accessibility helpers --- */
.sr{position:absolute;left:-9999px}

@media (max-width:1080px){
  .hero{grid-column:span 12}
  .constel{grid-column:span 12}
}
@media (max-width:720px){
  .tiles{grid-template-columns:repeat(2,1fr)}
  .kpis{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:520px){
  .tiles{grid-template-columns:1fr}
  .kpis{grid-template-columns:1fr}
}

/* World-Class Settings Tab Styles */

/* Master Grid Container */
.settings-master-grid {
  display: flex;
  flex-direction: column;
  gap: 32px;
  padding: 24px 0;
  max-height: calc(80vh - 200px);
  overflow-y: auto;
  scroll-behavior: smooth;
}

.settings-master-grid::-webkit-scrollbar {
  width: 6px;
}

.settings-master-grid::-webkit-scrollbar-track {
  background: var(--bg);
  border-radius: 3px;
}

.settings-master-grid::-webkit-scrollbar-thumb {
  background: var(--ring);
  border-radius: 3px;
  transition: background 0.2s ease;
}

.settings-master-grid::-webkit-scrollbar-thumb:hover {
  background: var(--primary);
}

/* Category Sections */
.settings-category {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.settings-category.danger-zone {
  border-top: 2px solid var(--danger);
  padding-top: 24px;
  margin-top: 16px;
}

.category-header {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 0 4px;
}

.category-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.02em;
}

.category-icon {
  font-size: 24px;
  opacity: 0.9;
}

.category-description {
  margin: 0;
  font-size: 14px;
  color: rgba(233, 238, 247, 0.7);
  line-height: 1.5;
}

/* Settings Cards Grid */
.settings-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
  gap: 20px;
  width: 100%;
}

@media (max-width: 1200px) {
  .settings-cards-grid {
    grid-template-columns: 1fr;
  }
}

/* Individual Settings Cards */
.settings-card {
  background: linear-gradient(135deg, rgba(91,157,255,0.03), rgba(91,157,255,0.01));
  border: 1px solid var(--ring);
  border-radius: 16px;
  padding: 0;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.settings-card:hover {
  border-color: var(--primary);
  box-shadow: 0 8px 32px rgba(91,157,255,0.15);
  transform: translateY(-2px);
}

.settings-card.premium {
  background: linear-gradient(135deg, rgba(91,157,255,0.08), rgba(91,157,255,0.02));
  border: 1px solid rgba(91,157,255,0.3);
  position: relative;
}

.settings-card.premium::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary), #7c3aed, #ec4899);
  opacity: 0.8;
}

.settings-card.security {
  border-color: rgba(50, 230, 133, 0.3);
  background: linear-gradient(135deg, rgba(50,230,133,0.05), rgba(50,230,133,0.01));
}

.settings-card.danger {
  border-color: var(--danger);
  background: linear-gradient(135deg, rgba(255,95,122,0.08), rgba(255,95,122,0.02));
}

/* Card Header */
.settings-card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 24px 24px 16px 24px;
  border-bottom: 1px solid var(--ring);
  background: rgba(255,255,255,0.01);
}

.settings-card-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  background: var(--bg);
  border: 1px solid var(--ring);
  position: relative;
  overflow: hidden;
}

.settings-card-icon::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(45deg, transparent, rgba(91,157,255,0.1), transparent);
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.settings-card:hover .settings-card-icon::before {
  transform: translateX(100%);
}

.settings-card-icon.export {
  background: linear-gradient(135deg, rgba(91,157,255,0.1), rgba(91,157,255,0.05));
  border-color: rgba(91,157,255,0.3);
}

.settings-card-icon.import {
  background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(255,209,102,0.05));
  border-color: rgba(255,209,102,0.3);
}

.settings-card-icon.backup {
  background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(124,58,237,0.05));
  border-color: rgba(124,58,237,0.3);
}

.settings-card-icon.performance {
  background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(34,197,94,0.05));
  border-color: rgba(34,197,94,0.3);
}

.settings-card-icon.display {
  background: linear-gradient(135deg, rgba(236,72,153,0.1), rgba(236,72,153,0.05));
  border-color: rgba(236,72,153,0.3);
}

.settings-card-icon.notifications {
  background: linear-gradient(135deg, rgba(249,115,22,0.1), rgba(249,115,22,0.05));
  border-color: rgba(249,115,22,0.3);
}

.settings-card-icon.security {
  background: linear-gradient(135deg, rgba(50,230,133,0.1), rgba(50,230,133,0.05));
  border-color: rgba(50,230,133,0.3);
}

.settings-card-icon.privacy {
  background: linear-gradient(135deg, rgba(168,85,247,0.1), rgba(168,85,247,0.05));
  border-color: rgba(168,85,247,0.3);
}

.settings-card-icon.audit {
  background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05));
  border-color: rgba(59,130,246,0.3);
}

.settings-card-icon.reset {
  background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(255,209,102,0.05));
  border-color: rgba(255,209,102,0.3);
}

.settings-card-icon.delete {
  background: linear-gradient(135deg, rgba(255,95,122,0.1), rgba(255,95,122,0.05));
  border-color: rgba(255,95,122,0.3);
}

.settings-card-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin: 0;
  letter-spacing: -0.01em;
}

/* Card Content */
.settings-card-content {
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.settings-card-description {
  margin: 0;
  font-size: 14px;
  color: rgba(233, 238, 247, 0.7);
  line-height: 1.6;
}

/* Settings Rows */
.settings-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.settings-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
  margin: 0;
}

/* Modern Form Controls */
.modern-checkbox {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
  font-size: 14px;
  color: var(--text);
  transition: color 0.2s ease;
}

.modern-checkbox:hover {
  color: var(--primary);
}

.modern-checkbox input[type="checkbox"] {
  display: none;
}

.modern-checkbox .checkmark {
  width: 20px;
  height: 20px;
  border: 2px solid var(--ring);
  border-radius: 6px;
  background: var(--bg);
  position: relative;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.modern-checkbox:hover .checkmark {
  border-color: var(--primary);
}

.modern-checkbox input[type="checkbox"]:checked + .checkmark {
  background: var(--primary);
  border-color: var(--primary);
}

.modern-checkbox input[type="checkbox"]:checked + .checkmark::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.modern-checkbox.danger input[type="checkbox"]:checked + .checkmark {
  background: var(--danger);
  border-color: var(--danger);
}

/* Modern Select */
.modern-select {
  appearance: none;
  background: var(--bg);
  border: 1px solid var(--ring);
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 14px;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s ease;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 12px center;
  background-repeat: no-repeat;
  background-size: 16px;
  padding-right: 40px;
}

.modern-select:hover {
  border-color: var(--primary);
}

.modern-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(91,157,255,0.1);
}

/* Modern Range Input */
.range-input-container {
  display: flex;
  align-items: center;
  gap: 12px;
}

.modern-range {
  flex: 1;
  height: 6px;
  border-radius: 3px;
  background: var(--ring);
  outline: none;
  appearance: none;
  cursor: pointer;
}

.modern-range::-webkit-slider-thumb {
  appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transition: all 0.2s ease;
}

.modern-range::-webkit-slider-thumb:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(91,157,255,0.3);
}

.range-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--primary);
  min-width: 40px;
  text-align: right;
}

/* Theme Selector */
.theme-selector {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.theme-option {
  flex: 1;
  cursor: pointer;
}

.theme-option input[type="radio"] {
  display: none;
}

.theme-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 16px 12px;
  border: 2px solid var(--ring);
  border-radius: 12px;
  background: var(--bg);
  transition: all 0.2s ease;
  text-align: center;
}

.theme-option:hover .theme-preview {
  border-color: var(--primary);
  background: rgba(91,157,255,0.05);
}

.theme-option input[type="radio"]:checked + .theme-preview {
  border-color: var(--primary);
  background: rgba(91,157,255,0.1);
}

.theme-name {
  font-size: 12px;
  font-weight: 500;
  color: var(--text);
}

.theme-icon {
  font-size: 20px;
}

/* Export Options */
.export-options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}

.export-option {
  padding: 12px;
  background: rgba(91,157,255,0.02);
  border: 1px solid rgba(91,157,255,0.1);
  border-radius: 8px;
  transition: all 0.2s ease;
}

.export-option:hover {
  background: rgba(91,157,255,0.05);
}

/* Import Zone */
.import-zone {
  position: relative;
  border: 2px dashed var(--ring);
  border-radius: 12px;
  padding: 32px 24px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  background: rgba(91,157,255,0.01);
}

.import-zone:hover {
  border-color: var(--primary);
  background: rgba(91,157,255,0.05);
}

.import-zone.dragover {
  border-color: var(--primary);
  background: rgba(91,157,255,0.1);
  transform: scale(1.02);
}

.import-zone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.import-icon {
  font-size: 32px;
  opacity: 0.6;
}

.import-text {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.import-text strong {
  font-size: 16px;
  color: var(--text);
}

.import-text span {
  font-size: 14px;
  color: rgba(233, 238, 247, 0.7);
}

.import-file-input {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
}

/* Security Status */
.security-status {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 16px;
}

.security-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.security-indicator.active .indicator-dot {
  background: var(--ok);
}

.indicator-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--ring);
  transition: background 0.2s ease;
}

.indicator-text {
  color: var(--text);
}

/* Backup Status */
.backup-status {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 16px;
  background: rgba(124,58,237,0.05);
  border: 1px solid rgba(124,58,237,0.2);
  border-radius: 8px;
}

.backup-info, .backup-size {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.backup-label {
  font-size: 14px;
  color: rgba(233, 238, 247, 0.7);
}

.backup-time, .backup-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

/* Audit Summary */
.audit-summary {
  display: flex;
  gap: 24px;
  margin-top: 16px;
}

.audit-stat {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.audit-number {
  font-size: 24px;
  font-weight: 700;
  color: var(--primary);
}

.audit-label {
  font-size: 12px;
  color: rgba(233, 238, 247, 0.7);
  text-align: center;
}

/* Warning and Danger Boxes */
.warning-box {
  display: flex;
  gap: 12px;
  padding: 16px;
  background: rgba(255,209,102,0.1);
  border: 1px solid rgba(255,209,102,0.3);
  border-radius: 8px;
  margin-top: 16px;
}

.warning-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.warning-text {
  font-size: 14px;
  color: var(--text);
  line-height: 1.5;
}

.danger-box {
  display: flex;
  gap: 12px;
  padding: 16px;
  background: rgba(255,95,122,0.1);
  border: 1px solid rgba(255,95,122,0.3);
  border-radius: 8px;
  margin-top: 16px;
}

.danger-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.danger-text {
  font-size: 14px;
  color: var(--text);
  line-height: 1.5;
}

/* Deletion Checklist */
.deletion-checklist {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}

/* Card Actions */
.settings-card-actions {
  padding: 20px 24px;
  border-top: 1px solid var(--ring);
  background: rgba(255,255,255,0.01);
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* Premium Buttons */
.btn-premium {
  background: linear-gradient(135deg, var(--primary), #7c3aed);
  border: none;
  color: white;
  font-weight: 600;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(91,157,255,0.3);
}

.btn-premium:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 24px rgba(91,157,255,0.4);
}

.btn-premium .btn-glow {
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s ease;
}

.btn-premium:hover .btn-glow {
  left: 100%;
}

.btn-warning {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  border: none;
  color: white;
  font-weight: 600;
}

.btn-warning:hover {
  background: linear-gradient(135deg, #d97706, #b45309);
  transform: translateY(-1px);
}

/* Settings Footer */
.settings-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 24px 0;
  border-top: 1px solid var(--ring);
  margin-top: 32px;
  gap: 24px;
  flex-wrap: wrap;
}

.settings-info {
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.info-label {
  font-size: 12px;
  color: rgba(233, 238, 247, 0.7);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.info-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

.settings-actions {
  display: flex;
  gap: 12px;
}

/* Button Loading State */
.btn-loading {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .settings-master-grid {
    padding: 16px 0;
    gap: 24px;
  }
  
  .settings-cards-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .settings-card-header {
    padding: 20px 20px 12px 20px;
  }
  
  .settings-card-content {
    padding: 20px;
  }
  
  .settings-card-actions {
    padding: 16px 20px;
    flex-direction: column;
  }
  
  .settings-footer {
    flex-direction: column;
    align-items: stretch;
    gap: 16px;
  }
  
  .settings-info {
    justify-content: space-between;
  }
  
  .settings-actions {
    justify-content: stretch;
  }
  
  .settings-actions .btn {
    flex: 1;
  }
}

/* Formula Actions Button */
.formula-actions{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  padding:24px 32px;
  margin-top:24px;
  border-top:1px solid rgba(91,157,255,0.15);
}

.btn-save-formulas{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:14px 32px;
  background:linear-gradient(135deg,#5b9dff,#4a8fd7);
  color:#ffffff;
  border:none;
  border-radius:12px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 4px 16px rgba(91,157,255,0.3);
}

.btn-save-formulas:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 24px rgba(91,157,255,0.4);
  background:linear-gradient(135deg,#6ba3ff,#5599e7);
}

.btn-save-formulas:active{
  transform:translateY(0);
  box-shadow:0 2px 8px rgba(91,157,255,0.3);
}

.btn-save-formulas .btn-icon{
  font-size:16px;
}

.formula-save-hint{
  font-size:12px;
  color:rgba(233,238,247,0.6);
  margin:0;
  text-align:center;
}

/* Weight Factor Tooltip Styles */
.factor-info-trigger{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:20px;
  height:20px;
  margin-left:8px;
  border-radius:50%;
  background:rgba(91,157,255,0.15);
  color:var(--primary);
  font-size:12px;
  cursor:help;
  transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  border:1px solid rgba(91,157,255,0.3);
  user-select:none;
}

.factor-info-trigger:hover{
  background:rgba(91,157,255,0.35);
  border-color:rgba(91,157,255,0.6);
  transform:scale(1.15) rotate(180deg);
  box-shadow:0 0 12px rgba(91,157,255,0.4);
}

.factor-info-trigger:active{
  transform:scale(0.95) rotate(180deg);
}

.tooltip-portal{
  display:none;
  position:fixed;
  inset:0;
  z-index:9999;
  pointer-events:none;
}

.tooltip-portal[aria-hidden="false"]{
  display:flex;
  pointer-events:auto;
}

.tooltip-backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.6);
  backdrop-filter:blur(8px);
  animation:backdropFadeIn 0.3s ease;
  z-index:1;
}

.tooltip-content{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:90%;
  max-width:900px;
  max-height:90vh;
  background:linear-gradient(135deg,var(--panel),rgba(91,157,255,0.05));
  border:1px solid rgba(91,157,255,0.3);
  border-radius:20px;
  box-shadow:0 25px 60px rgba(0,0,0,0.4),0 0 60px rgba(91,157,255,0.15),inset 0 1px 0 rgba(255,255,255,0.1);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  animation:tooltipSlideIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
  z-index:2;
}

.tooltip-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:28px 32px;
  background:linear-gradient(135deg,rgba(91,157,255,0.15),rgba(91,157,255,0.05));
  border-bottom:1px solid rgba(91,157,255,0.2);
}

.tooltip-header h3{
  margin:0;
  font-size:24px;
  font-weight:700;
  color:var(--text);
  letter-spacing:0.5px;
}

.tooltip-close{
  width:36px;
  height:36px;
  border:none;
  background:rgba(91,157,255,0.1);
  color:var(--primary);
  font-size:20px;
  border-radius:12px;
  cursor:pointer;
  transition:all 0.3s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
}

.tooltip-close:hover{
  background:rgba(91,157,255,0.25);
  transform:rotate(90deg) scale(1.1);
  box-shadow:0 0 12px rgba(91,157,255,0.3);
}

.tooltip-body{
  padding:32px;
  overflow-y:auto;
  flex:1;
}

.tooltip-body::-webkit-scrollbar{
  width:8px;
}

.tooltip-body::-webkit-scrollbar-track{
  background:rgba(91,157,255,0.05);
  border-radius:4px;
}

.tooltip-body::-webkit-scrollbar-thumb{
  background:rgba(91,157,255,0.3);
  border-radius:4px;
  transition:all 0.3s ease;
}

.tooltip-body::-webkit-scrollbar-thumb:hover{
  background:rgba(91,157,255,0.5);
}

.tooltip-section{
  margin-bottom:32px;
}

.tooltip-section:last-child{
  margin-bottom:0;
}

.tooltip-section h4{
  margin:0 0 16px 0;
  font-size:16px;
  font-weight:700;
  color:var(--text);
  display:flex;
  align-items:center;
  gap:8px;
}

.tooltip-section p{
  margin:0 0 12px 0;
  font-size:14px;
  line-height:1.6;
  color:rgba(233,238,247,0.8);
}

.formula-breakdown{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin:20px 0;
}

.factor-item{
  display:flex;
  flex-direction:column;
  gap:8px;
  padding:16px;
  background:rgba(91,157,255,0.08);
  border:1px solid rgba(91,157,255,0.2);
  border-radius:12px;
  text-align:center;
  transition:all 0.3s ease;
}

.factor-item:hover{
  background:rgba(91,157,255,0.15);
  border-color:rgba(91,157,255,0.4);
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(91,157,255,0.2);
}

.factor-name{
  font-size:13px;
  font-weight:600;
  color:var(--text);
}

.factor-range{
  font-size:12px;
  color:var(--primary);
  font-weight:700;
  font-family:'Monaco','Courier New',monospace;
}

.math-proof{
  display:flex;
  align-items:center;
  gap:16px;
  padding:16px 20px;
  background:linear-gradient(135deg,rgba(50,230,133,0.1),rgba(91,157,255,0.08));
  border-left:4px solid var(--ok);
  border-radius:8px;
  margin-top:16px;
}

.math-label{
  font-size:13px;
  font-weight:600;
  color:rgba(233,238,247,0.7);
}

.math-equation{
  font-size:16px;
  font-weight:700;
  color:var(--ok);
  font-family:'Monaco','Courier New',monospace;
  letter-spacing:1px;
}

.fixed-reasons{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
  margin-top:16px;
}

.reason-card{
  display:flex;
  gap:16px;
  padding:16px;
  background:rgba(91,157,255,0.08);
  border:1px solid rgba(91,157,255,0.15);
  border-radius:12px;
  transition:all 0.3s ease;
}

.reason-card:hover{
  background:rgba(91,157,255,0.12);
  border-color:rgba(91,157,255,0.3);
  transform:translateX(4px);
  box-shadow:0 4px 12px rgba(91,157,255,0.15);
}

.reason-icon{
  font-size:24px;
  flex-shrink:0;
}

.reason-text{
  flex:1;
}

.reason-text strong{
  display:block;
  font-size:13px;
  font-weight:700;
  color:var(--text);
  margin-bottom:4px;
}

.reason-text p{
  margin:0;
  font-size:13px;
  line-height:1.5;
  color:rgba(233,238,247,0.75);
}

.examples-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  margin-top:16px;
}

.example-item{
  padding:16px;
  background:linear-gradient(135deg,rgba(91,157,255,0.1),rgba(91,157,255,0.05));
  border:1px solid rgba(91,157,255,0.2);
  border-radius:12px;
  text-align:center;
  transition:all 0.3s ease;
}

.example-item:hover{
  background:linear-gradient(135deg,rgba(91,157,255,0.15),rgba(91,157,255,0.08));
  border-color:rgba(91,157,255,0.4);
  transform:translateY(-4px);
  box-shadow:0 8px 24px rgba(91,157,255,0.2);
}

.example-title{
  font-size:13px;
  font-weight:700;
  color:var(--text);
  margin-bottom:8px;
}

.example-formula{
  font-size:12px;
  color:var(--primary);
  font-family:'Monaco','Courier New',monospace;
  margin-bottom:8px;
  padding:8px;
  background:rgba(91,157,255,0.08);
  border-radius:6px;
}

.example-result{
  font-size:16px;
  font-weight:700;
  color:var(--primary);
}

.tooltip-footer{
  padding:20px 32px;
  background:rgba(91,157,255,0.08);
  border-top:1px solid rgba(91,157,255,0.15);
  margin-top:20px;
}

.tooltip-footer p{
  margin:0;
  font-size:13px;
  line-height:1.6;
  color:rgba(233,238,247,0.85);
}

@keyframes backdropFadeIn{
  from{opacity:0;backdrop-filter:blur(0px)}
  to{opacity:1;backdrop-filter:blur(8px)}
}

@keyframes tooltipSlideIn{
  from{opacity:0;transform:translate(-50%,-48%) scale(0.92)}
  to{opacity:1;transform:translate(-50%,-50%) scale(1)}
}

@media (max-width: 768px) {
  .tooltip-content{
    width:95%;
    max-height:95vh;
  }

  .tooltip-header{
    padding:20px 24px;
  }

  .tooltip-header h3{
    font-size:20px;
  }

  .tooltip-body{
    padding:24px;
  }

  .tooltip-section{
    margin-bottom:24px;
  }

  .formula-breakdown{
    grid-template-columns:1fr;
  }

  .examples-grid{
    grid-template-columns:1fr;
  }

  .math-proof{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }

  .reason-card{
    flex-direction:column;
    align-items:flex-start;
  }
}

</style>
</head>
<body>
  <div class="wrapper">
    <header>
            <div class="h-title">
              <h1 id="mainTitleDisplay"></h1>
              <small id="subtitleDisplay"></small>
            </div>      <div class="controls" role="region" aria-label="Controles">
        <input id="q" type="search" placeholder="/ Search Business Unit‚Ä¶ (HR, PAY, GDPA)" aria-label="Buscar" />
        <select id="status" aria-label="Filtro de estado">
          <option value="all">All</option>
          <option value="done">100%</option>
          <option value="wip">1‚Äì99%</option>
          <option value="todo">0%</option>
        </select>

        <button class="btn pill" data-sort="name" title="Order A‚ÜíZ (tecla: s)">A‚ÜíZ</button>
        <button class="btn pill" data-sort="progress" title="Order by Advance">Advance</button>

        <div class="switch" title="Theme light/dark">
          <span>üåô</span><input id="theme" class="toggle" type="checkbox" /><span>‚òÄÔ∏è</span>
        </div>

        <button id="cinema" class="btn pill" title="Cinematic Mode (key: x)">Cinematic</button>
        <button id="exportBars" class="btn pill" title="Exportar barras PNG">Bar PNG</button>
        <button id="exportSVG" class="btn pill" title="Exportar barras SVG">Bar SVG</button>
        <button id="exportCSV" class="btn pill" title="Exportar CSV">CSV</button>
        <button id="setupAdmin" class="btn pill" title="Administration">Setup</button>
      </div>
    </header>

    <!-- FIX: bot√≥n flotante para salir del modo cinem√°tico -->
    <button id="exitCinema" class="btn pill exit-cinema" title="Turn off cinematic mode (Esc)">Exit</button>

    <section class="grid">
      <div class="card hero">
        <div class="inner">
          <h2>Progreso Global</h2>
          <svg id="heroGauge" viewBox="0 0 360 360" width="100%" height="100%" role="img" aria-label="Medidor global"></svg>
          <div class="val" style="inset:auto; top:50%; transform:translateY(-50%);">
            <div class="big" id="heroPct">‚Äî%</div>
            <div class="sub" id="heroCaption">Avg</div>
          </div>
          <div class="spark"></div>
        </div>
      </div>

      <div class="card constel pad">
        <h3>BU's Constellation</h3>
        <div class="tiles" id="tiles"></div>
        <p class="tip">Hover to activate spotlight ¬∑ Click to lock focus ¬∑ Press ESC to release</p>
      </div>

      <div class="card kpis">
        <div class="kpi"><div class="dot" style="background:var(--ok)"></div><h4>Completed</h4><div class="num" id="kpiDone">‚Äî</div></div>
        <div class="kpi"><div class="dot" style="background:var(--warn)"></div><h4>In Progress</h4><div class="num" id="kpiWip">‚Äî</div></div>
        <div class="kpi"><div class="dot" style="background:var(--danger)"></div><h4>About to Start</h4><div class="num" id="kpiTodo">‚Äî</div></div>
        <div class="kpi"><div class="dot" style="background:var(--accent)"></div><h4>Total Avg</h4><div class="num" id="kpiAvg">‚Äî%</div></div>
      </div>

      <div class="card bars pad">
        <h3>Ranking by Advance</h3>
        <svg id="bars" viewBox="0 0 1100 460" width="100%" height="100%" role="img" aria-label="Barras de avance"></svg>
      </div>
    </section>
  </div>

  
  <!-- ADMIN MODAL -->
  <div id="adminModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìä Project Administration</h2>
        <button class="modal-close" id="closeAdminModal">‚úï</button>
      </div>
      
      <!-- BU EDITOR MODAL (nested) -->
      <div id="buEditorModal" class="nested-modal">
        <div class="nested-modal-content">
          <div class="modal-header">
            <h3 id="buEditorTitle">Edit Business Unit</h3>
            <button class="modal-close" id="closeBUEditorModal">‚úï</button>
          </div>
          <div class="modal-body">
            <form id="buEditorForm">
              <div class="form-group">
                <label for="buNameInput">Business Unit Name <span style="color:var(--danger)">*</span></label>
                <div class="input-with-icon">
                  <span class="input-icon">‚úèÔ∏è</span>
                  <input type="text" id="buNameInput" placeholder="Business Unit Name" required>
                </div>
                <small class="form-hint">The display name for this business unit (e.g., HR, IT, SALES)</small>
                <div id="buNameError" class="form-error"></div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="buDomainInput">Domain Code <span style="color:var(--danger)">*</span></label>
                  <div class="input-with-icon">
                    <span class="input-icon">üè¢</span>
                    <input type="text" id="buDomainInput" placeholder="ABCD" maxlength="4" required pattern="[A-Z0-9]{1,4}">
                  </div>
                  <small class="form-hint">Short code (max 4 characters, uppercase)</small>
                  <div id="buDomainError" class="form-error"></div>
                </div>
                <div class="form-group">
                  <label for="buColorInput">Color Theme</label>
                  <div class="color-picker">
                    <input type="color" id="buColorInput" value="#5b9dff">
                    <span class="color-preview" id="colorPreview"></span>
                  </div>
                  <small class="form-hint">Choose a representative color</small>
                </div>
              </div>
              <div class="form-group">
                <label for="buFullnameInput">Full Name/Description <span style="color:var(--danger)">*</span></label>
                <div class="input-with-icon">
                  <span class="input-icon">üìù</span>
                  <input type="text" id="buFullnameInput" placeholder="Business Unit Full Name" required>
                </div>
                <small class="form-hint">Complete name or description (e.g., Human Resources Department)</small>
                <div id="buFullnameError" class="form-error"></div>
              </div>
              <div class="form-group">
                <label for="buManagerInput">Manager/Lead Contact</label>
                <div class="input-with-icon">
                  <span class="input-icon">üë§</span>
                  <input type="text" id="buManagerInput" placeholder="Manager Name">
                </div>
                <small class="form-hint">Optional: Name of the Business Unit leader</small>
              </div>
              <div class="form-group" id="buEditorStats"></div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary"><span class="btn-icon">üíæ</span> Save Changes</button>
                <button type="button" class="btn btn-secondary" id="buEditorCancel">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- APP EDITOR MODAL (nested) -->
      <div id="appEditorModal" class="nested-modal">
        <div class="nested-modal-content">
          <div class="modal-header">
            <h3 id="appEditorTitle">‚ú® Create New Application</h3>
            <button class="modal-close" id="closeAppEditorModal">‚úï</button>
          </div>
          <div class="modal-body">
            <form id="appEditorForm" class="app-editor-form-premium">
              <!-- Section 1: Application Identity -->
              <div class="form-section">
                <div class="form-section-header">
                  <h4>üì± Application Identity</h4>
                  <p>Core information about the application</p>
                </div>
                <div class="form-group">
                  <label for="appNameInput">Application Name <span class="required">*</span></label>
                  <div class="input-with-icon">
                    <span class="input-icon">üì±</span>
                    <input type="text" id="appNameInput" placeholder="e.g., Customer Portal, API Gateway" required>
                  </div>
                  <small class="form-hint">‚úì Clear, descriptive name (3-50 characters)</small>
                  <div id="appNameError" class="form-error"></div>
                </div>
              </div>
              
              <!-- Section 2: Status & Progress -->
              <div class="form-section">
                <div class="form-section-header">
                  <h4>‚è±Ô∏è Status & Progress</h4>
                  <p>Current state and completion tracking</p>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="appStatusInput">Status <span class="required">*</span></label>
                    <select id="appStatusInput" required>
                      <option value="TBS">üîú To Be Started (TBS)</option>
                      <option value="WIP">üöß Work In Progress (WIP)</option>
                      <option value="CLO">‚úÖ Completed (CLO)</option>
                    </select>
                    <small class="form-hint">Application lifecycle stage</small>
                  </div>
                  <div class="form-group">
                    <label for="appProgressInput">Progress <span class="required">*</span></label>
                    <div class="progress-input-wrapper">
                      <input type="number" id="appProgressInput" min="0" max="100" value="0" required>
                      <span class="progress-unit">%</span>
                    </div>
                    <small class="form-hint">Completion percentage (0-100)</small>
                  </div>
                </div>
              </div>
              
              <!-- Section 3: Execution Planning -->
              <div class="form-section">
                <div class="form-section-header">
                  <h4>üìÖ Execution Planning</h4>
                  <p>Schedule and prioritize implementation</p>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="appWaveInput">Implementation Wave <span class="required">*</span></label>
                    <select id="appWaveInput" required>
                      <option value="Wave 1">üåä Wave 1 (First Phase)</option>
                      <option value="Wave 2">üåä Wave 2 (Second Phase)</option>
                      <option value="Wave 3">üåä Wave 3 (Third Phase)</option>
                    </select>
                    <small class="form-hint">Project delivery phase</small>
                  </div>
                  <div class="form-group">
                    <label for="appOrderInput">Execution Order</label>
                    <div class="order-input-wrapper">
                      <input type="number" id="appOrderInput" min="1" value="1">
                    </div>
                    <small class="form-hint">Sequence within the wave (1=first)</small>
                  </div>
                </div>
              </div>
              
              <!-- Section 4: Business Factors -->
              <div class="form-section">
                <div class="form-section-header">
                  <h4>‚öñÔ∏è Business Factors</h4>
                  <p>Factors determining application weight and priority</p>
                </div>
                <div class="form-row three-cols">
                  <div class="form-group">
                    <label for="appCriticalityInput">Criticality <span class="required">*</span></label>
                    <select id="appCriticalityInput" required>
                      <option value="Low">üü¢ Low</option>
                      <option value="Medium" selected>üü° Medium</option>
                      <option value="High">üî¥ High</option>
                    </select>
                    <small class="form-hint">System criticality level</small>
                  </div>
                  <div class="form-group">
                    <label for="appImpactInput">Business Impact <span class="required">*</span></label>
                    <select id="appImpactInput" required>
                      <option value="Low">üü¢ Low</option>
                      <option value="Medium" selected>üü° Medium</option>
                      <option value="High">üî¥ High</option>
                    </select>
                    <small class="form-hint">Business area impact</small>
                  </div>
                  <div class="form-group">
                    <label for="appPriorityInput">Priority <span class="required">*</span></label>
                    <select id="appPriorityInput" required>
                      <option value="Low">üü¢ Low</option>
                      <option value="Medium" selected>üü° Medium</option>
                      <option value="High">üî¥ High</option>
                    </select>
                    <small class="form-hint">Implementation priority</small>
                  </div>
                </div>
              </div>
              
              <!-- Section 5: Auto-Calculated Weight -->
              <div class="form-section weight-preview-section">
                <div class="form-section-header">
                  <h4>üìä Application Weight</h4>
                  <p>Auto-calculated from business factors</p>
                </div>
                <div class="weight-display-box">
                  <div class="weight-value-large" id="weightPreview">1.48</div>
                  <div class="weight-formula">Formula: (C √ó BI √ó P) √∑ 27 √ó 3</div>
                  <small class="form-hint" style="display:block;margin-top:8px;text-align:center">Weight determines resource allocation and priority ranking</small>
                </div>
              </div>
              
              <!-- Form Actions -->
              <div class="form-actions-premium">
                <button type="submit" class="btn btn-primary btn-lg"><span class="btn-icon">‚ú®</span> Create Application</button>
                <button type="button" class="btn btn-secondary" id="appEditorCancel">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="buses">üìä Business Units</button>
        <button class="modal-tab" data-tab="apps">üì± Applications</button>
        <button class="modal-tab" data-tab="app-overview">üîç Applications Overview</button>
        <button class="modal-tab" data-tab="whitelabel">üè∑Ô∏è Whitelabel</button>
        <button class="modal-tab" data-tab="formulas">‚öôÔ∏è Calculation Formulas</button>
        <button class="modal-tab" data-tab="settings">üõ†Ô∏è Settings</button>
      </div>
      
      <div class="modal-scroll-container">
      
      <!-- TAB: BUSINESS UNITS -->
      <div class="modal-tabpanel active" id="tab-buses">
        <div class="tab-header">
          <div>
            <h3>Business Units Management</h3>
            <p class="tab-description">Create, edit, and manage all business units for your project</p>
          </div>
          <button class="btn btn-primary" id="newBUBtn"><span class="btn-icon">‚ú®</span> New Business Unit</button>
        </div>
        <div class="bu-list" id="buList"></div>
      </div>
      
      <!-- TAB: APPLICATIONS -->
      <div class="modal-tabpanel" id="tab-apps">
        <div class="tab-header">
          <div>
            <h3>Applications Management</h3>
            <p class="tab-description">Manage applications and their properties for each business unit</p>
          </div>
        </div>
        <div class="apps-selector-section">
          <div class="form-group" style="margin-bottom:0">
            <label for="appBUFilter">üì± Select Business Unit</label>
            <select id="appBUFilter" class="bu-selector-premium"></select>
          </div>
        </div>
        <div id="appEditorContainer"></div>
      </div>
      
      <!-- TAB: APPLICATIONS OVERVIEW -->
      <div class="modal-tabpanel" id="tab-app-overview">
        <div class="tab-header">
          <div>
            <h3>üîç Applications Overview</h3>
            <p class="tab-description">Complete view of all applications across business units with filtering and sorting</p>
          </div>
        </div>
        
        <!-- Statistics Dashboard -->
        <div class="apps-overview-stats">
          <div class="stat-item">
            <div class="stat-label">Total Apps</div>
            <div class="stat-value" id="statsTotal">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Filtered</div>
            <div class="stat-value" id="statsFiltered">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Avg Completion</div>
            <div class="stat-value" id="statsCompletion">0%</div>
          </div>
        </div>
        
        <!-- Premium Filters Bar -->
        <div class="filters-bar-premium">
          <div class="search-box-wrapper">
            <input type="text" id="appsOverviewSearch" placeholder="üîé Search by name or ID..." class="search-input-premium"/>
          </div>
          <select id="overviewFilterField" class="filter-select-premium">
            <option value="all">üìä Filter By: All</option>
            <option value="status">‚è±Ô∏è Status</option>
            <option value="criticality">‚ö†Ô∏è Criticality</option>
            <option value="wave">üåä Wave</option>
            <option value="buId">üè¢ Business Unit</option>
          </select>
          <select id="overviewFilterValue" class="filter-select-premium">
            <option value="all">All Values</option>
          </select>
          <button class="btn btn-secondary btn-sm" id="resetAppOverviewFilters" title="Reset all filters"><span class="btn-icon">‚Üª</span> Reset</button>
        </div>
        
        <!-- Active Filters Display -->
        <div class="active-filters-container" id="activeFiltersBadges" style="display: none;">
          <span class="active-filters-label">Active Filters:</span>
          <div id="activeFiltersList"></div>
        </div>
        
        <!-- Premium Table Container -->
        <div class="apps-table-container-premium">
          <div class="table-header-info">
            <span class="table-info-icon">üìã</span>
            <span class="table-info-text">Showing <strong id="appsCountDisplay">0</strong> applications</span>
          </div>
          
          <table class="app-table-premium" id="appsOverviewTable">
            <thead>
              <tr>
                <th onclick="Dashboard.AdminController.sortAppsOverview('ID', 0)" class="sortable">
                  <span class="col-icon">üî¢</span> ID <span class="sort-indicator"></span>
                </th>
                <th onclick="Dashboard.AdminController.sortAppsOverview('BU', 1)" class="sortable">
                  <span class="col-icon">üè¢</span> BU <span class="sort-indicator"></span>
                </th>
                <th onclick="Dashboard.AdminController.sortAppsOverview('Wave', 2)" class="sortable">
                  <span class="col-icon">üåä</span> Wave <span class="sort-indicator"></span>
                </th>
                <th onclick="Dashboard.AdminController.sortAppsOverview('App Name', 3)" class="sortable">
                  <span class="col-icon">üì±</span> App Name <span class="sort-indicator"></span>
                </th>
                <th onclick="Dashboard.AdminController.sortAppsOverview('Priority', 4)" class="sortable">
                  <span class="col-icon">üéØ</span> Priority <span class="sort-indicator"></span>
                </th>
                <th onclick="Dashboard.AdminController.sortAppsOverview('Criticality', 5)" class="sortable">
                  <span class="col-icon">‚ö†Ô∏è</span> Criticality <span class="sort-indicator"></span>
                </th>
                <th onclick="Dashboard.AdminController.sortAppsOverview('Business Impact', 6)" class="sortable">
                  <span class="col-icon">üíº</span> Impact <span class="sort-indicator"></span>
                </th>
                <th onclick="Dashboard.AdminController.sortAppsOverview('Completion', 7)" class="sortable">
                  <span class="col-icon">‚úÖ</span> Completion <span class="sort-indicator"></span>
                </th>
                <th onclick="Dashboard.AdminController.sortAppsOverview('Status', 8)" class="sortable">
                  <span class="col-icon">üìä</span> Status <span class="sort-indicator"></span>
                </th>
              </tr>
            </thead>
            <tbody id="appsOverviewTableBody">
              <!-- App data will be populated here -->
            </tbody>
          </table>
          
          <div class="table-empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-title">No applications found</div>
            <div class="empty-state-description">Try adjusting your filters or search criteria</div>
          </div>
        </div>
      </div>
      
      <!-- TAB: WHITELABEL -->
      <div class="modal-tabpanel" id="tab-whitelabel">
        <div class="tab-header">
          <div>
            <h3>Whitelabel Configuration</h3>
            <p class="tab-description">Customize branding, titles, and logos for your project</p>
          </div>
        </div>
        <div class="whitelabel-container">
          <!-- Title Section -->
          <div class="whitelabel-section">
            <h4 class="whitelabel-section-title">üìù Project Title</h4>
            <div class="form-group">
              <label>Main Title</label>
              <input type="text" id="wl-mainTitle" placeholder="" class="form-input"/>
              <p class="form-help">Appears in the main header</p>
            </div>
            <div class="form-group">
              <label>Subtitle</label>
              <input type="text" id="wl-subtitle" placeholder="" class="form-input"/>
              <p class="form-help">Appears below the main title</p>
            </div>
          </div>

          <!-- Logos Section -->
          <div class="whitelabel-section">
            <h4 class="whitelabel-section-title">üé® Logos</h4>
            
            <!-- Left Logo -->
            <div class="form-group">
              <label>Left Logo</label>
              <div class="logo-upload-area" id="leftLogoArea">
                <div class="logo-preview" id="leftLogoPreview">
                  <span class="logo-placeholder">üì∑ Left Logo</span>
                </div>
                <input type="file" id="leftLogoInput" accept="image/*" style="display:none"/>
                <button type="button" class="btn btn-secondary" id="leftLogoBrowseBtn"><span class="btn-icon">üìÅ</span> Upload Logo</button>
              </div>
              <p class="form-help">Recommended size: 200x80px (PNG/JPG)</p>
              <button type="button" class="btn btn-sm btn-danger" id="leftLogoClearBtn" style="margin-top:8px">Clear Logo</button>
            </div>

            <!-- Right Logo -->
            <div class="form-group">
              <label>Right Logo</label>
              <div class="logo-upload-area" id="rightLogoArea">
                <div class="logo-preview" id="rightLogoPreview">
                  <span class="logo-placeholder">üì∑ Right Logo</span>
                </div>
                <input type="file" id="rightLogoInput" accept="image/*" style="display:none"/>
                <button type="button" class="btn btn-secondary" id="rightLogoBrowseBtn"><span class="btn-icon">üìÅ</span> Upload Logo</button>
              </div>
              <p class="form-help">Recommended size: 200x80px (PNG/JPG)</p>
              <button type="button" class="btn btn-sm btn-danger" id="rightLogoClearBtn" style="margin-top:8px">Clear Logo</button>
            </div>
          </div>

          <!-- Preview Section -->
          <div class="whitelabel-section">
            <h4 class="whitelabel-section-title">üëÅÔ∏è Live Preview</h4>
            <div class="whitelabel-preview">
              <div class="preview-header">
                <div class="preview-logo-left" id="previewLogoLeft">
                  <span>Logo</span>
                </div>
                <div class="preview-title">
                  <h2 id="previewMainTitle"></h2>
                  <p id="previewSubtitle"></p>
                </div>
                <div class="preview-logo-right" id="previewLogoRight">
                  <span>Logo</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="whitelabel-section">
            <button class="btn btn-primary" id="wl-saveBtn"><span class="btn-icon">üíæ</span> Save Whitelabel Config</button>
            <button class="btn btn-secondary" id="wl-resetBtn"><span class="btn-icon">‚Ü∫</span> Reset to Defaults</button>
          </div>
        </div>
      </div>

      <!-- TAB: CALCULATION FORMULAS -->
      <div class="modal-tabpanel" id="tab-formulas">
        <div class="tab-header">
          <div>
            <h3>üöÄ Enterprise Calculation Engine</h3>
            <p class="tab-description">Automatic weight calculation system powered by objective business intelligence</p>
          </div>
        </div>
        
        <!-- Hero Section: Automatic Weight System -->
        <div class="formula-hero-section">
          <div class="hero-content">
            <h2>Automatic Weight Calculation</h2>
            <p class="hero-subtitle">Enterprise-grade formula eliminates manual bias and ensures objective prioritization</p>
            
            <div class="formula-showcase">
              <div class="formula-box">
                <div class="formula-label">
                  Core Algorithm
                  <span class="factor-info-trigger" data-tooltip-id="factor27-tooltip">‚ÑπÔ∏è</span>
                </div>
                <div class="formula-equation">
                  Weight = [<span class="highlight">(Criticality √ó Business Impact √ó Priority)</span> √∑ 27 ] √ó 3
                </div>
                <div class="formula-range">Range: 0.11 ‚Üí 3.00 | Precision: 0.01</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Business Intelligence Dashboard -->
        <div class="business-intelligence-grid">
          <!-- Status Inclusion -->
          <div class="bi-card status-inclusion">
            <div class="bi-header">
              <h4>ÔøΩ Status Inclusion Rules</h4>
              <div class="bi-badge rules">Business Rules</div>
            </div>
            <div class="inclusion-content">
              <div class="inclusion-grid">
                <div class="inclusion-item">
                  <div class="inclusion-header">
                    <input type="checkbox" id="include-tbs" class="inclusion-checkbox">
                    <label for="include-tbs" class="status-badge danger">TBS</label>
                    <span class="inclusion-name">To Be Started</span>
                  </div>
                  <div class="inclusion-desc">Future work ‚Ä¢ Include for full pipeline view</div>
                </div>
                
                <div class="inclusion-item">
                  <div class="inclusion-header">
                    <input type="checkbox" id="include-wip" class="inclusion-checkbox" checked>
                    <label for="include-wip" class="status-badge warn">WIP</label>
                    <span class="inclusion-name">Work In Progress</span>
                  </div>
                  <div class="inclusion-desc">Active work ‚Ä¢ Recommended for realistic progress</div>
                </div>
                
                <div class="inclusion-item">
                  <div class="inclusion-header">
                    <input type="checkbox" id="include-clo" class="inclusion-checkbox" checked>
                    <label for="include-clo" class="status-badge ok">CLO</label>
                    <span class="inclusion-name">Closed</span>
                  </div>
                  <div class="inclusion-desc">Completed work ‚Ä¢ Essential for progress tracking</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Progress Method Configuration -->
          <div class="bi-card progress-config">
            <div class="bi-header">
              <h4>‚öôÔ∏è Progress Calculation Method</h4>
              <div class="bi-badge config">Configuration</div>
            </div>
            <div class="config-content">
              <div class="method-selector">
                <div class="method-option">
                  <input type="radio" id="method-weighted" name="progress-method" value="weighted" checked>
                  <label for="method-weighted">
                    <div class="method-name">üéØ Weighted Average</div>
                    <div class="method-desc">Uses automatic weights from business factors</div>
                    <div class="method-formula">BU Progress = Œ£(App Progress √ó Auto-Weight) / Œ£(Auto-Weight)</div>
                  </label>
                </div>
                
                <div class="method-option">
                  <input type="radio" id="method-simple" name="progress-method" value="simple">
                  <label for="method-simple">
                    <div class="method-name">üìä Simple Average</div>
                    <div class="method-desc">All applications have equal influence</div>
                    <div class="method-formula">BU Progress = Œ£(App Progress) / Count(Apps)</div>
                  </label>
                </div>
                
                <div class="method-option">
                  <input type="radio" id="method-minimum" name="progress-method" value="minimum">
                  <label for="method-minimum">
                    <div class="method-name">‚ö†Ô∏è Minimum Progress</div>
                    <div class="method-desc">Conservative bottleneck approach</div>
                    <div class="method-formula">BU Progress = MIN(App Progress)</div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Global Progress -->
          <div class="bi-card global-progress">
            <div class="bi-header">
              <h4>üåê Global Progress Formula</h4>
              <div class="bi-badge global">Enterprise</div>
            </div>
            <div class="global-content">
              <div class="global-selector">
                <div class="global-option">
                  <input type="radio" id="global-weighted" name="global-method" value="weighted" checked>
                  <label for="global-weighted">
                    <div class="global-name">üéØ Weighted by BU Size</div>
                    <div class="global-formula">Global = Œ£(BU Progress √ó BU App Count) / Œ£(App Count)</div>
                  </label>
                </div>
                
                <div class="global-option">
                  <input type="radio" id="global-simple" name="global-method" value="simple">
                  <label for="global-simple">
                    <div class="global-name">üìä Simple BU Average</div>
                    <div class="global-formula">Global = Œ£(BU Progress) / Count(BUs)</div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Factor Analysis -->
          <div class="bi-card factor-analysis">
            <div class="bi-header">
              <h4>üìä Business Factor Analysis</h4>
              <div class="bi-badge">Live Data</div>
            </div>
            <div class="factor-matrix">
              <div class="factor-row">
                <div class="factor-name">üî• Criticality</div>
                <div class="factor-scale">
                  <div class="scale-item danger">High<span>3</span></div>
                  <div class="scale-item warn">Med<span>2</span></div>
                  <div class="scale-item ok">Low<span>1</span></div>
                </div>
                <div class="factor-desc">Operational Impact</div>
              </div>
              
              <div class="factor-row">
                <div class="factor-name">üíº Business Impact</div>
                <div class="factor-scale">
                  <div class="scale-item danger">High<span>3</span></div>
                  <div class="scale-item warn">Med<span>2</span></div>
                  <div class="scale-item ok">Low<span>1</span></div>
                </div>
                <div class="factor-desc">Economic Value</div>
              </div>
              
              <div class="factor-row">
                <div class="factor-name">üéØ Priority</div>
                <div class="factor-scale">
                  <div class="scale-item danger">High<span>3</span></div>
                  <div class="scale-item warn">Med<span>2</span></div>
                  <div class="scale-item ok">Low<span>1</span></div>
                </div>
                <div class="factor-desc">Strategic Urgency</div>
              </div>
            </div>
          </div>

          <!-- Weight Examples -->
          <div class="bi-card weight-examples">
            <div class="bi-header">
              <h4>üíé Weight Examples</h4>
              <div class="bi-badge examples">Reference</div>
            </div>
            <div class="examples-content">
              <div class="example-item max">
                <span class="auto-weight">3.00</span>
                <div class="example-details">
                  <div class="example-combo">High √ó High √ó High</div>
                  <div class="example-desc">Maximum business priority</div>
                </div>
              </div>
              
              <div class="example-item high">
                <span class="auto-weight">2.00</span>
                <div class="example-details">
                  <div class="example-combo">High √ó Medium √ó High</div>
                  <div class="example-desc">Critical urgent application</div>
                </div>
              </div>
              
              <div class="example-item standard">
                <span class="auto-weight">0.89</span>
                <div class="example-details">
                  <div class="example-combo">Medium √ó Medium √ó Medium</div>
                  <div class="example-desc">Standard business application</div>
                </div>
              </div>
              
              <div class="example-item low">
                <span class="auto-weight">0.22</span>
                <div class="example-details">
                  <div class="example-combo">Medium √ó Low √ó Low</div>
                  <div class="example-desc">Low priority maintenance</div>
                </div>
              </div>
              
              <div class="example-item min">
                <span class="auto-weight">0.11</span>
                <div class="example-details">
                  <div class="example-combo">Low √ó Low √ó Low</div>
                  <div class="example-desc">Minimum possible weight</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Weight Calculator -->
          <div class="bi-card weight-calculator">
            <div class="bi-header">
              <h4>üßÆ Real-time Weight Calculator</h4>
              <div class="bi-badge calculator">Interactive</div>
            </div>
            <div class="calculator-content">
              <div class="calc-inputs">
                <div class="calc-input">
                  <label>Criticality</label>
                  <select id="calc-criticality">
                    <option value="1">Low</option>
                    <option value="2" selected>Medium</option>
                    <option value="3">High</option>
                  </select>
                </div>
                <div class="calc-input">
                  <label>Business Impact</label>
                  <select id="calc-impact">
                    <option value="1">Low</option>
                    <option value="2" selected>Medium</option>
                    <option value="3">High</option>
                  </select>
                </div>
                <div class="calc-input">
                  <label>Priority</label>
                  <select id="calc-priority">
                    <option value="1">Low</option>
                    <option value="2" selected>Medium</option>
                    <option value="3">High</option>
                  </select>
                </div>
              </div>
              
              <div class="calc-result">
                <div class="result-label">Calculated Weight</div>
                <div class="result-value" id="calc-result">1.48</div>
                <div class="result-formula" id="calc-formula">[(2 √ó 2 √ó 2) √∑ 27] √ó 3</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Save Changes Action -->
        <div class="formula-actions">
          <button class="btn-save-formulas" id="btn-save-formulas">
            <span class="btn-icon">üíæ</span>
            <span class="btn-text">Save Formula Changes</span>
          </button>
          <p class="formula-save-hint">All formula configurations will be saved to your dashboard settings</p>
        </div>
      </div>

      <!-- TAB: SETTINGS -->
      <div class="modal-tabpanel" id="tab-settings">
        <div class="tab-header">
          <div>
            <h3>üõ†Ô∏è Advanced Settings</h3>
            <p class="tab-description">Complete dashboard configuration, data management, and system preferences</p>
          </div>
        </div>
        
        <!-- Settings Grid Container -->
        <div class="settings-master-grid">
          
          <!-- Data Management Section -->
          <div class="settings-category">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">üíæ</span>
                Data Management
              </h4>
              <p class="category-description">Import, export, and manage your project configuration</p>
            </div>
            
            <div class="settings-cards-grid">
              <!-- Export Configuration -->
              <div class="settings-card premium">
                <div class="settings-card-header">
                  <div class="settings-card-icon export">üì§</div>
                  <div class="settings-card-title">Export Configuration</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Export your complete dashboard configuration with enriched metadata and analytics</p>
                  <div class="export-options">
                    <div class="export-option">
                      <label class="modern-checkbox">
                        <input type="checkbox" id="includeCalculatedMetrics" checked>
                        <span class="checkmark"></span>
                        Include calculated metrics & progress data
                      </label>
                    </div>
                    <div class="export-option">
                      <label class="modern-checkbox">
                        <input type="checkbox" id="includeAuditTrail" checked>
                        <span class="checkmark"></span>
                        Include audit trail & modification history
                      </label>
                    </div>
                    <div class="export-option">
                      <label class="modern-checkbox">
                        <input type="checkbox" id="includeSystemInfo">
                        <span class="checkmark"></span>
                        Include system info & environment details
                      </label>
                    </div>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-premium" id="exportAdminJSON" title="Export complete configuration">
                    <span class="btn-icon">üì•</span>
                    <span class="btn-text">Export Configuration</span>
                    <span class="btn-glow"></span>
                  </button>
                </div>
              </div>
              
              <!-- Import Configuration -->
              <div class="settings-card premium">
                <div class="settings-card-header">
                  <div class="settings-card-icon import">üìÇ</div>
                  <div class="settings-card-title">Import Configuration</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Import a previously exported configuration with full validation and integrity checks</p>
                  <div class="import-zone" id="importZone">
                    <div class="import-zone-content">
                      <div class="import-icon">üìÅ</div>
                      <div class="import-text">
                        <strong>Drop JSON file here or click to browse</strong>
                        <span>Supports .json files up to 10MB</span>
                      </div>
                    </div>
                    <input type="file" id="importAdminJSON" accept=".json" class="import-file-input" />
                  </div>
                  <div class="import-validation-result" id="validationResult" style="display:none;">
                    <div class="validation-status">
                      <span class="status-icon">‚úÖ</span>
                      <span class="status-text">Configuration validated successfully</span>
                    </div>
                    <div class="validation-details"></div>
                  </div>
                </div>
              </div>
              
              <!-- Backup & Restore -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon backup">üíø</div>
                  <div class="settings-card-title">Backup & Restore</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Create automatic backups and restore from previous versions</p>
                  <div class="backup-status">
                    <div class="backup-info">
                      <span class="backup-label">Last backup:</span>
                      <span class="backup-time" id="lastBackupTime">Never</span>
                    </div>
                    <div class="backup-size">
                      <span class="backup-label">Storage used:</span>
                      <span class="backup-value" id="storageUsed">0 KB</span>
                    </div>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-secondary" id="createBackupBtn">
                    <span class="btn-icon">üíæ</span>
                    Create Backup
                  </button>
                  <button class="btn btn-secondary" id="restoreBackupBtn">
                    <span class="btn-icon">‚èÆÔ∏è</span>
                    Restore
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- System Preferences Section -->
          <div class="settings-category">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">‚öôÔ∏è</span>
                System Preferences
              </h4>
              <p class="category-description">Customize dashboard behavior and appearance</p>
            </div>
            
            <div class="settings-cards-grid">
              <!-- Performance Settings -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon performance">‚ö°</div>
                  <div class="settings-card-title">Performance</div>
                </div>
                <div class="settings-card-content">
                  <div class="settings-row">
                    <label class="settings-label">Animation Duration</label>
                    <div class="range-input-container">
                      <input type="range" id="animationSpeed" min="0.1" max="2" step="0.1" value="1" class="modern-range">
                      <span class="range-value" id="animationSpeedValue">1.0s</span>
                    </div>
                  </div>
                  <div class="settings-row">
                    <label class="settings-label">Auto-refresh Interval</label>
                    <select id="refreshInterval" class="modern-select">
                      <option value="0">Disabled</option>
                      <option value="5000">5 seconds</option>
                      <option value="10000">10 seconds</option>
                      <option value="30000" selected>30 seconds</option>
                      <option value="60000">1 minute</option>
                    </select>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableTransitions" checked>
                      <span class="checkmark"></span>
                      Enable smooth transitions
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Display Settings -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon display">üé®</div>
                  <div class="settings-card-title">Display</div>
                </div>
                <div class="settings-card-content">
                  <div class="settings-row">
                    <label class="settings-label">Theme Preference</label>
                    <div class="theme-selector">
                      <label class="theme-option">
                        <input type="radio" name="theme" value="auto" checked>
                        <span class="theme-preview auto">
                          <span class="theme-name">Auto</span>
                          <span class="theme-icon">üåì</span>
                        </span>
                      </label>
                      <label class="theme-option">
                        <input type="radio" name="theme" value="light">
                        <span class="theme-preview light">
                          <span class="theme-name">Light</span>
                          <span class="theme-icon">‚òÄÔ∏è</span>
                        </span>
                      </label>
                      <label class="theme-option">
                        <input type="radio" name="theme" value="dark">
                        <span class="theme-preview dark">
                          <span class="theme-name">Dark</span>
                          <span class="theme-icon">üåô</span>
                        </span>
                      </label>
                    </div>
                  </div>
                  <div class="settings-row">
                    <label class="settings-label">Density</label>
                    <select id="displayDensity" class="modern-select">
                      <option value="compact">Compact</option>
                      <option value="comfortable" selected>Comfortable</option>
                      <option value="spacious">Spacious</option>
                    </select>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="showTooltips" checked>
                      <span class="checkmark"></span>
                      Show helpful tooltips
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Notifications -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon notifications">üîî</div>
                  <div class="settings-card-title">Notifications</div>
                </div>
                <div class="settings-card-content">
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableNotifications" checked>
                      <span class="checkmark"></span>
                      Enable system notifications
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="notifyOnProgress">
                      <span class="checkmark"></span>
                      Notify when progress changes
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="notifyOnCompletion" checked>
                      <span class="checkmark"></span>
                      Notify when applications complete
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Security & Privacy Section -->
          <div class="settings-category">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">üîí</span>
                Security & Privacy
              </h4>
              <p class="category-description">Manage data security and privacy settings</p>
            </div>
            
            <div class="settings-cards-grid">
              <!-- Data Security -->
              <div class="settings-card security">
                <div class="settings-card-header">
                  <div class="settings-card-icon security">üõ°Ô∏è</div>
                  <div class="settings-card-title">Data Security</div>
                </div>
                <div class="settings-card-content">
                  <div class="security-status">
                    <div class="security-indicator active">
                      <span class="indicator-dot"></span>
                      <span class="indicator-text">Local storage encrypted</span>
                    </div>
                    <div class="security-indicator active">
                      <span class="indicator-dot"></span>
                      <span class="indicator-text">Session validation active</span>
                    </div>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableEncryption" checked>
                      <span class="checkmark"></span>
                      Encrypt local data storage
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableAuditLog" checked>
                      <span class="checkmark"></span>
                      Enable audit logging
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- Privacy Controls -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon privacy">üëÅÔ∏è</div>
                  <div class="settings-card-title">Privacy Controls</div>
                </div>
                <div class="settings-card-content">
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="shareUsageData">
                      <span class="checkmark"></span>
                      Share anonymous usage analytics
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="modern-checkbox">
                      <input type="checkbox" id="enableCrashReports">
                      <span class="checkmark"></span>
                      Send crash reports
                    </label>
                  </div>
                  <div class="settings-row">
                    <label class="settings-label">Data Retention Period</label>
                    <select id="dataRetention" class="modern-select">
                      <option value="30">30 days</option>
                      <option value="90" selected>90 days</option>
                      <option value="180">180 days</option>
                      <option value="365">1 year</option>
                      <option value="0">Indefinite</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Audit Trail -->
              <div class="settings-card">
                <div class="settings-card-header">
                  <div class="settings-card-icon audit">üìã</div>
                  <div class="settings-card-title">Audit Trail</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">View detailed log of all system changes and user actions</p>
                  <div class="audit-summary">
                    <div class="audit-stat">
                      <span class="audit-number" id="auditEntries">0</span>
                      <span class="audit-label">Total entries</span>
                    </div>
                    <div class="audit-stat">
                      <span class="audit-number" id="auditToday">0</span>
                      <span class="audit-label">Today</span>
                    </div>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-secondary" id="showAuditTrailBtn">
                    <span class="btn-icon">üìã</span>
                    View Audit Trail
                  </button>
                  <button class="btn btn-secondary" id="exportAuditBtn">
                    <span class="btn-icon">üìÑ</span>
                    Export Log
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Danger Zone Section -->
          <div class="settings-category danger-zone">
            <div class="category-header">
              <h4 class="category-title">
                <span class="category-icon">‚ö†Ô∏è</span>
                Danger Zone
              </h4>
              <p class="category-description">Irreversible actions that affect your entire dashboard</p>
            </div>
            
            <div class="settings-cards-grid">
              <!-- Reset Configuration -->
              <div class="settings-card danger">
                <div class="settings-card-header">
                  <div class="settings-card-icon reset">üîÑ</div>
                  <div class="settings-card-title">Reset Configuration</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Reset all settings to factory defaults while preserving your data</p>
                  <div class="warning-box">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-text">This will reset all preferences, themes, and configurations to default values</div>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-warning" id="resetConfigBtn">
                    <span class="btn-icon">üîÑ</span>
                    Reset Settings
                  </button>
                </div>
              </div>
              
              <!-- Clear All Data -->
              <div class="settings-card danger">
                <div class="settings-card-header">
                  <div class="settings-card-icon delete">üóëÔ∏è</div>
                  <div class="settings-card-title">Clear All Data</div>
                </div>
                <div class="settings-card-content">
                  <p class="settings-card-description">Permanently delete all dashboard data including Business Units, Applications, and history</p>
                  <div class="danger-box">
                    <div class="danger-icon">üö®</div>
                    <div class="danger-text">
                      <strong>This action cannot be undone!</strong><br>
                      All Business Units, Applications, Progress data, and Settings will be permanently deleted.
                    </div>
                  </div>
                  <div class="deletion-checklist">
                    <label class="modern-checkbox danger">
                      <input type="checkbox" id="confirmDeletion1">
                      <span class="checkmark"></span>
                      I understand this will delete all Business Units
                    </label>
                    <label class="modern-checkbox danger">
                      <input type="checkbox" id="confirmDeletion2">
                      <span class="checkmark"></span>
                      I understand this will delete all Applications
                    </label>
                    <label class="modern-checkbox danger">
                      <input type="checkbox" id="confirmDeletion3">
                      <span class="checkmark"></span>
                      I have exported a backup if needed
                    </label>
                  </div>
                </div>
                <div class="settings-card-actions">
                  <button class="btn btn-danger" id="clearAllDataBtn" disabled>
                    <span class="btn-icon">üóëÔ∏è</span>
                    <span class="btn-text">Clear All Data</span>
                    <span class="btn-loading" style="display:none;">üîÑ</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
        </div>
        
        <!-- Settings Actions Footer -->
        <div class="settings-footer">
          <div class="settings-info">
            <div class="info-item">
              <span class="info-label">Configuration version:</span>
              <span class="info-value" id="configVersion">2.0.0</span>
            </div>
            <div class="info-item">
              <span class="info-label">Last modified:</span>
              <span class="info-value" id="lastModified">Never</span>
            </div>
            <div class="info-item">
              <span class="info-label">Storage used:</span>
              <span class="info-value" id="storageInfo">0 KB</span>
            </div>
          </div>
          <div class="settings-actions">
            <button class="btn btn-secondary" id="resetAllSettingsBtn">
              <span class="btn-icon">‚Ü∫</span>
              Reset All Settings
            </button>
            <button class="btn btn-primary" id="saveSettingsBtn">
              <span class="btn-icon">üíæ</span>
              Save Changes
            </button>
          </div>
        </div>
      </div>
      
      <!-- Status Automation Confirmation Modal -->
      <div id="statusConfirmationModal" class="nested-modal">
        <div class="nested-modal-content" style="min-width:400px;max-width:600px">
          <h3 id="confirmTitle" style="margin:0 0 16px 0;font-size:20px;color:var(--text)">Confirm Status Change</h3>
          <p id="confirmMessage" style="margin:0 0 24px 0;color:var(--text-muted);line-height:1.6"></p>
          <div style="display:flex;gap:12px;margin-top:24px">
            <button id="confirmYes" class="btn btn-primary" style="flex:1">Yes, Proceed</button>
            <button id="confirmNo" class="btn btn-secondary" style="flex:1">Cancel</button>
          </div>
        </div>
      </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-primary" id="saveAdminBtn"><span class="btn-icon">üíæ</span> Save & Close</button>
        <button class="btn btn-secondary" id="cancelAdminBtn">Cancel</button>
      </div>
    </div>
  </div>

<!-- World-Class Tooltip Portal for Weight Factor 27 - Moved outside modal to be always accessible -->
<div id="factor27-tooltip" class="tooltip-portal" role="tooltip" aria-hidden="true">
  <div class="tooltip-content">
    <div class="tooltip-header">
      <h3>üéØ Why Factor 27?</h3>
      <button class="tooltip-close" aria-label="Close tooltip">‚úï</button>
    </div>
    <div class="tooltip-body">
      <div class="tooltip-section">
        <h4>üìê The Mathematics</h4>
        <p>The factor <strong>27</strong> represents the <strong>maximum possible product</strong> of your three priority dimensions:</p>
        <div class="formula-breakdown">
          <div class="factor-item">
            <span class="factor-name">Criticality</span>
            <span class="factor-range">1‚Äì3</span>
          </div>
          <div class="factor-item">
            <span class="factor-name">Business Impact</span>
            <span class="factor-range">1‚Äì3</span>
          </div>
          <div class="factor-item">
            <span class="factor-name">Priority</span>
            <span class="factor-range">1‚Äì3</span>
          </div>
        </div>
        <div class="math-proof">
          <span class="math-label">Maximum Product:</span>
          <span class="math-equation">3 √ó 3 √ó 3 = <strong>27</strong></span>
        </div>
      </div>

      <div class="tooltip-section">
        <h4>üîß Why Is It Fixed?</h4>
        <div class="fixed-reasons">
          <div class="reason-card">
            <div class="reason-icon">1Ô∏è‚É£</div>
            <div class="reason-text">
              <strong>Normalization</strong>
              <p>Dividing by 27 converts any factor combination into the standardized <code>0‚Äì1</code> range, ensuring consistency across all calculations.</p>
            </div>
          </div>
          <div class="reason-card">
            <div class="reason-icon">2Ô∏è‚É£</div>
            <div class="reason-text">
              <strong>Controlled Scaling</strong>
              <p>Multiplying by 3 scales the normalized range to your final output range: <code>0.11‚Äì3.00</code>, maintaining mathematical integrity.</p>
            </div>
          </div>
          <div class="reason-card">
            <div class="reason-icon">3Ô∏è‚É£</div>
            <div class="reason-text">
              <strong>System Stability</strong>
              <p>Changing this value breaks the entire calibration. It guarantees minimum thresholds (1√ó1√ó1√∑27√ó3 = 0.11) and maximum boundaries (3√ó3√ó3√∑27√ó3 = 3.00).</p>
            </div>
          </div>
        </div>
      </div>

      <div class="tooltip-section">
        <h4>üìä Real-World Examples</h4>
        <div class="examples-grid">
          <div class="example-item">
            <div class="example-title">Lowest Priority</div>
            <div class="example-formula">[(1√ó1√ó1) √∑ 27] √ó 3</div>
            <div class="example-result">= 0.11</div>
          </div>
          <div class="example-item">
            <div class="example-title">Balanced</div>
            <div class="example-formula">[(2√ó2√ó2) √∑ 27] √ó 3</div>
            <div class="example-result">= 0.89</div>
          </div>
          <div class="example-item">
            <div class="example-title">Highest Priority</div>
            <div class="example-formula">[(3√ó3√ó3) √∑ 27] √ó 3</div>
            <div class="example-result">= 3.00</div>
          </div>
        </div>
      </div>

      <div class="tooltip-footer">
        <p><strong>üí° Key Insight:</strong> This fixed factor ensures that your prioritization system remains mathematically consistent and predictable, regardless of how many applications or workflows you manage.</p>
      </div>
    </div>
  </div>
  <div class="tooltip-backdrop" aria-hidden="true"></div>
</div>

  <!-- JavaScript Modules - Embedded directly to avoid CORS issues -->
  <!-- No external scripts - all code embedded inline to avoid CORS errors -->
<script>
/* ========== Storage Manager Module ========== */
const StorageManager = {
  STORAGE_KEY: 'dashboard_config_v1',
  CLEARED_FLAG: 'dashboard_user_cleared_v1',
  
  init() {
    // =========== SISTEMA DE DETECCI√ìN DE BORRADO INTENCIONAL ===========
    console.log('üîç [StorageManager.init] Verificando estado de los datos...');
    console.log('üìä [DIAGN√ìSTICO INICIAL]', {
      localStorage_STORAGE_KEY: localStorage.getItem(this.STORAGE_KEY),
      localStorage_Keys: Object.keys(localStorage),
      DATA_length: DATA ? DATA.length : 'undefined',
      Dashboard_DATA_length: window.Dashboard && window.Dashboard.DATA ? window.Dashboard.DATA.length : 'undefined'
    });
    
    // 1. SOLO inicializar si no hay datos
    if (!localStorage.getItem(this.STORAGE_KEY)) {
      console.log('üîÑ [StorageManager.init] No hay datos existentes, inicializando dashboard por defecto');
      console.log('üìä [INICIALIZACI√ìN] Usando DATA con', DATA.length, 'elementos:', JSON.stringify(DATA));
      
      // Solo inicializar si DATA tiene elementos (de lo contrario, mantener vac√≠o)
      if (DATA && DATA.length > 0) {
        this.saveConfig({
          buses: DATA.map((d, i) => ({
            id: i + 1,
            key: d.key,
            name: d.name,
            domain: 'CORF',
            fullname: d.name + ' Department',
            apps: []
          })),
          apps: [],
          waves: [
            { id: 1, name: 'Wave 1' },
            { id: 2, name: 'Wave 2' },
            { id: 3, name: 'Wave 3' }
          ]
        });
        console.log('‚úÖ [StorageManager.init] Dashboard inicializado con datos por defecto');
      } else {
        console.log('‚úÖ [StorageManager.init] DATA est√° vac√≠o, manteniendo estado vac√≠o');
        this.saveConfig({ buses: [], apps: [], waves: [] });
      }
    } else {
      console.log('‚ÑπÔ∏è [StorageManager.init] Datos existentes encontrados en localStorage');
    }
    
    // CRITICAL: Rebuild DATA array from storage (not from hardcode)
    console.log('üîÑ [StorageManager.init] Reconstruyendo DATA desde storage...');
    rebuildDATAFromStorage();
  },
  
  loadConfig() {
    const config = localStorage.getItem(this.STORAGE_KEY);
    return config ? JSON.parse(config) : this.getDefaultConfig();
  },
  
  saveConfig(config) {
    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(config));
  },
  
  getDefaultConfig() {
    return { buses: [], apps: [], waves: [] };
  },
  
  getBUs() {
    return this.loadConfig().buses || [];
  },
  
  getApps() {
    return this.loadConfig().apps || [];
  },
  
  getAppsByBU(buId) {
    return this.getApps().filter(app => app.buId === buId);
  },
  
  addBU(bu) {
    const config = this.loadConfig();
    bu.id = Math.max(...config.buses.map(b => b.id), 0) + 1;
    
    // Ensure all new properties are set with defaults
    bu.key = bu.domain; // Keep key and domain in sync
    bu.color = bu.color || '#5b9dff';
    bu.manager = bu.manager || '';
    
    config.buses.push(bu);
    this.saveConfig(config);
    return bu;
  },
  
  updateBU(buId, updates) {
    const config = this.loadConfig();
    const bu = config.buses.find(b => b.id === buId);
    if (bu) {
      // Ensure we preserve custom properties like color and manager
      Object.assign(bu, updates);
      // Make sure key and domain stay in sync
      bu.key = bu.domain;
    }
    this.saveConfig(config);
  },
  
  deleteBU(buId) {
    const config = this.loadConfig();
    config.buses = config.buses.filter(b => b.id !== buId);
    config.apps = config.apps.filter(a => a.buId !== buId);
    this.saveConfig(config);
  },
  
  addApp(app) {
    const config = this.loadConfig();
    app.id = Math.max(...config.apps.map(a => a.id || 0), 0) + 1;
    
    // Ensure all required fields have default values if not provided
    app.name = app.name || 'Unnamed App';
    app.buId = app.buId || null; // This should be caught by validation
    app.status = app.status || 'TBS';
    app.progress = app.progress || 0;
    app.criticality = app.criticality || 'Medium';
    app.impact = app.impact || 'Medium';
    app.priority = app.priority || 'Medium';
    app.order = app.order || 0;
    app.wave = app.wave || 'Wave 1';
    app.weight = app.weight || 1;
    
    // Only add if it has a valid buId
    if (app.buId !== null && app.buId !== undefined) {
      config.apps.push(app);
      this.saveConfig(config);
    }
    
    return app;
  },
  
  updateApp(appId, updates) {
    const config = this.loadConfig();
    const app = config.apps.find(a => a.id === appId);
    if (app) Object.assign(app, updates);
    this.saveConfig(config);
  },
  
  deleteApp(appId) {
    const config = this.loadConfig();
    config.apps = config.apps.filter(a => a.id !== appId);
    this.saveConfig(config);
  },
  
  getAllApps() {
    return this.getApps();
  },
  
  getBUById(buId) {
    return this.getBUs().find(bu => bu.id === buId);
  },
  
  markAsCleared() {
    // Mark in sessionStorage so page reload doesn't auto-recreate data
    console.log('üö´ Marking data as INTENTIONALLY CLEARED');
    sessionStorage.clear(); // Limpiar cualquier valor previo
    sessionStorage.setItem(this.CLEARED_FLAG, 'INTENTIONALLY_CLEARED_BY_USER');
    
    // Verificar que se guard√≥ correctamente
    const verifyFlag = sessionStorage.getItem(this.CLEARED_FLAG);
    console.log('‚úÖ Verification - CLEARED_FLAG saved as:', verifyFlag);
  },
  
  // Funci√≥n emergencia para restablecer datos si es necesario
  resetClearedFlag() {
    console.log('üîÑ Resetting cleared flag - allowing data initialization');
    sessionStorage.removeItem(this.CLEARED_FLAG);
    return !sessionStorage.getItem(this.CLEARED_FLAG);
  },
  
  reassignApp(appId, newBuId) {
    console.log(`üìã [StorageManager] Reassigning app ${appId} to BU ${newBuId}`);
    
    const config = this.loadConfig();
    const app = config.apps.find(a => a.id === appId);
    
    if (!app) {
      console.error(`‚ùå App ${appId} not found`);
      return false;
    }
    
    const oldBuId = app.buId;
    const oldBU = config.buses.find(b => b.id === oldBuId);
    const newBU = config.buses.find(b => b.id === newBuId);
    
    if (!newBU) {
      console.error(`‚ùå Target BU ${newBuId} not found`);
      return false;
    }
    
    // Create audit entry
    const auditEntry = {
      timestamp: new Date().toISOString(),
      action: 'APP_REASSIGNED',
      appId: appId,
      appName: app.name,
      fromBuId: oldBuId,
      fromBuName: oldBU ? oldBU.name : 'Unknown',
      toBuId: newBuId,
      toBuName: newBU.name,
      status: app.status,
      progress: app.progress
    };
    
    // Update app
    app.buId = newBuId;
    
    // Initialize audit trail if doesn't exist
    if (!config.auditTrail) {
      config.auditTrail = [];
    }
    
    config.auditTrail.push(auditEntry);
    
    this.saveConfig(config);
    
    console.log(`‚úÖ App reassigned: ${app.name} (${oldBU?.name} ‚Üí ${newBU.name})`);
    console.log('üìä Audit entry:', auditEntry);
    
    return true;
  },
  
  getAuditTrail() {
    const config = this.loadConfig();
    return config.auditTrail || [];
  },
  
  clearAuditTrail() {
    const config = this.loadConfig();
    config.auditTrail = [];
    this.saveConfig(config);
    console.log('üóëÔ∏è Audit trail cleared');
  }
};

// Export module for namespace compatibility
if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.StorageManager = StorageManager;

/* ========== Progress Calculator Module ========== */
// REPLACEMENT FOR HARDCODED DATA ARRAY
// This is now DYNAMICALLY built from StorageManager, not hardcoded
// The old const DATA = [...] is REMOVED entirely

const DATA = [];  // Empty by default, populated from StorageManager

// Function to rebuild DATA from storage (single source of truth)
function rebuildDATAFromStorage(statusConfig = null) {
  DATA.length = 0;  // Clear array
  const buses = Dashboard.StorageManager.getBUs();
  
  // Usar configuraci√≥n de Status Inclusion por defecto
  const config = statusConfig || {
    TBS: false,
    WIP: true,
    CLO: true
  };
  
  buses.forEach(bus => {
    const apps = Dashboard.StorageManager.getAppsByBU(bus.id);
    
    // Filtrar apps seg√∫n configuraci√≥n de status
    const activeApps = apps.filter(app => {
      const status = app.status || 'TBS';
      return config[status] === true;
    });
    
    let progress = 0;
    
    if (activeApps.length > 0) {
      // IMPORTANTE: Usar calculateAppWeight() para cada app, NO app.weight directamente
      // calculateAppWeight() implementa la f√≥rmula: (C √ó BI √ó P) √∑ 27 √ó 3
      
      let totalWeight = 0;
      let weightedSum = 0;
      
      activeApps.forEach(app => {
        const weight = Dashboard.ProgressCalculator.calculateAppWeight(app);
        const appProgress = app.progress || 0;
        
        totalWeight += weight;
        weightedSum += (appProgress * weight);
      });
      
      // F√ìRMULA: (Œ£ Progress √ó Weight) / Œ£ Weight
      progress = totalWeight > 0 ? Math.round((weightedSum / totalWeight) * 100) / 100 : 0;
      
      console.log(`üîÑ [DATA] BU '${bus.name}': ${activeApps.length} apps, total weight=${totalWeight.toFixed(2)}, progress=${progress}%`);
    } else {
      console.log(`üîÑ [DATA] BU '${bus.name}': No active apps with current filter, progress=0%`);
    }
    
    DATA.push({
      key: bus.key,
      name: bus.name,
      progress: progress
    });
  });
  
  console.log('üîÑ [DATA] Rebuilt from storage with status config:', JSON.stringify({config, data: DATA}));
  return DATA;
}

const ProgressCalculator = {
  /**
   * Calculates automatic weight based on business factors
   * Formula: (Criticality √ó Business Impact √ó Priority) √∑ 27 * 3
   * Range: 0.11 to 3.0 (enterprise-grade scaling)
   */
  calculateAppWeight(app) {
    // Validaci√≥n: asegurar que el app existe
    if (!app) {
      console.warn('‚ö†Ô∏è [ProgressCalculator] calculateAppWeight called with null app, returning 1.0');
      return 1.0;
    }
    
    // Mapeo normalizado de factores a valores 1-3 (ENTERPRISE STANDARD)
    const factorMap = {
      Low: 1,
      Medium: 2,
      High: 3
    };
    
    // Obtener valores con validaci√≥n estricta
    // IMPORTANTE: Solo usar app.criticality, app.impact, app.priority (strings)
    // NO usar app.order o conversiones complejas
    const criticality = factorMap[app.criticality] || 2;
    const businessImpact = factorMap[app.impact] || 2;
    const priority = factorMap[app.priority] || 2;
    
    // F√ìRMULA ENTERPRISE: (Criticality √ó Business Impact √ó Priority) √∑ 27 √ó 3
    // Rango te√≥rico calculado:
    //   M√≠nimo: (1 √ó 1 √ó 1) √∑ 27 √ó 3 = 0.111...
    //   M√°ximo: (3 √ó 3 √ó 3) √∑ 27 √ó 3 = 3.0
    //   Mediano: (2 √ó 2 √ó 2) √∑ 27 √ó 3 = 1.481...
    const weight = (criticality * businessImpact * priority) / 27 * 3;
    
    // Redondear a 2 decimales para precisi√≥n
    const rounded = Math.round(weight * 100) / 100;
    
    // VALIDACI√ìN DE RANGO: Asegurar que est√° entre 0.11 y 3.0
    // Clamp para prevenir valores inv√°lidos
    let final = rounded;
    if (final < 0.11) {
      console.warn(`‚ö†Ô∏è [ProgressCalculator] Weight ${rounded} below minimum 0.11, clamping`);
      final = 0.11;
    }
    if (final > 3.0) {
      console.warn(`‚ö†Ô∏è [ProgressCalculator] Weight ${rounded} above maximum 3.0, clamping`);
      final = 3.0;
    }
    
    return final;
  },
  
  calculateBUProgress(buId, statusConfig = null) {
    const apps = Dashboard.StorageManager.getAppsByBU(buId);
    
    if (apps.length === 0) {
      console.log(`üìä [BU ${buId}] No apps found, progress = 0`);
      return 0;
    }
    
    // Usar configuraci√≥n de Status Inclusion
    // Si no se proporciona, usar defaults (excluir TBS, incluir WIP y CLO)
    const config = statusConfig || {
      TBS: false,
      WIP: true,
      CLO: true
    };
    
    // Filtrar apps seg√∫n configuraci√≥n de status
    const activeApps = apps.filter(app => {
      const status = app.status || 'TBS';
      return config[status] === true;
    });
    
    console.log(`üìä [BU ${buId}] Total apps: ${apps.length}, Active apps: ${activeApps.length}, Config: TBS=${config.TBS}, WIP=${config.WIP}, CLO=${config.CLO}`);
    
    if (activeApps.length === 0) {
      console.log(`üìä [BU ${buId}] No active apps with current filter, progress = 0`);
      return 0;
    }
    
    // Calcular suma ponderada
    let totalWeight = 0;
    let weightedSum = 0;
    
    activeApps.forEach(app => {
      const weight = this.calculateAppWeight(app);
      const progress = app.progress || 0;
      
      totalWeight += weight;
      weightedSum += (progress * weight);
      
      console.log(`  ‚îî‚îÄ App: ${app.name} | Weight: ${weight} | Progress: ${progress}% | Contribution: ${(progress * weight).toFixed(2)}`);
    });
    
    if (totalWeight === 0) {
      console.warn(`‚ö†Ô∏è [BU ${buId}] Total weight is 0, returning 0`);
      return 0;
    }
    
    // F√ìRMULA: (Œ£ Progress √ó Weight) / Œ£ Weight
    const buProgress = (weightedSum / totalWeight);
    
    // Redondear a 2 decimales
    const rounded = Math.round(buProgress * 100) / 100;
    
    // Validaci√≥n: asegurar que est√° entre 0 y 100
    let final = rounded;
    if (final < 0) final = 0;
    if (final > 100) final = 100;
    
    console.log(`üìä [BU ${buId}] Final progress: ${final}% (weighted=${weightedSum.toFixed(2)}, total weight=${totalWeight.toFixed(2)})`);
    
    return final;
  },

  calculateGlobalProgress(globalMethod = 'weighted', statusConfig = null) {
    const buses = Dashboard.StorageManager.getBUs();
    
    if (buses.length === 0) {
      console.log('üåê No business units found, global progress = 0');
      return 0;
    }
    
    // Calcular progreso para cada BU con la configuraci√≥n de status
    const buProgressData = buses.map(bu => {
      const buProgress = this.calculateBUProgress(bu.id, statusConfig);
      const apps = Dashboard.StorageManager.getAppsByBU(bu.id);
      const appCount = apps.length;
      
      return {
        buId: bu.id,
        buName: bu.name,
        progress: buProgress,
        appCount: appCount
      };
    });
    
    console.log(`üåê [GlobalProgress] BU data:`, JSON.stringify(buProgressData));
    
    let globalProgress = 0;
    
    if (globalMethod === 'weighted') {
      // M√âTODO 1: Ponderado por tama√±o de BU
      // Global Progress = Œ£(BU Progress √ó App Count) / Œ£(App Count)
      // Esto da m√°s peso a BUs con m√°s aplicaciones
      
      const totalApps = buProgressData.reduce((sum, bu) => sum + bu.appCount, 0);
      const weightedSum = buProgressData.reduce((sum, bu) => sum + (bu.progress * bu.appCount), 0);
      
      globalProgress = totalApps > 0 ? (weightedSum / totalApps) : 0;
      
      console.log(`üåê [GlobalProgress] WEIGHTED method: ${weightedSum.toFixed(2)} / ${totalApps} apps = ${globalProgress.toFixed(2)}%`);
    } 
    else if (globalMethod === 'simple') {
      // M√âTODO 2: Promedio simple
      // Global Progress = Œ£(BU Progress) / Count(BUs)
      // Todos los BUs tienen igual peso, sin importar cantidad de apps
      
      const sum = buProgressData.reduce((sum, bu) => sum + bu.progress, 0);
      globalProgress = buProgressData.length > 0 ? (sum / buProgressData.length) : 0;
      
      console.log(`üåê [GlobalProgress] SIMPLE average: ${sum.toFixed(2)} / ${buProgressData.length} BUs = ${globalProgress.toFixed(2)}%`);
    }
    else {
      console.warn(`‚ö†Ô∏è [GlobalProgress] Unknown method '${globalMethod}', defaulting to weighted`);
      return this.calculateGlobalProgress('weighted', statusConfig);
    }
    
    // Redondear a 2 decimales
    const rounded = Math.round(globalProgress * 100) / 100;
    
    // Validaci√≥n: asegurar que est√° entre 0 y 100
    let final = rounded;
    if (final < 0) final = 0;
    if (final > 100) final = 100;
    
    console.log(`üåê [GlobalProgress] Final result: ${final}% (method=${globalMethod})`);
    
    return final;
  },
  
  recalculateAllBUsProgress() {
    const buses = Dashboard.StorageManager.getBUs();
    const updated = buses.map(bu => ({
      ...bu,
      computedProgress: this.calculateBUProgress(bu.id)
    }));
    return updated;
  },
  
  getEnhancedDATA() {
    // Devuelve DATA actualizado con progreso computado desde storage
    const buses = this.recalculateAllBUsProgress();
    return buses.map(bu => ({
      key: bu.key,
      name: bu.name,
      progress: bu.computedProgress || 0
    }));
  }
};

// Export module for namespace compatibility
if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.ProgressCalculator = ProgressCalculator;
window.Dashboard.DATA = DATA;

/* ========== UI Controller Module ========== */
const UIController = {
  state: { q: '', status: 'all', sort: 'progress', theme: 'dark', pinned: null },

  init() {
    // Load whitelabel titles from localStorage on UI init
    applyWhitelabelTitles();
    
    this.setupEventListeners();
    this.apply();
  },

  setupEventListeners() {
    // Controls
    document.querySelector('#q').addEventListener('input', e => {
      this.state.q = e.target.value;
      this.apply();
    });

    document.querySelector('#status').addEventListener('change', e => {
      this.state.status = e.target.value;
      this.apply();
    });

    Array.from(document.querySelectorAll('button[data-sort]')).forEach(b => b.addEventListener('click', e => {
      this.state.sort = e.target.dataset.sort;
      this.apply();
    }));

    document.querySelector('#theme').addEventListener('change', e => {
      const theme = e.target.checked ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      this.state.theme = theme;
      this.apply();
    });

    document.querySelector('#cinema').addEventListener('click', () => document.body.classList.toggle('cinematic'));
    document.querySelector('#exitCinema').addEventListener('click', () => {
      document.body.classList.remove('cinematic');
    });

    document.addEventListener('keydown', (ev) => {
      if (ev.key === '/' && document.activeElement.id !== 'q') {
        ev.preventDefault();
        document.querySelector('#q').focus();
      }
      if (ev.key === 'Enter' && document.activeElement.id === 'q') {
        ev.preventDefault();
        document.querySelector('#q').value = '';
        this.state.q = '';
        this.apply();
      }
      if (ev.key === 's') {
        this.state.sort = (this.state.sort === 'name' ? 'progress' : 'name');
        this.apply();
      }
      if (ev.key === 'x') {
        document.body.classList.toggle('cinematic');
      }
      // FIX: ESC primero limpia selecci√≥n; si no hay selecci√≥n, sale del modo cinem√°tico
      if (ev.key === 'Escape') {
        if (this.state.pinned) {
          this.state.pinned = null;
          this.apply();
        } else if (document.body.classList.contains('cinematic')) {
          document.body.classList.remove('cinematic');
        }
      }
    });

    document.querySelector('#exportBars').addEventListener('click', () => this.svgToPNG(document.querySelector('#bars'), 2400, 1000, 'ranking_avance.png'));
    document.querySelector('#exportSVG').addEventListener('click', () => {
      const svg = document.querySelector('#bars').cloneNode(true);
      const sty = document.createElement('style');
      sty.textContent = `text{fill:${this.getCSS('--text')};font-family:${getComputedStyle(document.body).fontFamily}}`;
      svg.insertBefore(sty, svg.firstChild);
      const s = `<?xml version="1.0"?>` + new XMLSerializer().serializeToString(svg);
      this.download('ranking_avance.svg', s, 'image/svg+xml');
    });
    
    document.querySelector('#exportCSV').addEventListener('click', () => {
      const rows = Dashboard.DATA.map(d => `${d.name},${d.progress}`).join('\n');
      this.download('avance_por_area.csv', 'area,progress\n' + rows, 'text/csv');
    });

    // Click en hero gauge para ver apps detail
    document.querySelector('#heroGauge').addEventListener('click', () => {
      if (this.state.pinned) {
        const pinned = Dashboard.DATA.find(d => d.name === this.state.pinned);
        if (pinned) {
          const buId = Dashboard.StorageManager.getBUs().find(bu => bu.name === pinned.name)?.id;
          if (buId) {
            Dashboard.AdminController.currentBUId = buId;
            Dashboard.AdminController.openModal();
            Dashboard.AdminController.switchTab('apps');
            setTimeout(() => {
              const busSelect = document.querySelector('#appBUFilter');
              if (busSelect) busSelect.value = Dashboard.AdminController.currentBUId;
              Dashboard.AdminController.renderAppsEditor();
            }, 100);
          }
        }
      }
    });
  },

  getCSS(v) {
    return getComputedStyle(document.documentElement).getPropertyValue(v).trim();
  },

  fmt(n) {
    return `${n.toFixed(0)}%`;
  },

  color(p) {
    if (p === 100) return this.getCSS('--ok');
    if (p === 0) return this.getCSS('--danger');
    if (p >= 50) return this.getCSS('--warn');
    return this.getCSS('--low');
  },

  filtered() {
    let arr = Dashboard.DATA.filter(d => d.name.toLowerCase().includes(this.state.q.toLowerCase()));
    if (this.state.status === 'done') arr = arr.filter(d => d.progress === 100);
    if (this.state.status === 'wip') arr = arr.filter(d => d.progress > 0 && d.progress < 100);
    if (this.state.status === 'todo') arr = arr.filter(d => d.progress === 0);

    if (this.state.sort === 'name') arr.sort((a, b) => a.name.localeCompare(b.name));
    if (this.state.sort === 'progress') arr.sort((a, b) => b.progress - a.progress || a.name.localeCompare(b.name));
    return arr;
  },

  drawHero(avg) {
    const svg = document.querySelector('#heroGauge');
    svg.innerHTML = '';
    const W = 360, H = 360, cx = W / 2, cy = H / 2, r = 130, sw = 28, C = 2 * Math.PI * r;
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
    const lg = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
    lg.id = 'g';
    lg.setAttribute('x1', '0');
    lg.setAttribute('y1', '0');
    lg.setAttribute('x2', '1');
    lg.setAttribute('y2', '1');
    const stops = [['0%', '#4fd1ff'], ['50%', '#7affb3'], ['100%', '#ffd166']];
    stops.forEach(([o, c]) => {
      const s = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
      s.setAttribute('offset', o);
      s.setAttribute('stop-color', c);
      lg.appendChild(s);
    });
    const f = document.createElementNS('http://www.w3.org/2000/svg', 'filter');
    f.id = 'glow';
    f.innerHTML = '<feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>';
    defs.appendChild(lg);
    defs.appendChild(f);
    svg.appendChild(defs);

    const track = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    track.setAttribute('cx', cx);
    track.setAttribute('cy', cy);
    track.setAttribute('r', r);
    track.setAttribute('fill', 'none');
    track.setAttribute('stroke', this.getCSS('--ring'));
    track.setAttribute('stroke-width', sw);
    svg.appendChild(track);

    // grid
    for (let i = 0; i <= 10; i++) {
      const a = (i / 10) * Math.PI * 2 - Math.PI / 2, R = r + sw / 2, r2 = R + 8;
      const x1 = cx + Math.cos(a) * R, y1 = cy + Math.sin(a) * R, x2 = cx + Math.cos(a) * r2, y2 = cy + Math.sin(a) * r2;
      const L = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      L.setAttribute('x1', x1);
      L.setAttribute('y1', y1);
      L.setAttribute('x2', x2);
      L.setAttribute('y2', y2);
      L.setAttribute('stroke', this.getCSS('--grid'));
      L.setAttribute('stroke-width', (i % 5 === 0) ? 2 : 1);
      svg.appendChild(L);
    }

    const arc = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    arc.setAttribute('cx', cx);
    arc.setAttribute('cy', cy);
    arc.setAttribute('r', r);
    arc.setAttribute('fill', 'none');
    arc.setAttribute('stroke', 'url(#g)');
    arc.setAttribute('stroke-width', sw);
    arc.setAttribute('stroke-linecap', 'round');
    arc.setAttribute('transform', `rotate(-90 ${cx} ${cy})`);
    const target = C * (1 - avg / 100);
    const t0 = performance.now();
    const dur = 800;
    function step(t) {
      const k = Math.min(1, (t - t0) / dur);
      const ease = .5 * (1 - Math.cos(Math.PI * k));
      arc.setAttribute('stroke-dasharray', `${C} ${C}`);
      arc.setAttribute('stroke-dashoffset', target + (C - target) * (1 - ease));
      requestAnimationFrame(step);
    }
    arc.setAttribute('filter', 'url(#glow)');
    svg.appendChild(arc);

    const comet = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    comet.setAttribute('r', '6');
    comet.setAttribute('fill', '#ffffff');
    comet.setAttribute('opacity', '.9');
    svg.appendChild(comet);

    function step2() {
      const ang = -Math.PI / 2 + 2 * Math.PI * (avg / 100);
      const rr = r;
      const x = cx + Math.cos(ang) * rr, y = cy + Math.sin(ang) * rr;
      comet.setAttribute('cx', x);
      comet.setAttribute('cy', y);
      requestAnimationFrame(step2);
    }
    requestAnimationFrame(step);
    requestAnimationFrame(step2);
  },

  orbTile(d) {
    const wrap = document.createElement('div');
    wrap.className = 'tile';
    if (this.state.pinned === d.name) wrap.classList.add('pinned');
    wrap.dataset.name = d.name;
    wrap.dataset.progress = d.progress;

    const svgNS = 'http://www.w3.org/2000/svg';
    const svg = document.createElementNS(svgNS, 'svg');
    svg.setAttribute('viewBox', '0 0 100 100');
    svg.setAttribute('class', 'orb');

    const defs = document.createElementNS(svgNS, 'defs');
    const g = document.createElementNS(svgNS, 'linearGradient');
    g.id = 'g-' + d.name.replace(/\W/g, '');
    g.setAttribute('x1', '0');
    g.setAttribute('y1', '0');
    g.setAttribute('x2', '1');
    g.setAttribute('y2', '1');
    [['0%', '#5bdcff'], ['50%', this.color(Math.max(1, d.progress))], ['100%', '#ffd166']].forEach(([o, c]) => {
      const s = document.createElementNS(svgNS, 'stop');
      s.setAttribute('offset', o);
      s.setAttribute('stop-color', c);
      g.appendChild(s);
    });
    defs.appendChild(g);
    svg.appendChild(defs);

    const r = 34, cx = 50, cy = 50, sw = 10, C = 2 * Math.PI * r;
    const track = document.createElementNS(svgNS, 'circle');
    track.setAttribute('cy', cy);
    track.setAttribute('cx', cx);
    track.setAttribute('r', r);
    track.setAttribute('fill', 'none');
    track.setAttribute('stroke', this.getCSS('--ring'));
    track.setAttribute('stroke-width', sw);
    svg.appendChild(track);

    const fg = document.createElementNS(svgNS, 'circle');
    fg.setAttribute('cy', cy);
    fg.setAttribute('cx', cx);
    fg.setAttribute('r', r);
    fg.setAttribute('fill', 'none');
    fg.setAttribute('stroke', `url(#${g.id})`);
    fg.setAttribute('stroke-width', sw);
    fg.setAttribute('stroke-linecap', 'round');
    fg.setAttribute('transform', `rotate(-90 ${cx} ${cy})`);
    const target = C * (1 - d.progress / 100);
    const t0 = performance.now();
    const dur = 600 + d.progress * 2;
    function anim(t) {
      const k = Math.min(1, (t - t0) / dur);
      const ease = .5 * (1 - Math.cos(Math.PI * k));
      fg.setAttribute('stroke-dashoffset', target + (C - target) * (1 - ease));
      if (k < 1) requestAnimationFrame(anim);
    }
    fg.setAttribute('stroke-dasharray', `${C} ${C}`);
    svg.appendChild(fg);
    requestAnimationFrame(anim);

    const sat = document.createElementNS(svgNS, 'circle');
    sat.setAttribute('r', '3');
    sat.setAttribute('fill', '#fff');
    svg.appendChild(sat);
    function anim2() {
      const ang = -Math.PI / 2 + 2 * Math.PI * (d.progress / 100);
      const x = cx + Math.cos(ang) * r, y = cy + Math.sin(ang) * r;
      sat.setAttribute('cx', x);
      sat.setAttribute('cy', y);
      requestAnimationFrame(anim2);
    }
    requestAnimationFrame(anim2);

    const info = document.createElement('div');
    info.innerHTML = `<div class="name">${d.name}</div><div class="meta">${d.progress}%</div>`;
    const spot = document.createElement('div');
    spot.className = 'spot';
    wrap.appendChild(svg);
    wrap.appendChild(info);
    wrap.appendChild(spot);

    wrap.addEventListener('mouseenter', () => this.spotlight(d.name, true));
    wrap.addEventListener('mouseleave', () => this.spotlight(d.name, false));
    wrap.addEventListener('click', () => {
      this.state.pinned = (this.state.pinned === d.name ? null : d.name);
      this.apply();
    });

    return wrap;
  },

  spotlight(name, on) {
    if (this.state.pinned) return; // si hay selecci√≥n, ignorar hover
    Array.from(document.querySelectorAll('#tiles .tile')).forEach(t => {
      t.style.opacity = on ? (t.dataset.name === name ? '1' : '.25') : '1';
    });
  },

  drawBars(items) {
    const svg = document.querySelector('#bars');
    svg.innerHTML = '';
    const W = 1100, H = 460, M = { t: 40, r: 24, b: 40, l: 150 };
    const w = W - M.l - M.r, h = H - M.t - M.b;
    svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

    // grid + etiquetas
    for (let i = 0; i <= 10; i++) {
      const x = M.l + (i / 10) * w;
      const L = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      L.setAttribute('x1', x);
      L.setAttribute('y1', M.t);
      L.setAttribute('x2', x);
      L.setAttribute('y2', M.t + h);
      L.setAttribute('stroke', this.getCSS('--grid'));
      L.setAttribute('stroke-width', (i % 2 === 0) ? 2 : 1);
      svg.appendChild(L);

      const T = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      T.setAttribute('x', x);
      T.setAttribute('y', M.t - 10);
      T.setAttribute('text-anchor', 'middle');
      T.setAttribute('font-size', '11');
      T.textContent = (i * 10) + '%';
      T.setAttribute('fill', this.getCSS('--text'));
      svg.appendChild(T);
    }

    const barH = Math.min(26, h / items.length - 10);
    items.forEach((d, i) => {
      const y = M.t + i * (barH + 10);

      const lab = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      lab.setAttribute('x', M.l - 12);
      lab.setAttribute('y', y + barH / 2);
      lab.setAttribute('text-anchor', 'end');
      lab.setAttribute('dominant-baseline', 'middle');
      lab.setAttribute('font-size', '13');
      lab.textContent = d.name;
      lab.setAttribute('fill', this.getCSS('--text'));
      svg.appendChild(lab);

      const track = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      track.setAttribute('x', M.l);
      track.setAttribute('y', y);
      track.setAttribute('width', w);
      track.setAttribute('height', barH);
      track.setAttribute('rx', '8');
      track.setAttribute('fill', this.getCSS('--ring'));
      svg.appendChild(track);

      const defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      if (!svg.querySelector('defs')) svg.appendChild(defs);
      const gid = 'gb' + i;
      const gr = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
      gr.id = gid;
      gr.setAttribute('x1', '0');
      gr.setAttribute('y1', '0');
      gr.setAttribute('x2', '1');
      gr.setAttribute('y2', '0');
      [['0%', this.color(Math.max(1, d.progress))], ['100%', '#ffd166']].forEach(([o, c]) => {
        const s = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
        s.setAttribute('offset', o);
        s.setAttribute('stop-color', c);
        gr.appendChild(s);
      });
      defs.appendChild(gr);

      const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bar.setAttribute('x', M.l);
      bar.setAttribute('y', y);
      bar.setAttribute('width', '0');
      bar.setAttribute('height', barH);
      bar.setAttribute('fill', `url(#${gid})`);
      bar.style.filter = 'drop-shadow(0 2px 10px rgba(0,0,0,.2))';
      bar.dataset.target = w * d.progress / 100;
      svg.appendChild(bar);

      const gloss = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      gloss.setAttribute('x', M.l);
      gloss.setAttribute('y', y);
      gloss.setAttribute('width', '0');
      gloss.setAttribute('height', Math.max(2, barH * 0.35));
      gloss.setAttribute('rx', '6');
      gloss.setAttribute('fill', '#fff');
      gloss.setAttribute('opacity', '0.18');
      svg.appendChild(gloss);

      const v = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      v.setAttribute('x', M.l + 4);
      v.setAttribute('y', y + barH / 2);
      v.setAttribute('dominant-baseline', 'middle');
      v.setAttribute('font-size', '12');
      v.setAttribute('fill', this.getCSS('--text'));
      v.textContent = this.fmt(d.progress);
      svg.appendChild(v);
    });

    // ‚úÖ FIX: seleccionar solo las barras animables por su data-attribute
    const bars = Array.from(svg.querySelectorAll('rect[data-target]'));
    const glosses = Array.from(svg.querySelectorAll('rect[rx="6"]'));
    bars.forEach((el, idx) => {
      const target = +el.dataset.target;
      const t0 = performance.now();
      const dur = 600;
      function step(t) {
        const k = Math.min(1, (t - t0) / dur);
        const ease = 1 - Math.pow(1 - k, 3);
        const w = target * ease;
        el.setAttribute('width', w);
        if (glosses[idx]) glosses[idx].setAttribute('width', Math.max(0, w - 6));
        if (k < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    });
  },

  updateKPIs(items) {
    console.log('üîç [updateKPIs] Actualizando KPIs con', items.length, 'items');
    
    const done = items.filter(d => d.progress === 100).length;
    const wip = items.filter(d => d.progress > 0 && d.progress < 100).length;
    const todo = items.filter(d => d.progress === 0).length;
    
    console.log('üìä [KPI] Conteo:', { done, wip, todo });
    
    const avg = Dashboard.DATA.length > 0 
      ? Dashboard.DATA.reduce((s, d) => s + (d.progress || 0), 0) / Dashboard.DATA.length 
      : 0;
      
    console.log('üìä [KPI] Promedio calculado:', avg);
    
    document.querySelector('#kpiDone').textContent = done;
    document.querySelector('#kpiWip').textContent = wip;
    document.querySelector('#kpiTodo').textContent = todo;
    document.querySelector('#kpiAvg').textContent = avg.toFixed(2) + '%';
  },

  renderTiles(items) {
    const box = document.querySelector('#tiles');
    box.innerHTML = '';
    items.forEach(d => box.appendChild(this.orbTile(d))); // posiciones fijas
    if (this.state.pinned) {
      Array.from(document.querySelectorAll('#tiles .tile')).forEach(t => t.style.opacity = (t.dataset.name === this.state.pinned ? '1' : '.18'));
    }
  },

  apply() {
    console.log('üîç [UIController.apply] Iniciando actualizaci√≥n de UI');
    
    // CRITICAL: Rebuild DATA from storage first (single source of truth)
    rebuildDATAFromStorage();
    console.log('üìä [APPLY] DATA after rebuild:', JSON.stringify(DATA));
    
    // Get data from StorageManager (the single source of truth)
    const busesFromStorage = Dashboard.StorageManager.getBUs();
    console.log('üìä [STORAGE] BUs in storage:', JSON.stringify(busesFromStorage));
    console.log('üßπ [CLEARED] Flag state:', sessionStorage.getItem(Dashboard.StorageManager.CLEARED_FLAG));
    
    // If storage is empty (user cleared data), use empty items
    if (busesFromStorage.length === 0) {
      console.log('‚úÖ [APPLY] Storage is empty - showing empty dashboard');
      const items = [];
      this.drawHero(0);
      document.querySelector('#heroPct').textContent = '0';
      document.querySelector('#heroCaption').textContent = 'Empty';
      this.renderTiles(items);
      this.drawBars(items);
      this.updateKPIs(items);
      return;
    }
    
    const items = this.filtered();
    const avgGlobal = DATA.length > 0 
      ? DATA.reduce((s, d) => s + (d.progress || 0), 0) / DATA.length 
      : 0;
    
    console.log('üìä [CALCULO] Progreso global:', avgGlobal, 'Items filtrados:', items.length);
    
    let heroValue = avgGlobal;
    let heroText = 'Avg';
    if (this.state.pinned) {
      const sel = Dashboard.DATA.find(d => d.name === this.state.pinned);
      if (sel) {
        heroValue = sel.progress;
        heroText = sel.name;
      }
    }
    this.drawHero(heroValue);
    document.querySelector('#heroPct').textContent = this.fmt(heroValue);
    document.querySelector('#heroCaption').textContent = heroText;

    this.renderTiles(items);
    this.drawBars(items);
    this.updateKPIs(items);
  },

  download(filename, text, type = 'text/plain') {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], { type }));
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  },

  svgToPNG(svgEl, w = 2200, h = 920, filename = 'chart.png') {
    const svg = new XMLSerializer().serializeToString(svgEl);
    const img = new Image();
    img.onload = function() {
      const c = document.createElement('canvas');
      c.width = w;
      c.height = h;
      const ctx = c.getContext('2d');
      ctx.fillStyle = UIController.getCSS('--bg');
      ctx.fillRect(0, 0, w, h);
      ctx.drawImage(img, 0, 0, w, h);
      c.toBlob(b => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      }, 'image/png');
    };
    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
  }
};

// Export module for namespace compatibility
if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.UIController = UIController;

/* ========== Whitelabel Dynamic Loader ========== */
function applyWhitelabelTitles() {
  const mainTitle = localStorage.getItem('wl_mainTitle');
  const subtitle = localStorage.getItem('wl_subtitle');
  
  const h1 = document.querySelector('#mainTitleDisplay');
  const small = document.querySelector('#subtitleDisplay');
  
  // CRITICAL: Only set if values exist in localStorage
  // NO fallbacks, NO defaults - only what's in persistent storage
  if (mainTitle !== null && h1) {
    h1.textContent = mainTitle;
  }
  if (subtitle !== null && small) {
    small.textContent = subtitle;
  }
}

/* ========== Admin Controller Module ========== */
const AdminController = {
  currentBUId: null,
  
  init() {
    // Load whitelabel titles dynamically
    applyWhitelabelTitles();
    
    // Initialize state
    this.currentOverviewFilters = { field: 'all', value: 'all' };
    this.currentOverviewSearch = '';
    this.currentSort = { column: null, direction: 'asc' };
    
    this.setupEventListeners();
    this.renderBUList();
  },
  
  setupEventListeners() {
    document.querySelector('#setupAdmin').addEventListener('click', () => this.openModal());
    document.querySelector('#closeAdminModal').addEventListener('click', () => this.closeModal());
    document.querySelector('#cancelAdminBtn').addEventListener('click', () => this.closeModal());
    document.querySelector('#saveAdminBtn').addEventListener('click', () => this.saveAndClose());
    
    // Weight Factor Tooltip
    const tooltipTrigger = document.querySelector('[data-tooltip-id="factor27-tooltip"]');
    const tooltip = document.getElementById('factor27-tooltip');
    const tooltipClose = tooltip?.querySelector('.tooltip-close');
    const tooltipBackdrop = tooltip?.querySelector('.tooltip-backdrop');

    if (tooltipTrigger) {
      tooltipTrigger.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = tooltip.getAttribute('aria-hidden') === 'false';
        tooltip.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
        tooltipTrigger.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
        if (!isOpen) {
          document.body.style.overflow = 'hidden';
          setTimeout(() => tooltip.querySelector('.tooltip-close')?.focus(), 50);
        } else {
          document.body.style.overflow = '';
        }
      });

      tooltipTrigger.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          tooltipTrigger.click();
        }
      });
    }

    if (tooltipClose) {
      tooltipClose.addEventListener('click', () => {
        tooltip.setAttribute('aria-hidden', 'true');
        tooltipTrigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        tooltipTrigger.focus();
      });
    }

    if (tooltipBackdrop) {
      tooltipBackdrop.addEventListener('click', () => {
        tooltip.setAttribute('aria-hidden', 'true');
        tooltipTrigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        tooltipTrigger.focus();
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && tooltip && tooltip.getAttribute('aria-hidden') === 'false') {
        tooltip.setAttribute('aria-hidden', 'true');
        tooltipTrigger.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        tooltipTrigger.focus();
      }
    });

    // Save Formula Changes button
    const saveFFormulasBtn = document.getElementById('btn-save-formulas');
    if (saveFFormulasBtn) {
      saveFFormulasBtn.addEventListener('click', () => {
        console.log('üíæ Saving formula changes...');
        // Collect current formula settings using proper selectors
        const formulaConfig = {
          timestamp: new Date().toISOString(),
          progressMethod: document.querySelector('input[name="progress-method"]:checked')?.value || 'weighted',
          globalMethod: document.querySelector('input[name="global-method"]:checked')?.value || 'weighted',
          statusInclusions: {
            tbs: document.getElementById('include-tbs')?.checked || false,
            wip: document.getElementById('include-wip')?.checked || true,
            clo: document.getElementById('include-clo')?.checked || true
          }
        };
        
        // Validate formula configuration
        if (!formulaConfig.progressMethod || !formulaConfig.globalMethod) {
          console.error('‚ùå Formula configuration incomplete:', formulaConfig);
          alert('‚ö†Ô∏è Please ensure all formula settings are configured before saving.');
          return;
        }
        
        // Save to localStorage with validation
        const config = Dashboard.StorageManager.loadConfig();
        config.formulaSettings = formulaConfig;
        Dashboard.StorageManager.saveConfig(config);
        
        // Visual feedback with proper class management
        const originalBackground = saveFFormulasBtn.style.background;
        const originalHTML = saveFFormulasBtn.innerHTML;
        saveFFormulasBtn.style.background = 'linear-gradient(135deg,#32e685,#28c26e)';
        saveFFormulasBtn.innerHTML = '<span class="btn-icon">‚úÖ</span><span class="btn-text">Changes Saved!</span>';
        
        setTimeout(() => {
          saveFFormulasBtn.style.background = originalBackground;
          saveFFormulasBtn.innerHTML = originalHTML;
        }, 2000);
        
        console.log('‚úÖ Formula settings saved with validation:', formulaConfig);
      });
    }
    
    // Tabs - with proper event delegation
    Array.from(document.querySelectorAll('.modal-tab')).forEach(tab => {
      tab.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
    });
    
    // Formula Tab event listeners with null checks
    const saveFormulaBtn = document.getElementById('btn-save-formulas');
    if (saveFormulaBtn) {
      saveFormulaBtn.addEventListener('click', () => this.saveFormulaConfig?.());
    }
    
    const resetFormulaBtn = document.getElementById('btn-reset-formulas');
    if (resetFormulaBtn) {
      resetFormulaBtn.addEventListener('click', () => this.resetFormulaConfig?.());
    }
    
    // Formula change events with proper selectors
    const progressRadios = document.querySelectorAll('input[name="progress-method"]');
    const globalRadios = document.querySelectorAll('input[name="global-method"]');
    
    progressRadios.forEach(radio => {
      radio.addEventListener('change', () => this.updateFormulaLabels?.());
    });
    
    globalRadios.forEach(radio => {
      radio.addEventListener('change', () => this.updateFormulaLabels?.());
    });
    
    // BU Editor Modal (click outside to close)
    const buEditorModal = document.getElementById('buEditorModal');
    if (buEditorModal) {
      buEditorModal.addEventListener('click', (e) => {
        if (e.target === buEditorModal) {
          this.closeBUEditorModal();
        }
      });
    }
    
    // New BU button
    document.querySelector('#newBUBtn').addEventListener('click', () => this.newBU());
    
    // App filter
    document.querySelector('#appBUFilter').addEventListener('change', (e) => {
      this.currentBUId = parseInt(e.target.value);
      this.renderAppsEditor();
    });
    
    // Apps overview filters
    const overviewFilterField = document.querySelector('#overviewFilterField');
    const overviewFilterValue = document.querySelector('#overviewFilterValue');
    const resetAppOverviewFilters = document.querySelector('#resetAppOverviewFilters');
    
    if (overviewFilterField) {
      overviewFilterField.addEventListener('change', () => {
        this.currentOverviewFilters.field = overviewFilterField.value;
        this.updateOverviewFilterValues();
        this.renderAppsOverviewTable();
      });
    }
    
    if (overviewFilterValue) {
      overviewFilterValue.addEventListener('change', () => {
        this.currentOverviewFilters.value = overviewFilterValue.value;
        this.renderAppsOverviewTable();
      });
    }
    
    if (resetAppOverviewFilters) {
      resetAppOverviewFilters.addEventListener('click', () => {
        this.currentOverviewFilters = { field: 'all', value: 'all' };
        if (overviewFilterField) overviewFilterField.value = 'all';
        this.updateOverviewFilterValues();
        if (overviewFilterValue) overviewFilterValue.value = 'all';
        this.renderAppsOverviewTable();
      });
    }
    
    // Add sorting functionality to app overview table headers
    const headers = document.querySelectorAll('#appsOverviewTable th');
    headers.forEach((header, index) => {
      header.addEventListener('click', () => {
        const columnName = header.textContent.trim();
        this.sortAppsOverview(columnName, index);
      });
    });
    
    // Initialize sort and filters
    this.currentOverviewFilters = { field: 'all', value: 'all' };
    this.currentSort = { column: null, direction: 'asc' };
    
    // Settings
    document.querySelector('#exportAdminJSON').addEventListener('click', () => this.exportConfig());
    document.querySelector('#importAdminJSON').addEventListener('change', (e) => this.importConfig(e));
    document.querySelector('#showAuditTrailBtn').addEventListener('click', () => this.showAuditTrail());
    document.querySelector('#clearAllDataBtn').addEventListener('click', () => this.clearAllData());
    
    // Whitelabel
    this.setupWhitelabelListeners();
  },
  
  setupWhitelabelListeners() {
    // Left logo
    document.querySelector('#leftLogoBrowseBtn').addEventListener('click', () => {
      document.querySelector('#leftLogoInput').click();
    });
    document.querySelector('#leftLogoInput').addEventListener('change', (e) => {
      this.handleLogoUpload(e, 'left');
    });
    document.querySelector('#leftLogoClearBtn').addEventListener('click', () => {
      this.clearLogo('left');
    });
    
    // Right logo
    document.querySelector('#rightLogoBrowseBtn').addEventListener('click', () => {
      document.querySelector('#rightLogoInput').click();
    });
    document.querySelector('#rightLogoInput').addEventListener('change', (e) => {
      this.handleLogoUpload(e, 'right');
    });
    document.querySelector('#rightLogoClearBtn').addEventListener('click', () => {
      this.clearLogo('right');
    });
    
    // Title inputs - update preview in real time (NO defaults - only what user enters)
    document.querySelector('#wl-mainTitle').addEventListener('input', (e) => {
      document.querySelector('#previewMainTitle').textContent = e.target.value;
    });
    document.querySelector('#wl-subtitle').addEventListener('input', (e) => {
      document.querySelector('#previewSubtitle').textContent = e.target.value;
    });
    
    // Save and reset buttons
    document.querySelector('#wl-saveBtn').addEventListener('click', () => this.saveWhitelabelConfig());
    document.querySelector('#wl-resetBtn').addEventListener('click', () => this.resetWhitelabelDefaults());
    
    // Load current whitelabel config on tab open
    this.loadWhitelabelConfig();
  },
  
  handleLogoUpload(event, side) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target.result;
      const preview = document.querySelector(side === 'left' ? '#leftLogoPreview' : '#rightLogoPreview');
      const previewDisplay = document.querySelector(side === 'left' ? '#previewLogoLeft' : '#previewLogoRight');
      
      // Clear existing content and add image
      preview.innerHTML = `<img src="${dataUrl}" alt="Logo"/>`;
      previewDisplay.innerHTML = `<img src="${dataUrl}" alt="Logo"/>`;
      
      // Store the data URL
      if (side === 'left') {
        localStorage.setItem('wl_leftLogo', dataUrl);
      } else {
        localStorage.setItem('wl_rightLogo', dataUrl);
      }
    };
    reader.readAsDataURL(file);
  },
  
  clearLogo(side) {
    const preview = document.querySelector(side === 'left' ? '#leftLogoPreview' : '#rightLogoPreview');
    const previewDisplay = document.querySelector(side === 'left' ? '#previewLogoLeft' : '#previewLogoRight');
    
    preview.innerHTML = '<span class="logo-placeholder">üì∑ ' + (side === 'left' ? 'Left' : 'Right') + ' Logo</span>';
    previewDisplay.innerHTML = '<span>' + (side === 'left' ? 'Logo' : 'Logo') + '</span>';
    
    if (side === 'left') {
      localStorage.removeItem('wl_leftLogo');
      document.querySelector('#leftLogoInput').value = '';
    } else {
      localStorage.removeItem('wl_rightLogo');
      document.querySelector('#rightLogoInput').value = '';
    }
  },
  
  loadWhitelabelConfig() {
    // Load titles (no defaults, only if they exist)
    const mainTitle = localStorage.getItem('wl_mainTitle');
    const subtitle = localStorage.getItem('wl_subtitle');
    
    const mainTitleInput = document.querySelector('#wl-mainTitle');
    const subtitleInput = document.querySelector('#wl-subtitle');
    const previewMainTitle = document.querySelector('#previewMainTitle');
    const previewSubtitle = document.querySelector('#previewSubtitle');
    
    if (mainTitle !== null) {
      mainTitleInput.value = mainTitle;
      previewMainTitle.textContent = mainTitle;
    } else {
      mainTitleInput.value = '';
      previewMainTitle.textContent = '';
    }
    
    if (subtitle !== null) {
      subtitleInput.value = subtitle;
      previewSubtitle.textContent = subtitle;
    } else {
      subtitleInput.value = '';
      previewSubtitle.textContent = '';
    }
    
    // Load logos
    const leftLogo = localStorage.getItem('wl_leftLogo');
    const rightLogo = localStorage.getItem('wl_rightLogo');
    
    if (leftLogo) {
      const leftPreview = document.querySelector('#leftLogoPreview');
      leftPreview.innerHTML = `<img src="${leftLogo}" alt="Left Logo"/>`;
      const leftDisplay = document.querySelector('#previewLogoLeft');
      leftDisplay.innerHTML = `<img src="${leftLogo}" alt="Left Logo"/>`;
    }
    
    if (rightLogo) {
      const rightPreview = document.querySelector('#rightLogoPreview');
      rightPreview.innerHTML = `<img src="${rightLogo}" alt="Right Logo"/>`;
      const rightDisplay = document.querySelector('#previewLogoRight');
      rightDisplay.innerHTML = `<img src="${rightLogo}" alt="Right Logo"/>`;
    }
  },
  
  saveWhitelabelConfig() {
    const mainTitle = document.querySelector('#wl-mainTitle').value;
    const subtitle = document.querySelector('#wl-subtitle').value;
    
    // Only save if values are provided (no defaults)
    if (mainTitle) {
      localStorage.setItem('wl_mainTitle', mainTitle);
    } else {
      localStorage.removeItem('wl_mainTitle');
    }
    
    if (subtitle) {
      localStorage.setItem('wl_subtitle', subtitle);
    } else {
      localStorage.removeItem('wl_subtitle');
    }
    
    // Apply changes dynamically to H1 and subtitle
    applyWhitelabelTitles();
    
    alert('‚úÖ Whitelabel configuration saved successfully!');
    console.log('Whitelabel config saved:', { mainTitle, subtitle });
  },
  
  resetWhitelabelDefaults() {
    if (!confirm('Are you sure you want to reset all whitelabel settings to defaults?')) return;
    
    localStorage.removeItem('wl_mainTitle');
    localStorage.removeItem('wl_subtitle');
    localStorage.removeItem('wl_leftLogo');
    localStorage.removeItem('wl_rightLogo');
    
    // Clear UI
    document.querySelector('#wl-mainTitle').value = '';
    document.querySelector('#wl-subtitle').value = '';
    this.clearLogo('left');
    this.clearLogo('right');
    this.loadWhitelabelConfig();
    
    alert('‚úÖ Whitelabel settings reset to defaults');
  },
  
  openModal() {
    document.querySelector('#adminModal').classList.add('active');
    this.renderBUList();
    this.renderBUFilter();
    
    // Si hay una BU seleccionada, actualizar el dropdown para reflejarla
    if (this.currentBUId) {
      const buFilter = document.querySelector('#appBUFilter');
      buFilter.value = this.currentBUId;
      
      // Tambi√©n marcar la tarjeta correspondiente como seleccionada
      const buCards = document.querySelectorAll('.bu-card');
      buCards.forEach(card => {
        const buId = parseInt(card.getAttribute('data-bu-id') || '0');
        if (buId === this.currentBUId) {
          card.classList.add('selected');
        }
      });
      
      // Actualizar la vista de aplicaciones
      this.renderAppsEditor();
    }
    
    // Modal content now uses consistent responsive sizing via CSS
    
    // Setup column sorting event listeners for apps overview
    setTimeout(() => {
      const headers = document.querySelectorAll('#appsOverviewTable th');
      headers.forEach((header, index) => {
        header.addEventListener('click', () => {
          const columnName = header.textContent.trim();
          this.sortAppsOverview(columnName, index);
        });
      });
    }, 100);
  },
  
  closeModal() {
    document.querySelector('#adminModal').classList.remove('active');
  },
  
  switchTab(tabName) {
    Array.from(document.querySelectorAll('.modal-tab')).forEach(t => t.classList.remove('active'));
    Array.from(document.querySelectorAll('.modal-tabpanel')).forEach(p => p.classList.remove('active'));
    document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
    document.querySelector('#tab-' + tabName).classList.add('active');
    
    // Modal content uses responsive CSS sizing - no JS overrides needed
    
    // Initialize specific tab content
    if (tabName === 'app-overview') {
      console.log('Switching to Applications Overview tab');
      // Initialize filters and render table
      this.currentOverviewFilters = { field: 'all', value: 'all' };
      const filterField = document.querySelector('#overviewFilterField');
      if (filterField) filterField.value = 'all';
      const filterValue = document.querySelector('#overviewFilterValue');
      if (filterValue) filterValue.value = 'all';
    } else if (tabName === 'formulas') {
      console.log('üöÄ Switching to Enterprise Calculation Formulas tab');
      // Initialize the new enterprise formula calculator
      setTimeout(() => {
        this.initializeFormulaCalculator();
      }, 100);
      // Load formula configuration
      this.loadFormulaConfig();
    }
    
    // Solo renderizar la vista de aplicaciones si estamos en esa pesta√±a
    if (tabName === 'app-overview') {
      this.renderAppsOverview();
    }
  },
  
  renderBUList() {
    const buses = Dashboard.StorageManager.getBUs();
    const container = document.querySelector('#buList');
    container.innerHTML = '';
    
    buses.forEach(bu => {
      const apps = Dashboard.StorageManager.getAppsByBU(bu.id);
      const progress = Dashboard.ProgressCalculator.calculateBUProgress(bu.id);
      const card = document.createElement('div');
      card.className = 'bu-card';
      // A√±adir data-bu-id para facilitar la selecci√≥n al reabrir el modal
      card.setAttribute('data-bu-id', bu.id);
      // Add a class if the BU has no apps
      if (apps.length === 0) {
        card.classList.add('empty');
      }
      // Marcar como seleccionada si coincide con currentBUId
      if (this.currentBUId === bu.id) {
        card.classList.add('selected');
      }

      // Calculate the number of apps by status
      const appsDone = apps.filter(app => app.progress === 100 || app.status === 'CLO').length;
      const appsWIP = apps.filter(app => app.progress > 0 && app.progress < 100 && app.status !== 'CLO').length;
      const appsTodo = apps.filter(app => app.progress === 0 || app.status === 'TBS').length;
      
      // Get color based on progress
      const getColor = (p) => {
        if (p === 100) return 'var(--ok)';
        if (p === 0) return 'var(--danger)';
        if (p >= 50) return 'var(--warn)';
        return 'var(--low)';
      };
      
      card.innerHTML = `
        <div class="bu-card-actions">
          <button class="bu-card-btn edit-bu-btn" title="Edit" data-buid="${bu.id}">‚úèÔ∏è</button>
          <button class="bu-card-btn delete-bu-btn" title="Delete" data-buid="${bu.id}">üóëÔ∏è</button>
        </div>
        <div class="bu-card-name">
          <span class="bu-card-icon" style="background:${getColor(progress)};color:#fff;border-radius:4px;">${bu.domain.charAt(0)}</span>
          ${bu.name} ${apps.length === 0 ? '<span class="bu-empty-badge">Empty</span>' : ''}
        </div>
        <div class="bu-card-meta"><span class="bu-card-icon" title="Domain">üè¢</span>${bu.domain} ¬∑ ${bu.fullname}</div>
        <div class="bu-card-meta">
          <span class="bu-card-icon" title="Applications">üì±</span>Apps: ${apps.length} 
          ${apps.length > 0 ? `<span title="Completed">‚úÖ ${appsDone}</span> <span title="In Progress">‚è≥ ${appsWIP}</span> <span title="To Start">üîú ${appsTodo}</span>` : ''}
        </div>
        <div class="bu-card-progress">
          <div class="bu-card-progress-bar" style="width:${progress}%; background:${getColor(progress)}"></div>
        </div>
        <div class="bu-card-meta"><span class="bu-card-icon" title="Progress">üìä</span>Progress: <strong>${progress.toFixed(1)}%</strong></div>
      `;
      // Add click event for selecting the BU
      card.addEventListener('click', (e) => {
        // Don't select if clicking on the action buttons
        if (!e.target.closest('.bu-card-btn')) {
          this.selectBU(bu.id, card);
        }
      });
      
      // Add event handlers for edit and delete buttons
      const editBtn = card.querySelector('.edit-bu-btn');
      const deleteBtn = card.querySelector('.delete-bu-btn');
      
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent BU selection
        this.editBU(bu.id);
      });
      
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent BU selection
        this.deleteBU(bu.id);
      });
      container.appendChild(card);
    });
  },
  
  selectBU(buId, element) {
    Array.from(document.querySelectorAll('.bu-card')).forEach(c => c.classList.remove('selected'));
    element.classList.add('selected');
    this.currentBUId = buId;
  },
  
  newBU() {
    this.openBUEditorModal();
  },
  
  openBUEditorModal(buId = null) {
    // Get BU data if editing, or set defaults for new BU
    const isNewBU = buId === null;
    let bu = { 
      name: '', 
      domain: '', 
      fullname: '', 
      manager: '',
      color: '#5b9dff'
    };
    
    if (!isNewBU) {
      bu = Dashboard.StorageManager.getBUById(buId);
      if (!bu) return;
      
      // Set default values if they're missing
      if (!bu.color) bu.color = '#5b9dff';
      if (!bu.manager) bu.manager = '';
    }
    
    // Set the modal title and adjust style based on operation
    const buEditorTitle = document.getElementById('buEditorTitle');
    buEditorTitle.textContent = isNewBU ? '‚ú® Create New Business Unit' : '‚úèÔ∏è Edit Business Unit';
    
    // Set form values
    document.getElementById('buNameInput').value = bu.name;
    document.getElementById('buDomainInput').value = bu.domain;
    document.getElementById('buFullnameInput').value = bu.fullname;
    
    // Set color and manager if available
    const colorInput = document.getElementById('buColorInput');
    colorInput.value = bu.color || '#5b9dff';
    document.getElementById('colorPreview').style.backgroundColor = colorInput.value;
    
    // Manager field (might be new)
    const managerInput = document.getElementById('buManagerInput');
    if (managerInput) managerInput.value = bu.manager || '';
    
    // Setup color picker interaction
    colorInput.addEventListener('input', function() {
      document.getElementById('colorPreview').style.backgroundColor = this.value;
    });
    
    // Show statistics if editing an existing BU
    if (!isNewBU) {
      const apps = Dashboard.StorageManager.getAppsByBU(buId);
      const progress = Dashboard.ProgressCalculator.calculateBUProgress(buId);
      
      // Calculate apps by status
      const appsDone = apps.filter(app => app.progress === 100 || app.status === 'CLO').length;
      const appsWIP = apps.filter(app => app.progress > 0 && app.progress < 100 && app.status !== 'CLO').length;
      const appsTodo = apps.filter(app => app.progress === 0 || app.status === 'TBS').length;
      
      const statsDiv = document.getElementById('buEditorStats');
      
      statsDiv.innerHTML = `
        <div class="form-stats">
          <div class="form-stats-title">Business Unit Statistics</div>
          <div class="form-stats-item">
            <span>Applications Total:</span>
            <span><strong>${apps.length}</strong></span>
          </div>
          <div class="form-stats-item">
            <span>Applications by Status:</span>
            <span>
              <span title="Completed" style="margin-right:8px">‚úÖ ${appsDone}</span>
              <span title="In Progress" style="margin-right:8px">‚è≥ ${appsWIP}</span>
              <span title="To Start">üîú ${appsTodo}</span>
            </span>
          </div>
          <div class="form-stats-item">
            <span>Overall Progress:</span>
            <span>
              <div style="width:100px;height:10px;background:var(--ring);border-radius:5px;overflow:hidden;display:inline-block;vertical-align:middle;margin-right:8px">
                <div style="height:100%;background:${this.getProgressColor(progress)};width:${progress}%"></div>
              </div>
              <strong>${progress.toFixed(1)}%</strong>
            </span>
          </div>
          <div class="form-stats-item">
            <span>Status:</span>
            <span>${progress === 100 ? 
              '<span style="color:var(--ok)">‚úÖ Complete</span>' : 
              progress > 0 ? '<span style="color:var(--warn)">üöß In Progress</span>' : 
              '<span style="color:var(--danger)">üîú Not Started</span>'
            }</span>
          </div>
        </div>
      `;
    } else {
      document.getElementById('buEditorStats').innerHTML = '';
    }
    
    // Show the modal with animation
    const modal = document.getElementById('buEditorModal');
    modal.classList.add('active');
    
    // Focus on the first input with delay to allow animation to complete
    setTimeout(() => document.getElementById('buNameInput').focus(), 300);
    
    // Setup form validation and submission
    const form = document.getElementById('buEditorForm');
    
    // Remove any existing event listeners
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Set up real-time validation
    const nameInput = document.getElementById('buNameInput');
    const domainInput = document.getElementById('buDomainInput');
    const fullnameInput = document.getElementById('buFullnameInput');
    
    // Validate name field
    nameInput.addEventListener('input', () => {
      const name = nameInput.value.trim();
      const nameError = document.getElementById('buNameError');
      
      if (name.length === 0) {
        nameError.textContent = "Business Unit name is required";
      } else if (name.length < 2) {
        nameError.textContent = "Name must be at least 2 characters";
      } else {
        nameError.textContent = "";
      }
    });
    
    // Validate domain field
    domainInput.addEventListener('input', () => {
      const domain = domainInput.value.trim();
      const domainError = document.getElementById('buDomainError');
      
      if (domain.length === 0) {
        domainError.textContent = "Domain code is required";
      } else if (!/^[A-Z0-9]{1,4}$/.test(domain)) {
        domainError.textContent = "Domain must be 1-4 uppercase letters/numbers";
        domainInput.value = domain.toUpperCase(); // Auto convert to uppercase
      } else {
        domainError.textContent = "";
      }
    });
    
    // Validate fullname field
    fullnameInput.addEventListener('input', () => {
      const fullname = fullnameInput.value.trim();
      const fullnameError = document.getElementById('buFullnameError');
      
      if (fullname.length === 0) {
        fullnameError.textContent = "Full name is required";
      } else if (fullname.length < 4) {
        fullnameError.textContent = "Full name must be at least 4 characters";
      } else {
        fullnameError.textContent = "";
      }
    });
    
    // Add submit event listener with validation
    newForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      // Get form values
      const name = nameInput.value.trim();
      const domain = domainInput.value.trim();
      const fullname = fullnameInput.value.trim();
      const color = colorInput.value;
      const manager = document.getElementById('buManagerInput')?.value?.trim() || '';
      
      // Validate all fields
      let isValid = true;
      
      // Name validation
      if (name.length === 0) {
        document.getElementById('buNameError').textContent = "Business Unit name is required";
        isValid = false;
      } else if (name.length < 2) {
        document.getElementById('buNameError').textContent = "Name must be at least 2 characters";
        isValid = false;
      } else {
        document.getElementById('buNameError').textContent = "";
      }
      
      // Domain validation
      if (domain.length === 0) {
        document.getElementById('buDomainError').textContent = "Domain code is required";
        isValid = false;
      } else if (!/^[A-Z0-9]{1,4}$/.test(domain)) {
        document.getElementById('buDomainError').textContent = "Domain must be 1-4 uppercase letters/numbers";
        isValid = false;
      } else {
        document.getElementById('buDomainError').textContent = "";
      }
      
      // Fullname validation
      if (fullname.length === 0) {
        document.getElementById('buFullnameError').textContent = "Full name is required";
        isValid = false;
      } else if (fullname.length < 4) {
        document.getElementById('buFullnameError').textContent = "Full name must be at least 4 characters";
        isValid = false;
      } else {
        document.getElementById('buFullnameError').textContent = "";
      }
      
      if (!isValid) {
        return; // Stop submission if any validation fails
      }
      
      // Update or create BU with all fields
      if (isNewBU) {
        Dashboard.StorageManager.addBU({
          key: domain,
          name,
          domain,
          fullname,
          color,
          manager
        });
      } else {
        Dashboard.StorageManager.updateBU(buId, {
          key: domain,
          name,
          domain,
          fullname,
          color,
          manager
        });
      }
      
      // Show success message with animation
      const successMessage = document.createElement('div');
      successMessage.className = 'form-success';
      successMessage.textContent = `Business Unit ${isNewBU ? 'created' : 'updated'} successfully!`;
      newForm.appendChild(successMessage);
      
      // Close modal with a small delay to show success message
      setTimeout(() => {
        this.closeBUEditorModal();
        
        // Refresh UI
        this.renderBUList();
        this.renderBUFilter();
        
        // If apps tab is visible and this BU is selected, refresh the apps editor
        if (!isNewBU && this.currentBUId === buId && document.querySelector('#tab-apps.active')) {
          this.renderAppsEditor();
        }
        
        // Refresh the UI controller to update visualizations
        Dashboard.UIController.apply();
      }, 800);
    });
    
    // Setup cancel button
    document.getElementById('buEditorCancel').addEventListener('click', () => {
      this.closeBUEditorModal();
    });
    
    // Setup close button
    document.getElementById('closeBUEditorModal').addEventListener('click', () => {
      this.closeBUEditorModal();
    });
  },
  
  // Helper function to get color based on progress
  getProgressColor(progress) {
    if (progress === 100) return 'var(--ok)';
    if (progress === 0) return 'var(--danger)';
    if (progress >= 50) return 'var(--warn)';
    return 'var(--low)';
  },
  
  closeBUEditorModal() {
    document.getElementById('buEditorModal').classList.remove('active');
  },
  
  editBU(buId) {
    this.openBUEditorModal(buId);
  },
  
  deleteBU(buId) {
    const bu = Dashboard.StorageManager.getBUById(buId);
    if (!bu) return;
    
    const apps = Dashboard.StorageManager.getAppsByBU(buId);
    
    // Confirm deletion
    const message = apps.length > 0 ? 
      `Are you sure you want to delete the Business Unit "${bu.name}" and all its ${apps.length} applications?` :
      `Are you sure you want to delete the Business Unit "${bu.name}"?`;
      
    if (!confirm(message)) return;
    
    // Delete the BU
    Dashboard.StorageManager.deleteBU(buId);
    
    // Reset current BU ID if it was deleted
    if (this.currentBUId === buId) {
      this.currentBUId = null;
    }
    
    // Refresh the BU list
    this.renderBUList();
    
    // Refresh BU filter in apps tab
    this.renderBUFilter();
    
    // Clear apps editor if this BU was selected
    if (document.querySelector('#tab-apps.active')) {
      const container = document.querySelector('#appEditorContainer');
      container.innerHTML = '<p>Please select a Business Unit</p>';
    }
  },
  
  renderBUFilter() {
    const buses = Dashboard.StorageManager.getBUs();
    const select = document.querySelector('#appBUFilter');
    select.innerHTML = '<option value="">-- Select BU --</option>';
    buses.forEach(bu => {
      const opt = document.createElement('option');
      opt.value = bu.id;
      opt.textContent = bu.name;
      select.appendChild(opt);
    });
  },

  progressChangeHandler(appId, newProgress) {
    const app = Dashboard.StorageManager.getAllApps().find(a => a.id === appId);
    if (!app) return;
    
    const oldProgress = app.progress || 0;
    newProgress = parseInt(newProgress) || 0;
    
    if (newProgress < 0) newProgress = 0;
    if (newProgress > 100) newProgress = 100;
    
    console.log(`Progress change: ${appId} from ${oldProgress}% to ${newProgress}%`);
    
    if (oldProgress === 0 && newProgress === 0) return;
    
    if (newProgress === 0) {
      this.handleStatusTransition(appId, 'TBS', 0);
      return;
    }
    
    if (oldProgress === 0 && newProgress > 0 && newProgress < 100) {
      this.showStatusConfirmation(appId, 'start', newProgress, app.name);
      return;
    }
    
    if (oldProgress > 0 && oldProgress < 100 && newProgress === 100) {
      this.showStatusConfirmation(appId, 'complete', newProgress, app.name);
      return;
    }
    
    if (newProgress >= 1 && newProgress < 100) {
      if (app.status !== 'WIP') {
        Dashboard.StorageManager.updateApp(appId, { progress: newProgress, status: 'WIP' });
      } else {
        Dashboard.StorageManager.updateApp(appId, { progress: newProgress });
      }
      this.renderAppsEditor();
      Dashboard.UIController.apply();
      return;
    }
    
    if (newProgress === 100) {
      if (app.status !== 'CLO') {
        Dashboard.StorageManager.updateApp(appId, { progress: 100, status: 'CLO' });
      } else {
        Dashboard.StorageManager.updateApp(appId, { progress: 100 });
      }
      this.renderAppsEditor();
      Dashboard.UIController.apply();
      return;
    }
  },

  showStatusConfirmation(appId, type, newProgress, appName = '') {
    const modal = document.getElementById('statusConfirmationModal');
    const titleEl = document.getElementById('confirmTitle');
    const messageEl = document.getElementById('confirmMessage');
    const yesBtn = document.getElementById('confirmYes');
    const noBtn = document.getElementById('confirmNo');
    
    if (!modal || !titleEl || !messageEl || !yesBtn || !noBtn) {
      console.error('Status confirmation modal elements not found');
      return;
    }
    
    let title, message, newStatus;
    
    if (type === 'start') {
      title = 'üöÄ Start Application?';
      message = `Ready to start "<strong>${appName}</strong>"? This will change status from <strong>TBS</strong> to <strong>WIP</strong>.`;
      newStatus = 'WIP';
    } else if (type === 'complete') {
      title = '‚úÖ Mark as Complete?';
      message = `Ready to mark "<strong>${appName}</strong>" as complete? This will change status from <strong>WIP</strong> to <strong>CLO</strong>.`;
      newStatus = 'CLO';
    } else {
      return;
    }
    
    titleEl.textContent = title;
    messageEl.innerHTML = message;
    
    const newYesBtn = yesBtn.cloneNode(true);
    const newNoBtn = noBtn.cloneNode(true);
    yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
    noBtn.parentNode.replaceChild(newNoBtn, noBtn);
    
    const updatedYesBtn = document.getElementById('confirmYes');
    const updatedNoBtn = document.getElementById('confirmNo');
    
    updatedYesBtn.addEventListener('click', () => {
      this.handleStatusTransition(appId, newStatus, newProgress);
      modal.classList.remove('active');
    });
    
    updatedNoBtn.addEventListener('click', () => {
      modal.classList.remove('active');
      const appRow = document.querySelector(`tr[data-app-id="${appId}"]`);
      if (appRow) {
        const progressInput = appRow.querySelector('input[type="number"]');
        if (progressInput) {
          const currentApp = Dashboard.StorageManager.getAllApps().find(a => a.id === appId);
          progressInput.value = currentApp ? (currentApp.progress || 0) : 0;
        }
      }
    });
    
    modal.classList.add('active');
  },

  handleStatusTransition(appId, newStatus, newProgress) {
    Dashboard.StorageManager.updateApp(appId, {
      status: newStatus,
      progress: newProgress
    });
    this.renderAppsEditor();
    Dashboard.UIController.apply();
  },
  
  renderAppsEditor() {
    if (!this.currentBUId) return;
    const bu = Dashboard.StorageManager.getBUs().find(b => b.id === this.currentBUId);
    const allApps = Dashboard.StorageManager.getAppsByBU(this.currentBUId);
    const container = document.querySelector('#appEditorContainer');
    
    // Calculate stats
    const totalApps = allApps.length;
    const completedApps = allApps.filter(a => a.status === 'CLO').length;
    const inProgressApps = allApps.filter(a => a.status === 'WIP').length;
    const notStartedApps = allApps.filter(a => a.status === 'TBS').length;
    const avgProgress = totalApps > 0 ? Math.round(allApps.reduce((sum, a) => sum + (a.progress || 0), 0) / totalApps) : 0;
    
    // Initialize filters if not exists
    if (!this.appsEditorFilters) {
      this.appsEditorFilters = { status: null, wave: null, search: '' };
    }
    
    // Apply filters
    let apps = allApps.filter(app => {
      let matches = true;
      if (this.appsEditorFilters.status && app.status !== this.appsEditorFilters.status) matches = false;
      if (this.appsEditorFilters.wave && app.wave !== this.appsEditorFilters.wave) matches = false;
      if (this.appsEditorFilters.search) {
        const search = this.appsEditorFilters.search.toLowerCase();
        matches = matches && (app.name.toLowerCase().includes(search) || app.wave?.toLowerCase().includes(search));
      }
      return matches;
    });
    
    let html = `<div class="apps-editor-header">
      <h3>${bu.name} Applications</h3>
      <button class="btn btn-primary" onclick="Dashboard.AdminController.openAppEditorModal(${this.currentBUId})"><span class="btn-icon">‚ú®</span> Add Application</button>
    </div>
    
    <!-- Stats Dashboard -->
    <div class="apps-stats-dashboard">
      <div class="stat-card">
        <span class="stat-icon">üìä</span>
        <div class="stat-label">Total Apps</div>
        <div class="stat-value">${totalApps}</div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">‚úÖ</span>
        <div class="stat-label">Completed</div>
        <div class="stat-value">${completedApps}</div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">üöß</span>
        <div class="stat-label">In Progress</div>
        <div class="stat-value">${inProgressApps}</div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">üîú</span>
        <div class="stat-label">Not Started</div>
        <div class="stat-value">${notStartedApps}</div>
      </div>
      <div class="stat-card">
        <span class="stat-icon">üìà</span>
        <div class="stat-label">Avg Progress</div>
        <div class="stat-value">${avgProgress}%</div>
      </div>
    </div>
    
    <!-- Search & Filters -->
    <div class="apps-search-filter-bar">
      <input type="text" class="apps-search-input" id="appsSearchInput" placeholder="üîç Search by name or wave..." value="${this.appsEditorFilters.search}" onkeyup="Dashboard.AdminController.handleAppsSearch(this.value)"/>
      <button class="apps-filter-button ${this.appsEditorFilters.status === 'TBS' ? 'active' : ''}" onclick="Dashboard.AdminController.toggleAppsFilter('status', 'TBS')">üîú TBS</button>
      <button class="apps-filter-button ${this.appsEditorFilters.status === 'WIP' ? 'active' : ''}" onclick="Dashboard.AdminController.toggleAppsFilter('status', 'WIP')">üöß WIP</button>
      <button class="apps-filter-button ${this.appsEditorFilters.status === 'CLO' ? 'active' : ''}" onclick="Dashboard.AdminController.toggleAppsFilter('status', 'CLO')">‚úÖ CLO</button>
      <button class="apps-filter-button ${this.appsEditorFilters.wave === 'Wave 1' ? 'active' : ''}" onclick="Dashboard.AdminController.toggleAppsFilter('wave', 'Wave 1')">üåä Wave 1</button>
      <button class="apps-filter-button ${this.appsEditorFilters.wave === 'Wave 2' ? 'active' : ''}" onclick="Dashboard.AdminController.toggleAppsFilter('wave', 'Wave 2')">üåä Wave 2</button>
      <button class="apps-filter-button ${this.appsEditorFilters.wave === 'Wave 3' ? 'active' : ''}" onclick="Dashboard.AdminController.toggleAppsFilter('wave', 'Wave 3')">üåä Wave 3</button>
      ${(this.appsEditorFilters.status || this.appsEditorFilters.wave || this.appsEditorFilters.search) ? `<button class="apps-filter-button" onclick="Dashboard.AdminController.clearAppsFilters()" style="margin-left:auto">‚úï Clear Filters</button>` : ''}
    </div>
    
    <!-- Card Grid Container (WORLD-CLASS DESIGN) -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 24px; margin-bottom: 12px;">
      <div style="font-size: 12px; color: rgba(233,238,247,0.6); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
        üìã Showing <strong style="color: var(--text)">${apps.length}</strong> of <strong>${totalApps}</strong> applications
      </div>
    </div>
    
    <div class="apps-cards-grid">`;
    
    if (apps.length === 0) {
      html += `<div class="apps-empty-grid-state" style="grid-column: 1 / -1;">
        <div class="apps-empty-grid-state-icon">üîç</div>
        <div class="apps-empty-grid-state-title">No applications found</div>
        <div class="apps-empty-grid-state-description">${allApps.length === 0 ? 'No applications yet. Create one to get started!' : 'Try adjusting your filters or search criteria.'}</div>
        ${allApps.length === 0 ? `<button class="btn btn-primary" onclick="Dashboard.AdminController.openAppEditorModal(${this.currentBUId})" style="margin-top:12px">‚ú® Create First Application</button>` : ''}
      </div>`;
    } else {
      apps.forEach(app => {
        const progressPercent = app.progress || 0;
        const weight = Dashboard.ProgressCalculator.calculateAppWeight(app);
        const statusClass = app.status === 'TBS' ? 'tbs' : app.status === 'WIP' ? 'wip' : 'clo';
        
        html += `
        <div class="app-card" data-app-id="${app.id}">
          <div class="app-card-header">
            <div class="app-card-title">
              <div class="app-card-name">${app.name}</div>
              <div class="app-card-wave">üåä ${app.wave}</div>
            </div>
            <div class="app-card-status ${statusClass}">
              ${app.status === 'TBS' ? 'üîú TBS' : app.status === 'WIP' ? 'üöß WIP' : '‚úÖ CLO'}
            </div>
          </div>
          
          <div class="app-card-progress">
            <div class="app-card-progress-label">
              <span class="app-card-progress-label-value">Progress</span>
              <span class="app-card-progress-label-percent">${progressPercent}%</span>
            </div>
            <div class="app-card-progress-bar">
              <div class="app-card-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
          </div>
          
          <div class="app-card-metrics">
            <div class="app-metric">
              <div class="app-metric-item">
                <div class="app-metric-label">Order</div>
                <div class="app-metric-value">#${app.order || 1}</div>
              </div>
              <div class="app-metric-item">
                <div class="app-metric-label">Weight</div>
                <div class="app-metric-value progress">${weight.toFixed(2)}</div>
              </div>
            </div>
            <div class="app-metric">
              <div class="app-metric-item">
                <div class="app-metric-label">Criticality</div>
                <div class="app-metric-value">
                  ${app.criticality === 'Low' ? 'üü¢' : app.criticality === 'Medium' ? 'üü°' : 'üî¥'} ${app.criticality}
                </div>
              </div>
              <div class="app-metric-item">
                <div class="app-metric-label">Impact</div>
                <div class="app-metric-value">
                  ${app.impact === 'Low' ? 'üü¢' : app.impact === 'Medium' ? 'üü°' : 'üî¥'} ${app.impact}
                </div>
              </div>
            </div>
            <div class="app-metric">
              <div class="app-metric-item">
                <div class="app-metric-label">Priority</div>
                <div class="app-metric-value">
                  ${app.priority === 'Low' ? 'üü¢' : app.priority === 'Medium' ? 'üü°' : 'üî¥'} ${app.priority}
                </div>
              </div>
              <div class="app-metric-item">
                <div class="app-metric-label">BU</div>
                <div class="app-metric-value">${bu.key}</div>
              </div>
            </div>
          </div>
          
          <div class="app-card-actions">
            <button class="app-card-action-btn edit" onclick="Dashboard.AdminController.editAppFromCard(${app.id})" title="Edit application details">‚úèÔ∏è Edit</button>
            <button class="app-card-action-btn" onclick="Dashboard.AdminController.openReassignModal(${app.id})" title="Reassign to another BU">üîÑ Move</button>
            <button class="app-card-action-btn danger" onclick="Dashboard.AdminController.deleteApp(${app.id})" title="Delete application">üóëÔ∏è Delete</button>
          </div>
        </div>`;
      });
    }
    
    html += '</div></div>';
    container.innerHTML = html;
  },
  
  handleAppsSearch(searchText) {
    if (!this.appsEditorFilters) this.appsEditorFilters = { status: null, wave: null, search: '' };
    this.appsEditorFilters.search = searchText;
    this.renderAppsEditor();
  },
  
  toggleAppsFilter(filterType, filterValue) {
    if (!this.appsEditorFilters) this.appsEditorFilters = { status: null, wave: null, search: '' };
    if (filterType === 'status') {
      this.appsEditorFilters.status = this.appsEditorFilters.status === filterValue ? null : filterValue;
    } else if (filterType === 'wave') {
      this.appsEditorFilters.wave = this.appsEditorFilters.wave === filterValue ? null : filterValue;
    }
    this.renderAppsEditor();
  },
  
  clearAppsFilters() {
    this.appsEditorFilters = { status: null, wave: null, search: '' };
    this.renderAppsEditor();
  },
  
  openAppEditorModal(buId = null) {
    console.log('üî• FUNCTION CALLED: openAppEditorModal with buId=', buId);
    alert('üî• ADD APP MODAL OPENING - buId=' + buId);
    
    // If no buId provided, try current selected or fallback to first available BU
    if (buId === null) buId = this.currentBUId;
    // If still no buId, attempt to use the first BU in storage
    if (!buId) {
      const buses = Dashboard.StorageManager.getBUs();
      if (buses && buses.length > 0) {
        buId = buses[0].id;
        // set as current so UI reflects selection
        this.currentBUId = buId;
        console.log('openAppEditorModal: no BU selected, defaulting to first BU id=', buId);
      } else {
        // No BUs configured - inform user
        alert('Please create a Business Unit first before adding an application.');
        return;
      }
    }
    
    console.log('üî• buId determined:', buId);
    alert('üî• About to set title and reset form');
    
    // Set modal title
    document.getElementById('appEditorTitle').textContent = '‚ú® Create New Application';
    
    // Reset form
    document.getElementById('appNameInput').value = '';
    document.getElementById('appStatusInput').value = 'TBS';
    document.getElementById('appProgressInput').value = 0;
    document.getElementById('appCriticalityInput').value = 'Medium';
    document.getElementById('appImpactInput').value = 'Medium';
    document.getElementById('appPriorityInput').value = 'Medium';
    document.getElementById('appOrderInput').value = 1;
    // Weight preview will be updated by recalculateWeightPreview
    document.getElementById('appWaveInput').value = 'Wave 1';
    
    // Function to recalculate weight preview
    const recalculateWeightPreview = () => {
      const criticality = document.getElementById('appCriticalityInput').value;
      const impact = document.getElementById('appImpactInput').value;
      const priority = document.getElementById('appPriorityInput').value;
      const order = 5; // Default middle priority
      
      const mockApp = { criticality, impact, priority, order };
      const weight = Dashboard.ProgressCalculator.calculateAppWeight(mockApp);
      document.getElementById('weightPreview').textContent = weight.toFixed(2);
    };
    
    // Initial calculation
    recalculateWeightPreview();
    
    // Add event listeners to recalculate on change
    document.getElementById('appCriticalityInput').addEventListener('change', recalculateWeightPreview);
    document.getElementById('appImpactInput').addEventListener('change', recalculateWeightPreview);
    document.getElementById('appPriorityInput').addEventListener('change', recalculateWeightPreview);
    
    // Clear errors
    document.getElementById('appNameError').textContent = '';
    
    // Show modal
    console.log('üî• Looking for modal element with id="appEditorModal"');
    const modal = document.getElementById('appEditorModal');
    console.log('üî• Modal element found:', modal);
    alert('üî• About to show modal, classList=' + modal.className);
    
    if (!modal) {
      console.error('‚ùå CRITICAL: appEditorModal element not found in DOM!');
      alert('‚ùå ERROR: Modal element not found!');
      return;
    }
    
    modal.classList.add('active');
    console.log('üî• Modal active class added. New classList:', modal.className);
    alert('üî• Modal should now be visible!');
    
    // Focus on first input
    setTimeout(() => document.getElementById('appNameInput').focus(), 300);
    
    // Setup form submission
    const form = document.getElementById('appEditorForm');
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // Real-time validation
    document.getElementById('appNameInput').addEventListener('input', () => {
      const name = document.getElementById('appNameInput').value.trim();
      const nameError = document.getElementById('appNameError');
      if (name.length === 0) {
        nameError.textContent = "Application name is required";
      } else if (name.length < 3) {
        nameError.textContent = "Name must be at least 3 characters";
      } else {
        nameError.textContent = "";
      }
    });
    
    // Form submission
    newForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const name = document.getElementById('appNameInput').value.trim();
      const status = document.getElementById('appStatusInput').value;
      const progress = parseInt(document.getElementById('appProgressInput').value) || 0;
      const criticality = document.getElementById('appCriticalityInput').value;
      const impact = document.getElementById('appImpactInput').value;
      const priority = document.getElementById('appPriorityInput').value;
      const order = parseInt(document.getElementById('appOrderInput').value) || 1;
      const wave = document.getElementById('appWaveInput').value;
      
      // Validate
      let isValid = true;
      if (name.length === 0) {
        document.getElementById('appNameError').textContent = "Application name is required";
        isValid = false;
      } else if (name.length < 3) {
        document.getElementById('appNameError').textContent = "Name must be at least 3 characters";
        isValid = false;
      }
      
      if (!isValid) return;
      
      // Create app with explicit order from form (don't auto-increment)
      Dashboard.StorageManager.addApp({
        buId,
        name,
        status,
        progress,
        criticality,
        impact,
        priority,
        wave,
        order
      });
      
      // Close modal
      this.closeAppEditorModal();
      
      // Refresh UI
      this.renderAppsEditor();
      if (document.querySelector('#tab-app-overview.active')) {
        this.renderAppsOverview();
      }
      
      // Show success
      Dashboard.UIController.apply();
    });
    
    // Cancel button
    document.getElementById('appEditorCancel').addEventListener('click', () => {
      this.closeAppEditorModal();
    });
    
    // Close button
    document.getElementById('closeAppEditorModal').addEventListener('click', () => {
      this.closeAppEditorModal();
    });
    
    // Click outside to close
    document.getElementById('appEditorModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('appEditorModal')) {
        this.closeAppEditorModal();
      }
    });
  },
  
  closeAppEditorModal() {
    document.getElementById('appEditorModal').classList.remove('active');
  },
  
  newApp(buId) {
    this.openAppEditorModal(buId);
  },
  
  editAppFromCard(appId) {
    // Load app data
    const app = Dashboard.StorageManager.getAllApps().find(a => a.id === appId);
    if (!app) return;
    
    // Open modal with edit mode
    const modal = document.getElementById('appEditorModal');
    document.getElementById('appEditorTitle').textContent = '‚úèÔ∏è Edit Application';
    
    // Populate form with current values
    document.getElementById('appNameInput').value = app.name;
    document.getElementById('appStatusInput').value = app.status;
    document.getElementById('appProgressInput').value = app.progress || 0;
    document.getElementById('appCriticalityInput').value = app.criticality || 'Medium';
    document.getElementById('appImpactInput').value = app.impact || 'Medium';
    document.getElementById('appPriorityInput').value = app.priority || 'Medium';
    document.getElementById('appOrderInput').value = app.order || 1;
    document.getElementById('appWaveInput').value = app.wave || 'Wave 1';
    
    // Show modal
    modal.classList.add('active');
    
    // Focus on name input
    setTimeout(() => document.getElementById('appNameInput').focus(), 300);
    
    // Setup form submission for edit
    const form = document.getElementById('appEditorForm');
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    const updatedForm = document.getElementById('appEditorForm');
    updatedForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const name = document.getElementById('appNameInput').value.trim();
      const status = document.getElementById('appStatusInput').value;
      const progress = parseInt(document.getElementById('appProgressInput').value) || 0;
      const criticality = document.getElementById('appCriticalityInput').value;
      const impact = document.getElementById('appImpactInput').value;
      const priority = document.getElementById('appPriorityInput').value;
      const order = parseInt(document.getElementById('appOrderInput').value) || 1;
      const wave = document.getElementById('appWaveInput').value;
      
      // Validate
      let isValid = true;
      if (name.length === 0) {
        document.getElementById('appNameError').textContent = "Application name is required";
        isValid = false;
      } else if (name.length < 3) {
        document.getElementById('appNameError').textContent = "Name must be at least 3 characters";
        isValid = false;
      }
      
      if (!isValid) return;
      
      // Update app
      Dashboard.StorageManager.updateApp(appId, {
        name,
        status,
        progress,
        criticality,
        impact,
        priority,
        wave,
        order
      });
      
      // Close modal
      this.closeAppEditorModal();
      
      // Refresh UI
      this.renderAppsEditor();
      if (document.querySelector('#tab-app-overview.active')) {
        this.renderAppsOverview();
      }
      
      // Show success
      Dashboard.UIController.apply();
    });
  },
  
  updateApp(appId, updates) {
    Dashboard.StorageManager.updateApp(appId, updates);
    this.renderAppsEditor();
    // Refresh main dashboard when weight-affecting factors change
    if (updates.criticality || updates.impact || updates.order || updates.progress) {
      Dashboard.UIController.apply();
    }
    // Also refresh the overview table if it's visible
    if (document.querySelector('#tab-app-overview.active')) {
      this.renderAppsOverview();
    }
  },
  
  deleteApp(appId) {
    if (confirm('Delete this application?')) {
      Dashboard.StorageManager.deleteApp(appId);
      this.renderAppsEditor();
      // Also refresh the overview table if it's visible
      if (document.querySelector('#tab-app-overview.active')) {
        this.renderAppsOverview();
      }
    }
  },
  
  openReassignModal(appId) {
    console.log(`üîÑ Opening reassign modal for app ${appId}`);
    
    const config = Dashboard.StorageManager.loadConfig();
    const app = config.apps.find(a => a.id === appId);
    
    if (!app) {
      console.error(`‚ùå App ${appId} not found`);
      return;
    }
    
    const currentBU = config.buses.find(b => b.id === app.buId);
    const otherBUs = config.buses.filter(b => b.id !== app.buId);
    
    // Create modal content
    let html = `
      <div style="padding: 24px;">
        <h3 style="margin: 0 0 16px 0; color: var(--text);">üîÑ Reassign Application</h3>
        <div style="background: var(--ring); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
          <p style="margin: 0 0 8px 0;"><strong>App:</strong> ${app.name}</p>
          <p style="margin: 0 0 8px 0;"><strong>Current BU:</strong> ${currentBU?.name || 'Unknown'}</p>
          <p style="margin: 0;"><strong>Status:</strong> ${app.status} (${app.progress}%)</p>
        </div>
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 12px; color: var(--text); font-weight: 600;">Assign to Business Unit:</label>
          <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
    `;
    
    otherBUs.forEach(bu => {
      const buApps = config.apps.filter(a => a.buId === bu.id).length;
      html += `
        <button onclick="Dashboard.AdminController.confirmReassign(${appId}, ${bu.id})" 
                style="padding: 12px; background: var(--panel); border: 1px solid var(--ring); color: var(--text); border-radius: 8px; cursor: pointer; text-align: left; transition: all 0.3s;">
          <strong>${bu.name}</strong> <span style="float: right; opacity: 0.6;">${buApps} apps</span>
        </button>
      `;
    });
    
    html += `
          </div>
        </div>
      </div>
    `;
    
    // Insert into modal
    const modalContent = document.querySelector('.nested-modal-content');
    if (modalContent) {
      modalContent.innerHTML = html;
      document.querySelector('.nested-modal').classList.add('active');
    }
  },
  
  confirmReassign(appId, newBuId) {
    console.log(`‚úÖ Confirming reassign: app ${appId} ‚Üí BU ${newBuId}`);
    
    const success = Dashboard.StorageManager.reassignApp(appId, newBuId);
    
    if (success) {
      // Close modal
      document.querySelector('.nested-modal').classList.remove('active');
      
      // Refresh UI
      this.renderAppsEditor();
      Dashboard.UIController.apply();
      
      // Show notification
      alert(`‚úÖ App reassigned successfully`);
    } else {
      alert('‚ùå Failed to reassign app');
    }
  },
  
  showAuditTrail() {
    console.log('üìã Opening audit trail');
    
    const trail = Dashboard.StorageManager.getAuditTrail();
    
    let html = `
      <div style="padding: 24px;">
        <h3 style="margin: 0 0 16px 0; color: var(--text);">üìã Audit Trail</h3>
        <div style="max-height: 400px; overflow-y: auto;">
    `;
    
    if (trail.length === 0) {
      html += '<p style="color: var(--text); opacity: 0.7;">No audit entries yet</p>';
    } else {
      trail.forEach(entry => {
        html += `
          <div style="background: var(--ring); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <strong style="color: var(--primary);">${entry.action}</strong>
              <span style="opacity: 0.6; font-size: 12px;">${new Date(entry.timestamp).toLocaleString()}</span>
            </div>
            <div style="opacity: 0.8; font-size: 14px;">
              <p style="margin: 4px 0;">üì± App: <strong>${entry.appName}</strong> (${entry.status}, ${entry.progress}%)</p>
              <p style="margin: 4px 0;">üîÑ ${entry.fromBuName} ‚Üí ${entry.toBuName}</p>
            </div>
          </div>
        `;
      });
    }
    
    html += `
        </div>
        <div style="display: flex; gap: 8px; margin-top: 16px;">
          <button class="btn btn-danger btn-sm" onclick="Dashboard.StorageManager.clearAuditTrail(); Dashboard.AdminController.showAuditTrail();">Clear Audit Trail</button>
          <button class="btn btn-secondary" onclick="document.querySelector('.nested-modal').classList.remove('active')">Close</button>
        </div>
      </div>
    `;
    
    const modalContent = document.querySelector('.nested-modal-content');
    if (modalContent) {
      modalContent.innerHTML = html;
      document.querySelector('.nested-modal').classList.add('active');
    }
  },
  
  exportConfig() {
    const config = Dashboard.StorageManager.loadConfig();
    
    // Build whitelabel object only if values exist
    const whitelabel = {};
    const mainTitle = localStorage.getItem('wl_mainTitle');
    const subtitle = localStorage.getItem('wl_subtitle');
    const leftLogo = localStorage.getItem('wl_leftLogo');
    const rightLogo = localStorage.getItem('wl_rightLogo');
    
    if (mainTitle !== null) whitelabel.mainTitle = mainTitle;
    if (subtitle !== null) whitelabel.subtitle = subtitle;
    if (leftLogo !== null) whitelabel.leftLogo = leftLogo;
    if (rightLogo !== null) whitelabel.rightLogo = rightLogo;
    
    // Build formula configuration object
    const formulaConfigStr = localStorage.getItem('dashboard_formula_config');
    const formulaConfig = {};
    if (formulaConfigStr) {
      try {
        Object.assign(formulaConfig, JSON.parse(formulaConfigStr));
      } catch (err) {
        console.warn('Could not parse formula config during export:', err);
      }
    }
    
    // Enrich buses with calculated progress
    const enrichedConfig = {
      ...config,
      ...(Object.keys(whitelabel).length > 0 && { whitelabel }),
      ...(Object.keys(formulaConfig).length > 0 && { formulaConfig }),
      buses: config.buses.map(bu => ({
        ...bu,
        calculatedProgress: Dashboard.ProgressCalculator.calculateBUProgress(bu.id),
        appCount: config.apps.filter(app => app.buId === bu.id).length,
        weightedMetrics: this.calculateBUWeightedMetrics(bu.id)
      })),
      apps: config.apps.map(app => ({
        ...app,
        buName: config.buses.find(b => b.id === app.buId)?.name || 'Unknown',
        calculatedWeight: app.weight || 1,
        calculatedProgress: app.progress || 0
      })),
      exportMetadata: {
        exportedAt: new Date().toISOString(),
        version: '2.1',
        schema: 'dashboard_config_v1_enriched_with_formulas',
        totalBUs: config.buses.length,
        totalApps: config.apps.length,
        totalWaves: config.waves.length,
        includesFormulaConfig: Object.keys(formulaConfig).length > 0,
        includesWhitelabelConfig: Object.keys(whitelabel).length > 0
      }
    };
    
    const json = JSON.stringify(enrichedConfig, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dashboard_config_' + new Date().toISOString().slice(0, 10) + '.json';
    a.click();
    URL.revokeObjectURL(url);
    
    console.log('‚úÖ Configuration exported successfully with formula settings');
  },
  
  calculateBUWeightedMetrics(buId) {
    const apps = Dashboard.StorageManager.getAppsByBU(buId);
    if (apps.length === 0) return { totalWeight: 0, weightedSum: 0, averageProgress: 0 };
    
    const totalWeight = apps.reduce((sum, app) => sum + (app.weight || 1), 0);
    const weightedSum = apps.reduce((sum, app) => sum + ((app.progress || 0) * (app.weight || 1)), 0);
    const averageProgress = totalWeight > 0 ? Math.round((weightedSum / totalWeight) * 100) / 100 : 0;
    
    return {
      totalWeight,
      weightedSum,
      averageProgress
    };
  },
  
  // Applications Overview Tab Functionality
  renderAppsOverview() {
    this.initAppOverviewFilters();
    this.setupAppsOverviewSearch();
    this.renderAppsOverviewTable();
    this.updateAppsOverviewStats();
  },

  setupAppsOverviewSearch() {
    const searchInput = document.querySelector('#appsOverviewSearch');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        this.currentOverviewSearch = e.target.value.toLowerCase();
        this.renderAppsOverviewTable();
        this.updateAppsOverviewStats();
      });
    }
  },

  updateAppsOverviewStats() {
    const totalStats = document.querySelector('#statsTotal');
    const filteredStats = document.querySelector('#statsFiltered');
    const completionStats = document.querySelector('#statsCompletion');
    const countDisplay = document.querySelector('#appsCountDisplay');
    
    if (!totalStats) return;
    
    let apps = Dashboard.StorageManager.getAllApps();
    const totalCount = apps.length;
    
    let filteredApps = this.getFilteredApps();
    
    const avgCompletion = filteredApps.length > 0
      ? Math.round(filteredApps.reduce((sum, app) => sum + (app.progress || 0), 0) / filteredApps.length)
      : 0;
    
    totalStats.textContent = totalCount;
    filteredStats.textContent = filteredApps.length;
    completionStats.textContent = avgCompletion + '%';
    countDisplay.textContent = filteredApps.length;
  },

  getFilteredApps() {
    let apps = Dashboard.StorageManager.getAllApps();
    
    if (this.currentOverviewFilters.field !== 'all' && this.currentOverviewFilters.value !== 'all') {
      const fieldToProperty = {
        'status': 'status',
        'criticality': 'criticality',
        'wave': 'wave',
        'buId': 'buId'
      };
      const field = fieldToProperty[this.currentOverviewFilters.field];
      const value = this.currentOverviewFilters.value;
      apps = apps.filter(app => String(app[field]) === String(value));
    }
    
    if (this.currentOverviewSearch) {
      apps = apps.filter(app => 
        app.name.toLowerCase().includes(this.currentOverviewSearch) ||
        (app.wave && app.wave.toLowerCase().includes(this.currentOverviewSearch)) ||
        app.id.toString().includes(this.currentOverviewSearch)
      );
    }
    
    return apps;
  },

  initAppOverviewFilters() {
    const filterField = document.querySelector('#overviewFilterField');
    const filterValue = document.querySelector('#overviewFilterValue');
    
    if (filterField && filterValue) {
      this.currentOverviewFilters = { field: filterField.value, value: 'all' };
      this.updateOverviewFilterValues();
    }
  },
  
  updateOverviewFilterValues() {
    const filterField = document.querySelector('#overviewFilterField');
    const filterValue = document.querySelector('#overviewFilterValue');
    
    if (!filterField || !filterValue) return;
    
    const field = filterField.value;
    this.currentOverviewFilters.field = field;
    
    filterValue.innerHTML = '<option value="all">All Values</option>';
    
    const fieldToProperty = {
      'status': 'status',
      'criticality': 'criticality',
      'wave': 'wave',
      'buId': 'buId'
    };
    
    const propertyName = fieldToProperty[field] || field;
    const allApps = Dashboard.StorageManager.getAllApps();
    
    if (field === 'all') {
      filterValue.disabled = true;
      this.currentOverviewFilters.value = 'all';
    } else {
      filterValue.disabled = false;
      const uniqueValues = new Set();
      
      if (field === 'buId') {
        const buses = Dashboard.StorageManager.getBUs();
        buses.forEach(bu => {
          filterValue.innerHTML += `<option value="${bu.id}">${bu.name}</option>`;
        });
      } else {
        allApps.forEach(app => {
          const value = app[propertyName];
          if (value && !uniqueValues.has(value)) {
            uniqueValues.add(value);
            filterValue.innerHTML += `<option value="${value}">${value}</option>`;
          }
        });
      }
    }
  },
  
  renderAppsOverviewTable() {
    const tableBody = document.querySelector('#appsOverviewTableBody');
    const emptyState = document.querySelector('#emptyState');
    if (!tableBody) return;
    
    let apps = this.getFilteredApps();
    
    if (this.currentSort.column) {
      const { column, direction } = this.currentSort;
      const columnToProperty = {
        'ID': 'id',
        'BU': 'buId',
        'Wave': 'wave',
        'App Name': 'name',
        'Priority': 'priority',
        'Criticality': 'criticality',
        'Business Impact': 'impact',
        'Completion': 'progress',
        'Status': 'status'
      };
      
      const propertyName = columnToProperty[column];
      apps.sort((a, b) => {
        const aValue = a[propertyName] || '';
        const bValue = b[propertyName] || '';
        
        if (propertyName === 'progress' || propertyName === 'id' || propertyName === 'buId') {
          const aNum = parseInt(aValue) || 0;
          const bNum = parseInt(bValue) || 0;
          return direction === 'asc' ? (aNum - bNum) : (bNum - aNum);
        } else {
          return direction === 'asc' 
            ? aValue.toString().localeCompare(bValue.toString())
            : bValue.toString().localeCompare(aValue.toString());
        }
      });
    }
    
    let html = '';
    if (apps.length === 0) {
      html = '<tr style="background: var(--bg-2);"><td colspan="9" style="text-align:center;padding:40px;"><div class="empty-state-icon">üîç</div><div class="empty-state-title">No applications found</div><div class="empty-state-description">Try adjusting your filters or search criteria</div></td></tr>';
    } else {
      const validApps = apps.filter(app => app.id && app.name && app.buId !== undefined);
      validApps.forEach(app => {
        const bu = Dashboard.StorageManager.getBUById(app.buId);
        const buName = bu ? bu.name : app.buId;
        
        const criticality = app.criticality || 'Medium';
        const priority = app.priority || 'Medium';
        const status = app.status || 'TBS';
        
        const rowClass = criticality === 'High' ? 'high' : (criticality === 'Critical' ? 'critical' : 'medium');
        
        const priorityBadge = `<span class="priority-badge-premium ${priority.toLowerCase()}">${this.getPriorityEmoji(priority)} ${priority}</span>`;
        const criticalityBadge = `<span class="criticality-badge-premium ${criticality.toLowerCase()}">${this.getCriticalityEmoji(criticality)} ${criticality}</span>`;
        const statusBadge = `<span class="status-badge-premium ${status.toLowerCase()}">${this.getStatusEmoji(status)} ${status}</span>`;
        
        const progressBar = `<div class="progress-container"><div class="progress-label"><span class="progress-percentage">${app.progress || 0}%</span></div><div class="progress-bar-premium shimmer"><div class="progress-value-premium" style="width: ${app.progress || 0}%"></div></div></div>`;
        
        html += `<tr class="${rowClass}"><td>${app.id}</td><td title="${buName}">${buName}</td><td>${app.wave || '-'}</td><td>${app.name}</td><td>${priorityBadge}</td><td>${criticalityBadge}</td><td>${app.impact || 'Medium'}</td><td class="progress-cell-premium">${progressBar}</td><td>${statusBadge}</td></tr>`;
      });
    }
    
    tableBody.innerHTML = html;
    
    if (apps.length === 0) {
      if (emptyState) emptyState.style.display = 'flex';
    } else {
      if (emptyState) emptyState.style.display = 'none';
    }
    
    this.updateFilterBadges();
  },

  sortAppsOverview(columnName, columnIndex) {
    const headers = document.querySelectorAll('#appsOverviewTable th');
    
    headers.forEach(header => {
      header.classList.remove('sort-asc', 'sort-desc');
    });
    
    if (this.currentSort.column === columnName) {
      this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
      this.currentSort.column = columnName;
      this.currentSort.direction = 'asc';
    }
    
    headers[columnIndex].classList.add(
      this.currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc'
    );
    
    this.renderAppsOverviewTable();
  },

  getPriorityEmoji(priority) {
    return priority === 'High' ? 'üî¥' : (priority === 'Low' ? 'üü¢' : 'üü°');
  },

  getCriticalityEmoji(criticality) {
    return criticality === 'Critical' ? 'üî¥' : (criticality === 'High' ? '‚ö†Ô∏è' : '‚úÖ');
  },

  getStatusEmoji(status) {
    return status === 'CLO' ? '‚úÖ' : (status === 'WIP' ? '‚è±Ô∏è' : 'üìã');
  },

  updateFilterBadges() {
    const container = document.querySelector('#activeFiltersBadges');
    const list = document.querySelector('#activeFiltersList');
    
    if (!container || !list) return;
    
    const hasFilters = (this.currentOverviewFilters.field !== 'all' && this.currentOverviewFilters.value !== 'all') || this.currentOverviewSearch;
    
    if (hasFilters) {
      container.style.display = 'flex';
      let badges = '';
      
      if (this.currentOverviewSearch) {
        badges += `<span class="active-filter-badge">üîé "<strong>${this.currentOverviewSearch}</strong>" <span class="remove-filter" onclick="Dashboard.AdminController.clearSearch()">‚úï</span></span>`;
      }
      
      if (this.currentOverviewFilters.field !== 'all' && this.currentOverviewFilters.value !== 'all') {
        const fieldLabel = this.currentOverviewFilters.field;
        badges += `<span class="active-filter-badge">${fieldLabel}: <strong>${this.currentOverviewFilters.value}</strong> <span class="remove-filter" onclick="Dashboard.AdminController.clearFieldFilter()">‚úï</span></span>`;
      }
      
      list.innerHTML = badges;
    } else {
      container.style.display = 'none';
    }
  },

  clearSearch() {
    const searchInput = document.querySelector('#appsOverviewSearch');
    if (searchInput) searchInput.value = '';
    this.currentOverviewSearch = '';
    this.renderAppsOverviewTable();
    this.updateAppsOverviewStats();
  },

  clearFieldFilter() {
    this.currentOverviewFilters = { field: 'all', value: 'all' };
    const filterField = document.querySelector('#overviewFilterField');
    const filterValue = document.querySelector('#overviewFilterValue');
    if (filterField) filterField.value = 'all';
    if (filterValue) filterValue.value = 'all';
    this.renderAppsOverviewTable();
    this.updateAppsOverviewStats();
  },
  
  importConfig(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedConfig = JSON.parse(e.target.result);
        
        // Validate schema
        if (!importedConfig.buses || !importedConfig.apps || !importedConfig.waves) {
          throw new Error('Invalid configuration schema. Missing required fields: buses, apps, or waves');
        }
        
        // Extract and restore whitelabel config if present (only if values exist)
        if (importedConfig.whitelabel) {
          if (importedConfig.whitelabel.mainTitle) {
            localStorage.setItem('wl_mainTitle', importedConfig.whitelabel.mainTitle);
          }
          if (importedConfig.whitelabel.subtitle) {
            localStorage.setItem('wl_subtitle', importedConfig.whitelabel.subtitle);
          }
          if (importedConfig.whitelabel.leftLogo) {
            localStorage.setItem('wl_leftLogo', importedConfig.whitelabel.leftLogo);
          }
          if (importedConfig.whitelabel.rightLogo) {
            localStorage.setItem('wl_rightLogo', importedConfig.whitelabel.rightLogo);
          }
        }
        
        // Extract and restore formula config if present
        let formulaConfigImported = false;
        if (importedConfig.formulaConfig) {
          try {
            // Validate formula config structure
            const fc = importedConfig.formulaConfig;
            if (fc.progressMethod && fc.weights && fc.criticalityMultipliers) {
              localStorage.setItem('dashboard_formula_config', JSON.stringify({
                progressMethod: fc.progressMethod,
                globalMethod: fc.globalMethod || 'weighted',
                statusInclusion: fc.statusInclusion !== undefined ? fc.statusInclusion : true,
                weights: fc.weights,
                criticalityMultipliers: fc.criticalityMultipliers,
                timestamp: new Date().toISOString()
              }));
              formulaConfigImported = true;
              console.log('‚úÖ Formula configuration imported successfully');
            } else {
              console.warn('‚ö†Ô∏è Formula config is incomplete, skipping import');
            }
          } catch (fcErr) {
            console.warn('‚ö†Ô∏è Could not import formula config:', fcErr.message);
          }
        }
        
        // Extract only the essential data (remove calculated fields)
        const cleanConfig = {
          buses: importedConfig.buses.map(bu => ({
            id: bu.id,
            key: bu.key,
            name: bu.name,
            domain: bu.domain,
            fullname: bu.fullname,
            color: bu.color || '#5b9dff',
            manager: bu.manager || ''
          })),
          apps: importedConfig.apps.map(app => ({
            id: app.id,
            buId: app.buId,
            name: app.name,
            status: app.status || 'TBS',
            progress: app.progress || 0,
            weight: app.weight || 1,
            criticality: app.criticality || 'Medium'
          })),
          waves: importedConfig.waves.map(wave => ({
            id: wave.id,
            name: wave.name
          }))
        };
        
        // Validate data integrity
        const appBUIds = new Set(cleanConfig.apps.map(a => a.buId));
        const buIds = new Set(cleanConfig.buses.map(b => b.id));
        
        for (let buId of appBUIds) {
          if (!buIds.has(buId)) {
            throw new Error(`Invalid reference: app references non-existent Business Unit ID ${buId}`);
          }
        }
        
        // Save configuration
        Dashboard.StorageManager.saveConfig(cleanConfig);
        
        // Verify import
        const verifyConfig = Dashboard.StorageManager.loadConfig();
        const importSummary = {
          busesCount: verifyConfig.buses.length,
          appsCount: verifyConfig.apps.length,
          wavesCount: verifyConfig.waves.length,
          formulaConfigImported
        };
        
        console.log('‚úÖ Configuration imported successfully', importSummary);
        
        let alertMsg = '‚úÖ Configuration imported successfully:\n\n' +
              `  ‚Ä¢ Business Units: ${verifyConfig.buses.length}\n` +
              `  ‚Ä¢ Applications: ${verifyConfig.apps.length}\n` +
              `  ‚Ä¢ Waves: ${verifyConfig.waves.length}`;
        
        if (formulaConfigImported) {
          alertMsg += '\n  ‚Ä¢ Formula Config: Imported ‚úì';
        }
        
        alert(alertMsg);
        
        location.reload();
      } catch (err) {
        console.error('Import error:', err);
        alert('‚ùå Import failed:\n\n' + err.message);
      }
    };
    reader.readAsText(file);
  },
  
  saveAndClose() {
    this.closeModal();
    Dashboard.UIController.apply();
    alert('‚úÖ Changes saved');
  },
  
  clearAllData() {
    console.log('üîç [clearAllData] Iniciando proceso de borrado de datos');
    
    // Double confirmation to prevent accidents
    const confirmed = confirm('‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è\n\nThis will permanently delete ALL data:\n‚Ä¢ Business Units\n‚Ä¢ Applications\n‚Ä¢ Waves\n\nThis action CANNOT be undone.\n\nAre you sure?');
    
    if (!confirmed) {
      console.log('‚ùå [clearAllData] Usuario cancel√≥ la primera confirmaci√≥n');
      return;
    }
    
    const secondConfirmation = confirm('‚ö†Ô∏è FINAL WARNING ‚ö†Ô∏è\n\nType OK to confirm deletion of all data.');
    if (secondConfirmation === false) {
      console.log('‚ùå [clearAllData] Usuario cancel√≥ la segunda confirmaci√≥n');
      return;
    }
    
    try {
      console.log('üßπ [clearAllData] INICIANDO BORRADO COMPLETO DE DATOS');
      
      // Diagn√≥stico pre-borrado
      console.log('üìä [DIAGN√ìSTICO PRE-BORRADO]', {
        localStorage_STORAGE_KEY: localStorage.getItem(Dashboard.StorageManager.STORAGE_KEY),
        localStorage_Keys: Object.keys(localStorage),
        Dashboard_DATA: JSON.stringify(Dashboard.DATA),
        sessionStorage_CLEARED_FLAG: sessionStorage.getItem(Dashboard.StorageManager.CLEARED_FLAG)
      });
      
      // 1. Mark as cleared BEFORE deletion - CRITICAL STEP
      Dashboard.StorageManager.markAsCleared();
      
      // 2. Clear localStorage completely
      localStorage.clear(); // Borrar TODO, no solo la clave espec√≠fica
      
      // 3. Verificaci√≥n m√∫ltiple
      const verification1 = localStorage.getItem(Dashboard.StorageManager.STORAGE_KEY);
      const verification2 = Object.keys(localStorage).length;
      
      console.log('üìä [VERIFICACI√ìN POST-BORRADO]:', { 
        configDataExists: verification1 !== null, 
        remainingStorageItems: verification2,
        clearedFlag: sessionStorage.getItem(Dashboard.StorageManager.CLEARED_FLAG)
      });
      
      if (verification1 !== null) {
        throw new Error('Failed to clear dashboard data - configuration still exists');
      }
      
      // 4. CRUCIAL: Resetear el arreglo DATA hardcodeado
      console.log('üîÑ [clearAllData] Reseteando DATA hardcodeado...');
      // Vaciar el arreglo manteniendo la referencia
      while (DATA.length > 0) {
        DATA.pop();
      }
      
      // Vaciar tambi√©n la copia en el namespace Dashboard
      if (window.Dashboard && window.Dashboard.DATA) {
        while (window.Dashboard.DATA.length > 0) {
          window.Dashboard.DATA.pop();
        }
      }
      
      console.log('‚úÖ [clearAllData] DATA hardcodeado reseteado:', DATA);
      
      // 5. Resetear variables de estado
      this.currentBUId = null;
      
      // 6. Crear un objeto vac√≠o para usar despu√©s de la recarga
      const emptyConfig = { buses: [], apps: [], waves: [] };
      localStorage.setItem('temp_empty_dashboard_config', JSON.stringify(emptyConfig));
      
      console.log('‚úÖ [clearAllData] BORRADO COMPLETO EXITOSO - Dashboard reiniciado');
      
      // 8. Reload after showing success message (no hardcoded UI messages)
      location.reload();
    } catch (err) {
      console.error('Clear All Data Error:', err);
      // No hardcoded UI messages - just log to console
    }
  },
  
  // Enterprise Formula Configuration Functions
  initializeFormulaCalculator() {
    console.log('üöÄ Initializing Enterprise Formula Calculator');
    
    // Real-time weight calculator
    const calcCriticality = document.getElementById('calc-criticality');
    const calcImpact = document.getElementById('calc-impact');
    const calcPriority = document.getElementById('calc-priority');
    const calcResult = document.getElementById('calc-result');
    const calcFormula = document.getElementById('calc-formula');
    
    if (calcCriticality && calcImpact && calcPriority && calcResult && calcFormula) {
      const updateCalculator = () => {
        const criticality = parseInt(calcCriticality.value);
        const impact = parseInt(calcImpact.value);
        const priority = parseInt(calcPriority.value);
        
        // Calculate weight using enterprise formula
        const weight = ((criticality * impact * priority) / 27 * 3).toFixed(2);
        
        // Update display
        calcResult.textContent = weight;
        calcFormula.textContent = `[(${criticality} √ó ${impact} √ó ${priority}) √∑ 27] √ó 3`;
        
        // Add animation effect
        calcResult.style.transform = 'scale(1.1)';
        setTimeout(() => {
          calcResult.style.transform = 'scale(1)';
        }, 200);
      };
      
      // Event listeners
      calcCriticality.addEventListener('change', updateCalculator);
      calcImpact.addEventListener('change', updateCalculator);
      calcPriority.addEventListener('change', updateCalculator);
      
      // Initial calculation
      updateCalculator();
    }
    
    // Method selection handling
    const methodRadios = document.querySelectorAll('#tab-formulas input[name="progress-method"]');
    methodRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        console.log(`üìä Progress method changed to: ${e.target.value}`);
        this.updateProgressMethodDisplay(e.target.value);
      });
    });
    
    // Global method selection
    const globalRadios = document.querySelectorAll('#tab-formulas input[name="global-method"]');
    globalRadios.forEach(radio => {
      radio.addEventListener('change', (e) => {
        console.log(`üåê Global method changed to: ${e.target.value}`);
        this.updateGlobalMethodDisplay(e.target.value);
      });
    });
    
    // Status inclusion checkboxes
    const statusCheckboxes = document.querySelectorAll('#tab-formulas .inclusion-checkbox');
    statusCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        console.log(`üîÑ Status inclusion changed: ${e.target.id} = ${e.target.checked}`);
        this.updateStatusInclusion();
      });
    });
  },
  
  updateProgressMethodDisplay(method) {
    // Visual feedback for method selection
    const methodOptions = document.querySelectorAll('.method-option');
    methodOptions.forEach(option => {
      const input = option.querySelector('input[type="radio"]');
      if (input && input.value === method) {
        option.classList.add('active');
      } else {
        option.classList.remove('active');
      }
    });
  },
  
  updateGlobalMethodDisplay(method) {
    // Visual feedback for global method selection
    const globalOptions = document.querySelectorAll('.global-option');
    globalOptions.forEach(option => {
      const input = option.querySelector('input[type="radio"]');
      if (input && input.value === method) {
        option.classList.add('active');
      } else {
        option.classList.remove('active');
      }
    });
  },
  
  updateStatusInclusion() {
    // Get current status inclusion settings
    const includesTBS = document.getElementById('include-tbs')?.checked || false;
    const includesWIP = document.getElementById('include-wip')?.checked || true;
    const includesCLO = document.getElementById('include-clo')?.checked || true;
    
    console.log('üìã Status Inclusion Updated:', { includesTBS, includesWIP, includesCLO });
    
    // Store in configuration
    this.statusInclusionConfig = {
      TBS: includesTBS,
      WIP: includesWIP,
      CLO: includesCLO
    };
  },
  
  saveFormulaConfig() {
    console.log('üíæ Saving Enterprise Formula Configuration');
    
    // Collect all settings from the new interface
    const formulaConfig = {
      progressMethod: document.querySelector('#tab-formulas input[name="progress-method"]:checked')?.value || 'weighted',
      globalMethod: document.querySelector('#tab-formulas input[name="global-method"]:checked')?.value || 'weighted',
      statusInclusion: {
        TBS: document.getElementById('include-tbs')?.checked || false,
        WIP: document.getElementById('include-wip')?.checked || true,
        CLO: document.getElementById('include-clo')?.checked || true
      },
      automaticWeights: true, // Flag for automatic weight system
      weightFormula: 'enterprise', // Enterprise formula identifier
      timestamp: new Date().toISOString()
    };
    
    // Save to localStorage
    localStorage.setItem('dashboard_formula_config_v2', JSON.stringify(formulaConfig));
    
    // Apply changes immediately
    Dashboard.UIController.apply();
    
    console.log('‚úÖ Enterprise Formula Configuration Saved Successfully');
  },
  
  resetFormulaConfig() {
    console.log('üîÑ Resetting Formula Settings to Defaults');
    
    // Reset radio buttons to defaults
    document.querySelector('input[name="progress-method"][value="weighted"]').checked = true;
    document.querySelector('input[name="global-method"][value="weighted"]').checked = true;
    
    // Reset status inclusion checkboxes
    document.getElementById('include-tbs').checked = false;
    document.getElementById('include-wip').checked = true;
    document.getElementById('include-clo').checked = true;
    
    // Trigger change event to update display
    this.updateFormulaLabels();
    
    // Save reset configuration
    const config = Dashboard.StorageManager.loadConfig();
    config.formulaSettings = {
      timestamp: new Date().toISOString(),
      progressMethod: 'weighted',
      globalMethod: 'weighted',
      statusInclusions: {
        tbs: false,
        wip: true,
        clo: true
      }
    };
    Dashboard.StorageManager.saveConfig(config);
    
    console.log('‚úÖ Formula settings reset to defaults');
  },
  
  testFormulaConfig() {
    console.log('üß™ Testing Formula Configuration');
    
    // Get current configuration from form
    const formulaConfig = {
      progressMethod: document.querySelector('input[name="progress-method"]:checked')?.value || 'weighted',
      globalMethod: document.querySelector('input[name="global-method"]:checked')?.value || 'weighted',
      statusInclusions: {
        tbs: document.getElementById('include-tbs')?.checked || false,
        wip: document.getElementById('include-wip')?.checked || true,
        clo: document.getElementById('include-clo')?.checked || true
      }
    };
    
    // Get data
    const buses = Dashboard.StorageManager.getBUs();
    const apps = Dashboard.StorageManager.getAllApps();
    
    // Generate test results
    let results = '<div style="padding: 16px; max-height: 500px; overflow-y: auto;">';
    results += '<h3>Formula Test Results</h3>';
    results += '<p>Testing calculation with current configuration:</p>';
    results += '<ul>';
    results += `<li>Progress Method: <strong>${formulaConfig.progressMethod}</strong></li>`;
    results += `<li>Global Method: <strong>${formulaConfig.globalMethod}</strong></li>`;
    results += `<li>Include TBS: <strong>${formulaConfig.statusInclusion.TBS}</strong></li>`;
    results += `<li>Include WIP: <strong>${formulaConfig.statusInclusion.WIP}</strong></li>`;
    results += `<li>Include CLO: <strong>${formulaConfig.statusInclusion.CLO}</strong></li>`;
    results += '</ul>';
    
    // Calculate for each BU
    results += '<table style="width:100%; border-collapse: collapse; margin-top: 16px;">';
    results += '<thead><tr style="background: var(--ring);"><th style="text-align:left; padding: 8px;">Business Unit</th><th style="text-align:center; padding: 8px;">Apps</th><th style="text-align:center; padding: 8px;">Progress</th></tr></thead>';
    results += '<tbody>';
    
    let totalApps = 0;
    let weightedSum = 0;
    let buSum = 0;
    
    buses.forEach(bu => {
      const buApps = apps.filter(app => app.buId === bu.id);
      const buAppCount = buApps.length;
      totalApps += buAppCount;
      
      // Only include statuses based on configuration
      const filteredApps = buApps.filter(app => {
        if (app.status === 'TBS' && !formulaConfig.statusInclusion.TBS) return false;
        if (app.status === 'WIP' && !formulaConfig.statusInclusion.WIP) return false;
        if (app.status === 'CLO' && !formulaConfig.statusInclusion.CLO) return false;
        return true;
      });
      
      // Calculate BU progress based on selected method
      let buProgress = 0;
      
      if (filteredApps.length > 0) {
        if (formulaConfig.progressMethod === 'weighted') {
          const totalWeight = filteredApps.reduce((sum, app) => sum + (app.weight || 1), 0);
          const weightedSum = filteredApps.reduce((sum, app) => sum + ((app.progress || 0) * (app.weight || 1)), 0);
          buProgress = totalWeight > 0 ? Math.round(weightedSum / totalWeight) : 0;
        } else if (formulaConfig.progressMethod === 'simple') {
          buProgress = Math.round(filteredApps.reduce((sum, app) => sum + (app.progress || 0), 0) / filteredApps.length);
        } else if (formulaConfig.progressMethod === 'minimum') {
          buProgress = Math.min(...filteredApps.map(app => app.progress || 0));
        }
      }
      
      weightedSum += buProgress * buAppCount;
      buSum += buProgress;
      
      // Set background color based on progress
      const bgColor = buProgress === 100 ? 'rgba(50, 230, 133, 0.15)' : 
                     buProgress >= 50 ? 'rgba(255, 209, 102, 0.15)' : 
                     'rgba(255, 95, 122, 0.15)';
      
      results += `<tr style="background: ${bgColor}; border-bottom: 1px solid var(--ring);">
                   <td style="padding: 8px;">${bu.name}</td>
                   <td style="text-align:center; padding: 8px;">${buAppCount}</td>
                   <td style="text-align:center; padding: 8px;">${buProgress}%</td>
                 </tr>`;
    });
    
    results += '</tbody></table>';
    
    // Calculate global progress
    const globalProgress = formulaConfig.globalMethod === 'weighted' 
      ? (totalApps > 0 ? Math.round(weightedSum / totalApps) : 0)
      : (buses.length > 0 ? Math.round(buSum / buses.length) : 0);
    
    results += `<div style="margin-top: 24px; background: var(--ring); padding: 16px; border-radius: 8px;">
                 <h4 style="margin-top:0;">Global Progress: ${globalProgress}%</h4>
                 <p>Calculated using: ${formulaConfig.globalMethod === 'weighted' ? 'Weighted by BU Size' : 'Simple BU Average'}</p>
                 <div style="background: var(--panel); height: 24px; width: 100%; border-radius: 12px; overflow: hidden; margin-top: 8px;">
                   <div style="background: ${globalProgress === 100 ? 'var(--ok)' : globalProgress >= 50 ? 'var(--warn)' : 'var(--danger)'}; 
                               height: 100%; width: ${globalProgress}%"></div>
                 </div>
               </div>`;
    
    results += '</div>';
    
    // Show results in modal
    const nestedModal = document.querySelector('.nested-modal') || document.createElement('div');
    nestedModal.className = 'nested-modal';
    nestedModal.style.opacity = '1';
    nestedModal.style.pointerEvents = 'auto';
    
    nestedModal.innerHTML = `
      <div class="nested-modal-content" style="background: var(--panel); border: 1px solid var(--ring); 
          width: 80%; max-width: 800px; border-radius: var(--radius); box-shadow: 0 10px 50px rgba(0,0,0,0.5);">
        ${results}
        <div style="padding: 16px; display: flex; justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="document.querySelector('.nested-modal').style.opacity='0'; document.querySelector('.nested-modal').style.pointerEvents='none';">
            Close
          </button>
        </div>
      </div>
    `;
    
    if (!document.body.contains(nestedModal)) {
      document.body.appendChild(nestedModal);
    }
    
    nestedModal.style.opacity = '1';
    nestedModal.style.pointerEvents = 'auto';
  },
  
  loadFormulaConfig() {
    console.log('Loading formula configuration from localStorage');
    
    // Try to get saved configuration from localStorage
    const savedConfigStr = localStorage.getItem('dashboard_formula_config');
    
    // If no saved config, just load empty form (don't reset to defaults)
    if (!savedConfigStr) {
      console.log('No saved formula configuration found, initializing defaults');
      return;
    }
    
    try {
      // Parse saved configuration
      const config = JSON.parse(savedConfigStr);
      
      // Apply to form inputs - use correct selectors for actual HTML structure
      if (config.progressMethod) {
        document.querySelector(`input[name="progress-method"][value="${config.progressMethod}"]`).checked = true;
      }
      
      if (config.globalMethod) {
        document.querySelector(`input[name="global-method"][value="${config.globalMethod}"]`).checked = true;
      }
      
      // Status inclusion
      if (config.statusInclusions) {
        if (config.statusInclusions.tbs !== undefined) {
          document.getElementById('include-tbs').checked = config.statusInclusions.tbs;
        }
        if (config.statusInclusions.wip !== undefined) {
          document.getElementById('include-wip').checked = config.statusInclusions.wip;
        }
        if (config.statusInclusions.clo !== undefined) {
          document.getElementById('include-clo').checked = config.statusInclusions.clo;
        }
      }
      
      console.log('‚úÖ Formula configuration loaded successfully:', config);
    } catch (err) {
      console.error('Failed to load formula configuration:', err);
    }
  },

  initializeEmptyFormulaForm() {
    console.log('Initializing formula form with defaults');
    
    // Set form to default state
    document.querySelector('input[name="progress-method"][value="weighted"]').checked = true;
    document.querySelector('input[name="global-method"][value="weighted"]').checked = true;
    document.getElementById('include-tbs').checked = false;
    document.getElementById('include-wip').checked = true;
    document.getElementById('include-clo').checked = true;
  },
  
  updateFormulaLabels() {
    // Get currently selected methods
    const progressMethod = document.querySelector('input[name="progress-method"]:checked')?.value || 'weighted';
    const globalMethod = document.querySelector('input[name="global-method"]:checked')?.value || 'weighted';
    
    console.log('Formula update:', { progressMethod, globalMethod });
    // Update display labels based on selected methods
    // This function would update any formula display labels if they exist in the UI
  }
}

// Export module for namespace compatibility
if (!window.Dashboard) window.Dashboard = {};
window.Dashboard.AdminController = AdminController;


/* StorageManager is the ONLY source of truth */

// Settings Tab Enhanced Functionality

/* World-Class Settings Manager */
const AdvancedSettingsManager = {
  SETTINGS_KEY: 'dashboard_advanced_settings_v1',
  BACKUP_KEY: 'dashboard_backup_v1',
  AUDIT_KEY: 'dashboard_audit_log_v1',
  
  defaultSettings: {
    performance: {
      animationSpeed: 1.0,
      refreshInterval: 30000,
      enableTransitions: true
    },
    display: {
      theme: 'auto',
      density: 'comfortable',
      showTooltips: true
    },
    notifications: {
      enableNotifications: true,
      notifyOnProgress: false,
      notifyOnCompletion: true
    },
    security: {
      enableEncryption: true,
      enableAuditLog: true
    },
    privacy: {
      shareUsageData: false,
      enableCrashReports: false,
      dataRetention: 90
    },
    export: {
      includeCalculatedMetrics: true,
      includeAuditTrail: true,
      includeSystemInfo: false
    }
  },
  
  init() {
    this.loadSettings();
    this.setupSettingsEventListeners();
    this.updateSettingsUI();
    this.initializeDragAndDrop();
    this.updateSystemInfo();
    this.loadAuditTrail();
  },
  
  loadSettings() {
    const stored = localStorage.getItem(this.SETTINGS_KEY);
    this.settings = stored ? { ...this.defaultSettings, ...JSON.parse(stored) } : { ...this.defaultSettings };
    return this.settings;
  },
  
  saveSettings() {
    localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(this.settings));
    this.logAuditEvent('settings_changed', 'Settings configuration updated');
    this.showNotification('‚öôÔ∏è Settings saved successfully', 'success');
    this.updateSystemInfo();
  },
  
  setupSettingsEventListeners() {
    // Performance Settings
    const animationSpeed = document.getElementById('animationSpeed');
    const animationSpeedValue = document.getElementById('animationSpeedValue');
    const refreshInterval = document.getElementById('refreshInterval');
    const enableTransitions = document.getElementById('enableTransitions');
    
    if (animationSpeed) {
      animationSpeed.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        this.settings.performance.animationSpeed = value;
        animationSpeedValue.textContent = value.toFixed(1) + 's';
        this.applyAnimationSpeed(value);
      });
    }
    
    if (refreshInterval) {
      refreshInterval.addEventListener('change', (e) => {
        this.settings.performance.refreshInterval = parseInt(e.target.value);
        this.setupAutoRefresh();
      });
    }
    
    if (enableTransitions) {
      enableTransitions.addEventListener('change', (e) => {
        this.settings.performance.enableTransitions = e.target.checked;
        this.applyTransitionSettings(e.target.checked);
      });
    }
    
    // Display Settings
    const themeInputs = document.querySelectorAll('input[name="theme"]');
    const displayDensity = document.getElementById('displayDensity');
    const showTooltips = document.getElementById('showTooltips');
    
    themeInputs.forEach(input => {
      input.addEventListener('change', (e) => {
        if (e.target.checked) {
          this.settings.display.theme = e.target.value;
          this.applyTheme(e.target.value);
        }
      });
    });
    
    if (displayDensity) {
      displayDensity.addEventListener('change', (e) => {
        this.settings.display.density = e.target.value;
        this.applyDensity(e.target.value);
      });
    }
    
    if (showTooltips) {
      showTooltips.addEventListener('change', (e) => {
        this.settings.display.showTooltips = e.target.checked;
        this.toggleTooltips(e.target.checked);
      });
    }
    
    // Action Buttons
    const createBackupBtn = document.getElementById('createBackupBtn');
    const restoreBackupBtn = document.getElementById('restoreBackupBtn');
    const showAuditTrailBtn = document.getElementById('showAuditTrailBtn');
    const exportAuditBtn = document.getElementById('exportAuditBtn');
    const resetConfigBtn = document.getElementById('resetConfigBtn');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const resetAllSettingsBtn = document.getElementById('resetAllSettingsBtn');
    
    if (createBackupBtn) {
      createBackupBtn.addEventListener('click', () => this.createBackup());
    }
    
    if (restoreBackupBtn) {
      restoreBackupBtn.addEventListener('click', () => this.restoreBackup());
    }
    
    if (showAuditTrailBtn) {
      showAuditTrailBtn.addEventListener('click', () => this.showAuditTrail());
    }
    
    if (exportAuditBtn) {
      exportAuditBtn.addEventListener('click', () => this.exportAuditLog());
    }
    
    if (resetConfigBtn) {
      resetConfigBtn.addEventListener('click', () => this.resetConfiguration());
    }
    
    if (saveSettingsBtn) {
      saveSettingsBtn.addEventListener('click', () => this.saveSettings());
    }
    
    if (resetAllSettingsBtn) {
      resetAllSettingsBtn.addEventListener('click', () => this.resetAllSettings());
    }
    
    // Clear All Data Enhanced
    const confirmationCheckboxes = document.querySelectorAll('#confirmDeletion1, #confirmDeletion2, #confirmDeletion3');
    const clearAllDataBtn = document.getElementById('clearAllDataBtn');
    
    confirmationCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const allChecked = Array.from(confirmationCheckboxes).every(cb => cb.checked);
        if (clearAllDataBtn) {
          clearAllDataBtn.disabled = !allChecked;
        }
      });
    });
  },
  
  updateSettingsUI() {
    // Update Performance UI
    const animationSpeed = document.getElementById('animationSpeed');
    const animationSpeedValue = document.getElementById('animationSpeedValue');
    const refreshInterval = document.getElementById('refreshInterval');
    const enableTransitions = document.getElementById('enableTransitions');
    
    if (animationSpeed) {
      animationSpeed.value = this.settings.performance.animationSpeed;
      animationSpeedValue.textContent = this.settings.performance.animationSpeed.toFixed(1) + 's';
    }
    
    if (refreshInterval) {
      refreshInterval.value = this.settings.performance.refreshInterval;
    }
    
    if (enableTransitions) {
      enableTransitions.checked = this.settings.performance.enableTransitions;
    }
    
    // Update Display UI
    const themeInput = document.querySelector(`input[name="theme"][value="${this.settings.display.theme}"]`);
    const displayDensity = document.getElementById('displayDensity');
    const showTooltips = document.getElementById('showTooltips');
    
    if (themeInput) {
      themeInput.checked = true;
    }
    
    if (displayDensity) {
      displayDensity.value = this.settings.display.density;
    }
    
    if (showTooltips) {
      showTooltips.checked = this.settings.display.showTooltips;
    }
  },
  
  initializeDragAndDrop() {
    const importZone = document.getElementById('importZone');
    const importFileInput = document.getElementById('importAdminJSON');
    
    if (importZone && importFileInput) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        importZone.addEventListener(eventName, this.preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        importZone.addEventListener(eventName, () => importZone.classList.add('dragover'), false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        importZone.addEventListener(eventName, () => importZone.classList.remove('dragover'), false);
      });
      
      importZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          this.handleFileImport(files[0]);
        }
      });
      
      importZone.addEventListener('click', () => importFileInput.click());
      
      importFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          this.handleFileImport(e.target.files[0]);
        }
      });
    }
  },
  
  preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  },
  
  handleFileImport(file) {
    if (!file.type.includes('json')) {
      this.showNotification('‚ùå Please select a valid JSON file', 'error');
      return;
    }
    
    if (file.size > 10 * 1024 * 1024) { // 10MB limit
      this.showNotification('‚ùå File size too large. Maximum 10MB allowed.', 'error');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const config = JSON.parse(e.target.result);
        this.validateAndImportConfig(config);
      } catch (error) {
        this.showNotification('‚ùå Invalid JSON file format', 'error');
        console.error('Import error:', error);
      }
    };
    reader.readAsText(file);
  },
  
  validateAndImportConfig(config) {
    const validationResult = this.validateConfigStructure(config);
    const validationResultEl = document.getElementById('validationResult');
    
    if (validationResult.isValid) {
      validationResultEl.style.display = 'block';
      validationResultEl.querySelector('.status-text').textContent = 'Configuration validated successfully';
      validationResultEl.querySelector('.validation-details').innerHTML = `
        <div>‚Ä¢ Business Units: ${config.buses?.length || 0}</div>
        <div>‚Ä¢ Applications: ${config.apps?.length || 0}</div>
        <div>‚Ä¢ Waves: ${config.waves?.length || 0}</div>
      `;
      
      this.showImportConfirmationDialog(config);
      this.logAuditEvent('config_validated', 'Configuration file validated for import');
    } else {
      validationResultEl.style.display = 'block';
      validationResultEl.classList.add('error');
      validationResultEl.querySelector('.status-icon').textContent = '‚ùå';
      validationResultEl.querySelector('.status-text').textContent = 'Validation failed';
      validationResultEl.querySelector('.validation-details').innerHTML = validationResult.errors.map(error => `<div>‚Ä¢ ${error}</div>`).join('');
      this.logAuditEvent('config_validation_failed', `Validation errors: ${validationResult.errors.join(', ')}`);
    }
  },
  
  validateConfigStructure(config) {
    const errors = [];
    
    if (!config.buses || !Array.isArray(config.buses)) {
      errors.push('Missing or invalid "buses" array');
    }
    
    if (!config.apps || !Array.isArray(config.apps)) {
      errors.push('Missing or invalid "apps" array');
    }
    
    if (!config.waves || !Array.isArray(config.waves)) {
      errors.push('Missing or invalid "waves" array');
    }
    
    if (config.buses && config.apps) {
      const buIds = new Set(config.buses.map(bu => bu.id));
      config.apps.forEach((app, index) => {
        if (!buIds.has(app.buId)) {
          errors.push(`App at index ${index} references non-existent Business Unit ID ${app.buId}`);
        }
      });
    }
    
    return {
      isValid: errors.length === 0,
      errors
    };
  },
  
  showImportConfirmationDialog(config) {
    const confirmation = confirm(`Import this configuration?\n\nThis will replace all current data:\n‚Ä¢ ${config.buses.length} Business Units\n‚Ä¢ ${config.apps.length} Applications\n‚Ä¢ ${config.waves.length} Waves\n\nClick OK to proceed or Cancel to abort.`);
    
    if (confirmation) {
      Dashboard.StorageManager.saveConfig(config);
      this.showNotification('‚úÖ Configuration imported successfully', 'success');
      this.logAuditEvent('config_imported', `Imported ${config.buses.length} BUs, ${config.apps.length} apps, ${config.waves.length} waves`);
      
      setTimeout(() => {
        location.reload();
      }, 1500);
    }
  },
  
  createBackup() {
    const config = Dashboard.StorageManager.loadConfig();
    const backup = {
      timestamp: new Date().toISOString(),
      version: '2.0.0',
      data: config,
      settings: this.settings
    };
    
    localStorage.setItem(this.BACKUP_KEY, JSON.stringify(backup));
    this.showNotification('üíæ Backup created successfully', 'success');
    this.logAuditEvent('backup_created', 'Manual backup created');
    this.updateBackupInfo();
  },
  
  restoreBackup() {
    const backup = localStorage.getItem(this.BACKUP_KEY);
    if (!backup) {
      this.showNotification('‚ùå No backup found', 'error');
      return;
    }
    
    const confirmation = confirm('Restore from backup?\n\nThis will replace all current data with the backup version.\n\nClick OK to proceed or Cancel to abort.');
    
    if (confirmation) {
      try {
        const backupData = JSON.parse(backup);
        Dashboard.StorageManager.saveConfig(backupData.data);
        this.settings = backupData.settings || this.defaultSettings;
        localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(this.settings));
        
        this.showNotification('‚úÖ Backup restored successfully', 'success');
        this.logAuditEvent('backup_restored', `Restored backup from ${backupData.timestamp}`);
        
        setTimeout(() => {
          location.reload();
        }, 1500);
      } catch (error) {
        this.showNotification('‚ùå Failed to restore backup', 'error');
        console.error('Restore error:', error);
      }
    }
  },
  
  updateBackupInfo() {
    const backup = localStorage.getItem(this.BACKUP_KEY);
    const lastBackupTime = document.getElementById('lastBackupTime');
    
    if (backup && lastBackupTime) {
      try {
        const backupData = JSON.parse(backup);
        const date = new Date(backupData.timestamp);
        lastBackupTime.textContent = date.toLocaleString();
      } catch (error) {
        lastBackupTime.textContent = 'Invalid backup';
      }
    }
  },
  
  updateSystemInfo() {
    const configVersion = document.getElementById('configVersion');
    const lastModified = document.getElementById('lastModified');
    const storageInfo = document.getElementById('storageInfo');
    const storageUsed = document.getElementById('storageUsed');
    
    if (configVersion) {
      configVersion.textContent = '2.0.0';
    }
    
    if (lastModified) {
      const config = Dashboard.StorageManager.loadConfig();
      lastModified.textContent = config.lastModified ? new Date(config.lastModified).toLocaleString() : 'Never';
    }
    
    let totalSize = 0;
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key)) {
        totalSize += localStorage[key].length;
      }
    }
    
    const sizeKB = (totalSize / 1024).toFixed(1);
    
    if (storageInfo) {
      storageInfo.textContent = `${sizeKB} KB`;
    }
    
    if (storageUsed) {
      storageUsed.textContent = `${sizeKB} KB`;
    }
  },
  
  logAuditEvent(action, description) {
    if (!this.settings.security.enableAuditLog) return;
    
    const auditLog = JSON.parse(localStorage.getItem(this.AUDIT_KEY) || '[]');
    const event = {
      timestamp: new Date().toISOString(),
      action,
      description,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    auditLog.push(event);
    
    const retentionDays = this.settings.privacy.dataRetention;
    if (retentionDays > 0) {
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
      const filteredLog = auditLog.filter(entry => new Date(entry.timestamp) > cutoffDate);
      localStorage.setItem(this.AUDIT_KEY, JSON.stringify(filteredLog));
    } else {
      localStorage.setItem(this.AUDIT_KEY, JSON.stringify(auditLog));
    }
    
    this.updateAuditStats();
  },
  
  loadAuditTrail() {
    this.updateAuditStats();
  },
  
  updateAuditStats() {
    const auditLog = JSON.parse(localStorage.getItem(this.AUDIT_KEY) || '[]');
    const auditEntries = document.getElementById('auditEntries');
    const auditToday = document.getElementById('auditToday');
    
    if (auditEntries) {
      auditEntries.textContent = auditLog.length;
    }
    
    if (auditToday) {
      const today = new Date().toDateString();
      const todayEntries = auditLog.filter(entry => new Date(entry.timestamp).toDateString() === today);
      auditToday.textContent = todayEntries.length;
    }
  },
  
  showAuditTrail() {
    const auditLog = JSON.parse(localStorage.getItem(this.AUDIT_KEY) || '[]');
    
    if (auditLog.length === 0) {
      this.showNotification('üìã No audit entries found', 'info');
      return;
    }
    
    const auditHTML = auditLog.slice(-50).reverse().map(entry => `
      <div class="audit-entry">
        <div class="audit-timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
        <div class="audit-action">${entry.action}</div>
        <div class="audit-description">${entry.description}</div>
      </div>
    `).join('');
    
    const auditModal = document.createElement('div');
    auditModal.className = 'audit-modal-overlay';
    auditModal.innerHTML = `
      <div class="audit-modal-content">
        <div class="audit-modal-header">
          <h3>üìã Audit Trail (Last 50 entries)</h3>
          <button class="audit-modal-close">‚úï</button>
        </div>
        <div class="audit-modal-body">
          ${auditHTML}
        </div>
      </div>
    `;
    
    document.body.appendChild(auditModal);
    
    auditModal.querySelector('.audit-modal-close').addEventListener('click', () => {
      document.body.removeChild(auditModal);
    });
    
    auditModal.addEventListener('click', (e) => {
      if (e.target === auditModal) {
        document.body.removeChild(auditModal);
      }
    });
    
    this.logAuditEvent('audit_trail_viewed', 'User viewed audit trail');
  },
  
  exportAuditLog() {
    const auditLog = JSON.parse(localStorage.getItem(this.AUDIT_KEY) || '[]');
    
    if (auditLog.length === 0) {
      this.showNotification('üìã No audit entries to export', 'info');
      return;
    }
    
    const exportData = {
      exportedAt: new Date().toISOString(),
      version: '2.0.0',
      totalEntries: auditLog.length,
      entries: auditLog
    };
    
    const json = JSON.stringify(exportData, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dashboard_audit_log_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    this.showNotification('üìÑ Audit log exported successfully', 'success');
    this.logAuditEvent('audit_log_exported', `Exported ${auditLog.length} audit entries`);
  },
  
  resetConfiguration() {
    const confirmation = confirm('Reset all settings to default?\n\nThis will not affect your data (Business Units, Applications) but will reset all preferences and configurations.\n\nClick OK to proceed or Cancel to abort.');
    
    if (confirmation) {
      this.settings = { ...this.defaultSettings };
      this.saveSettings();
      this.updateSettingsUI();
      this.showNotification('üîÑ Settings reset to defaults', 'success');
      this.logAuditEvent('settings_reset', 'All settings reset to default values');
    }
  },
  
  resetAllSettings() {
    this.resetConfiguration();
  },
  
  applyAnimationSpeed(speed) {
    document.documentElement.style.setProperty('--animation-duration', `${speed}s`);
  },
  
  applyTransitionSettings(enabled) {
    document.documentElement.style.setProperty('--transitions-enabled', enabled ? 'all 0.3s ease' : 'none');
  },
  
  applyTheme(theme) {
    if (theme === 'auto') {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    } else {
      document.documentElement.setAttribute('data-theme', theme);
    }
    this.logAuditEvent('theme_changed', `Theme changed to ${theme}`);
  },
  
  applyDensity(density) {
    document.documentElement.setAttribute('data-density', density);
    this.logAuditEvent('density_changed', `Display density changed to ${density}`);
  },
  
  toggleTooltips(enabled) {
    document.documentElement.style.setProperty('--tooltips-enabled', enabled ? 'block' : 'none');
  },
  
  showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    Object.assign(notification.style, {
      position: 'fixed',
      top: '20px',
      right: '20px',
      padding: '16px 24px',
      borderRadius: '8px',
      color: 'white',
      fontWeight: '500',
      zIndex: '10000',
      animation: 'slideInRight 0.3s ease',
      maxWidth: '400px',
      boxShadow: '0 8px 24px rgba(0,0,0,0.3)'
    });
    
    const colors = {
      success: '#32e685',
      error: '#ff5f7a',
      warning: '#ffd166',
      info: '#5b9dff'
    };
    
    notification.style.background = colors[type] || colors.info;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 300);
    }, 4000);
  }
};

// Initialize Advanced Settings when the admin modal is opened
document.addEventListener('DOMContentLoaded', () => {
  const initAdvancedSettings = () => {
    if (window.Dashboard && window.Dashboard.AdminController) {
      const originalSwitchTab = Dashboard.AdminController.switchTab;
      Dashboard.AdminController.switchTab = function(tabName) {
        originalSwitchTab.call(this, tabName);
        
        if (tabName === 'settings') {
          setTimeout(() => {
            AdvancedSettingsManager.init();
          }, 100);
        }
      };
      
      const originalExportConfig = Dashboard.AdminController.exportConfig;
      Dashboard.AdminController.exportConfig = function() {
        const config = Dashboard.StorageManager.loadConfig();
        const settings = AdvancedSettingsManager.loadSettings();
        
        const enrichedConfig = {
          ...config,
          exportMetadata: {
            exportedAt: new Date().toISOString(),
            version: '2.0.0',
            schema: 'dashboard_config_v2_enhanced',
            totalBUs: config.buses.length,
            totalApps: config.apps.length,
            totalWaves: config.waves.length
          }
        };
        
        if (settings.export.includeCalculatedMetrics) {
          enrichedConfig.buses = config.buses.map(bu => ({
            ...bu,
            calculatedProgress: Dashboard.ProgressCalculator.calculateBUProgress(bu.id),
            appCount: config.apps.filter(app => app.buId === bu.id).length
          }));
          
          enrichedConfig.apps = config.apps.map(app => ({
            ...app,
            buName: config.buses.find(b => b.id === app.buId)?.name || 'Unknown',
            calculatedWeight: Dashboard.ProgressCalculator.calculateAppWeight(app)
          }));
        }
        
        if (settings.export.includeAuditTrail) {
          const auditLog = JSON.parse(localStorage.getItem(AdvancedSettingsManager.AUDIT_KEY) || '[]');
          enrichedConfig.auditTrail = auditLog.slice(-100);
        }
        
        if (settings.export.includeSystemInfo) {
          enrichedConfig.systemInfo = {
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString(),
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            language: navigator.language,
            settings: settings
          };
        }
        
        const json = JSON.stringify(enrichedConfig, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dashboard_enhanced_config_${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        AdvancedSettingsManager.logAuditEvent('config_exported', 'Enhanced configuration exported');
        AdvancedSettingsManager.showNotification('üì• Enhanced configuration exported successfully', 'success');
      };
    } else {
      setTimeout(initAdvancedSettings, 100);
    }
  };
  
  initAdvancedSettings();
});

const notificationStyles = document.createElement('style');
notificationStyles.textContent = `
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOutRight {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
  
  .audit-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(10px);
  }
  
  .audit-modal-content {
    background: var(--panel);
    border: 1px solid var(--ring);
    border-radius: 16px;
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .audit-modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--ring);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .audit-modal-header h3 {
    margin: 0;
    color: var(--text);
    font-size: 20px;
  }
  
  .audit-modal-close {
    background: none;
    border: none;
    color: var(--text);
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s ease;
  }
  
  .audit-modal-close:hover {
    background: var(--ring);
  }
  
  .audit-modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }
  
  .audit-entry {
    padding: 16px;
    border: 1px solid var(--ring);
    border-radius: 8px;
    margin-bottom: 12px;
    background: rgba(91,157,255,0.02);
    transition: background 0.2s ease;
  }
  
  .audit-entry:hover {
    background: rgba(91,157,255,0.05);
  }
  
  .audit-timestamp {
    font-size: 12px;
    color: rgba(233, 238, 247, 0.7);
    margin-bottom: 4px;
  }
  
  .audit-action {
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 4px;
  }
  
  .audit-description {
    font-size: 14px;
    color: var(--text);
  }
`;

document.head.appendChild(notificationStyles);

// End Settings Tab Functionality

/* Main entry point */
document.addEventListener('DOMContentLoaded', function() {
    // Initialize StorageManager FIRST to detect cleared state
    Dashboard.StorageManager.init();
    
    // Initialize other modules in the correct order
    Dashboard.AdminController.init();
    Dashboard.UIController.init();
});
</script>
</body>
</html>